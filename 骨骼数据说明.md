# 📐 BigWorld骨骼数据说明

根据BigWorld官方文档，骨骼数据的存储和分组说明：

---

## 📁 骨骼信息存储位置

### `.visual`文件 - 存储骨骼层级结构
骨骼的完整层级信息存储在`.visual`文件中的`<node>`标签中。

**格式（嵌套层级）**:
```xml
<filename.visual>
    <node>
        <identifier>Scene Root</identifier>
        <transform>
            <row0>1.0 0.0 0.0</row0>
            <row1>0.0 1.0 0.0</row1>
            <row2>0.0 0.0 1.0</row2>
            <row3>0.0 0.0 0.0</row3>
        </transform>
        <node>
            <identifier>Root</identifier>
            <transform>...</transform>
            <node>
                <identifier>Spine</identifier>
                <transform>...</transform>
                <node>
                    <identifier>Spine1</identifier>
                    <transform>...</transform>
                </node>
            </node>
        </node>
    </node>
    <renderSet>...</renderSet>
    <boundingBox>...</boundingBox>
</filename.visual>
```

**关键特征**:
- ✅ 嵌套的`<node>`标签表示父子关系
- ✅ 每个骨骼有`<identifier>`（骨骼名）
- ✅ 每个骨骼有`<transform>`（4x3矩阵，局部变换）
- ✅ Scene Root是根节点，所有骨骼都在其下

---

### `.model`文件 - 只引用.visual
`.model`文件不包含骨骼数据，只引用`.visual`文件。

**格式**:
```xml
<filename.model>
    <nodefullVisual>characters/dragon/Box01</nodefullVisual>
    <!-- 其他配置 -->
</filename.model>
```

**注意**:
- ✅ 有骨骼时使用`<nodefullVisual>`
- ✅ 无骨骼时使用`<nodelessVisual>`
- ✅ 路径是相对于res目录的相对路径
- ✅ 不含`.visual`扩展名

---

## 🔄 骨骼分组逻辑

### 分组方式：父子层级

BigWorld使用**嵌套的XML节点**来表示骨骼的父子关系：

```
Scene Root (根节点)
└── Root (第1级骨骼，parent=None)
    ├── Spine (第2级，parent=Root)
    │   ├── Spine1 (第3级，parent=Spine)
    │   └── Neck (第3级，parent=Spine)
    │       └── Head (第4级，parent=Neck)
    ├── LeftShoulder (第2级，parent=Root)
    │   ├── LeftArm
    │   └── LeftHand
    └── RightShoulder (第2级，parent=Root)
        ├── RightArm
        └── RightHand
```

---

## 🛠️ 插件实现

### SkeletonBuilder（export_builders.py）
**职责**: 从Blender Armature构建Skeleton数据结构

```python
@dataclass
class SkeletonBone:
    name: str                    # 骨骼名
    parent: Optional[str]        # 父骨骼名（None表示根骨骼）
    bind_matrix: List[List[float]]  # 4x3局部变换矩阵
```

**构建过程**:
1. 遍历Blender的所有骨骼
2. 记录每个骨骼的name、parent、bind_matrix
3. 返回Skeleton对象（包含bones列表和bone_names列表）

---

### VisualWriter（writers/visual_writer.py）
**职责**: 将Skeleton数据写入.visual文件

**写入过程**:
1. `_write_skeleton_hierarchy()` - 创建Scene Root
2. `_build_bone_hierarchy()` - 找到所有根骨骼（parent=None）
3. `_write_bone_node()` - 递归写入每个骨骼及其子骨骼

**递归逻辑**:
```python
def _write_bone_node(parent_node, bone, bone_map, all_bones):
    # 1. 创建当前骨骼的<node>标签
    bone_node = parent_node.add_child("node")
    bone_node.add_child("identifier", bone.name)
    bone_node.add_child("transform", bone.bind_matrix)
    
    # 2. 找到所有子骨骼（parent == 当前骨骼name）
    child_bones = [b for b in all_bones if b.parent == bone.name]
    
    # 3. 递归写入每个子骨骼
    for child_bone in child_bones:
        _write_bone_node(bone_node, child_bone, bone_map, all_bones)
```

---

## ✅ 验证骨骼层级是否正确

### 检查.visual文件
打开导出的`.visual`文件，查看`<node>`标签：

**正确的层级**:
```xml
<node>
    <identifier>Scene Root</identifier>
    <transform>...</transform>
    <node>
        <identifier>骨骼1</identifier>
        <transform>...</transform>
        <node>
            <identifier>子骨骼1</identifier>
            <transform>...</transform>
        </node>
    </node>
</node>
```

**错误的层级**（扁平列表）:
```xml
<node>骨骼1</node>
<node>骨骼2</node>
<node>骨骼3</node>
```

### 检查骨骼数量
- 骨骼数量应该与Blender Armature中的骨骼数量一致
- 每个骨骼都应该有`<identifier>`和`<transform>`

### 检查父子关系
- 子骨骼应该嵌套在父骨骼的`<node>`内部
- 根骨骼应该直接在Scene Root下

---

## 🐛 可能的问题

### 问题1: 骨骼层级是扁平的
**原因**: `parent`字段设置错误，导致所有骨骼都被识别为根骨骼

**检查**:
```python
# 在SkeletonBuilder.build中添加调试输出
print(f"骨骼: {bone.name}, 父骨骼: {bone.parent.name if bone.parent else 'None'}")
```

### 问题2: 骨骼变换矩阵不正确
**原因**: 局部矩阵计算错误或坐标转换错误

**检查**:
```python
# 检查bind_matrix是否是4x3矩阵
print(f"骨骼 {bone.name} 变换矩阵: {len(matrix)}行 x {len(matrix[0])}列")
```

### 问题3: 骨骼名称不正确
**原因**: Blender骨骼名与BigWorld期望的名称不匹配

**检查**:
- 确保骨骼名称不包含特殊字符
- 确保骨骼名称唯一

---

## 🔧 调试建议

### 1. 在SkeletonBuilder.build中添加调试输出
```python
print(f"=== 骨骼层级调试 ===")
print(f"总骨骼数: {len(skeleton.bones)}")
for bone in skeleton.bones:
    print(f"  {bone.name} -> 父: {bone.parent}")
print(f"根骨骼: {skeleton.root}")
```

### 2. 在VisualWriter._build_bone_hierarchy中添加调试输出
```python
root_bones = [bone for bone in skeleton.bones if bone.parent is None]
print(f"=== Visual写入调试 ===")
print(f"根骨骼数量: {len(root_bones)}")
for rb in root_bones:
    print(f"  根骨骼: {rb.name}")
```

---

## 📋 当前实现状态

### ✅ 已实现
- ✅ 骨骼层级数据结构（SkeletonBone, Skeleton）
- ✅ 骨骼数据构建（SkeletonBuilder.build）
- ✅ 嵌套XML写入（_write_skeleton_hierarchy, _write_bone_node）
- ✅ 坐标系转换（_get_bone_local_matrix）

### ❓ 需要验证
- ❓ 父子关系是否正确识别
- ❓ 骨骼顺序是否正确
- ❓ 变换矩阵是否正确
- ❓ BigWorld工具能否正确识别

---

**如果需要调试骨骼层级，请告诉我具体看到了什么问题！**


