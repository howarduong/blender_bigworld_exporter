# ğŸ“ BigWorldéª¨éª¼æ•°æ®è¯´æ˜

æ ¹æ®BigWorldå®˜æ–¹æ–‡æ¡£ï¼Œéª¨éª¼æ•°æ®çš„å­˜å‚¨å’Œåˆ†ç»„è¯´æ˜ï¼š

---

## ğŸ“ éª¨éª¼ä¿¡æ¯å­˜å‚¨ä½ç½®

### `.visual`æ–‡ä»¶ - å­˜å‚¨éª¨éª¼å±‚çº§ç»“æ„
éª¨éª¼çš„å®Œæ•´å±‚çº§ä¿¡æ¯å­˜å‚¨åœ¨`.visual`æ–‡ä»¶ä¸­çš„`<node>`æ ‡ç­¾ä¸­ã€‚

**æ ¼å¼ï¼ˆåµŒå¥—å±‚çº§ï¼‰**:
```xml
<filename.visual>
    <node>
        <identifier>Scene Root</identifier>
        <transform>
            <row0>1.0 0.0 0.0</row0>
            <row1>0.0 1.0 0.0</row1>
            <row2>0.0 0.0 1.0</row2>
            <row3>0.0 0.0 0.0</row3>
        </transform>
        <node>
            <identifier>Root</identifier>
            <transform>...</transform>
            <node>
                <identifier>Spine</identifier>
                <transform>...</transform>
                <node>
                    <identifier>Spine1</identifier>
                    <transform>...</transform>
                </node>
            </node>
        </node>
    </node>
    <renderSet>...</renderSet>
    <boundingBox>...</boundingBox>
</filename.visual>
```

**å…³é”®ç‰¹å¾**:
- âœ… åµŒå¥—çš„`<node>`æ ‡ç­¾è¡¨ç¤ºçˆ¶å­å…³ç³»
- âœ… æ¯ä¸ªéª¨éª¼æœ‰`<identifier>`ï¼ˆéª¨éª¼åï¼‰
- âœ… æ¯ä¸ªéª¨éª¼æœ‰`<transform>`ï¼ˆ4x3çŸ©é˜µï¼Œå±€éƒ¨å˜æ¢ï¼‰
- âœ… Scene Rootæ˜¯æ ¹èŠ‚ç‚¹ï¼Œæ‰€æœ‰éª¨éª¼éƒ½åœ¨å…¶ä¸‹

---

### `.model`æ–‡ä»¶ - åªå¼•ç”¨.visual
`.model`æ–‡ä»¶ä¸åŒ…å«éª¨éª¼æ•°æ®ï¼Œåªå¼•ç”¨`.visual`æ–‡ä»¶ã€‚

**æ ¼å¼**:
```xml
<filename.model>
    <nodefullVisual>characters/dragon/Box01</nodefullVisual>
    <!-- å…¶ä»–é…ç½® -->
</filename.model>
```

**æ³¨æ„**:
- âœ… æœ‰éª¨éª¼æ—¶ä½¿ç”¨`<nodefullVisual>`
- âœ… æ— éª¨éª¼æ—¶ä½¿ç”¨`<nodelessVisual>`
- âœ… è·¯å¾„æ˜¯ç›¸å¯¹äºresç›®å½•çš„ç›¸å¯¹è·¯å¾„
- âœ… ä¸å«`.visual`æ‰©å±•å

---

## ğŸ”„ éª¨éª¼åˆ†ç»„é€»è¾‘

### åˆ†ç»„æ–¹å¼ï¼šçˆ¶å­å±‚çº§

BigWorldä½¿ç”¨**åµŒå¥—çš„XMLèŠ‚ç‚¹**æ¥è¡¨ç¤ºéª¨éª¼çš„çˆ¶å­å…³ç³»ï¼š

```
Scene Root (æ ¹èŠ‚ç‚¹)
â””â”€â”€ Root (ç¬¬1çº§éª¨éª¼ï¼Œparent=None)
    â”œâ”€â”€ Spine (ç¬¬2çº§ï¼Œparent=Root)
    â”‚   â”œâ”€â”€ Spine1 (ç¬¬3çº§ï¼Œparent=Spine)
    â”‚   â””â”€â”€ Neck (ç¬¬3çº§ï¼Œparent=Spine)
    â”‚       â””â”€â”€ Head (ç¬¬4çº§ï¼Œparent=Neck)
    â”œâ”€â”€ LeftShoulder (ç¬¬2çº§ï¼Œparent=Root)
    â”‚   â”œâ”€â”€ LeftArm
    â”‚   â””â”€â”€ LeftHand
    â””â”€â”€ RightShoulder (ç¬¬2çº§ï¼Œparent=Root)
        â”œâ”€â”€ RightArm
        â””â”€â”€ RightHand
```

---

## ğŸ› ï¸ æ’ä»¶å®ç°

### SkeletonBuilderï¼ˆexport_builders.pyï¼‰
**èŒè´£**: ä»Blender Armatureæ„å»ºSkeletonæ•°æ®ç»“æ„

```python
@dataclass
class SkeletonBone:
    name: str                    # éª¨éª¼å
    parent: Optional[str]        # çˆ¶éª¨éª¼åï¼ˆNoneè¡¨ç¤ºæ ¹éª¨éª¼ï¼‰
    bind_matrix: List[List[float]]  # 4x3å±€éƒ¨å˜æ¢çŸ©é˜µ
```

**æ„å»ºè¿‡ç¨‹**:
1. éå†Blenderçš„æ‰€æœ‰éª¨éª¼
2. è®°å½•æ¯ä¸ªéª¨éª¼çš„nameã€parentã€bind_matrix
3. è¿”å›Skeletonå¯¹è±¡ï¼ˆåŒ…å«bonesåˆ—è¡¨å’Œbone_namesåˆ—è¡¨ï¼‰

---

### VisualWriterï¼ˆwriters/visual_writer.pyï¼‰
**èŒè´£**: å°†Skeletonæ•°æ®å†™å…¥.visualæ–‡ä»¶

**å†™å…¥è¿‡ç¨‹**:
1. `_write_skeleton_hierarchy()` - åˆ›å»ºScene Root
2. `_build_bone_hierarchy()` - æ‰¾åˆ°æ‰€æœ‰æ ¹éª¨éª¼ï¼ˆparent=Noneï¼‰
3. `_write_bone_node()` - é€’å½’å†™å…¥æ¯ä¸ªéª¨éª¼åŠå…¶å­éª¨éª¼

**é€’å½’é€»è¾‘**:
```python
def _write_bone_node(parent_node, bone, bone_map, all_bones):
    # 1. åˆ›å»ºå½“å‰éª¨éª¼çš„<node>æ ‡ç­¾
    bone_node = parent_node.add_child("node")
    bone_node.add_child("identifier", bone.name)
    bone_node.add_child("transform", bone.bind_matrix)
    
    # 2. æ‰¾åˆ°æ‰€æœ‰å­éª¨éª¼ï¼ˆparent == å½“å‰éª¨éª¼nameï¼‰
    child_bones = [b for b in all_bones if b.parent == bone.name]
    
    # 3. é€’å½’å†™å…¥æ¯ä¸ªå­éª¨éª¼
    for child_bone in child_bones:
        _write_bone_node(bone_node, child_bone, bone_map, all_bones)
```

---

## âœ… éªŒè¯éª¨éª¼å±‚çº§æ˜¯å¦æ­£ç¡®

### æ£€æŸ¥.visualæ–‡ä»¶
æ‰“å¼€å¯¼å‡ºçš„`.visual`æ–‡ä»¶ï¼ŒæŸ¥çœ‹`<node>`æ ‡ç­¾ï¼š

**æ­£ç¡®çš„å±‚çº§**:
```xml
<node>
    <identifier>Scene Root</identifier>
    <transform>...</transform>
    <node>
        <identifier>éª¨éª¼1</identifier>
        <transform>...</transform>
        <node>
            <identifier>å­éª¨éª¼1</identifier>
            <transform>...</transform>
        </node>
    </node>
</node>
```

**é”™è¯¯çš„å±‚çº§**ï¼ˆæ‰å¹³åˆ—è¡¨ï¼‰:
```xml
<node>éª¨éª¼1</node>
<node>éª¨éª¼2</node>
<node>éª¨éª¼3</node>
```

### æ£€æŸ¥éª¨éª¼æ•°é‡
- éª¨éª¼æ•°é‡åº”è¯¥ä¸Blender Armatureä¸­çš„éª¨éª¼æ•°é‡ä¸€è‡´
- æ¯ä¸ªéª¨éª¼éƒ½åº”è¯¥æœ‰`<identifier>`å’Œ`<transform>`

### æ£€æŸ¥çˆ¶å­å…³ç³»
- å­éª¨éª¼åº”è¯¥åµŒå¥—åœ¨çˆ¶éª¨éª¼çš„`<node>`å†…éƒ¨
- æ ¹éª¨éª¼åº”è¯¥ç›´æ¥åœ¨Scene Rootä¸‹

---

## ğŸ› å¯èƒ½çš„é—®é¢˜

### é—®é¢˜1: éª¨éª¼å±‚çº§æ˜¯æ‰å¹³çš„
**åŸå› **: `parent`å­—æ®µè®¾ç½®é”™è¯¯ï¼Œå¯¼è‡´æ‰€æœ‰éª¨éª¼éƒ½è¢«è¯†åˆ«ä¸ºæ ¹éª¨éª¼

**æ£€æŸ¥**:
```python
# åœ¨SkeletonBuilder.buildä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
print(f"éª¨éª¼: {bone.name}, çˆ¶éª¨éª¼: {bone.parent.name if bone.parent else 'None'}")
```

### é—®é¢˜2: éª¨éª¼å˜æ¢çŸ©é˜µä¸æ­£ç¡®
**åŸå› **: å±€éƒ¨çŸ©é˜µè®¡ç®—é”™è¯¯æˆ–åæ ‡è½¬æ¢é”™è¯¯

**æ£€æŸ¥**:
```python
# æ£€æŸ¥bind_matrixæ˜¯å¦æ˜¯4x3çŸ©é˜µ
print(f"éª¨éª¼ {bone.name} å˜æ¢çŸ©é˜µ: {len(matrix)}è¡Œ x {len(matrix[0])}åˆ—")
```

### é—®é¢˜3: éª¨éª¼åç§°ä¸æ­£ç¡®
**åŸå› **: Blenderéª¨éª¼åä¸BigWorldæœŸæœ›çš„åç§°ä¸åŒ¹é…

**æ£€æŸ¥**:
- ç¡®ä¿éª¨éª¼åç§°ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦
- ç¡®ä¿éª¨éª¼åç§°å”¯ä¸€

---

## ğŸ”§ è°ƒè¯•å»ºè®®

### 1. åœ¨SkeletonBuilder.buildä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
```python
print(f"=== éª¨éª¼å±‚çº§è°ƒè¯• ===")
print(f"æ€»éª¨éª¼æ•°: {len(skeleton.bones)}")
for bone in skeleton.bones:
    print(f"  {bone.name} -> çˆ¶: {bone.parent}")
print(f"æ ¹éª¨éª¼: {skeleton.root}")
```

### 2. åœ¨VisualWriter._build_bone_hierarchyä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
```python
root_bones = [bone for bone in skeleton.bones if bone.parent is None]
print(f"=== Visualå†™å…¥è°ƒè¯• ===")
print(f"æ ¹éª¨éª¼æ•°é‡: {len(root_bones)}")
for rb in root_bones:
    print(f"  æ ¹éª¨éª¼: {rb.name}")
```

---

## ğŸ“‹ å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®ç°
- âœ… éª¨éª¼å±‚çº§æ•°æ®ç»“æ„ï¼ˆSkeletonBone, Skeletonï¼‰
- âœ… éª¨éª¼æ•°æ®æ„å»ºï¼ˆSkeletonBuilder.buildï¼‰
- âœ… åµŒå¥—XMLå†™å…¥ï¼ˆ_write_skeleton_hierarchy, _write_bone_nodeï¼‰
- âœ… åæ ‡ç³»è½¬æ¢ï¼ˆ_get_bone_local_matrixï¼‰

### â“ éœ€è¦éªŒè¯
- â“ çˆ¶å­å…³ç³»æ˜¯å¦æ­£ç¡®è¯†åˆ«
- â“ éª¨éª¼é¡ºåºæ˜¯å¦æ­£ç¡®
- â“ å˜æ¢çŸ©é˜µæ˜¯å¦æ­£ç¡®
- â“ BigWorldå·¥å…·èƒ½å¦æ­£ç¡®è¯†åˆ«

---

**å¦‚æœéœ€è¦è°ƒè¯•éª¨éª¼å±‚çº§ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çœ‹åˆ°äº†ä»€ä¹ˆé—®é¢˜ï¼**


