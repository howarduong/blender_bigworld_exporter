# BigWorld Blender æ’ä»¶å®Œæ•´æ–¹æ¡ˆæ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–?*: 2025-10-22  
**çŠ¶æ€?*: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”?

---

## ğŸ“‘ ç›®å½•

1. [æ’ä»¶æ¦‚è¿°](#ç¬¬ä¸€ç« æ’ä»¶æ¦‚è¿?
2. [é¡¹ç›®æ¶æ„](#ç¬¬äºŒç« é¡¹ç›®æ¶æ?
3. [UIè®¾è®¡è§„èŒƒ](#ç¬¬ä¸‰ç« uiè®¾è®¡è§„èŒƒ)
4. [æ–‡ä»¶æ ¼å¼è§„èŒƒ](#ç¬¬å››ç« æ–‡ä»¶æ ¼å¼è§„èŒ?
5. [æŠ€æœ¯å®ç°ç»†èŠ‚](#ç¬¬äº”ç« æŠ€æœ¯å®ç°ç»†èŠ?
6. [å¯¼å‡ºæµç¨‹](#ç¬¬å…­ç« å¯¼å‡ºæµç¨?
7. [é—®é¢˜ä¿®å¤è®°å½•](#ç¬¬ä¸ƒç« é—®é¢˜ä¿®å¤è®°å½?
8. [å¼€å‘æŒ‡å—](#ç¬¬å…«ç« å¼€å‘æŒ‡å?
9. [å‚è€ƒèµ„æ–™](#ç¬¬ä¹ç« å‚è€ƒèµ„æ–?

---

# ç¬¬ä¸€ç« ï¼šæ’ä»¶æ¦‚è¿°

## 1.1 é¡¹ç›®ç®€ä»?

BigWorld Blender æ’ä»¶æ˜¯ä¸€ä¸ªç”¨äºå°† Blender 3D æ¨¡å‹å¯¼å‡ºä¸?BigWorld æ¸¸æˆå¼•æ“æ ¼å¼çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€?

**æ ¸å¿ƒåŠŸèƒ½**ï¼?
- é™æ€æ¨¡å‹å¯¼å‡ºï¼ˆ`.primitives` + `.visual` + `.model`ï¼?
- è’™çš®æ¨¡å‹å¯¼å‡ºï¼ˆå¸¦éª¨éª¼æƒé‡ï¼?
- è§’è‰²åŠ¨ç”»å¯¼å‡ºï¼ˆå®Œæ•´éª¨éª¼å±‚çº?+ åŠ¨ç”»æ•°æ®ï¼?
- å¤šå¯¹è±¡æ‰¹é‡å¯¼å‡?
- åæ ‡ç³»è‡ªåŠ¨è½¬æ¢ï¼ˆBlender Z-up â†?BigWorld Y-upï¼?

**æŠ€æœ¯ç‰¹ç‚?*ï¼?
- âœ?å®Œå…¨åŸºäº BigWorld å®˜æ–¹æºç å®ç°
- âœ?ç¬¦åˆå®˜æ–¹æ–‡ä»¶æ ¼å¼è§„èŒƒ
- âœ?æ™ºèƒ½æ•°æ®å¤„ç†å’Œé”™è¯¯å¤„ç?
- âœ?å®Œæ•´çš„æ—¥å¿—å’Œå®¡è®¡ç³»ç»Ÿ

---

## 1.2 åŠŸèƒ½ç‰¹æ€?

### å·²å®ŒæˆåŠŸèƒ?âœ?

#### æ ¸å¿ƒå¯¼å‡ºç³»ç»Ÿ
- âœ?é™æ€æ¨¡å‹å¯¼å‡?
- âœ?è’™çš®æ¨¡å‹å¯¼å‡º
- âœ?è§’è‰²åŠ¨ç”»å¯¼å‡º
- âœ?å¤šå¯¹è±¡æ‰¹é‡å¯¼å‡?
- âœ?æ–‡ä»¶ä¾èµ–ç®¡ç†

#### åæ ‡ç³»ç»Ÿ
- âœ?Blender Z-up â†?BigWorld Y-up è½¬æ¢
- âœ?é¡¶ç‚¹åæ ‡è½¬æ¢
- âœ?æ³•çº¿/åˆ‡çº¿è½¬æ¢
- âœ?éª¨éª¼çŸ©é˜µè½¬æ¢
- âœ?åŠ¨ç”»å…³é”®å¸§è½¬æ?

#### æ–‡ä»¶æ ¼å¼
- âœ?BinSection æ ¼å¼ï¼ˆ`.primitives`ï¼?
- âœ?PackedSection æ ¼å¼ï¼ˆ`.visual`, `.model`, `.animation`ï¼?
- âœ?åŠ¨æ€é¡¶ç‚¹æ ¼å¼ç”Ÿæˆ?
- âœ?Packed Normal æ ¼å¼ï¼?1-11-10ä½ï¼‰
- âœ?è’™çš®æ•°æ®æ ¼å¼ï¼?ç´¢å¼•+2æƒé‡ï¼?

#### éª¨éª¼ç³»ç»Ÿ
- âœ?å®Œæ•´éª¨éª¼å±‚çº§å¯¼å‡º
- âœ?éª¨éª¼ç»‘å®šçŸ©é˜µè®¡ç®—
- âœ?éª¨éª¼ç´¢å¼•èŒƒå›´éªŒè¯
- âœ?åµŒå¥—éª¨éª¼ç»“æ„

#### åŠ¨ç”»ç³»ç»Ÿ
- âœ?å…³é”®å¸§é‡‡æ ?
- âœ?ä½ç½®/æ—‹è½¬/ç¼©æ”¾å…³é”®å¸?
- âœ?å››å…ƒæ•°æ—‹è½?
- âœ?æ‰¹é‡åŠ¨ç”»å¯¼å‡º

#### UIç³»ç»Ÿ
- âœ?æ’ä»¶åå¥½è®¾ç½®é¢æ¿
- âœ?å¯¹è±¡å±æ€§é¢æ¿ï¼ˆNé¢æ¿ï¼?
- âœ?æ–‡ä»¶å¯¼å‡ºå¯¹è¯æ¡?
- âœ?å¯¼å‡ºç±»å‹é€‰æ‹©

#### å·¥å…·ç³»ç»Ÿ
- âœ?å®¡è®¡æ—¥å¿—ï¼ˆ`audit.log`ï¼?
- âœ?å¯¼å‡ºæ¸…å•ï¼ˆ`manifest.json`ï¼?
- âœ?é”™è¯¯å¤„ç†å’Œå›æ»?
- âœ?æ–‡ä»¶é”å®šå¤„ç†

### å¾…å¼€å‘åŠŸèƒ?â?

#### é«˜çº§åŠŸèƒ½
- â?LOD ç³»ç»Ÿ
- â?BSP æ•°æ®
- â?ç¢°æ’æ£€æµ?
- â?é—¨æˆ·ç³»ç»Ÿ
- â?æè´¨ Dye/Tint
- â?Action ç³»ç»Ÿ
- â?åŠ¨ç”»äº‹ä»¶
- â?åŠ¨ç”»å‹ç¼©

#### å·¥å…·å¢å¼º
- â?å¯¼å‡ºé¢„è®¾
- â?æ‰¹é‡å¤„ç†
- â?æ ¼å¼éªŒè¯
- â?ModelEditor é›†æˆæµ‹è¯•

---

## 1.3 å½“å‰çŠ¶æ€?

### è´¨é‡è¯„ä¼°

| æŒ‡æ ‡ | å®Œæˆåº?|
|------|--------|
| ä»£ç å®Œæ•´æ€?| 95% |
| åŠŸèƒ½å®Œæ•´æ€?| 85% |
| æµ‹è¯•è¦†ç›–åº?| 70% |
| æ–‡æ¡£å®Œæ•´æ€?| 90% |

### å¯ç”¨åŠŸèƒ½

1. **é™æ€æ¨¡å‹å¯¼å‡?* - âœ?å®Œå…¨æ­£å¸¸ï¼Œå·²éªŒè¯
2. **è’™çš®æ¨¡å‹å¯¼å‡º** - ğŸ§ª åŸºæœ¬åŠŸèƒ½å®Œæˆï¼Œå¾…æµ‹è¯•
3. **è§’è‰²åŠ¨ç”»å¯¼å‡º** - ğŸ§ª åŸºæœ¬åŠŸèƒ½å®Œæˆï¼Œå¾…æµ‹è¯•
4. **å¤šå¯¹è±¡å¯¼å‡?* - âœ?å®Œå…¨æ­£å¸¸
5. **åæ ‡è½¬æ¢** - âœ?å®Œå…¨æ­£å¸¸
6. **UIç•Œé¢** - âœ?å®Œå…¨æ­£å¸¸

### éœ€è¦æµ‹è¯•çš„åŠŸèƒ½

1. è’™çš®æ¨¡å‹ - éœ€è¦åœ¨ BigWorld å®˜æ–¹å·¥å…·ä¸­éªŒè¯?
2. è§’è‰²åŠ¨ç”» - éœ€è¦éªŒè¯åŠ¨ç”»æ’­æ”¾æ­£ç¡®æ€?
3. å¤šéª¨éª¼æ¨¡å?- éœ€è¦æµ‹è¯•éª¨éª¼æ•°é‡?> 255 çš„æƒ…å†?

---

# ç¬¬äºŒç« ï¼šé¡¹ç›®æ¶æ„

## 2.1 ç›®å½•ç»“æ„ï¼ˆå®é™…ï¼‰

```
blender_bigworld_exporter/
â”œâ”€â”€ __init__.py                    # æ’ä»¶ä¸»å…¥å?
â”œâ”€â”€ export_builders.py             # æ•°æ®æ„å»ºå™?
â”œâ”€â”€ export_dispatcher.py           # å¯¼å‡ºè°ƒåº¦å™?
â”œâ”€â”€ export_processor.py            # å¯¼å‡ºå¤„ç†å™?
â”?
â”œâ”€â”€ core/                          # æ ¸å¿ƒæ¨¡å—
â”?  â”œâ”€â”€ __init__.py
â”?  â”œâ”€â”€ bin_section_writer.py     # BinSection äºŒè¿›åˆ¶å†™å…¥å™¨
â”?  â”œâ”€â”€ coordinate_converter.py   # åæ ‡ç³»è½¬æ¢å™¨
â”?  â”œâ”€â”€ file_manager.py           # æ–‡ä»¶ç®¡ç†å™?
â”?  â”œâ”€â”€ logger.py                 # æ—¥å¿—è®°å½•å™?
â”?  â”œâ”€â”€ packed_section_writer.py  # PackedSection å†™å…¥å™?
â”?  â”œâ”€â”€ path_resolver.py          # è·¯å¾„è§£æå™?
â”?  â”œâ”€â”€ schema.py                 # æ•°æ®ç»“æ„å®šä¹‰ï¼ˆdataclassï¼?
â”?  â”œâ”€â”€ validator.py              # æ•°æ®éªŒè¯å™?
â”?  â”œâ”€â”€ vertex_format.py          # é¡¶ç‚¹æ ¼å¼å¤„ç†
â”?  â””â”€â”€ xml_writer.py             # XML å†™å…¥å™?
â”?
â”œâ”€â”€ ui/                            # ç”¨æˆ·ç•Œé¢æ¨¡å—
â”?  â”œâ”€â”€ __init__.py
â”?  â”œâ”€â”€ export_panel.py           # Fileâ†’Export å¯¹è¯æ¡?
â”?  â”œâ”€â”€ object_panel.py           # N é¢æ¿å¯¹è±¡å±æ€?
â”?  â””â”€â”€ preferences_panel.py      # æ’ä»¶åå¥½è®¾ç½®
â”?
â””â”€â”€ writers/                       # æ–‡ä»¶å†™å…¥å™¨æ¨¡å?
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ animation_writer.py       # åŠ¨ç”»æ–‡ä»¶å†™å…¥å™?
    â”œâ”€â”€ audit_writer.py           # å®¡è®¡æ—¥å¿—å†™å…¥å™?
    â”œâ”€â”€ manifest_writer.py        # æ¸…å•æ–‡ä»¶å†™å…¥å™?
    â”œâ”€â”€ model_writer.py           # æ¨¡å‹æ–‡ä»¶å†™å…¥å™?
    â”œâ”€â”€ primitives_writer.py      # å‡ ä½•æ–‡ä»¶å†™å…¥å™?
    â””â”€â”€ visual_writer.py          # è§†è§‰æ–‡ä»¶å†™å…¥å™?
```

---

## 2.2 æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 2.2.1 ä¸»å…¥å£æ¨¡å?

**æ–‡ä»¶**: `__init__.py`

**èŒè´£**:
- Blender æ’ä»¶æ³¨å†Œ
- å¯¼å‡ºæ“ä½œç¬¦å®šä¹?
- èœå•æ³¨å†Œ
- å±æ€§æ³¨å†?

**å…³é”®ç±?*:
- `BigWorldExportOperator` - å¯¼å‡ºæ“ä½œç¬?
- `BigWorldExportSettings` - å¯¼å‡ºè®¾ç½®
- `BigWorldObjectProperties` - å¯¹è±¡å±æ€?
- `BigWorldAddonPreferences` - æ’ä»¶åå¥½è®¾ç½®

---

### 2.2.2 æ ¸å¿ƒæ¨¡å— (core/)

#### bin_section_writer.py
**èŒè´£**: å®ç° BigWorld çš?BinSection äºŒè¿›åˆ¶æ ¼å¼å†™å…?

**å…³é”®åŠŸèƒ½**:
- å†™å…¥äºŒè¿›åˆ¶æ•°æ®ï¼ˆuint8, uint16, uint32, float, Vector2, Vector3ï¼?
- å†™å…¥ Packed Normalï¼?1-11-10 ä½æ ¼å¼ï¼‰
- æ„å»ºç´¢å¼•è¡¨å’Œ BinSection æ–‡ä»¶å¤?

#### coordinate_converter.py
**èŒè´£**: å¤„ç† Blender åˆ?BigWorld çš„åæ ‡ç³»è½¬æ¢

**è½¬æ¢è§„åˆ™**:
- Blender: Z-up, å³æ‰‹åæ ‡ç³?
- BigWorld: Y-up, å³æ‰‹åæ ‡ç³?
- è½¬æ¢çŸ©é˜µ: ç»?X è½´æ—‹è½?-90 åº?

**å…³é”®æ–¹æ³•**:
- `convert_position()` - ä½ç½®è½¬æ¢
- `convert_normal()` - æ³•çº¿è½¬æ¢
- `convert_matrix()` - çŸ©é˜µè½¬æ¢
- `convert_quaternion()` - å››å…ƒæ•°è½¬æ?

#### schema.py
**èŒè´£**: å®šä¹‰æ‰€æœ?BigWorld æ–‡ä»¶çš„æ•°æ®ç»“æ?

**å…³é”®æ•°æ®ç±?*:
- `Primitives` - å‡ ä½•æ•°æ®
- `Visual` - è§†è§‰æ•°æ®
- `Model` - æ¨¡å‹æ•°æ®
- `Animation` - åŠ¨ç”»æ•°æ®
- `Skeleton` - éª¨éª¼æ•°æ®

#### vertex_format.py
**èŒè´£**: åŠ¨æ€ç”Ÿæˆå’Œè§£æé¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸?

**æ”¯æŒçš„æ ¼å¼?*:
- `xyznuv` - é™æ€æ¨¡å‹ï¼ˆ32 å­—èŠ‚/é¡¶ç‚¹ï¼?
- `xyznuviiiww` - è’™çš®æ¨¡å‹ï¼?9 å­—èŠ‚/é¡¶ç‚¹ï¼?
- `xyznuvtb` - å¸¦åˆ‡çº¿æ¨¡å‹ï¼ˆ32 å­—èŠ‚/é¡¶ç‚¹ï¼?
- `xyznuvtbiiiww` - è’™çš®+åˆ‡çº¿æ¨¡å‹ï¼?7 å­—èŠ‚/é¡¶ç‚¹ï¼?

---

### 2.2.3 UI æ¨¡å— (ui/)

#### export_panel.py
**èŒè´£**: Fileâ†’Export èœå•çš„å¯¼å‡ºå¯¹è¯æ¡†

**åŠŸèƒ½**:
- é€‰æ‹©å¯¼å‡ºè·¯å¾„
- é€‰æ‹©å¯¼å‡ºç±»å‹ï¼ˆé™æ€?è’™çš®/è§’è‰²åŠ¨ç”»ï¼?
- é…ç½®å¯¼å‡ºé€‰é¡¹

#### object_panel.py
**èŒè´£**: N é¢æ¿ä¸­çš„å¯¹è±¡å±æ€§è®¾ç½?

**åŠŸèƒ½**:
- è®¾ç½®å¯¹è±¡å¯¼å‡ºç±»å‹
- é…ç½®èµ„æº ID
- ç®¡ç†å¯¹è±¡çº§åˆ«çš„å¯¼å‡ºé€‰é¡¹

#### preferences_panel.py
**èŒè´£**: æ’ä»¶åå¥½è®¾ç½®é¢æ¿

**åŠŸèƒ½**:
- è®¾ç½®å¯¼å‡ºæ ¹ç›®å½?
- è®¾ç½®çº¹ç†æ ¹ç›®å½?
- é…ç½®å…¨å±€å¯¼å‡ºé€‰é¡¹

---

### 2.2.4 æ–‡ä»¶å†™å…¥å™?(writers/)

#### primitives_writer.py
**èŒè´£**: å†™å…¥ `.primitives` å‡ ä½•æ–‡ä»¶

**æ ¼å¼**: BinSectionï¼ˆäºŒè¿›åˆ¶ï¼?

**å†…å®¹**:
- é¡¶ç‚¹æ•°æ®ï¼ˆä½ç½®ã€æ³•çº¿ã€UVï¼?
- ç´¢å¼•æ•°æ®
- è’™çš®æ•°æ®ï¼ˆéª¨éª¼ç´¢å¼•ã€æƒé‡ï¼‰
- PrimitiveGroup åˆ†ç»„ä¿¡æ¯

#### visual_writer.py
**èŒè´£**: å†™å…¥ `.visual` è§†è§‰æ–‡ä»¶

**æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**å†…å®¹**:
- RenderSet æ¸²æŸ“é›?
- æè´¨ç»‘å®š
- åŒ…å›´ç›?
- éª¨éª¼å±‚çº§ï¼ˆå¦‚æœæœ‰ï¼?

#### model_writer.py
**èŒè´£**: å†™å…¥ `.model` æ¨¡å‹æ–‡ä»¶

**æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**å†…å®¹**:
- Visual å¼•ç”¨
- åŠ¨ç”»å¼•ç”¨
- Parent ç»§æ‰¿
- Extent èŒƒå›´

#### animation_writer.py
**èŒè´£**: å†™å…¥ `.animation` åŠ¨ç”»æ–‡ä»¶

**æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**å†…å®¹**:
- éª¨éª¼é€šé“
- å…³é”®å¸§æ•°æ®ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰
- åŠ¨ç”»æ—¶é•¿å’Œå¸§ç?

---

## 2.3 è°ƒç”¨å…³ç³»

### å¯¼å‡ºæµç¨‹è°ƒç”¨é“?

```
ç”¨æˆ·æ“ä½œ
    â†?
BigWorldExportOperator.execute()
    â†?
ExportProcessor.process_object()
    â†?
ExportDispatcher.dispatch()
    â”œâ”€â†?_export_static()        # é™æ€æ¨¡å?
    â”œâ”€â†?_export_skinned()        # è’™çš®æ¨¡å‹
    â””â”€â†?_export_character()      # è§’è‰²åŠ¨ç”»
        â†?
export_builders.py
    â”œâ”€â†?PrimitivesBuilder.build()
    â”œâ”€â†?VisualBuilder.build()
    â”œâ”€â†?ModelBuilder.build()
    â”œâ”€â†?SkeletonBuilder.build()
    â””â”€â†?AnimationBuilder.build()
        â†?
writers/
    â”œâ”€â†?primitives_writer.write()
    â”œâ”€â†?visual_writer.write()
    â”œâ”€â†?model_writer.write()
    â””â”€â†?animation_writer.write()
```

---

## 2.4 æ•°æ®æµå‘

```
Blender åœºæ™¯æ•°æ®
    â†?
[æ•°æ®æå–] export_builders.py
    â”œâ”€ å‡ ä½•æ•°æ® â†?Primitives
    â”œâ”€ æè´¨æ•°æ® â†?Visual
    â”œâ”€ éª¨éª¼æ•°æ® â†?Skeleton
    â””â”€ åŠ¨ç”»æ•°æ® â†?Animation
    â†?
[åæ ‡è½¬æ¢] coordinate_converter.py
    â”œâ”€ é¡¶ç‚¹ä½ç½®è½¬æ¢
    â”œâ”€ æ³•çº¿è½¬æ¢
    â”œâ”€ éª¨éª¼çŸ©é˜µè½¬æ¢
    â””â”€ åŠ¨ç”»å…³é”®å¸§è½¬æ?
    â†?
[æ•°æ®éªŒè¯] validator.py
    â”œâ”€ éª¨éª¼ç´¢å¼•èŒƒå›´æ£€æŸ?
    â”œâ”€ æƒé‡å½’ä¸€åŒ–æ£€æŸ?
    â””â”€ æ•°æ®å®Œæ•´æ€§æ£€æŸ?
    â†?
[æ–‡ä»¶å†™å…¥] writers/
    â”œâ”€ .primitivesï¼ˆBinSectionï¼?
    â”œâ”€ .visualï¼ˆPackedSectionï¼?
    â”œâ”€ .modelï¼ˆPackedSectionï¼?
    â””â”€ .animationï¼ˆPackedSectionï¼?
    â†?
BigWorld å¼•æ“æ–‡ä»¶
```

---


# ç¬¬ä¸‰ç« ï¼šUIè®¾è®¡è§„èŒƒ

## 3.1 æ’ä»¶åå¥½è®¾ç½®ï¼ˆå…¨å±€è®¾ç½®ï¼?

**ä½ç½®**: Edit â†?Preferences â†?Add-ons â†?BigWorld Exporter

**åŠŸèƒ½è¯´æ˜**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?BigWorld æ’ä»¶å…¨å±€è®¾ç½®                                       â”?
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?å¯¼å‡ºæ ¹ç›®å½•ï¼š [è·¯å¾„] [ğŸ“]              âœ?å·²å®ç?             â”?
â”?çº¹ç†æ ¹ç›®å½•ï¼š [è·¯å¾„] [ğŸ“]              âœ?å·²å®ç?             â”?
â”?åæ ‡ç³»è½¬æ¢ï¼š (Z-up â†?Y-up)            âœ?å·²å®ç?             â”?
â”?å•ä½ï¼?(ç±?å˜ç±³) ä¸‹æ‹‰æ¡?              âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?[âœ”] å¯¼å‡ºå‰è‡ªåŠ¨æ£€æµ?                  âœ?å·²å®ç?             â”?
â”?[âœ”] å†™å…¥å®¡è®¡æ—¥å¿—                     âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?LOD è§„åˆ™æ¨¡æ¿ï¼?ä¸‹æ‹‰æ¡?                â?å¾…å®ç?             â”?
â”?å¯¼å‡ºç»„åˆ schemaï¼?[é»˜è®¤/é€‰æ‹©æ–‡ä»¶]     â?å¾…å®ç?             â”?
â”?ç›®å½•/æ‰“åŒ…ç­–ç•¥ï¼?ä¸‹æ‹‰æ¡?               â?å¾…å®ç?             â”?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
```

**å®ç°çš„å±æ€?*:
- `root_path` (StringProperty) - å¯¼å‡ºæ ¹ç›®å½?
- `texture_root` (StringProperty) - çº¹ç†æ ¹ç›®å½?
- `coordinate_system` (EnumProperty) - åæ ‡ç³»è½¬æ?
- `unit_scale` (EnumProperty) - å•ä½è®¾ç½®
- `enable_validation` (BoolProperty) - å¯¼å‡ºå‰æ£€æµ?
- `enable_audit_log` (BoolProperty) - å®¡è®¡æ—¥å¿—

**æ–‡ä»¶**: `ui/preferences_panel.py`

---

## 3.2 å¯¹è±¡å±æ€§é¢æ¿ï¼ˆNé¢æ¿ï¼?

**ä½ç½®**: 3D Viewport â†?N Panel â†?BigWorld

**åŠŸèƒ½è¯´æ˜**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?BigWorld å¯¹è±¡å±æ€?                                          â”?
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?å¯¼å‡ºç±»å‹ï¼?[é™æ€?è’™çš®/è§’è‰²åŠ¨ç”»]       âœ?å·²å®ç?             â”?
â”?èµ„æºIDï¼?[å¯¹è±¡åç§°]                   âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?æè´¨æ§½ï¼š æè´¨åˆ—è¡¨                     âœ?å·²å®ç?             â”?
â”?BaseColor [è·¯å¾„]                      âœ?å·²å®ç?             â”?
â”?Normal [è·¯å¾„]                         âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?[âœ”] å¯¼å‡ºæ­¤å¯¹è±?                      âœ?å·²å®ç?             â”?
â”?[âœ”] åŒ…å«åŠ¨ç”»                         âœ?å·²å®ç?             â”?
â”?[âœ”] åŒ…å«éª¨éª¼                         âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?ç¡¬ç‚¹ï¼?[æ·»åŠ æŒ‰é’®]                     â?å¾…å®ç?             â”?
â”?åŠ¨ç”»è½¨é“ï¼ˆä»…è§’è‰²ï¼‰ï¼š UIList            â?å¾…å®ç?             â”?
â”?ç¢°æ’ä½“å‚æ•?                           â?å¾…å®ç?             â”?
â”?é—¨æˆ·å‚æ•°                              â?å¾…å®ç?             â”?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
```

**å®ç°çš„å±æ€?*:
- `export_type` (EnumProperty) - å¯¼å‡ºç±»å‹
- `resource_id` (StringProperty) - èµ„æºID
- `export_enabled` (BoolProperty) - æ˜¯å¦å¯¼å‡º
- `include_animations` (BoolProperty) - åŒ…å«åŠ¨ç”»
- `include_skeleton` (BoolProperty) - åŒ…å«éª¨éª¼

**æ–‡ä»¶**: `ui/object_panel.py`

---

## 3.3 å¯¼å‡ºæ‰§è¡Œé¢æ¿ï¼ˆFile â†?Export â†?BigWorldï¼?

**ä½ç½®**: File â†?Export â†?BigWorld

**åŠŸèƒ½è¯´æ˜**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?å¯¼å‡º BigWorld æ–‡ä»¶                                          â”?
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?æ–‡ä»¶è·¯å¾„ï¼?[è·¯å¾„æµè§ˆå™¨]               âœ?å·²å®ç?             â”?
â”?å¯¼å‡ºæ¨¡å¼ï¼?[é€‰ä¸­/å…¨éƒ¨/åœºæ™¯]           âœ?å·²å®ç?             â”?
â”?å¯¼å‡ºç±»å‹ï¼?[é™æ€?è’™çš®/è§’è‰²åŠ¨ç”»]        âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?ç”Ÿæˆæ–‡ä»¶ï¼?                                                 â”?
â”? [âœ”] .primitives                      âœ?å·²å®ç?             â”?
â”? [âœ”] .visual                          âœ?å·²å®ç?             â”?
â”? [âœ”] .model                           âœ?å·²å®ç?             â”?
â”? [âœ”] .animation                       âœ?å·²å®ç?             â”?
â”? [âœ”] manifest.json                    âœ?å·²å®ç?             â”?
â”? [âœ”] audit.log                        âœ?å·²å®ç?             â”?
â”?-----------------------------------------------------------â”?
â”?[å¯¼å‡º] [å–æ¶ˆ]                         âœ?å·²å®ç?             â”?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
```

**å®ç°çš„å±æ€?*:
- `filepath` (StringProperty) - æ–‡ä»¶è·¯å¾„
- `export_mode` (EnumProperty) - å¯¼å‡ºæ¨¡å¼ï¼ˆSELECTED/ALL/SCENEï¼?
- `export_type` (EnumProperty) - å¯¼å‡ºç±»å‹ï¼ˆSTATIC/SKINNED/CHARACTERï¼?
- `export_primitives` (BoolProperty) - å¯¼å‡º.primitives
- `export_visual` (BoolProperty) - å¯¼å‡º.visual
- `export_model` (BoolProperty) - å¯¼å‡º.model
- `export_animation` (BoolProperty) - å¯¼å‡º.animation

**æ–‡ä»¶**: `ui/export_panel.py`, `__init__.py` (BigWorldExportOperator)

---

## 3.4 æ§ä»¶æ˜ å°„è¡¨ï¼ˆ3ds Max â†?Blenderï¼?

ç”¨äºå‚è€ƒæ—§ç‰?3ds Max æ’ä»¶çš?UI è®¾è®¡ï¼?

| åŠŸèƒ½ç±»åˆ« | 3ds Max æ§ä»¶ | Blender æ§ä»¶ | çŠ¶æ€?|
|---------|-------------|-------------|------|
| å¸ƒå°”å¼€å…?| CheckBox | BoolProperty | âœ?|
| ä¸‹æ‹‰é€‰æ‹© | ComboBox | EnumProperty | âœ?|
| æ–‡æœ¬è¾“å…¥ | EditText | StringProperty | âœ?|
| æ•°å€¼è¾“å…?| Spinner | IntProperty/FloatProperty | âœ?|
| æŒ‰é’® | Button | Operator | âœ?|
| é¢œè‰²é€‰æ‹© | ColorSwatch | FloatVectorProperty | â?|
| æ–‡ä»¶é€‰æ‹© | FilePicker | StringProperty(FILE_PATH) | âœ?|
| æ–‡ä»¶å¤¹é€‰æ‹© | FolderPicker | StringProperty(DIR_PATH) | âœ?|
| åˆ—è¡¨ | ListBox/UIList | UIList | â?|

---

# ç¬¬å››ç« ï¼šæ–‡ä»¶æ ¼å¼è§„èŒƒ

## 4.1 .primitives æ ¼å¼

**æ–‡ä»¶æ ¼å¼**: BinSectionï¼ˆäºŒè¿›åˆ¶ï¼?

**ç”¨é€?*: å­˜å‚¨å‡ ä½•ä½“çš„å®é™…é¡¶ç‚¹å’Œç´¢å¼•æ•°æ?

### æ–‡ä»¶ç»“æ„

```
BinSection Header (32 bytes)
â”œâ”€â”€ MagicNumber (4 bytes) - 0x42A14E65
â”œâ”€â”€ Version (4 bytes)
â”œâ”€â”€ IndexTableOffset (4 bytes)
â”œâ”€â”€ ReservedData (16 bytes) - å…¨éƒ¨ä¸?0x00
â””â”€â”€ Padding (4 bytes)

IndexTable
â”œâ”€â”€ NumSections (uint32)
â””â”€â”€ SectionEntries[]
    â”œâ”€â”€ TagLength (uint16)
    â”œâ”€â”€ TagValue (string)
    â”œâ”€â”€ DataType (uint8)
    â”œâ”€â”€ DataOffset (uint32)
    â””â”€â”€ DataLength (uint32)

Data Sections
â”œâ”€â”€ "vertices" - é¡¶ç‚¹æ•°æ®
â”?  â””â”€â”€ VertexData[] (æ ¹æ® vertex_format)
â”œâ”€â”€ "indices" - ç´¢å¼•æ•°æ®
â”?  â””â”€â”€ uint16[] or uint32[]
â””â”€â”€ "primitiveGroup" - åˆ†ç»„ä¿¡æ¯
    â””â”€â”€ PrimitiveGroup[]
```

### é¡¶ç‚¹æ ¼å¼

#### é™æ€æ¨¡å?(xyznuv)
```cpp
struct VertexXYZNUV {
    Vector3  pos;       // ä½ç½® (12 bytes)
    Vector3  normal;    // æ³•çº¿ (12 bytes)
    Vector2  uv;        // UV (8 bytes)
};
// æ€»è®¡: 32 bytes/vertex
```

#### è’™çš®æ¨¡å‹ (xyznuviiiww)
```cpp
struct VertexXYZNUVIIIWW {
    Vector3  pos;       // ä½ç½® (12 bytes)
    uint32   normal;    // æ³•çº¿ (4 bytes, packed)
    Vector2  uv;        // UV (8 bytes)
    uint8    index1;    // éª¨éª¼ç´¢å¼•1 (1 byte)
    uint8    index2;    // éª¨éª¼ç´¢å¼•2 (1 byte)
    uint8    index3;    // éª¨éª¼ç´¢å¼•3 (1 byte)
    uint8    weight1;   // æƒé‡1 (1 byte, 0-255)
    uint8    weight2;   // æƒé‡2 (1 byte, 0-255)
};
// æ€»è®¡: 29 bytes/vertex
```

### Packed Normal æ ¼å¼

**ä½å¸ƒå±€** (uint32):
```
ä½?31-22: Z åˆ†é‡ (10ä½? 0-511)
ä½?21-11: Y åˆ†é‡ (11ä½? 0-1023)
ä½?10-0:  X åˆ†é‡ (11ä½? 0-1023)
```

**BigWorld å®˜æ–¹å®ç°**:
```cpp
inline uint32 packNormal(const Vector3& n) {
    return ((uint32)(n.z * 511.0f) & 0x3ff) << 22 |
           ((uint32)(n.y * 1023.0f) & 0x7ff) << 11 |
           ((uint32)(n.x * 1023.0f) & 0x7ff);
}
```

---

## 4.2 .visual æ ¼å¼

**æ–‡ä»¶æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**ç”¨é€?*: å®šä¹‰å¦‚ä½•æ¸²æŸ“æ¨¡å‹ï¼ˆæè´¨ã€åŒ…å›´ç›’ã€éª¨éª¼å±‚çº§ï¼‰

### æ–‡ä»¶ç»“æ„

```xml
<root>
  <renderSet>
    <geometry> xxx.primitives/vertices </geometry>
    <node> xxx.primitives </node>
    <primitiveGroup> 0 </primitiveGroup>
    <material>
      <identifier> xxx.mfm </identifier>
      <property>
        <TextureFactor> æè´¨æ–‡ä»¶è·¯å¾„ </TextureFactor>
      </property>
    </material>
  </renderSet>
  
  <boundingBox>
    <min> x y z </min>
    <max> x y z </max>
  </boundingBox>
  
  <!-- é™æ€æ¨¡å‹æ— æ­¤èŠ‚ç‚¹ï¼Œè’™çš®æ¨¡å‹æœ‰å®Œæ•´éª¨éª¼å±‚çº?-->
  <node>
    <identifier> Scene Root </identifier>
    <transform> 4x3 çŸ©é˜µ </transform>
    <node>
      <identifier> biped </identifier>
      <transform> 4x3 çŸ©é˜µ </transform>
      <!-- é€’å½’åµŒå¥—å­éª¨éª?-->
    </node>
  </node>
</root>
```

### Visual ç±»å‹

1. **nodelessVisual** - é™æ€æ¨¡å‹ï¼ˆæ— éª¨éª¼èŠ‚ç‚¹ï¼‰
2. **nodefullVisual** - è’™çš®æ¨¡å‹ï¼ˆåŒ…å«å®Œæ•´éª¨éª¼å±‚çº§ï¼‰

---

## 4.3 .model æ ¼å¼

**æ–‡ä»¶æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**ç”¨é€?*: å®šä¹‰æ¨¡å‹çš„è¡Œä¸ºå’Œå…³ç³»ï¼ˆVisualå¼•ç”¨ã€åŠ¨ç”»å¼•ç”¨ã€ç»§æ‰¿å…³ç³»ï¼‰

### æ–‡ä»¶ç»“æ„

```xml
<root>
  <!-- å¯é€‰ï¼šç»§æ‰¿çˆ¶æ¨¡å?-->
  <parent> base </parent>
  
  <!-- å¿…é¡»ï¼šVisualæ–‡ä»¶å¼•ç”¨ -->
  <nodefullVisual> character_body </nodefullVisual>
  <!-- æˆ?-->
  <nodelessVisual> static_object </nodelessVisual>
  
  <!-- å¿…é¡»ï¼šæ¨¡å‹èŒƒå›?-->
  <extent> 100.0 </extent>
  
  <!-- å¿…é¡»ï¼šåŒ…å›´ç›’ -->
  <boundingBox>
    <min> x y z </min>
    <max> x y z </max>
  </boundingBox>
  
  <!-- å¯é€‰ï¼šåŠ¨ç”»å¼•ç”¨ -->
  <animation>
    <name> walk </name>
    <nodes> animations/walk </nodes>
  </animation>
  
  <!-- å¯é€‰ï¼šæè´¨æ›¿æ¢ -->
  <dye>
    <matter> body </matter>
    <tint> 1.0 1.0 1.0 1.0 </tint>
  </dye>
</root>
```

---

## 4.4 .animation æ ¼å¼

**æ–‡ä»¶æ ¼å¼**: PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼?

**ç”¨é€?*: å­˜å‚¨éª¨éª¼åŠ¨ç”»çš„å…³é”®å¸§æ•°æ®

### æ–‡ä»¶ç»“æ„

```xml
<root>
  <nodes>
    <!-- éª¨éª¼é€šé“ -->
    <node>
      <identifier> biped </identifier>
      
      <!-- ä½ç½®å…³é”®å¸?-->
      <translations>
        <key>
          <time> 0.0 </time>
          <value> x y z </value>
        </key>
      </translations>
      
      <!-- æ—‹è½¬å…³é”®å¸§ï¼ˆå››å…ƒæ•°ï¼‰ -->
      <rotations>
        <key>
          <time> 0.0 </time>
          <value> x y z w </value>
        </key>
      </rotations>
      
      <!-- ç¼©æ”¾å…³é”®å¸?-->
      <scales>
        <key>
          <time> 0.0 </time>
          <value> x y z </value>
        </key>
      </scales>
    </node>
  </nodes>
</root>
```

---

## 4.5 é¡¶ç‚¹æ ¼å¼è¯¦è§£

### æ”¯æŒçš„é¡¶ç‚¹æ ¼å¼?

| æ ¼å¼ | æè¿° | å­—èŠ‚/é¡¶ç‚¹ | ç”¨é€?|
|------|------|----------|------|
| `xyz` | ä½ç½® | 12 | åŸºç¡€ |
| `xyznuv` | ä½ç½®+æ³•çº¿+UV | 32 | é™æ€æ¨¡å?|
| `xyznuvtb` | ä½ç½®+æ³•çº¿+UV+åˆ‡çº¿ | 32 | å¸¦æ³•çº¿è´´å›?|
| `xyznuviiiww` | ä½ç½®+æ³•çº¿+UV+è’™çš® | 29 | è’™çš®æ¨¡å‹ |
| `xyznuvtbiiiww` | ä½ç½®+æ³•çº¿+UV+åˆ‡çº¿+è’™çš® | 37 | è’™çš®+æ³•çº¿è´´å›¾ |

### æ ¼å¼ç»„æˆéƒ¨åˆ†

- `xyz` - ä½ç½® (Vector3, 12 bytes)
- `n` - æ³•çº¿ (Vector3 æˆ?packed uint32)
- `uv` - UVåæ ‡ (Vector2, 8 bytes)
- `tb` - åˆ‡çº¿+å‰¯åˆ‡çº?(2Ã— packed uint32, 8 bytes)
- `iiiww` - è’™çš®æ•°æ® (3Ã— uint8 ç´¢å¼• + 2Ã— uint8 æƒé‡, 5 bytes)
- `c` - é¡¶ç‚¹é¢œè‰² (4Ã— float, 16 bytes)

### åŠ¨æ€æ ¼å¼ç”Ÿæˆ?

æ’ä»¶æ ¹æ®æ¨¡å‹ç‰¹å¾è‡ªåŠ¨ç”Ÿæˆé¡¶ç‚¹æ ¼å¼ï¼?

```python
def build_vertex_format(has_normals, has_uv, has_tangent, has_skin, has_color):
    fmt = 'xyz'
    if has_normals:
        fmt += 'n'
    if has_uv:
        fmt += 'uv'
    if has_tangent:
        fmt += 'tb'
    if has_color:
        fmt += 'c'
    if has_skin:
        fmt += 'iiiww'
    return fmt
```

---


# ç¬¬äº”ç« ï¼šæŠ€æœ¯å®ç°ç»†èŠ?

## 5.1 åæ ‡ç³»è½¬æ?

### 5.1.1 åæ ‡ç³»å·®å¼?

**Blender åæ ‡ç³?*:
- Z-upï¼ˆZè½´å‘ä¸Šï¼‰
- å³æ‰‹åæ ‡ç³?
- å•ä½ï¼šBlender Units

**BigWorld åæ ‡ç³?*:
- Y-upï¼ˆYè½´å‘ä¸Šï¼‰
- å³æ‰‹åæ ‡ç³?
- å•ä½ï¼šç±³ï¼ˆMetersï¼?

### 5.1.2 è½¬æ¢çŸ©é˜µ

**å®ç°ä½ç½®**: `core/coordinate_converter.py`

```python
CONVERSION_MATRIX = [
    [1,  0,  0],
    [0,  0,  1],
    [0, -1,  0]
]
```

**è½¬æ¢åŸç†**: ç»?X è½´æ—‹è½?-90 åº?

### 5.1.3 è½¬æ¢åº”ç”¨

**å·²åº”ç”¨çš„è½¬æ¢**:
- âœ?é¡¶ç‚¹ä½ç½®è½¬æ¢ (`convert_position`)
- âœ?æ³•çº¿è½¬æ¢ (`convert_normal`)
- âœ?éª¨éª¼çŸ©é˜µè½¬æ¢ (`convert_matrix`)
- âœ?åŠ¨ç”»å…³é”®å¸§è½¬æ¢ï¼ˆä½ç½®ï¼?
- âœ?åŠ¨ç”»å…³é”®å¸§è½¬æ¢ï¼ˆæ—‹è½¬ - `convert_quaternion`ï¼?

---

## 5.2 é¡¶ç‚¹æ ¼å¼ç³»ç»Ÿ

### 5.2.1 åŠ¨æ€æ ¼å¼ç”Ÿæˆ?

**å®ç°ä½ç½®**: `core/vertex_format.py`

```python
def build_vertex_format(has_normals, has_uv, has_tangent, has_skin, has_color):
    """
    æ ¹æ®æ¨¡å‹ç‰¹å¾åŠ¨æ€ç”Ÿæˆé¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸²
    
    å‚æ•°:
        has_normals: æ˜¯å¦æœ‰æ³•çº?
        has_uv: æ˜¯å¦æœ‰UV
        has_tangent: æ˜¯å¦æœ‰åˆ‡çº?å‰¯åˆ‡çº?
        has_skin: æ˜¯å¦æœ‰è’™çš®æ•°æ?
        has_color: æ˜¯å¦æœ‰é¡¶ç‚¹é¢œè‰?
    
    è¿”å›:
        é¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¦?"xyznuv", "xyznuviiiww" ç­?
    """
    fmt = 'xyz'  # ä½ç½®æ€»æ˜¯å¿…é¡»çš?
    
    if has_normals:
        fmt += 'n'
    if has_uv:
        fmt += 'uv'
    if has_tangent:
        fmt += 'tb'  # tangent + binormal
    if has_color:
        fmt += 'c'
    if has_skin:
        fmt += 'iiiww'  # 3 indices + 2 weights
    
    return fmt
```

### 5.2.2 é¡¶ç‚¹æ­¥é•¿è®¡ç®—

```python
def get_vertex_stride(vertex_format: str) -> int:
    """
    è®¡ç®—é¡¶ç‚¹æ ¼å¼çš„å­—èŠ‚æ­¥é•?
    
    å‚æ•°:
        vertex_format: é¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸?
    
    è¿”å›:
        æ¯ä¸ªé¡¶ç‚¹çš„å­—èŠ‚æ•°
    """
    stride = 0
    
    # è§£ææ ¼å¼å­—ç¬¦ä¸?
    if 'xyz' in vertex_format:
        stride += 12  # Vector3 (3 * 4 bytes)
    
    if 'n' in vertex_format:
        if 'tb' in vertex_format:
            # æœ‰åˆ‡çº¿æ—¶ä½¿ç”¨ packed normal
            stride += 4  # packed uint32
        else:
            # é™æ€æ¨¡å‹ä½¿ç”?Vector3 normal
            stride += 12  # Vector3 (3 * 4 bytes)
    
    if 'uv' in vertex_format:
        stride += 8  # Vector2 (2 * 4 bytes)
    
    if 'tb' in vertex_format:
        stride += 8  # 2 * packed uint32
    
    if 'c' in vertex_format:
        stride += 16  # 4 * float (RGBA)
    
    if 'iiiww' in vertex_format:
        stride += 5  # 3 * uint8 (indices) + 2 * uint8 (weights)
    
    return stride
```

---

## 5.3 Packed Normal æ ¼å¼

### 5.3.1 æ ¼å¼è¯´æ˜

**ç”¨é€?*: å‹ç¼©æ³•çº¿/åˆ‡çº¿/å‰¯åˆ‡çº¿æ•°æ®ï¼Œä»?12 å­—èŠ‚ï¼ˆVector3ï¼‰å‹ç¼©åˆ° 4 å­—èŠ‚ï¼ˆuint32ï¼?

**ä½å¸ƒå±€**:
```
uint32 (32 ä½?:
â”œâ”€â”€ ä½?31-22: Z åˆ†é‡ (10ä½? èŒƒå›´ 0-511)
â”œâ”€â”€ ä½?21-11: Y åˆ†é‡ (11ä½? èŒƒå›´ 0-1023)
â””â”€â”€ ä½?10-0:  X åˆ†é‡ (11ä½? èŒƒå›´ 0-1023)
```

### 5.3.2 BigWorld å®˜æ–¹å®ç°

**æºæ–‡ä»?*: `moo_math.hpp`

```cpp
inline uint32 packNormal(const Vector3& nn) {
    Vector3 n = nn;
    n.normalise();
    
    n.x = Math::clamp(-1.f, n.x, 1.f);
    n.y = Math::clamp(-1.f, n.y, 1.f);
    n.z = Math::clamp(-1.f, n.z, 1.f);
    
    return  ((uint32)(n.z * 511.0f) & 0x3ff) << 22 |
            ((uint32)(n.y * 1023.0f) & 0x7ff) << 11 |
            ((uint32)(n.x * 1023.0f) & 0x7ff);
}
```

### 5.3.3 æ’ä»¶å®ç°

**å®ç°ä½ç½®**: `core/bin_section_writer.py`

```python
def write_packed_normal(self, v: tuple) -> None:
    """
    å†™å…¥ packed æ³•çº¿/åˆ‡çº¿ï¼ˆuint32ï¼?1-11-10ä½ï¼‰
    
    å‚æ•°:
        v: (x, y, z) æ³•çº¿å‘é‡
    """
    import math
    
    # å½’ä¸€åŒ–å¹¶ clamp åˆ?[-1, 1]
    length = math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2])
    if length > 0.0001:
        nx = max(-1.0, min(1.0, v[0] / length))
        ny = max(-1.0, min(1.0, v[1] / length))
        nz = max(-1.0, min(1.0, v[2] / length))
    else:
        nx, ny, nz = 0.0, 0.0, 1.0
    
    # æŒ‰ç…§ BigWorld æºç çš„æ–¹å¼ï¼šç›´æ¥ä¹˜ä»¥ 511/1023
    x_packed = int(nx * 1023.0) & 0x7ff  # 11ä½æ©ç ?
    y_packed = int(ny * 1023.0) & 0x7ff  # 11ä½æ©ç ?
    z_packed = int(nz * 511.0) & 0x3ff   # 10ä½æ©ç ?
    
    # æ‰“åŒ…æˆ?uint32 (11-11-10ä½æ ¼å¼?
    packed = (z_packed << 22) | (y_packed << 11) | x_packed
    
    self.write_uint32(packed)
```

---

## 5.4 è’™çš®æ•°æ®å¤„ç†

### 5.4.1 æ•°æ®æ ¼å¼

**BigWorld æ ¼å¼** (iiiww):
```
3 ä¸ªéª¨éª¼ç´¢å¼?(uint8):
â”œâ”€â”€ index1 (1 byte, 0-255)
â”œâ”€â”€ index2 (1 byte, 0-255)
â””â”€â”€ index3 (1 byte, 0-255)

2 ä¸ªéª¨éª¼æƒé‡?(uint8):
â”œâ”€â”€ weight1 (1 byte, 0-255 è¡¨ç¤º 0%-100%)
â””â”€â”€ weight2 (1 byte, 0-255 è¡¨ç¤º 0%-100%)

æ³¨æ„ï¼šç¬¬3ä¸ªæƒé‡éšå«è®¡ç®?= 255 - weight1 - weight2
```

### 5.4.2 æ•°æ®æå–

**å®ç°ä½ç½®**: `export_builders.py` - `PrimitivesBuilder._get_vertex_weights()`

```python
def _get_vertex_weights(self, mesh_obj, bone_names):
    """
    ä»?Blender å¯¹è±¡æå–é¡¶ç‚¹æƒé‡æ•°æ®
    
    è¿”å›:
        bone_indices: List[List[int]] - æ¯ä¸ªé¡¶ç‚¹çš?ä¸ªéª¨éª¼ç´¢å¼?
        bone_weights: List[List[int]] - æ¯ä¸ªé¡¶ç‚¹çš?ä¸ªæƒé‡å€?0-255)
    """
    # æå– Blender çš„é¡¶ç‚¹ç»„æƒé‡
    vertex_groups = mesh_obj.vertex_groups
    
    bone_indices = []
    bone_weights = []
    
    for vertex in mesh_obj.data.vertices:
        # è·å–è¯¥é¡¶ç‚¹çš„æ‰€æœ‰æƒé‡?
        weights_data = []
        for group in vertex.groups:
            group_name = vertex_groups[group.group].name
            if group_name in bone_names:
                bone_idx = bone_names.index(group_name)
                weight = group.weight
                weights_data.append((bone_idx, weight))
        
        # æ’åºå¹¶å–æƒé‡æœ€å¤§çš„3ä¸?
        weights_data.sort(key=lambda x: x[1], reverse=True)
        weights_data = weights_data[:3]
        
        # å½’ä¸€åŒ–æƒé‡?
        total_weight = sum(w[1] for w in weights_data)
        if total_weight > 0:
            weights_data = [(idx, w/total_weight) for idx, w in weights_data]
        
        # è¡¥é½åˆ?ä¸ªç´¢å¼•å’Œ2ä¸ªæƒé‡?
        while len(weights_data) < 3:
            weights_data.append((0, 0.0))  # å¡«å……æ ¹éª¨éª?
        
        # è½¬æ¢ä¸?uint8 æ ¼å¼
        indices = [w[0] for w in weights_data]
        weights = [int(weights_data[i][1] * 255.0) for i in range(2)]
        
        bone_indices.append(indices)
        bone_weights.append(weights)
    
    return bone_indices, bone_weights
```

### 5.4.3 éª¨éª¼ç´¢å¼•éªŒè¯

**é—®é¢˜**: BigWorld åªæ”¯æŒ?0-255 çš„éª¨éª¼ç´¢å¼•ï¼ˆuint8ï¼?

**è§£å†³æ–¹æ¡ˆ**:
```python
# éª¨éª¼ç´¢å¼•èŒƒå›´éªŒè¯
for j in range(3):
    bone_idx = int(indices[j])
    if bone_idx < 0:
        safe_index = 0  # æ— æ•ˆç´¢å¼•æ˜ å°„åˆ°æ ¹éª¨éª¼
    elif bone_idx > 255:
        safe_index = 0  # è¶…èŒƒå›´ç´¢å¼•æ˜ å°„åˆ°æ ¹éª¨éª?
        print(f"WARNING: éª¨éª¼ç´¢å¼• {bone_idx} è¶…å‡ºèŒƒå›´(0-255)ï¼Œæ˜ å°„åˆ°æ ¹éª¨éª?)
    else:
        safe_index = bone_idx
    bw.write_byte(safe_index)
```

---

## 5.5 éª¨éª¼å±‚çº§ç³»ç»Ÿ

### 5.5.1 æ•°æ®ç»“æ„

**å®ç°ä½ç½®**: `core/schema.py`

```python
@dataclass
class SkeletonBone:
    """éª¨éª¼èŠ‚ç‚¹"""
    name: str                      # éª¨éª¼åç§°
    parent_name: Optional[str]     # çˆ¶éª¨éª¼åç§?
    bind_matrix: List[List[float]] # ç»‘å®šçŸ©é˜µ (4x3)
    children: List['SkeletonBone'] # å­éª¨éª¼åˆ—è¡?

@dataclass
class Skeleton:
    """éª¨éª¼å±‚çº§ç»“æ„"""
    bones: List[SkeletonBone]      # æ‰€æœ‰éª¨éª¼ï¼ˆæ‰å¹³åˆ—è¡¨ï¼?
    bone_names: List[str]          # éª¨éª¼åç§°åˆ—è¡¨
    root_bones: List[SkeletonBone] # æ ¹éª¨éª¼åˆ—è¡¨ï¼ˆç”¨äºé€’å½’ï¼?
```

### 5.5.2 éª¨éª¼æ•°æ®æå–

**å®ç°ä½ç½®**: `export_builders.py` - `SkeletonBuilder.build()`

```python
def build(self, armature_obj):
    """
    æ„å»ºéª¨éª¼å±‚çº§æ•°æ®
    
    å‚æ•°:
        armature_obj: Blender éª¨æ¶å¯¹è±¡
    
    è¿”å›:
        Skeleton å¯¹è±¡
    """
    bones = []
    bone_names = []
    
    # 1. æ”¶é›†æ‰€æœ‰éª¨éª?
    for bone in armature_obj.data.bones:
        bone_names.append(bone.name)
        
        # è®¡ç®—ç»‘å®šçŸ©é˜µï¼ˆå±€éƒ¨çŸ©é˜µï¼‰
        bind_matrix = self._get_bone_local_matrix(bone, armature_obj)
        
        bones.append(SkeletonBone(
            name=bone.name,
            parent_name=bone.parent.name if bone.parent else None,
            bind_matrix=bind_matrix,
            children=[]
        ))
    
    # 2. æ„å»ºå±‚çº§å…³ç³»
    bone_dict = {b.name: b for b in bones}
    root_bones = []
    
    for bone in bones:
        if bone.parent_name:
            parent = bone_dict[bone.parent_name]
            parent.children.append(bone)
        else:
            root_bones.append(bone)
    
    return Skeleton(
        bones=bones,
        bone_names=bone_names,
        root_bones=root_bones
    )
```

### 5.5.3 éª¨éª¼å±‚çº§å†™å…¥

**å®ç°ä½ç½®**: `writers/visual_writer.py`

```python
def _write_skeleton_hierarchy(self, skeleton: Skeleton):
    """å†™å…¥å®Œæ•´çš„éª¨éª¼å±‚çº§ç»“æ?""
    
    self.xml.start_node("node")
    self.xml.write_string("identifier", "Scene Root")
    
    # é€’å½’å†™å…¥æ‰€æœ‰æ ¹éª¨éª¼
    for root_bone in skeleton.root_bones:
        self._write_bone_node(root_bone)
    
    self.xml.end_node()  # node

def _write_bone_node(self, bone: SkeletonBone):
    """é€’å½’å†™å…¥éª¨éª¼èŠ‚ç‚¹"""
    
    self.xml.start_node("node")
    self.xml.write_string("identifier", bone.name)
    
    # å†™å…¥å˜æ¢çŸ©é˜µ (4x3)
    self.xml.start_node("transform")
    for row in bone.bind_matrix:
        self.xml.write_string("row", " ".join(str(v) for v in row))
    self.xml.end_node()
    
    # é€’å½’å†™å…¥å­éª¨éª?
    for child in bone.children:
        self._write_bone_node(child)
    
    self.xml.end_node()  # node
```

**ç”Ÿæˆçš„ç»“æ?*:
```xml
<node>
  <identifier> Scene Root </identifier>
  <transform>...</transform>
  <node>
    <identifier> biped </identifier>
    <transform>...</transform>
    <node>
      <identifier> biped..Spine </identifier>
      <transform>...</transform>
      <!-- é€’å½’åµŒå¥—... -->
    </node>
  </node>
</node>
```

---


# ç¬¬å…­ç« ï¼šå¯¼å‡ºæµç¨‹

## 6.1 é™æ€æ¨¡å‹å¯¼å‡?

### 6.1.1 æµç¨‹æ¦‚è¿°

```
ç”¨æˆ·é€‰æ‹©é™æ€æ¨¡å‹å¯¼å‡?
    â†?
ExportDispatcher._export_static()
    â†?
â”œâ”€ PrimitivesBuilder.build(force_static=True)
â”? â””â”€ ç”Ÿæˆå‡ ä½•æ•°æ®ï¼ˆxyznuvæ ¼å¼ï¼Œæ— è’™çš®ï¼?
â”?
â”œâ”€ VisualBuilder.build()
â”? â””â”€ ç”Ÿæˆè§†è§‰æ•°æ®ï¼ˆnodelessVisualï¼Œæ— éª¨éª¼ï¼?
â”?
â””â”€ ModelBuilder.build()
   â””â”€ ç”Ÿæˆæ¨¡å‹æ•°æ®
       â†?
writers/
â”œâ”€ primitives_writer.write() â†?xxx.primitives
â”œâ”€ visual_writer.write()     â†?xxx.visual
â””â”€ model_writer.write()      â†?xxx.model
```

### 6.1.2 å…³é”®ç‚?

**é¡¶ç‚¹æ ¼å¼**: `xyznuv`
- ä½ç½® (Vector3, 12 bytes)
- æ³•çº¿ (Vector3, 12 bytes) â†?æ³¨æ„ï¼šé™æ€æ¨¡å‹ä½¿ç”¨Vector3ï¼Œä¸æ˜¯packed
- UV (Vector2, 8 bytes)
- æ€»è®¡ï¼?2 bytes/vertex

**Visualç±»å‹**: `nodelessVisual`ï¼ˆæ— éª¨éª¼èŠ‚ç‚¹ï¼?

**ç”Ÿæˆæ–‡ä»¶**:
- `{resource_id}.primitives`
- `{resource_id}.visual`
- `{resource_id}.model`

---

## 6.2 è’™çš®æ¨¡å‹å¯¼å‡º

### 6.2.1 æµç¨‹æ¦‚è¿°

```
ç”¨æˆ·é€‰æ‹©è’™çš®æ¨¡å‹å¯¼å‡º
    â†?
ExportDispatcher._export_skinned()
    â†?
â”œâ”€ SkeletonBuilder.build()
â”? â””â”€ ç”Ÿæˆå®Œæ•´éª¨éª¼å±‚çº§ç»“æ„
â”?
â”œâ”€ PrimitivesBuilder.build()
â”? â””â”€ ç”Ÿæˆå‡ ä½•+è’™çš®æ•°æ®ï¼ˆxyznuviiiwwæ ¼å¼ï¼?
â”?
â”œâ”€ VisualBuilder.build(skeleton)
â”? â””â”€ ç”Ÿæˆè§†è§‰+éª¨éª¼æ•°æ®ï¼ˆnodefullVisualï¼?
â”?
â””â”€ ModelBuilder.build()
   â””â”€ ç”Ÿæˆæ¨¡å‹æ•°æ®
       â†?
writers/
â”œâ”€ primitives_writer.write() â†?xxx.primitivesï¼ˆå«è’™çš®ï¼?
â”œâ”€ visual_writer.write()     â†?xxx.visualï¼ˆå«éª¨éª¼å±‚çº§ï¼?
â””â”€ model_writer.write()      â†?xxx.model
```

### 6.2.2 å…³é”®ç‚?

**é¡¶ç‚¹æ ¼å¼**: `xyznuviiiww`
- ä½ç½® (Vector3, 12 bytes)
- æ³•çº¿ (packed uint32, 4 bytes) â†?æ³¨æ„ï¼šè’™çš®æ¨¡å‹ä½¿ç”¨packed
- UV (Vector2, 8 bytes)
- éª¨éª¼ç´¢å¼•1-3 (3Ã— uint8, 3 bytes)
- éª¨éª¼æƒé‡1-2 (2Ã— uint8, 2 bytes)
- æ€»è®¡ï¼?9 bytes/vertex

**Visualç±»å‹**: `nodefullVisual`ï¼ˆåŒ…å«å®Œæ•´éª¨éª¼å±‚çº§ï¼‰

**éª¨éª¼é™åˆ¶**: æœ€å¤?55æ ¹éª¨éª¼ï¼ˆuint8èŒƒå›´ï¼?

**ç”Ÿæˆæ–‡ä»¶**:
- `{resource_id}.primitives`ï¼ˆå«è’™çš®æ•°æ®ï¼?
- `{resource_id}.visual`ï¼ˆå«éª¨éª¼èŠ‚ç‚¹ï¼?
- `{resource_id}.model`

---

## 6.3 è§’è‰²åŠ¨ç”»å¯¼å‡º

### 6.3.1 æµç¨‹æ¦‚è¿°

```
ç”¨æˆ·é€‰æ‹©è§’è‰²åŠ¨ç”»å¯¼å‡º
    â†?
ExportDispatcher._export_character()
    â†?
â”œâ”€ SkeletonBuilder.build()
â”? â””â”€ ç”Ÿæˆå®Œæ•´éª¨éª¼å±‚çº§ç»“æ„
â”?
â”œâ”€ PrimitivesBuilder.build()
â”? â””â”€ ç”Ÿæˆå‡ ä½•+è’™çš®æ•°æ®ï¼ˆxyznuviiiwwæ ¼å¼ï¼?
â”?
â”œâ”€ VisualBuilder.build(skeleton)
â”? â””â”€ ç”Ÿæˆè§†è§‰+éª¨éª¼æ•°æ®ï¼ˆnodefullVisualï¼?
â”?
â”œâ”€ AnimationBuilder.build()
â”? â””â”€ ç”Ÿæˆæ‰€æœ‰åŠ¨ç”»æ•°æ?
â”?    â””â”€ é‡‡æ ·æ¯ä¸ªActionçš„å…³é”®å¸§
â”?
â””â”€ ModelBuilder.build(animations)
   â””â”€ ç”Ÿæˆæ¨¡å‹+åŠ¨ç”»å¼•ç”¨æ•°æ®
       â†?
writers/
â”œâ”€ primitives_writer.write() â†?xxx.primitives
â”œâ”€ visual_writer.write()     â†?xxx.visual
â”œâ”€ animation_writer.write()  â†?animations/xxx.animationï¼ˆæ‰¹é‡ï¼‰
â””â”€ model_writer.write()      â†?xxx.modelï¼ˆå«åŠ¨ç”»å¼•ç”¨ï¼?
```

### 6.3.2 å…³é”®ç‚?

**åŠ¨ç”»æ–‡ä»¶ä½ç½®**: `animations/` å­ç›®å½?

**åŠ¨ç”»å¼•ç”¨è·¯å¾„**: ç›¸å¯¹äºresæ ¹ç›®å½•ï¼Œä¸å«æ‰©å±•å?
```xml
<animation>
  <name> walk </name>
  <nodes> characters/hero/animations/walk </nodes>
</animation>
```

**åæ ‡è½¬æ¢**: 
- ä½ç½®å…³é”®å¸§ï¼šä½¿ç”¨ `convert_position()`
- æ—‹è½¬å…³é”®å¸§ï¼šä½¿ç”¨ `convert_quaternion()`
- ç¼©æ”¾å…³é”®å¸§ï¼šä¸éœ€è¦è½¬æ?

**ç”Ÿæˆæ–‡ä»¶**:
- `{resource_id}.primitives`
- `{resource_id}.visual`
- `animations/{action_name}.animation`ï¼ˆæ¯ä¸ªåŠ¨ç”»ä¸€ä¸ªæ–‡ä»¶ï¼‰
- `{resource_id}.model`ï¼ˆå«æ‰€æœ‰åŠ¨ç”»å¼•ç”¨ï¼‰

---

## 6.4 æ–‡ä»¶ä¾èµ–å…³ç³»

### 6.4.1 ä¾èµ–é¡ºåºå›?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”? .primitives  â”? â†?å‡ ä½•æ•°æ®ï¼ˆæœ€åº•å±‚ï¼?
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”?
        â”?å¼•ç”¨ geometry
        â–?
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?   .visual    â”? â†?æ¸²æŸ“é…ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”?
        â”?å¼•ç”¨ visual
        â–?
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?   .model     â”? â†?æ¨¡å‹ç»„åˆ
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”?
        â”?å¼•ç”¨ animation
        â–?
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”? .animation   â”? â†?åŠ¨ç”»æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
```

### 6.4.2 å¯¼å‡ºé¡ºåº

**å¿…é¡»æŒ‰æ­¤é¡ºåº**:
1. `.primitives` - å‡ ä½•æ•°æ®
2. `.visual` - å¼•ç”¨primitives
3. `.animation` - ç‹¬ç«‹æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼?
4. `.model` - å¼•ç”¨visualå’Œanimation

**åŸå› **: BigWorldå¼•æ“æŒ‰å¼•ç”¨å…³ç³»åŠ è½½ï¼Œè¢«å¼•ç”¨çš„æ–‡ä»¶å¿…é¡»å…ˆå­˜åœ?

---

# ç¬¬ä¸ƒç« ï¼šé—®é¢˜ä¿®å¤è®°å½•

## 7.1 é™æ€æ¨¡å?ä¹±æ¨¡"é—®é¢˜

### 7.1.1 é—®é¢˜æè¿°

**ç°è±¡**: é™æ€æ¨¡å‹åœ¨BigWorldå®˜æ–¹å·¥å…·ä¸­æ˜¾ç¤ºä¸º"ä¹±æ¨¡"ï¼ˆé¡¶ç‚¹é”™ä¹±ï¼‰

**æ—¶é—´**: 2025-10-22

### 7.1.2 é—®é¢˜æ ¹æº

é€šè¿‡æ·±å…¥åˆ†æBigWorldå®˜æ–¹æºç å‘ç°ï¼?

**é™æ€æ¨¡å‹ä½¿ç”¨äº†é”™è¯¯çš„æ³•çº¿æ ¼å¼ï¼**

#### BigWorldå®˜æ–¹æ ¼å¼å¯¹æ¯”

**é™æ€æ¨¡å?* (`VertexXYZNUV`):
```cpp
struct VertexXYZNUV {
    Vector3  pos_;      // 12 bytes
    Vector3  normal_;   // 12 bytes â†?ä½¿ç”¨Vector3
    Vector2  uv_;       // 8 bytes
};
```

**å¸¦åˆ‡çº¿æ¨¡å?* (`VertexXYZNUVTB`):
```cpp
struct VertexXYZNUVTB {
    Vector3  pos_;      // 12 bytes
    uint32   normal_;   // 4 bytes â†?ä½¿ç”¨packed
    Vector2  uv_;       // 8 bytes
    uint32   tangent_;  // 4 bytes
    uint32   binormal_; // 4 bytes
};
```

### 7.1.3 é”™è¯¯çš„å®ç?

```python
# â?é”™è¯¯ï¼šé™æ€æ¨¡å‹ä¹Ÿä½¿ç”¨äº†packed normal
if primitives.normals:
    bw.write_packed_normal(primitives.normals[i])  # 4å­—èŠ‚
```

**åæœ**: 
- é¡¶ç‚¹æ­¥é•¿é”™è¯¯ï¼?4å­—èŠ‚ï¼ˆå®é™…åº”è¯?2å­—èŠ‚ï¼?
- æ•°æ®å¯¹é½é”™è¯¯ï¼šåç»­UVæ•°æ®ä½ç½®é”™è¯¯
- æ¨¡å‹æ˜¾ç¤ºé”™ä¹±

### 7.1.4 æ­£ç¡®çš„å®ç?

```python
# âœ?æ­£ç¡®ï¼šæ ¹æ®æ˜¯å¦æœ‰åˆ‡çº¿å†³å®šæ³•çº¿æ ¼å¼
if primitives.normals:
    if primitives.tangents:
        # å¸¦åˆ‡çº?å‰¯åˆ‡çº¿çš„æ¨¡å‹ä½¿ç”¨packed normal
        bw.write_packed_normal(primitives.normals[i])  # 4å­—èŠ‚
    else:
        # é™æ€æ¨¡å‹ä½¿ç”¨Vector3 normal
        bw.write_vector3(primitives.normals[i])  # 12å­—èŠ‚
```

### 7.1.5 ä¿®å¤çš„æ–‡ä»?

- âœ?`writers/primitives_writer.py` - ä¿®å¤æ³•çº¿æ ¼å¼
- âœ?`core/vertex_format.py` - ä¿®å¤æ­¥é•¿è®¡ç®—
- âœ?`core/bin_section_writer.py` - ä¿®å¤ReservedData

### 7.1.6 ä¿®å¤ç»“æœ

- âœ?é™æ€æ¨¡å‹æ³•çº¿ï¼š12å­—èŠ‚ Vector3
- âœ?é¡¶ç‚¹æ­¥é•¿ï¼?2å­—èŠ‚ï¼ˆæ­£ç¡®ï¼‰
- âœ?æ¨¡å‹æ­£å¸¸æ˜¾ç¤ºï¼?ä¹±æ¨¡"é—®é¢˜å½»åº•è§£å†³ï¼?

---

## 7.2 è’™çš®æ•°æ®æ£€æµ‹é”™è¯?

### 7.2.1 é—®é¢˜æè¿°

**ç°è±¡**: é™æ€æ¨¡å‹è¢«é”™è¯¯æ ‡è®°ä¸ºåŒ…å«è’™çš®æ•°æ®ï¼Œå¯¼è‡´BigWorldè¯»å–æ—¶å‡ºç?invalid bone indices"é”™è¯¯

### 7.2.2 é”™è¯¯çš„æ£€æµ‹é€»è¾‘

```python
# â?é”™è¯¯ï¼šåªæ£€æŸ¥bone_indicesæ˜¯å¦å­˜åœ¨
has_skin = bool(primitives.bone_indices)
```

**é—®é¢˜**: å³ä½¿bone_indicesä¸ºç©ºåˆ—è¡¨ï¼Œbool([])ä¹Ÿè¿”å›Falseï¼Œä½†primitives.bone_indiceså¯èƒ½è¢«åˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨è€Œä¸æ˜¯None

### 7.2.3 æ­£ç¡®çš„æ£€æµ‹é€»è¾‘

```python
# âœ?æ­£ç¡®ï¼šåŒæ—¶æ£€æŸ¥bone_indiceså’Œbone_weightsçš„é•¿åº?
has_skin = (len(primitives.bone_indices) > 0 and 
            len(primitives.bone_weights) > 0)
```

### 7.2.4 ä¿®å¤ç»“æœ

- âœ?é™æ€æ¨¡å‹æ­£ç¡®è¯†åˆ«ä¸ºæ— è’™çš?
- âœ?è’™çš®æ¨¡å‹æ­£ç¡®è¯†åˆ«ä¸ºæœ‰è’™çš®
- âœ?é¡¶ç‚¹æ ¼å¼æ­£ç¡®ç”Ÿæˆ

---

## 7.3 éª¨éª¼ç´¢å¼•èŒƒå›´æº¢å‡º

### 7.3.1 é—®é¢˜æè¿°

**ç°è±¡**: è§’è‰²æ¨¡å‹æœ?35æ ¹éª¨éª¼ï¼Œå¯¼è‡´BigWorldå®˜æ–¹å·¥å…·å´©æºƒï¼Œé”™è¯¯ä¿¡æ¯ï¼š"invalid bone indices"

**åŸå› **: BigWorldåªæ”¯æŒ?-255çš„éª¨éª¼ç´¢å¼•ï¼ˆuint8ï¼‰ï¼Œä½†æŸäº›é¡¶ç‚¹çš„éª¨éª¼ç´¢å¼•è¶…å‡ºèŒƒå›´

### 7.3.2 è§£å†³æ–¹æ¡ˆ

```python
# éª¨éª¼ç´¢å¼•èŒƒå›´éªŒè¯å’Œå®‰å…¨æ˜ å°?
for j in range(3):
    bone_idx = int(indices[j])
    if bone_idx < 0:
        safe_index = 0  # æ— æ•ˆç´¢å¼•æ˜ å°„åˆ°æ ¹éª¨éª¼
    elif bone_idx > 255:
        safe_index = 0  # è¶…èŒƒå›´ç´¢å¼•æ˜ å°„åˆ°æ ¹éª¨éª?
        print(f"WARNING: éª¨éª¼ç´¢å¼• {bone_idx} è¶…å‡ºèŒƒå›´(0-255)ï¼Œæ˜ å°„åˆ°æ ¹éª¨éª?)
    else:
        safe_index = bone_idx
    bw.write_byte(safe_index)
```

### 7.3.3 ä¿®å¤ç»“æœ

- âœ?é¿å…éª¨éª¼ç´¢å¼•æº¢å‡ºå´©æºƒ
- âœ?è¶…èŒƒå›´éª¨éª¼å®‰å…¨é™çº§åˆ°æ ¹éª¨éª?
- âœ?æä¾›è­¦å‘Šä¿¡æ¯ä¾¿äºè°ƒè¯•

---

## 7.4 BinSection ReservedData é”™è¯¯

### 7.4.1 é—®é¢˜æè¿°

**ç°è±¡**: `.primitives`æ–‡ä»¶æ— æ³•è¢«BigWorldå®˜æ–¹å·¥å…·è¯»å–

**åŸå› **: BinSectionæ–‡ä»¶å¤´çš„ReservedDataå­—æ®µå†™å…¥äº†é”™è¯¯çš„æ•°æ®

### 7.4.2 é”™è¯¯çš„å®ç?

```python
# â?é”™è¯¯ï¼šå†™å…¥preloadLenã€versionã€modifiedç­‰æ•°æ?
self.fp.write(struct.pack("<I", preloadLen))
self.fp.write(struct.pack("<I", version))
self.fp.write(struct.pack("<Q", int(time.time())))
```

### 7.4.3 BigWorldå®˜æ–¹æºç 

**æºæ–‡ä»?*: `bin_section.cpp`

```cpp
// ReservedData: 16 bytes, should be all zeros
char reserved[16] = {0};
file.write(reserved, 16);
```

### 7.4.4 æ­£ç¡®çš„å®ç?

```python
# âœ?æ­£ç¡®ï¼šReservedDataåº”è¯¥å…¨éƒ¨ä¸?
self.fp.write(b"\x00" * 16)  # 16å­—èŠ‚å…?
```

### 7.4.5 ä¿®å¤ç»“æœ

- âœ?BinSectionæ–‡ä»¶å¤´æ ¼å¼å®Œå…¨ç¬¦åˆBigWorldè§„èŒƒ
- âœ?æ–‡ä»¶å¯ä»¥è¢«BigWorldå®˜æ–¹å·¥å…·æ­£å¸¸è¯»å–

---

# ç¬¬å…«ç« ï¼šå¼€å‘æŒ‡å?

## 8.1 å¼€å‘ä¼˜å…ˆçº§

### 8.1.1 å·²å®ŒæˆåŠŸèƒ½ï¼ˆä¼˜å…ˆçº?ï¼?

| åŠŸèƒ½ | çŠ¶æ€?| æ–‡ä»¶ |
|------|------|------|
| é™æ€æ¨¡å‹å¯¼å‡?| âœ?å®Œæˆ | æ‰€æœ‰æ ¸å¿ƒæ–‡ä»?|
| è’™çš®æ¨¡å‹å¯¼å‡º | âœ?å®Œæˆ | æ‰€æœ‰æ ¸å¿ƒæ–‡ä»?|
| è§’è‰²åŠ¨ç”»å¯¼å‡º | âœ?å®Œæˆ | æ‰€æœ‰æ ¸å¿ƒæ–‡ä»?|
| åæ ‡ç³»è½¬æ?| âœ?å®Œæˆ | core/coordinate_converter.py |
| UIç³»ç»Ÿ | âœ?å®Œæˆ | ui/ |
| æ–‡ä»¶å†™å…¥å™?| âœ?å®Œæˆ | writers/ |
| å®¡è®¡æ—¥å¿— | âœ?å®Œæˆ | writers/audit_writer.py |

### 8.1.2 å¾…å®ç°åŠŸèƒ½ï¼ˆä¼˜å…ˆçº?ï¼?

| åŠŸèƒ½ | ä¼˜å…ˆçº?| å¤æ‚åº?| é¢„è®¡å·¥æ—¶ |
|------|--------|--------|----------|
| LODç³»ç»Ÿ | é«?| ä¸?| 3-5å¤?|
| ç¢°æ’æ£€æµ?| ä¸?| ä¸?| 2-3å¤?|
| é—¨æˆ·ç³»ç»Ÿ | ä¸?| ä½?| 1-2å¤?|
| æè´¨Dye/Tint | ä½?| ä½?| 1å¤?|
| Actionç³»ç»Ÿ | ä½?| ä¸?| 2-3å¤?|
| åŠ¨ç”»äº‹ä»¶ | ä½?| ä½?| 1å¤?|
| BSPæ•°æ® | ä½?| é«?| 5-7å¤?|

---

## 8.2 æµ‹è¯•æŒ‡å—

### 8.2.1 é™æ€æ¨¡å‹æµ‹è¯?

**æµ‹è¯•æ­¥éª¤**:
1. åœ¨Blenderä¸­åˆ›å»ºç®€å•ç«‹æ–¹ä½“
2. æ·»åŠ æè´¨å’ŒUV
3. é€‰æ‹©å¯¼å‡ºç±»å‹ï¼šé™æ€æ¨¡å?
4. å¯¼å‡ºæ–‡ä»¶
5. åœ¨BigWorld ModelEditorä¸­æ‰“å¼€

**é¢„æœŸç»“æœ**:
- âœ?æ¨¡å‹æ­£å¸¸æ˜¾ç¤º
- âœ?æè´¨æ­£ç¡®
- âœ?UVæ­£ç¡®
- âœ?æ—?ä¹±æ¨¡"ç°è±¡

### 8.2.2 è’™çš®æ¨¡å‹æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**:
1. åœ¨Blenderä¸­åˆ›å»ºå¸¦éª¨éª¼çš„è§’è‰²æ¨¡å?
2. ç»‘å®šéª¨éª¼æƒé‡
3. é€‰æ‹©å¯¼å‡ºç±»å‹ï¼šè’™çš®æ¨¡å?
4. å¯¼å‡ºæ–‡ä»¶
5. åœ¨BigWorld ModelEditorä¸­æ‰“å¼€

**é¢„æœŸç»“æœ**:
- âœ?æ¨¡å‹æ­£å¸¸æ˜¾ç¤º
- âœ?éª¨éª¼å±‚çº§æ­£ç¡®
- âœ?è’™çš®å˜å½¢æ­£å¸¸

### 8.2.3 è§’è‰²åŠ¨ç”»æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**:
1. åœ¨Blenderä¸­åˆ›å»ºå¸¦åŠ¨ç”»çš„è§’è‰²æ¨¡å?
2. åˆ›å»ºå¤šä¸ªAction
3. é€‰æ‹©å¯¼å‡ºç±»å‹ï¼šè§’è‰²åŠ¨ç”?
4. å¯¼å‡ºæ–‡ä»¶
5. åœ¨BigWorld ModelEditorä¸­æ‰“å¼€å¹¶æ’­æ”¾åŠ¨ç”?

**é¢„æœŸç»“æœ**:
- âœ?æ‰€æœ‰åŠ¨ç”»æ­£ç¡®å¯¼å‡?
- âœ?åŠ¨ç”»æ’­æ”¾æµç•…
- âœ?æ— åæ ‡é—®é¢?

---

## 8.3 ä»£ç è´¡çŒ®æŒ‡å—

### 8.3.1 ä»£ç è§„èŒƒ

**Pythonç‰ˆæœ¬**: Python 2.7ï¼ˆBlenderå†…ç½®ï¼?

**ç¼–ç è§„èŒƒ**:
- ä½¿ç”¨4ç©ºæ ¼ç¼©è¿›
- éµå¾ªPEP 8é£æ ¼
- æ·»åŠ ç±»å‹æ³¨é‡Šï¼ˆPython 2.7å…¼å®¹æ–¹å¼ï¼?
- å‡½æ•°æ·»åŠ docstring

**å‘½åè§„èŒƒ**:
- ç±»åï¼šPascalCaseï¼ˆå¦‚ `PrimitivesBuilder`ï¼?
- å‡½æ•°åï¼šsnake_caseï¼ˆå¦‚ `build_vertex_format`ï¼?
- å¸¸é‡ï¼šUPPER_CASEï¼ˆå¦‚ `CONVERSION_MATRIX`ï¼?
- ç§æœ‰æ–¹æ³•ï¼š_å‰ç¼€ï¼ˆå¦‚ `_write_bone_node`ï¼?

### 8.3.2 æäº¤è§„èŒƒ

**æäº¤ä¿¡æ¯æ ¼å¼**:
```
[ç±»å‹] ç®€çŸ­æè¿?

è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼‰

ç›¸å…³é—®é¢˜ï¼?issue_numberï¼ˆå¦‚æœæœ‰ï¼?
```

**ç±»å‹æ ‡ç­¾**:
- `[Feature]` - æ–°åŠŸèƒ?
- `[Fix]` - Bugä¿®å¤
- `[Refactor]` - ä»£ç é‡æ„
- `[Docs]` - æ–‡æ¡£æ›´æ–°
- `[Test]` - æµ‹è¯•ç›¸å…³

---

# ç¬¬ä¹ç« ï¼šå‚è€ƒèµ„æ–?

## 9.1 BigWorldå®˜æ–¹æ–‡æ¡£

### 9.1.1 File Grammar Guide

**URL**: `https://howarduong.github.io/github.io/doc/html/file_grammar_guide/`

**ä¸»è¦å†…å®¹**:
- `.visual` æ–‡ä»¶æ ¼å¼è§„èŒƒ
- `.model` æ–‡ä»¶æ ¼å¼è§„èŒƒ
- `.animation` æ–‡ä»¶æ ¼å¼è§„èŒƒ
- éª¨éª¼å±‚çº§ç»“æ„è§„èŒƒ

### 9.1.2 å®˜æ–¹æºç å‚è€?

**å…³é”®æ–‡ä»¶**:
- `moo_math.hpp` - Packed Normalå®ç°
- `vertex_formats.hpp` - é¡¶ç‚¹æ ¼å¼å®šä¹‰
- `bin_section.cpp` - BinSectionæ–‡ä»¶æ ¼å¼
- `visual.cpp` - Visualéª¨éª¼å±‚çº§

---

## 9.2 æŠ€æœ¯æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| é™æ€æ¨¡å?| Static Model | æ— éª¨éª¼åŠ¨ç”»çš„æ¨¡å‹ |
| è’™çš®æ¨¡å‹ | Skinned Model | å¸¦éª¨éª¼ç»‘å®šçš„æ¨¡å‹ |
| é¡¶ç‚¹æ ¼å¼ | Vertex Format | é¡¶ç‚¹æ•°æ®çš„ç»„ç»‡æ–¹å¼?|
| æ‰“åŒ…æ³•çº¿ | Packed Normal | å‹ç¼©çš„æ³•çº¿æ ¼å¼ï¼ˆuint32ï¼?|
| éª¨éª¼å±‚çº§ | Skeleton Hierarchy | éª¨éª¼çš„çˆ¶å­å…³ç³»æ ‘ |
| ç»‘å®šçŸ©é˜µ | Bind Matrix | éª¨éª¼çš„åˆå§‹å˜æ¢çŸ©é˜?|
| å…³é”®å¸?| Keyframe | åŠ¨ç”»çš„å…³é”®æ—¶é—´ç‚¹ |
| å››å…ƒæ•?| Quaternion | æ—‹è½¬çš„æ•°å­¦è¡¨ç¤?|

---

## 9.3 å¸¸è§é—®é¢˜è§£ç­”ï¼ˆFAQï¼?

### Q1: ä¸ºä»€ä¹ˆé™æ€æ¨¡å‹å’Œè’™çš®æ¨¡å‹çš„æ³•çº¿æ ¼å¼ä¸åŒï¼Ÿ

**A**: 
- é™æ€æ¨¡å‹ä½¿ç”?Vector3 æ³•çº¿ï¼?2 bytesï¼‰æ˜¯å› ä¸ºæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œä½¿ç”¨æ ‡å‡†æ ¼å¼æ›´ç®€å?
- è’™çš®æ¨¡å‹ä½¿ç”¨ packed æ³•çº¿ï¼? bytesï¼‰æ˜¯ä¸ºäº†å‡å°‘GPUå†…å­˜å¸¦å®½ï¼Œæé«˜æ€§èƒ½

### Q2: æœ€å¤šæ”¯æŒå¤šå°‘æ ¹éª¨éª¼ï¼?

**A**: 255æ ¹ã€‚å› ä¸ºBigWorldä½¿ç”¨uint8å­˜å‚¨éª¨éª¼ç´¢å¼•ï¼ŒèŒƒå›´æ˜¯0-255ã€?

### Q3: åŠ¨ç”»æ–‡ä»¶ä¸ºä»€ä¹ˆè¦æ”¾åœ¨animations/å­ç›®å½•ï¼Ÿ

**A**: è¿™æ˜¯BigWorldçš„æ ‡å‡†ç›®å½•ç»“æ„çº¦å®šï¼Œä¾¿äºèµ„æºç®¡ç†å’ŒåŠ è½½ã€?

### Q4: æ”¯æŒå“ªäº›Blenderç‰ˆæœ¬ï¼?

**A**: Blender 2.8+ï¼ˆä¸»è¦æµ‹è¯•ç¯å¢ƒä¸ºBlender 4.5ï¼?

---

**æ–‡æ¡£å®Œæˆï¼?* ğŸ‰

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–?*: 2025-10-22  
**ç»´æŠ¤è€?*: BigWorld Exporter Team


# é™„å½•Aï¼šBigWorldæ–‡ä»¶å®Œæ•´æ•°æ®è§„èŒƒï¼ˆå®˜æ–¹å¯¹ç…§ï¼‰

> æœ¬ç« åŸºäº [BigWorld File Grammar Guide](https://howarduong.github.io/github.io/doc/html/file_grammar_guide/index.html) å®˜æ–¹æ–‡æ¡£å’?BigWorld æºç æ•´ç†

## A.1 å››å¤§æ–‡ä»¶å®Œæ•´æ•°æ®æ¸…å•

### A.1.1 `.primitives` æ–‡ä»¶å®Œæ•´æ•°æ®

**æ–‡ä»¶æ ¼å¼**: BinSectionï¼ˆäºŒè¿›åˆ¶ï¼? 
**å®˜æ–¹æ–‡æ¡£**: File Grammar Guide ç¬?0ç«? 
**ç”¨é€?*: å­˜å‚¨å‡ ä½•ä½“çš„åŸå§‹é¡¶ç‚¹å’Œç´¢å¼•æ•°æ?

#### **æ–‡ä»¶å¤´ï¼ˆ32å­—èŠ‚ï¼?*
```
å­—æ®µå?             ç±»å‹      å­—èŠ‚æ•?  å€?è¯´æ˜                    å®ç°çŠ¶æ€?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MagicNumber         uint32    4        0x42A14E65ï¼ˆå›ºå®šï¼‰        âœ?å·²å®ç?
Version             uint32    4        ç‰ˆæœ¬å?                   âœ?å·²å®ç?
IndexTableOffset    uint32    4        ç´¢å¼•è¡¨çš„æ–‡ä»¶åç§»          âœ?å·²å®ç?
ReservedData        byte[16]  16       å¿…é¡»å…¨éƒ¨ä¸?x00            âœ?å·²ä¿®å¤?
Padding             uint32    4        å¯¹é½å¡«å……                  âœ?å·²å®ç?
```

#### **é¡¶ç‚¹æ ¼å¼å¯¹ç…§è¡?*

**é™æ€æ¨¡å?(xyznuv - 32å­—èŠ‚/é¡¶ç‚¹)**
```
å­—æ®µå?     ç±»å‹        å­—èŠ‚æ•?  åç§»   è¯´æ˜                  å®ç°çŠ¶æ€?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
position    Vector3     12       0      é¡¶ç‚¹ä½ç½®(x,y,z)      âœ?å·²å®ç?
normal      Vector3     12       12     æ³•çº¿(nx,ny,nz)       âœ?å·²ä¿®å¤?
uv          Vector2     8        24     UVåæ ‡(u,v)          âœ?å·²å®ç?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                    32 bytes/vertex
```

**è’™çš®æ¨¡å‹ (xyznuviiiww - 29å­—èŠ‚/é¡¶ç‚¹)**
```
å­—æ®µå?        ç±»å‹     å­—èŠ‚æ•? åç§»  èŒƒå›´    è¯´æ˜              å®ç°çŠ¶æ€?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
position       Vector3  12      0     -       é¡¶ç‚¹ä½ç½®         âœ?å·²å®ç?
normal         uint32   4       12    -       packedæ³•çº¿       âœ?å·²å®ç?
uv             Vector2  8       16    -       UVåæ ‡           âœ?å·²å®ç?
bone_index_1   uint8    1       24    0-255   éª¨éª¼ç´¢å¼•1        âœ?å·²å®ç?
bone_index_2   uint8    1       25    0-255   éª¨éª¼ç´¢å¼•2        âœ?å·²å®ç?
bone_index_3   uint8    1       26    0-255   éª¨éª¼ç´¢å¼•3        âœ?å·²å®ç?
bone_weight_1  uint8    1       27    0-255   æƒé‡1            âœ?å·²å®ç?
bone_weight_2  uint8    1       28    0-255   æƒé‡2            âœ?å·²å®ç?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                    29 bytes/vertex
ç¬?ä¸ªæƒé‡?= 255 - weight1 - weight2ï¼ˆéšå¼ï¼‰
```

**å®˜æ–¹å…¶ä»–æ”¯æŒæ ¼å¼ï¼ˆæœªå®ç°ï¼?*
```
æ ¼å¼                 å­—èŠ‚/é¡¶ç‚¹  è¯´æ˜                  å®ç°çŠ¶æ€?  ä¼˜å…ˆçº?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
xyznuvtb             32         å¸¦åˆ‡çº?              âœ?å·²å®ç?  -
xyznuvtbiiiww        37         è’™çš®+åˆ‡çº¿            âœ?å·²å®ç?  -
xyznuviiiiwwww       33         4ç´¢å¼•4æƒé‡           â?æœªå®ç?  ä½?
xyznuvtbiiiiwwww     41         å¸¦åˆ‡çº?ç´¢å¼•4æƒé‡     â?æœªå®ç?  ä½?
xyznuvc              48         å¸¦é¡¶ç‚¹é¢œè‰?RGBA)     â?æœªå®ç?  ä½?
xyzduv               28         åŒç²¾åº¦ä½ç½?          â?æœªå®ç?  ä½?
```

---

### A.1.2 `.visual` æ–‡ä»¶å®Œæ•´æ•°æ®ï¼ˆPackedSectionï¼?

**å®˜æ–¹æ–‡æ¡£**: File Grammar Guide ç¬?7ç«?

#### **å¿…éœ€å­—æ®µæ¸…å•**

```xml
<root>
  <renderSet>                    âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼Œå¯å¤šä¸ªï¼?
    <geometry>                   âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <node>                       âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <primitiveGroup>             âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <material>                   âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <identifier>               âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <property>                 âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
        <TextureFactor>          âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
        <NormalMap>              â?éƒ¨åˆ†å®ç°ï¼ˆå¯é€‰ï¼‰
        <SpecularMap>            â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
        <selfIllumination>       â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
        <shininess>              â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
  
  <boundingBox>                  âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <min>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <max>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
  
  <node>                         âœ?å·²å®ç°ï¼ˆè’™çš®æ¨¡å‹å¿…éœ€ï¼?
    <identifier>                 âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <transform>                  âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <row0>                     âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <row1>                     âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <row2>                     âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      <row3>                     âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
```

#### **å¯é€‰å­—æ®µæ¸…å?*

```xml
<flags>                          â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
  <doubleSided>                  â?æœªå®ç?
  <transparent>                  â?æœªå®ç?
  <castShadow>                   â?æœªå®ç?

<portal>                         â?æœªå®ç°ï¼ˆå¯é€‰ï¼Œç¬?7.2èŠ‚ï¼‰
  <flags>                        â?æœªå®ç?
  <points>                       â?æœªå®ç?
  <uAxis>                        â?æœªå®ç?
  <vAxis>                        â?æœªå®ç?

<animation>                      â?æœªå®ç°ï¼ˆä¸æ¨èï¼Œåº”åœ¨.modelä¸­ï¼‰
```

---

### A.1.3 `.model` æ–‡ä»¶å®Œæ•´æ•°æ®ï¼ˆPackedSectionï¼?

**å®˜æ–¹æ–‡æ¡£**: File Grammar Guide ç¬?2ç«?

#### **å¿…éœ€å­—æ®µæ¸…å•**

```xml
<root>
  <!-- Visualå¼•ç”¨ï¼ˆäºŒé€‰ä¸€ï¼?->
  <nodefullVisual>               âœ?å·²å®ç°ï¼ˆè’™çš®/åŠ¨ç”»æ¨¡å‹å¿…éœ€ï¼?
  æˆ?
  <nodelessVisual>               âœ?å·²å®ç°ï¼ˆé™æ€æ¨¡å‹å¿…éœ€ï¼?
  
  <extent>                       âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
  
  <boundingBox>                  âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <min>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <max>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
```

#### **å¯é€‰å­—æ®µæ¸…å?*

```xml
<parent>                         â?å­—æ®µé¢„ç•™ï¼ˆè§’è‰²ç»„ä»¶æ¨èï¼‰
  ç”¨é€? ç»§æ‰¿çˆ¶æ¨¡å‹çš„éª¨éª¼å’ŒåŠ¨ç”?
  
<animation>                      âœ?å·²å®ç°ï¼ˆè§’è‰²æ¨¡å‹æ¨èï¼?
  <name>                         âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
  <nodes>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?

<action>                         â?æœªå®ç°ï¼ˆé«˜ä¼˜å…ˆçº§ï¼?
  <name>                         â?æœªå®ç?
  <animation>                    â?æœªå®ç?
  <blended>                      â?æœªå®ç?
  <track>                        â?æœªå®ç?
  <matchInfo>                    â?æœªå®ç?

<dye>                            â?æœªå®ç°ï¼ˆä½ä¼˜å…ˆçº§ï¼?
  <matter>                       â?æœªå®ç?
  <tint>                         â?æœªå®ç?

<lod>                            â?æœªå®ç°ï¼ˆä¸­ä¼˜å…ˆçº§ï¼?
  <extent>                       â?æœªå®ç?
  <model>                        â?æœªå®ç?
```

---

### A.1.4 `.animation` æ–‡ä»¶å®Œæ•´æ•°æ®ï¼ˆPackedSectionï¼?

**å®˜æ–¹æ–‡æ¡£**: BigWorldæºç å‚è€?

#### **å¿…éœ€å­—æ®µæ¸…å•**

```xml
<root>
  <nodes>                        âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
    <node>                       âœ?å·²å®ç°ï¼ˆæ¯éª¨éª¼ä¸€ä¸ªï¼‰
      <identifier>               âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      
      <translations>             âœ?å·²å®ç°ï¼ˆå¯é€‰ï¼‰
        <key>                    âœ?å·²å®ç?
          <time>                 âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
          <value>                âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      
      <rotations>                âœ?å·²å®ç°ï¼ˆæ¨èå¿…éœ€ï¼?
        <key>                    âœ?å·²å®ç?
          <time>                 âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
          <value>                âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
      
      <scales>                   âœ?å·²å®ç°ï¼ˆå¯é€‰ï¼‰
        <key>                    âœ?å·²å®ç?
          <time>                 âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
          <value>                âœ?å·²å®ç°ï¼ˆå¿…éœ€ï¼?
```

#### **å¯é€‰å­—æ®µæ¸…å?*

```xml
<compression>                    â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
  ç”¨é€? å‡å°æ–‡ä»¶å¤§å°

<events>                         â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
  <event>                        â?æœªå®ç?
    <time>                       â?æœªå®ç?
    <identifier>                 â?æœªå®ç?

<isCoordinated>                  â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
<isImpacting>                    â?æœªå®ç°ï¼ˆå¯é€‰ï¼‰
```

---

## A.2 å…³é”®å†™å…¥è§„åˆ™æ±‡æ€?

### A.2.1 `.primitives` å†™å…¥è§„åˆ™

**è§„åˆ™1: é¡¶ç‚¹æ•°æ®ä¸¥æ ¼æŒ‰é¡ºåº?*
```python
# xyznuviiiwwæ ¼å¼å†™å…¥é¡ºåºï¼ˆä¸å¯æ›´æ”¹ï¼‰
bw.write_vector3(position)       # åç§»0:  12å­—èŠ‚
bw.write_packed_normal(normal)   # åç§»12: 4å­—èŠ‚
bw.write_vector2(uv)             # åç§»16: 8å­—èŠ‚
bw.write_byte(bone_idx_1)        # åç§»24: 1å­—èŠ‚
bw.write_byte(bone_idx_2)        # åç§»25: 1å­—èŠ‚
bw.write_byte(bone_idx_3)        # åç§»26: 1å­—èŠ‚
bw.write_byte(bone_weight_1)     # åç§»27: 1å­—èŠ‚
bw.write_byte(bone_weight_2)     # åç§»28: 1å­—èŠ‚
```

**è§„åˆ™2: æ³•çº¿æ ¼å¼åˆ¤æ–­**
```python
if vertex_format == "xyznuv":
    # é™æ€æ¨¡å‹ï¼šVector3æ³•çº¿
    bw.write_vector3(normal)  # 12å­—èŠ‚
elif "iiiww" in vertex_format or "tb" in vertex_format:
    # è’™çš®æˆ–å¸¦åˆ‡çº¿ï¼špackedæ³•çº¿
    bw.write_packed_normal(normal)  # 4å­—èŠ‚
```

**è§„åˆ™3: éª¨éª¼æ•°æ®éªŒè¯**
```python
# ç´¢å¼•éªŒè¯
assert 0 <= bone_index <= 255, "ç´¢å¼•è¶…å‡ºuint8èŒƒå›´"

# æƒé‡éªŒè¯
assert 0 <= weight <= 255, "æƒé‡è¶…å‡ºuint8èŒƒå›´"
assert weight1 + weight2 <= 255, "æƒé‡å’Œä¸èƒ½è¶…è¿?55"
```

---

### A.2.2 `.visual` å†™å…¥è§„åˆ™

**è§„åˆ™1: renderSetå­—æ®µé¡ºåº**
```xml
<!-- å¿…é¡»æŒ‰æ­¤é¡ºåº -->
<renderSet>
  <geometry>...</geometry>           <!-- 1 -->
  <node>...</node>                   <!-- 2 -->
  <primitiveGroup>...</primitiveGroup> <!-- 3 -->
  <material>...</material>           <!-- 4 -->
</renderSet>
```

**è§„åˆ™2: éª¨éª¼å±‚çº§åµŒå¥—**
```xml
<!-- âœ?æ­£ç¡®ï¼šé€’å½’åµŒå¥— -->
<node>
  <identifier>Parent</identifier>
  <node>
    <identifier>Child</identifier>
  </node>
</node>

<!-- â?é”™è¯¯ï¼šå¹¶åˆ?-->
<node><identifier>Parent</identifier></node>
<node><identifier>Child</identifier></node>
```

---

### A.2.3 `.model` å†™å…¥è§„åˆ™

**è§„åˆ™1: Visualç±»å‹åŒ¹é…**
```
é™æ€æ¨¡å?â†?nodelessVisual â†?visualæ–‡ä»¶æ—?node>
è’™çš®æ¨¡å‹ â†?nodefullVisual â†?visualæ–‡ä»¶æœ?node>
```

**è§„åˆ™2: åŠ¨ç”»è·¯å¾„æ ¼å¼**
```xml
<nodes>characters/hero/animations/walk</nodes>

âœ?æ­£ç¡®ï¼šç›¸å¯¹è·¯å¾„ï¼Œæ— æ‰©å±•å
â?é”™è¯¯ï¼šcharacters/hero/animations/walk.animation
â?é”™è¯¯ï¼šanimations/walkï¼ˆç¼ºå°‘å®Œæ•´è·¯å¾„ï¼‰
```

---

### A.2.4 `.animation` å†™å…¥è§„åˆ™

**è§„åˆ™1: éª¨éª¼åç§°ä¸€è‡´æ€?*
```
.visual: <identifier>biped..Spine</identifier>
.animation: <identifier>biped..Spine</identifier>

âœ?å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬å¤§å°å†™ã€æ ‡ç‚¹ï¼‰
â?ä¸ä¸€è‡´ä¼šå¯¼è‡´åŠ¨ç”»æ— æ³•åº”ç”¨
```

**è§„åˆ™2: å…³é”®å¸§æ—¶é—´å‡åº?*
```xml
<rotations>
  <key><time>0.0</time>...</key>
  <key><time>0.033</time>...</key>
  <key><time>0.066</time>...</key>
</rotations>

è¦æ±‚ï¼štime[i] < time[i+1]
```

**è§„åˆ™3: å››å…ƒæ•°æ ¼å¼?*
```xml
<value>x y z w</value>

âœ?å½’ä¸€åŒ–ï¼šsqrt(xÂ²+yÂ²+zÂ²+wÂ²) = 1.0
âœ?å·²è½¬æ¢ï¼šY-upåæ ‡ç³?
âœ?æ ¼å¼ï¼šç©ºæ ¼åˆ†éš?
```

---

## A.3 æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æ¸…å?

### `.primitives` æ£€æŸ¥é¡¹
```
âœ?MagicNumber = 0x42A14E65
âœ?ReservedData = 16å­—èŠ‚0x00
âœ?é¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸²æ­£ç¡?
âœ?å­—èŠ‚å¯¹é½æ­£ç¡®
âœ?éª¨éª¼ç´¢å¼•0-255
âœ?æƒé‡å’?=255
```

### `.visual` æ£€æŸ¥é¡¹
```
âœ?renderSetæ•°é‡=primitiveGroupæ•°é‡
âœ?geometryå?/vertices"
âœ?éª¨éª¼é€’å½’åµŒå¥—
âœ?transformæ˜?x3
âœ?min<max
```

### `.model` æ£€æŸ¥é¡¹
```
âœ?Visualç±»å‹åŒ¹é…
âœ?åŠ¨ç”»è·¯å¾„æ— æ‰©å±•å
âœ?extent>0
âœ?æ–‡ä»¶å¼•ç”¨å­˜åœ¨
```

### `.animation` æ£€æŸ¥é¡¹
```
âœ?éª¨éª¼åç§°ä¸€è‡?
âœ?æ—¶é—´å‡åº
âœ?å››å…ƒæ•°å½’ä¸€åŒ?
âœ?åæ ‡å·²è½¬æ?
```

---


