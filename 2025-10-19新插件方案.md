
---

# 🖥️ BigWorld Blender 插件 UI 字符示意图（最终版）


- **绿色（✔ 必须实现）**  
- **黄色（◆ 占位保留，暂不开发）**  
- **红色（✘ 删除，不再需要）**

在 3ds Max 插件里常用的控件有：  
- **下拉框（ComboBox）** → 对象类型、LOD 模板、目录策略  
- **复选框（CheckBox）** → 导出选项、渲染标志、功能开关  
- **文本框（EditText）** → 路径、资源ID  
- **按钮（Button）** → 浏览、运行检测、导出  
- **颜色选择器（ColorSwatch）** → Tint 颜色  
- **列表（UIList/ListBox）** → 动画轨道、事件列表  
- **滑块（Spinner/Slider）** → 压缩阈值、数值参数  

---

# 🎛️ 改进后的三大区域 UI 示意图（带颜色标记）

## 1. 插件偏好设置（全局设置）
```plaintext
┌────────────────────────────────────────────────────────────┐
│ BigWorld 插件全局设置                                       │
├────────────────────────────────────────────────────────────┤
│ 导出根目录： [路径] [📁]              ✔                     │
│ 纹理根目录： [路径] [📁]              ✔                     │
│ 坐标系转换： (Z-up → Y-up) 下拉框     ✔                     │
│ 单位： (米/厘米) 下拉框               ✔                     │
│ 命名规范模板： 下拉框                 ✔                     │
│ LOD 规则模板： 下拉框                 ◆                     │
│ 导出组合 schema： [默认/选择文件]     ◆                     │
│ 目录/打包策略： 下拉框                ◆                     │
│------------------------------------------------------------│
│ [✔] 导出前自动检测                  ✔                      │
│ [✔] 写入审计日志                    ✔                      │
│ [保存设置] [重置]                   ✔                      │
└────────────────────────────────────────────────────────────┘
```

---

## 2. 对象属性面板（对象级设置）
```plaintext
┌────────────────────────────────────────────────────────────┐
│ BigWorld 对象属性                                           │
├────────────────────────────────────────────────────────────┤
│ 对象类型： 下拉框 (静态/角色/碰撞/门户/组)   ✔              │
│ 资源ID： [文本框]   分组： [文本框]          ✔              │
│------------------------------------------------------------│
│ LOD： [启用] [自动生成LOD] 下拉框规则        ◆              │
│------------------------------------------------------------│
│ 材质槽： 模板下拉框 [默认PBR]               ✔              │
│ BaseColor [路径] Normal [路径] ORM [路径]    ✔              │
│ 压缩： 下拉框 (DXT5/BC7/无)                 ✔              │
│------------------------------------------------------------│
│ 硬点： [添加按钮] 名称/类型 下拉框           ✔              │
│------------------------------------------------------------│
│ 动画轨道（仅角色）： UIList                 ✔              │
│   - 轨道名 / 帧率 / 循环 / 事件标签                          │
│ 标签： IsCoordinated [✔]  IsImpacting [✔]   ◆              │
│------------------------------------------------------------│
│ 碰撞体参数： 来源下拉框 层下拉框             ◆              │
│ 门户参数： 空间ID [文本框] 法线校验[按钮]    ◆              │
│------------------------------------------------------------│
│ [运行导出前检测按钮]                     ✔                  │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 导出执行面板（File > Export > BigWorld）
```plaintext
┌────────────────────────────────────────────────────────────┐
│ BigWorld 导出执行                                           │
├────────────────────────────────────────────────────────────┤
│ 导出类型： 下拉框 (静态/角色/碰撞/门户/组)   ✔              │
│ 几何格式： 下拉框 (primitives/processed)     ◆              │
│------------------------------------------------------------│
│ 生成文件：                                                  │
│  - .primitives [✔]                          ✔              │
│  - .visual [✔]                              ✔              │
│  - .animation [✔]                           ✔              │
│  - .collision [✔]                           ◆              │
│  - .model/.xml [✔]                          ✔              │
│  - manifest.json [✔]                        ✔              │
│  - audit.log [✔]                            ✔              │
│------------------------------------------------------------│
│ 目录策略： 下拉框 (按类型/按包/按LOD)        ◆              │
│ 导出预设： [保存按钮] [选择按钮]             ◆              │
│------------------------------------------------------------│
│ [开始导出按钮]                             ✔                │
└────────────────────────────────────────────────────────────┘
```

---

# ✅ 总结
- **绿色（✔）必须实现**：保证导出闭环（路径、对象类型、材质、动画、导出按钮）。  
- **黄色（◆）占位保留**：LOD、BSP、压缩、事件、门户、碰撞体、目录策略、导出预设。UI 保留但灰掉。  
- **红色（✘）删除**：冗余功能（如 UV 校验独立按钮、提示性文字），已去掉。  
- **全局设置**：一次设定，全局生效（路径、坐标系、命名/LOD 规则、schema、目录策略）  
- **对象属性**：对象自身的配置（类型、LOD、材质、硬点、动画、碰撞、门户）  
- **导出执行**：导出任务控制（导出类型、导出选项、生成文件、目录策略、执行按钮）  



---

# 🗂️ 控件类型对照表（3ds Max → Blender）

| 功能类别         | 3ds Max 插件控件类型              | Blender 插件对应控件 (bpy.types) | 典型用途示例 |
|------------------|----------------------------------|----------------------------------|--------------|
| **布尔开关**     | CheckBox (复选框)                | BoolProperty + CheckBox          | 导出选项、启用LOD、是否循环 |
| **单选/枚举**    | ComboBox (下拉框)                | EnumProperty + Dropdown          | 对象类型、几何格式、LOD 模板 |
| **文本输入**     | EditText (文本框)                | StringProperty + TextField       | 路径、资源ID、空间ID |
| **数值输入**     | Spinner (数值微调器)             | IntProperty / FloatProperty + NumberField | 帧率、压缩阈值、缩放比例 |
| **滑块**         | Slider (滑动条)                  | FloatProperty + Slider           | 压缩阈值、透明度、权重 |
| **按钮**         | Button                           | Operator (bpy.types.Operator)    | 浏览路径、运行检测、开始导出 |
| **颜色选择**     | ColorSwatch (颜色块)             | FloatVectorProperty(subtype='COLOR') | Tint 染色、材质颜色 |
| **文件选择**     | FilePicker (文件浏览器)           | bpy.props.StringProperty(subtype='FILE_PATH') | 选择 Visual/Animation 文件 |
| **文件夹选择**   | FolderPicker (目录浏览器)         | bpy.props.StringProperty(subtype='DIR_PATH')  | 导出根目录、纹理根目录 |
| **列表**         | ListBox / UIList                 | UIList (bpy.types.UIList)        | 动画轨道列表、事件列表、材质槽 |
| **分组框**       | GroupBox (分组容器)              | Panel / BoxLayout                | 板块划分（材质、LOD、动画） |
| **标签**         | StaticText (静态文本)            | Label                            | 字段说明、提示信息 |

---

# 🔑 迁移要点
1. **CheckBox → BoolProperty**  
   - Max 插件里常见的 `[✔] 导出 .visual` → Blender 用 `BoolProperty` + `layout.prop()`。  

2. **ComboBox → EnumProperty**  
   - Max 插件的下拉框（对象类型、LOD 模板） → Blender 用 `EnumProperty`。  

3. **EditText → StringProperty**  
   - Max 插件的路径输入框 → Blender 用 `StringProperty`，可加 `subtype='FILE_PATH'`。  

4. **Spinner/Slider → Int/FloatProperty**  
   - Max 插件的数值微调器 → Blender 用 `FloatProperty`，可设置 `min/max/step`。  

5. **UIList → bpy.types.UIList**  
   - 动画轨道、材质槽列表 → Blender 原生支持 UIList，功能更强。  

---

# ✅ 总结
- **必须迁移的控件**：CheckBox、ComboBox、EditText、Button、UIList。  
- **可增强的控件**：颜色选择、文件/目录选择（Blender 原生支持更好）。  
- **布局方式**：3ds Max 用 GroupBox，Blender 用 Panel/BoxLayout。  

---


---

# 📂 BigWorld Blender 插件文件结构（带开发优先级标注）

```plaintext
blender_bigworld_exporter/
│
├─ core/                               # 核心写入器与通用逻辑
│   ├─ bin_section_writer.py            # ✔ 必须实现：写 .primitives
│   ├─ packed_section_writer.py         # ✔ 必须实现：写 .visual/.model/.animation
│   ├─ schema.py                        # ✔ 必须实现：dataclass 定义（Primitives/Visual/Model/Animation）
│   └─ validators.py                    # ✔ 必须实现：通用校验器（骨骼一致性、group 对齐、关键帧单调性）
│
├─ writers/                            # 各文件类型导出器
│   ├─ primitives_writer.py             # ✔ 必须实现
│   ├─ visual_writer.py                 # ✔ 必须实现
│   ├─ model_writer.py                  # ✔ 必须实现
│   ├─ animation_writer.py              # ✔ 必须实现
│   └─ collision_writer.py              # ◆ 占位保留：碰撞体导出（暂不开发）
│
├─ ui/                                 # Blender 插件 UI
│   ├─ preferences_panel.py             # ✔ 必须实现：插件偏好设置（全局设置）
│   ├─ object_panel.py                  # ✔ 必须实现：对象属性面板
│   ├─ export_panel.py                  # ✔ 必须实现：导出执行面板
│   ├─ material_panel.py                # ◆ 占位保留：材质高级参数（Dye/Tint、PBR 扩展）
│   ├─ lod_panel.py                     # ◆ 占位保留：LOD 配置
│   ├─ portal_panel.py                  # ◆ 占位保留：门户对象配置
│   └─ collision_panel.py               # ◆ 占位保留：碰撞体参数配置
│
├─ utils/                              # 工具函数
│   ├─ mesh_utils.py                    # ✔ 必须实现：三角化、法线/切线生成
│   ├─ armature_utils.py                # ✔ 必须实现：骨骼采样、动画采样
│   ├─ material_utils.py                # ✔ 必须实现：材质映射表
│   ├─ audit_utils.py                   # ✔ 必须实现：manifest.json & audit.log 写入
│   ├─ lod_utils.py                     # ◆ 占位保留：LOD 自动生成
│   ├─ portal_utils.py                  # ◆ 占位保留：门户空间校验
│   └─ collision_utils.py               # ◆ 占位保留：碰撞体生成
│
├─ tests/                              # 测试与验证
│   ├─ test_hex_diff.py                 # ✔ 必须实现：与旧版产物对比
│   ├─ test_model_editor.py             # ✔ 必须实现：调用 ModelEditor 验证
│   ├─ test_schema.py                   # ✔ 必须实现：schema 校验
│   └─ test_lod_collision.py            # ◆ 占位保留：LOD/碰撞体测试
│
└─ docs/                               # 文档
    ├─ schema_reference.md              # ✔ 必须实现：字段对照表
    ├─ ui_mapping.md                    # ✔ 必须实现：UI → 文件字段映射
    └─ roadmap.md                       # ✔ 必须实现：开发计划（标注占位功能）
```

---

# ✅ 总结
- **必须实现（✔）**：保证导出闭环的核心功能（primitives/visual/model/animation、基础材质、动画采样、manifest/audit、验证工具）。  
- **占位保留（◆）**：LOD、碰撞体、门户、材质高级参数（Dye/Tint）、压缩等高级功能，UI 和文件结构保留，但暂不开发。  
- **删除（✘）**：冗余功能已在目录中去掉，不再单独列出。  

---


```

---

# ⚙️ 功能描述（最终版）

- **导出文件类型与顺序**  
  - 静态模型：`.primitives → .collision(选) → .visual → .model/.xml → manifest/log`  
  - 动画角色：`.primitives → .animation → .visual → .model/.xml → manifest/log`  
  - 碰撞体：`.collision → .model/.xml(选) → manifest/log`  
  - 门户：`.visual → .model/.xml → manifest/log`  

- **路径策略与引用**  
  - 所有引用路径由 `utils.path_policy` 生成  
  - `.visual` 引用 `.primitives`、`.collision`  
  - `.model/.xml` 引用 `.visual`、`.animation`、`.collision`  
  - `.portal.xml` 引用空间 ID、法线方向  

- **坐标系统**  
  - 默认：Blender Z-up → BigWorld Y-up  
  - 统一入口：`core.coordinate_system`  
  - 覆盖：顶点/法线/切线、硬点、动画关键帧、碰撞体、门户法线  

- **XML 模板体系**  
  - 所有 XML 类文件（visual、model、portal、动画绑定）通过 `core.xml_writer` 渲染  
  - 模板存放在 `templates/*.tpl.xml`  
  - writer 只准备数据字典，调用 `xml_writer.render(template, data)`  
  - 保证字段顺序、缩进、标签命名与官方一致  

- **primitives 对齐**  
  - 严格对齐顶点缓冲、索引缓冲、属性通道、LOD  
  - `core.serializer` 统一字节序与块头  
  - `utils.hex_diff` 与旧产物对比  

- **验证与可追踪**  
  - `validate_operator` 输出 UI 摘要与 audit.log  
  - `manifest_writer` 输出清单，列出产物与依赖关系  

---


---

# 🚀 导出流程（最终版）

### 1. 对象配置阶段
- **在 N 键对象面板**中完成对象级设置：  
  - 类型（静态/角色/碰撞/门户）  
  - LOD 配置（自动生成/命名规则）  
  - 材质槽与纹理路径（BaseColor/Normal/ORM）  
  - 硬点（名称、类型、变换校验）  
  - 动画轨道（轨道名、帧率、循环、事件标签）  
  - 碰撞体参数（来源：网格/简化/凸包，层级）  
  - 门户参数（空间ID、法线方向校验）  

👉 这一阶段只涉及对象自身属性，不涉及导出顺序。

---

### 2. 预检阶段
- **调用 `validate_operator`**，执行以下校验：  
  - 几何：非流形、三角化、法线一致性  
  - UV：重叠、越界、切线空间  
  - 材质：槽位完整性、纹理路径存在性、压缩策略  
  - 命名：对象/LOD/硬点命名符合 schema  
  - 动画：轨道参数完整、骨架一致性  
  - 碰撞/门户：凸包生成可用、门户法线方向正确  

- **输出结果**：  
  - UI 面板摘要（红/黄/绿状态）  
  - audit.log 详细记录（错误码、警告、建议）  

👉 未通过校验则禁止进入导出。

---

### 3. 导出执行阶段（pipeline 固定顺序）
- **调用 `export_operator`**，根据对象类型选择对应 pipeline：  

| 类型       | 导出顺序（固定） |
|------------|------------------|
| 静态模型   | primitives → collision(选) → visual → model/xml → manifest/log |
| 动画角色   | primitives → animation → visual → model/xml → manifest/log |
| 碰撞体     | collision → model/xml(选) → manifest/log |
| 门户       | visual → model/xml → manifest/log |

- **每一步 writer 的职责**：  
  - primitives_writer：写几何数据（调用 coordinate_system 转换）  
  - collision_writer：写碰撞体数据  
  - animation_writer：写骨骼动画轨道  
  - visual_writer：调用 xml_writer 渲染 visual.tpl.xml  
  - model_writer：调用 xml_writer 渲染 model.tpl.xml  
  - portal_writer：调用 xml_writer 渲染 portal.tpl.xml  
  - manifest_writer：生成清单  
  - audit_writer：生成日志  

👉 所有 writer 的路径与引用由 `utils.path_policy` 提供，禁止自行拼接。

---

### 4. 提交与清单阶段
- **事务控制**：  
  - 所有文件先写入临时目录  
  - 依赖校验通过后统一提交到目标路径  
  - 任一步失败则回滚，audit.log 记录错误  

- **生成清单与日志**：  
  - manifest.json：列出所有产物与引用关系  
  - audit.log：记录导出全过程、错误码、警告  

---

### 5. 验证闭环阶段
- **二进制对比**：  
  - 使用 `utils.hex_diff` 与旧 3ds Max 插件产物对比，确保 primitives/visual 字段对齐  
- **引擎加载测试**：  
  - 在 BigWorld 官方工具（ModelEditor/WorldEditor）中加载，验证 visual/model/collision/animation 引用正确  

---

# ✅ 最终方案总结

1. **UI 分工合理**：  
   - 偏好设置：全局路径/坐标系/规则  
   - 对象面板：对象属性（LOD/材质/硬点/动画/碰撞/门户）  
   - 导出面板：执行导出（类型选择、文件组合、预设）  

2. **目录架构科学**：  
   - core 层：数据结构、坐标系、序列化、依赖、XML 渲染  
   - writers：单一职责写文件  
   - pipeline：固定顺序调度  
   - utils：路径策略、材质绑定、纹理校验、差异对比  
   - templates：XML 模板库  

3. **导出顺序固定**：  
   - 按类型内置顺序执行，避免引用缺失  

4. **路径与引用统一**：  
   - path_policy 生成所有路径与引用，writers 禁止拼接  

5. **XML 模板驱动**：  
   - visual/model/portal/动画绑定统一通过 xml_writer 渲染模板  
   - 保证字段顺序、标签命名与官方一致  

6. **primitives 严格对齐**：  
   - serializer 控制字节序与块头  
   - hex_diff 对比旧产物  

7. **验证与可追踪**：  
   - validate_operator 校验  
   - audit.log + manifest.json 形成可追踪闭环  

---

**好的 ✅ 总结一句：我们要把 BigWorld 源码里的工具链逐层拆解，提炼出字段（数据结构）、模块职责、调用关系，然后映射到 Blender 插件的功能 → 模块 → 文件 → 接口。**

下面我先从 **tools 目录**的核心子项目开始逐个解析，逐步建立映射表。  

---

## 🔎 Step 1：exporter_common  
这是 BigWorld 工具链的“底层库”，所有导出器（3ds Max、Maya）都会依赖它。

### 字段（数据结构）
- **VisualHeader / ModelHeader**：定义 `.visual`、`.model` 文件的头部字段（版本号、依赖、引用路径）。  
- **PrimitiveGroup / VertexFormat**：几何缓冲的字段（顶点属性、索引、LOD）。  
- **MaterialDesc**：材质槽字段（贴图路径、压缩方式、UV 通道）。  
- **AnimationChannel / Track**：动画轨道字段（名称、帧率、循环、事件）。  

### 模块职责
- 提供 **通用数据结构**（几何、材质、动画、LOD）。  
- 提供 **序列化接口**（字节序、块头、版本号）。  
- 提供 **错误码与日志接口**（导出器统一调用）。  

### 调用关系
- `visualexporter` / `mayavisualexporter` → 调用 exporter_common 的数据结构和写入函数。  
- `modeleditor` → 读取这些结构，验证导出结果。  

👉 在 Blender 插件中对应：`core/data_structures.py`、`core/serializer.py`、`core/logger.py`。

---

## 🔎 Step 2：visualexporter（3ds Max 导出器）
这是最关键的部分，定义了从 DCC 到 BigWorld 文件的导出流程。

### 字段
- **ExportSettings**：导出根目录、纹理路径、坐标系、单位。  
- **ExportObject**：对象类型（静态/角色/碰撞/门户）、资源ID、分组。  
- **LODInfo**：LOD 层级、自动生成规则。  
- **HardPoint**：名称、类型、矩阵。  

### 模块职责
- 负责 **UI → 数据结构** 的映射。  
- 调用 exporter_common 写 `.primitives`、`.visual`、`.model`。  
- 调用 animationexporter 写 `.animation`。  
- 调用 collisionexporter 写 `.collision`。  

### 调用关系
- UI → ExportOperator → ExportPipeline → Writer → exporter_common。  

👉 在 Blender 插件中对应：`operators/export_operator.py`、`pipeline/static_pipeline.py`、`writers/*_writer.py`。

---

## 🔎 Step 3：mayavisualexporter
与 visualexporter 类似，但针对 Maya。  
作用：**交叉验证字段一致性**，确保不同 DCC 导出结果相同。  

👉 在 Blender 插件中主要用于 **对照验证**，不直接实现。

---

## 🔎 Step 4：modeleditor / modeleditor_core
这是 BigWorld 的产物消费端，能反推导出文件的字段要求。

### 字段
- `.visual`：几何引用、材质槽、LOD。  
- `.model`：引用 `.visual`、`.animation`、`.collision`。  
- `.portal`：空间 ID、法线方向。  

### 模块职责
- 加载并验证导出文件。  
- 提供错误提示（缺少引用、字段不一致）。  

👉 在 Blender 插件中对应：`validate_operator.py` + `core/validator.py`。

---

## 🔎 Step 5：asset_pipeline / resourcechecker
负责资源打包、路径策略、校验。

### 字段
- **ManifestEntry**：产物清单（文件名、依赖、时间戳）。  
- **AuditEntry**：日志条目（错误码、警告、建议）。  

### 模块职责
- 定义目录策略（按类型/包/LOD）。  
- 定义校验规则（UV、法线、命名、纹理路径）。  

👉 在 Blender 插件中对应：`utils/path_policy.py`、`writers/manifest_writer.py`、`writers/audit_writer.py`。

---

## ✅ 功能 → 模块 → 文件 → 接口（示例表）

| 功能需求        | 模块职责         | 文件位置 (Blender 插件) | 接口/类 |
|-----------------|------------------|-------------------------|---------|
| 导出前检测      | 校验             | core/validator.py       | `validate_object()` |
| 写 primitives   | 几何写入         | writers/primitives_writer.py | `write_primitives()` |
| 写 visual.xml   | XML 渲染         | writers/visual_writer.py | `write_visual()` |
| 写 model.xml    | XML 渲染         | writers/model_writer.py | `write_model()` |
| 写 animation    | 动画写入         | writers/animation_writer.py | `write_animation()` |
| 写 collision    | 碰撞写入         | writers/collision_writer.py | `write_collision()` |
| 写 portal.xml   | 门户写入         | writers/portal_writer.py | `write_portal()` |
| 生成 manifest   | 清单生成         | writers/manifest_writer.py | `write_manifest()` |
| 写 audit.log    | 日志生成         | writers/audit_writer.py | `write_audit()` |
| 坐标系转换      | 坐标适配         | core/coordinate_system.py | `convert_coords()` |
| 路径策略        | 路径生成         | utils/path_policy.py    | `resolve_path()` |

---


---

## 🔎 Step 2：抽取 `.visual` 文件结构（核心）

在 BigWorld 工具链（`exporter_common` + `visualexporter` + `modeleditor`）中，`.visual` 文件是最关键的描述文件，负责把几何、材质、LOD、硬点等信息组织起来。

### `.visual` 主要字段
- **header**：版本号、依赖信息  
- **renderSet[]**：渲染集（每个 renderSet 对应一个材质/几何组合）  
  - **geometry**：引用 `.primitives` 文件  
  - **material**：材质槽（贴图路径、shader、压缩方式）  
- **LOD**：LOD 层级、切换距离  
- **hardPoints[]**：硬点（名称、类型、矩阵）  
- **boundingBox / boundingSphere**：包围盒/球  
- **portal / bsp**：门户或空间分割信息（可选）

👉 在 Blender 插件中对应：`writers/visual_writer.py` + `core/data_structures.Visual`.

---

## 🔎 Step 3：抽取 `.model` 文件结构

`.model` 是更高层的描述文件，负责把 `.visual`、`.animation`、`.collision` 等组合起来。

### `.model` 主要字段
- **header**：版本号、依赖  
- **visual**：引用 `.visual` 文件  
- **animations[]**：动画轨道列表（引用 `.animation` 文件）  
- **collision**：引用 `.collision` 文件（可选）  
- **portal**：引用 `.portal` 文件（可选）  
- **meta**：资源 ID、分组、标签  

👉 在 Blender 插件中对应：`writers/model_writer.py`.

---

## 🔎 Step 4：抽取 `.primitives` 文件结构

`.primitives` 是二进制几何文件，包含顶点缓冲、索引缓冲、LOD 信息。

### `.primitives` 主要字段
- **header**：magic、版本号、字节序  
- **vertexBuffer[]**：顶点属性（位置、法线、切线、UV、颜色）  
- **indexBuffer[]**：索引数据  
- **primitiveGroup[]**：子网格（起始索引、数量、材质 ID）  
- **LOD[]**：LOD 层级对应的 primitiveGroup 范围  

👉 在 Blender 插件中对应：`writers/primitives_writer.py` + `core/serializer.py`.

---

## 🔎 Step 5：dataclass 草稿（Python 版）

```python
@dataclass
class HardPoint:
    name: str
    type: str   # mount / interact / fx
    matrix: List[List[float]]

@dataclass
class MaterialSlot:
    name: str
    base_color: str
    normal: str
    orm: str
    compression: str  # DXT5 / BC7 / None

@dataclass
class Visual:
    version: int
    render_sets: List[str]
    materials: List[MaterialSlot]
    lod_levels: List[str]
    hardpoints: List[HardPoint]
    bounding_box: Tuple[float, float, float, float, float, float]

@dataclass
class Model:
    version: int
    visual: str
    animations: List[str]
    collision: Optional[str]
    portal: Optional[str]
    meta: Dict[str, str]

@dataclass
class Primitives:
    version: int
    vertex_buffer: bytes
    index_buffer: bytes
    primitive_groups: List[Dict]
    lods: List[Dict]
```

---



## 🔎 Step 6：`.animation` 文件结构

在 BigWorld 工具链中，`.animation` 文件是角色动画的核心数据文件，通常由 **animationexporter** 或 **visualexporter** 调用生成。

### 主要字段
- **header**：版本号、帧率、总帧数  
- **skeleton**：骨架引用（骨骼名称、层级关系）  
- **channels[]**：动画轨道列表  
  - **name**：轨道名（通常对应骨骼名）  
  - **keyframes[]**：关键帧数据（时间戳、位置、旋转、缩放）  
  - **loop**：是否循环  
  - **events[]**：事件标签（如 IsCoordinated、IsImpacting）  

### 模块职责
- 提供角色动画的关键帧数据  
- 支持事件标签（交互动画、碰撞响应）  
- 与 `.model` 文件中的 `animations[]` 字段关联  

👉 在 Blender 插件中对应：`writers/animation_writer.py`，数据结构在 `core/data_structures.AnimationTrack`。

---

## 🔎 Step 7：`.collision` 文件结构

`.collision` 文件是物理碰撞体的描述文件，通常由 **collisionexporter** 或 **visualexporter** 生成。

### 主要字段
- **header**：版本号、碰撞体类型  
- **mesh**：网格数据（顶点、索引）  
- **hull**：凸包数据（可选）  
- **simplified**：简化网格（LOD 用）  
- **layer**：碰撞层（物理分组）  
- **boundingBox**：包围盒  

### 模块职责
- 提供物理引擎使用的碰撞体数据  
- 支持多种生成方式（网格、简化、凸包）  
- 与 `.model` 文件中的 `collision` 字段关联  

👉 在 Blender 插件中对应：`writers/collision_writer.py`，数据结构在 `core/data_structures.Collision`.

---

## 🔎 Step 8：dataclass 草稿（Python 版）

```python
@dataclass
class AnimationEvent:
    name: str
    frame: int

@dataclass
class AnimationChannel:
    bone_name: str
    keyframes: List[Dict]  # {time, position, rotation, scale}
    loop: bool
    events: List[AnimationEvent]

@dataclass
class Animation:
    version: int
    frame_rate: int
    total_frames: int
    skeleton: str
    channels: List[AnimationChannel]

@dataclass
class Collision:
    version: int
    type: str  # mesh / hull / simplified
    vertices: List[Tuple[float, float, float]]
    indices: List[int]
    layer: str
    bounding_box: Tuple[float, float, float, float, float, float]
```

---

## 🔎 Step 9：调用关系（功能 → 模块 → 文件 → 接口）

| 功能需求        | 模块职责         | 文件位置 (Blender 插件) | 接口/类 |
|-----------------|------------------|-------------------------|---------|
| 写 animation    | 动画写入         | writers/animation_writer.py | `write_animation(Animation)` |
| 写 collision    | 碰撞写入         | writers/collision_writer.py | `write_collision(Collision)` |
| 动画轨道校验    | 骨架一致性、事件标签 | core/validator.py | `validate_animation()` |
| 碰撞体校验      | 凸包/简化可用性  | core/validator.py | `validate_collision()` |

---



---

## 🔎 Step 10：`.portal` 文件结构

在 BigWorld 工具链中，`.portal` 文件用于描述 **空间连接与可见性**，主要出现在室内/分区场景中。它通常由 **visualexporter** 或 **worldeditor** 生成，并在 `.model` 文件中被引用。

### 主要字段
- **header**：版本号、空间 ID  
- **plane**：门户平面（法线向量 + 距离）  
- **vertices[]**：门户多边形顶点（通常是矩形或凸多边形）  
- **normalCheck**：法线方向校验（保证朝向一致）  
- **adjacentSpace**：相邻空间 ID（portal 连接的另一侧空间）  
- **flags**：门户属性（双向/单向/遮挡）  

---

## 🔎 Step 11：dataclass 草稿（Python 版）

```python
@dataclass
class Portal:
    version: int
    space_id: str
    adjacent_space: str
    plane: Tuple[float, float, float, float]  # 法线 + 距离
    vertices: List[Tuple[float, float, float]]
    normal_check: bool
    flags: List[str]  # e.g. ["two_sided", "occluder"]
```

---

## 🔎 Step 12：调用关系（功能 → 模块 → 文件 → 接口）

| 功能需求        | 模块职责         | 文件位置 (Blender 插件) | 接口/类 |
|-----------------|------------------|-------------------------|---------|
| 写 portal.xml   | 门户写入         | writers/portal_writer.py | `write_portal(Portal)` |
| 门户校验        | 空间 ID、法线方向 | core/validator.py       | `validate_portal()` |
| 门户路径策略    | 目录/引用生成     | utils/path_policy.py    | `resolve_portal_path()` |

---

## 🔎 Step 13：五大产物 schema 总结

1. **Primitives** → 几何缓冲（顶点/索引/LOD）  
2. **Visual** → 渲染集（材质槽、几何引用、硬点、包围盒）  
3. **Model** → 组合文件（引用 visual/animation/collision/portal）  
4. **Animation** → 骨架轨道（关键帧、循环、事件）  
5. **Collision** → 碰撞体（网格/凸包/简化、层级）  
6. **Portal** → 空间连接（plane、vertices、adjacentSpace、flags）

---


---

## 🗂️ 功能 → 模块 → 文件 → 接口（总表）

### 1. 导出前检测（Validator）
- **功能**：几何、UV、材质、命名、动画、碰撞、门户校验  
- **模块职责**：统一校验逻辑，输出 UI 摘要 + audit.log  
- **文件**：`core/validator.py`  
- **接口**：  
  - `validate_geometry(obj)`  
  - `validate_uv(obj)`  
  - `validate_material(obj)`  
  - `validate_naming(obj)`  
  - `validate_animation(anim)`  
  - `validate_collision(col)`  
  - `validate_portal(portal)`  

---

### 2. 几何导出（Primitives）
- **功能**：写入 `.primitives` 文件  
- **模块职责**：顶点缓冲、索引缓冲、LOD、字节序  
- **文件**：`writers/primitives_writer.py`  
- **接口**：  
  - `write_primitives(Primitives, path)`  

---

### 3. 渲染描述（Visual）
- **功能**：写入 `.visual` 文件  
- **模块职责**：材质槽、几何引用、LOD、硬点、包围盒  
- **文件**：`writers/visual_writer.py`  
- **接口**：  
  - `write_visual(Visual, path)`  

---

### 4. 模型组合（Model）
- **功能**：写入 `.model/.xml` 文件  
- **模块职责**：组合 visual/animation/collision/portal  
- **文件**：`writers/model_writer.py`  
- **接口**：  
  - `write_model(Model, path)`  

---

### 5. 动画导出（Animation）
- **功能**：写入 `.animation` 文件  
- **模块职责**：骨架轨道、关键帧、循环、事件标签  
- **文件**：`writers/animation_writer.py`  
- **接口**：  
  - `write_animation(Animation, path)`  

---

### 6. 碰撞导出（Collision）
- **功能**：写入 `.collision` 文件  
- **模块职责**：网格/凸包/简化、层级、包围盒  
- **文件**：`writers/collision_writer.py`  
- **接口**：  
  - `write_collision(Collision, path)`  

---

### 7. 门户导出（Portal）
- **功能**：写入 `.portal.xml` 文件  
- **模块职责**：空间 ID、法线方向、相邻空间、顶点  
- **文件**：`writers/portal_writer.py`  
- **接口**：  
  - `write_portal(Portal, path)`  

---

### 8. 清单与日志
- **功能**：生成 `manifest.json` 与 `audit.log`  
- **模块职责**：产物清单、依赖关系、错误码追踪  
- **文件**：  
  - `writers/manifest_writer.py`  
  - `writers/audit_writer.py`  
- **接口**：  
  - `write_manifest(entries, path)`  
  - `write_audit(logs, path)`  

---

### 9. 公共核心层（Core）
- **功能**：提供通用服务  
- **文件与接口**：  
  - `core/serializer.py` → `serialize_vertex_buffer()`  
  - `core/coordinate_system.py` → `convert_coords()`  
  - `core/dependency_graph.py` → `resolve_dependencies()`  
  - `core/logger.py` → `log_error(code, msg)`  
  - `core/xml_writer.py` → `render(template, data)`  

---

### 10. 工具层（Utils）
- **功能**：路径策略、命名规则、材质绑定、纹理校验、二进制对比  
- **文件与接口**：  
  - `utils/path_policy.py` → `resolve_path(obj)`  
  - `utils/naming_checker.py` → `check_naming(obj)`  
  - `utils/material_binder.py` → `bind_material(blender_mat)`  
  - `utils/texture_resolver.py` → `check_texture(path)`  
  - `utils/hex_diff.py` → `compare_binary(file1, file2)`  

---


---

## 1. 骨架结构（Skeleton）

### 数据结构
```python
@dataclass
class SkeletonBone:
    name: str
    parent: Optional[str]
    bind_matrix: List[List[float]]   # 4x4 绑定矩阵
    inverse_bind_matrix: List[List[float]]

@dataclass
class Skeleton:
    bones: List[SkeletonBone]
    root: str
    version: int
```

### 要点
- **骨骼层级**：父子关系必须完整，避免孤立骨骼。  
- **矩阵**：同时保存绑定矩阵与逆矩阵，方便动画计算。  
- **引用**：`.animation` 文件中的轨道必须引用 `SkeletonBone.name`。  

---

## 2. 动画事件枚举

### 枚举定义
```python
class AnimationEventType(Enum):
    IS_COORDINATED = "IsCoordinated"
    IS_IMPACTING = "IsImpacting"
    FOOTSTEP = "Footstep"
    ATTACK = "Attack"
    CUSTOM = "Custom"
```

### 要点
- **标准事件**：IsCoordinated、IsImpacting（BigWorld 原生）。  
- **扩展事件**：Footstep、Attack 等常见交互。  
- **自定义事件**：允许开发者扩展，写入 `.animation` 的 events[]。  

---

## 3. 材质槽扩展字段

### 数据结构
```python
@dataclass
class MaterialSlot:
    name: str
    base_color: str
    normal: str
    orm: str
    specular: Optional[str] = None
    emissive: Optional[str] = None
    alpha: Optional[str] = None
    compression: str = "None"  # DXT5 / BC7 / None
    uv_channel: int = 0
```

### 要点
- **必选槽**：BaseColor、Normal、ORM。  
- **可选槽**：Specular、Emissive、Alpha。  
- **压缩策略**：与 BigWorld 工具链一致（DXT5/BC7）。  

---

## 4. manifest.json 结构

### 数据结构
```python
@dataclass
class ManifestEntry:
    file: str
    type: str  # primitives / visual / model / animation / collision / portal
    dependencies: List[str]
    hash: str
    timestamp: str

@dataclass
class Manifest:
    version: int
    entries: List[ManifestEntry]
```

### 要点
- **依赖关系**：visual → primitives/collision，model → visual/animation。  
- **hash**：MD5 或 SHA1，保证可追溯性。  
- **timestamp**：导出时间，便于比对。  

---

## 5. audit.log 错误码体系

### 错误码分类
- **GEO001**：非流形几何  
- **GEO002**：法线不一致  
- **UV001**：UV 越界  
- **UV002**：UV 重叠  
- **MAT001**：材质槽缺失  
- **MAT002**：纹理路径无效  
- **NAM001**：命名不符合规范  
- **ANM001**：动画轨道缺失骨骼  
- **ANM002**：事件标签无效  
- **COL001**：碰撞体生成失败  
- **POR001**：门户法线方向错误  

### 数据结构
```python
@dataclass
class AuditEntry:
    code: str
    message: str
    severity: str  # ERROR / WARNING / INFO
    object: Optional[str]
```

---

## 6. 事务控制模块

### 设计
- **临时目录**：所有导出文件先写入临时目录。  
- **校验**：调用 validator 校验产物。  
- **提交**：校验通过后移动到目标路径。  
- **回滚**：失败时清理临时目录，写入 audit.log。  

### 接口
```python
class ExportTransaction:
    def __init__(self, target_dir: str): ...
    def begin(self): ...
    def commit(self): ...
    def rollback(self, reason: str): ...
```

---

## 7. UI → 数据结构映射方法

### 设计
- **偏好设置（Preferences）** → 全局配置 dataclass（路径、坐标系、单位、模板）。  
- **对象面板（Object Panel）** → `Visual` / `Collision` / `Animation` / `Portal` dataclass。  
- **导出面板（Export Panel）** → `ExportSettings` dataclass。  

### 示例
```python
def collect_object_settings(obj) -> Visual:
    return Visual(
        version=1,
        render_sets=[...],
        materials=[...],
        lod_levels=[...],
        hardpoints=[...],
        bounding_box=compute_bbox(obj)
    )
```

---
**简要回答：旧版 BigWorld 插件的路径系统核心逻辑是：UI/导出器收集用户设置 → 统一调用 PathManager/PathResolver → 内部将 Blender/Max 的绝对路径转换为 BigWorld 资源相对路径 → Writer 写入文件时只保存相对路径。读取时，工具链（ModelEditor/WorldEditor）再通过资源根目录拼接成绝对路径。**

---

## 🔎 旧版插件路径系统实现方法

### 1. 路径类型
- **绝对路径**：用户在 DCC 工具（3ds Max/Maya/Blender）里选择的磁盘路径，例如：  
  `D:/project/assets/characters/hero.fbx`
- **相对路径**：BigWorld 引擎内部使用的资源路径，相对于资源根目录，例如：  
  `characters/hero.visual`

### 2. 模块职责
- **UI 层**：用户在插件偏好设置里指定“导出根目录”“纹理根目录”。  
- **PathManager / PathResolver**：负责路径转换逻辑。  
- **Writer 层**：写入 `.visual/.model/.xml` 时调用 PathResolver，确保写入相对路径。  
- **Reader 层（ModelEditor/WorldEditor）**：加载时再拼接资源根目录，解析为绝对路径。

### 3. 调用关系
```
UI (preferences.py) → ExportOperator → PathPolicy/PathResolver → Writer
```

- **导出时**：  
  - `ExportOperator` 收集对象数据（绝对路径）。  
  - 调用 `utils/path_policy.py` → `resolve_path()`。  
  - 转换为相对路径，传给 Writer。  
  - Writer 写入文件时只保存相对路径。

- **读取时**：  
  - `modeleditor` 打开 `.visual` 或 `.model`。  
  - 解析相对路径字段。  
  - 拼接资源根目录（engine_config.xml 中定义的 res_path）。  
  - 转换为绝对路径，加载文件。

---

## 🔎 源码实现方式（旧版 Max/Maya 插件参考）

### 1. 路径解析函数
```python
def resolve_path(abs_path: str, root: str) -> str:
    """
    将绝对路径转换为相对路径
    abs_path: D:/project/assets/characters/hero.fbx
    root: D:/project/assets/
    return: characters/hero.fbx
    """
    if abs_path.startswith(root):
        return os.path.relpath(abs_path, root).replace("\\", "/")
    else:
        raise ValueError("路径不在资源根目录下")
```

### 2. 写入时调用
```python
def write_visual(visual: Visual, path: str, root: str):
    rel_path = resolve_path(visual.geometry, root)
    xml = f"<geometry>{rel_path}</geometry>"
    save_file(path, xml)
```

### 3. 读取时调用（ModelEditor）
```cpp
// C++ 伪代码
std::string VisualLoader::resolvePath(const std::string& relPath) {
    return ResourceSystem::instance().root() + "/" + relPath;
}
```

---

## 🔎 关键点总结
- **导出时**：始终写相对路径（相对于导出根/纹理根）。  
- **读取时**：引擎工具拼接资源根目录，恢复绝对路径。  
- **调用链**：UI → ExportOperator → PathResolver → Writer。  
- **函数核心**：`resolve_path(abs_path, root)`（导出），`resolvePath(relPath)`（读取）。  

---

Rick，要不要我帮你把 **新版 Blender 插件的 PathPolicy 设计稿**写出来？包括：  
- `resolve_export_path()`（导出时绝对→相对）  
- `resolve_import_path()`（读取时相对→绝对）  
- `validate_path()`（校验路径是否在根目录下）  

这样你就能直接落地到 `utils/path_policy.py`。


**简答：要彻底搞清 `.primitives` 格式，必须结合 BigWorld 最新源码（14.4.1 工具链）与旧版文档（File Grammar Guide ch03/ch27/ch30）。文档提供语法框架，源码提供最终实现。下面我为你整理一份完整详解，涵盖容器结构、字段、写入流程、旧版插件逻辑、Blender 迁移方案与验证闭环。**

---

# 🗂️ BigWorld `.primitives` 文件详解（源码对齐版）

## 1. 容器层：BinSection
- **本质**：`.primitives` 是一个 **BinSection 包**。  
- **结构**：
  - **magic number**：0x42A14E65  
  - **binary_blob[]**：每个子块的数据，4 字节对齐  
  - **index_table[]**：记录子块 tag、偏移、长度、版本、时间戳  
- **意义**：允许在一个文件中存放多个 section（顶点、索引、BSP）。

---

## 2. 核心子块（源码 + 文档对齐）

### (1) 顶点数据块
- **vertex_format**：64 字节字符串（如 `"xyznuv"`, `"xyznuvtb"`），源码中由 `VertexFormat` 动态生成。  
- **num_vertices**：顶点数量。  
- **raw_vertex_data**：逐顶点写入，按 vertex_format 顺序：  
  - 位置 (x,y,z)  
  - 法线 (nx,ny,nz)  
  - UV (u,v)  
  - 可选：切线、副切线、颜色、额外 UV  

### (2) 索引数据块
- **index_format**：`list` (16 位) 或 `list32` (32 位)，源码中根据顶点数选择。  
- **num_indices**：索引数量。  
- **num_primitive_groups**：子网格数量。  
- **indices[]**：索引数组。  
- **primitive_groups[]**：每组包含：  
  - start_index  
  - num_primitives  
  - start_vertex  
  - num_vertices  
  - material_id（源码中可能扩展）

### (3) BSP 数据块（可选）
- 用于静态场景的空间划分。  
- 包含三角形、节点、用户数据。  
- 源码中 `BSPTree` 负责写入。

---

## 3. 写入顺序（源码确认）
1. Header（BinSection magic + index table 占位）  
2. Vertex section  
3. Index section  
4. PrimitiveGroup 数据  
5. BSP section（可选）  
6. 回填 index_table  

👉 **所有子块必须 4 字节对齐**。

---

## 4. 旧版插件（3ds Max/Maya）逻辑
- **采样数据**：顶点、法线、UV、切线、顶点色。  
- **转换**：Z-up → Y-up，单位换算到米。  
- **三角化**：所有面转三角形。  
- **索引压缩**：顶点数 < 65536 → 16 位，否则 32 位。  
- **分组**：按材质/对象划分 PrimitiveGroup。  
- **LOD**：根据规则生成多个 group 段。  
- **写入**：调用 `PrimitiveFileWriter`，逐块写入。

---

## 5. Blender 插件迁移方案

### (1) 数据采样
- 使用 `bmesh` 获取顶点、法线、UV、颜色。  
- 三角化 → 坐标系转换 → 单位缩放。  

### (2) 构建 VertexFormat
- 动态生成字符串（如 `"xyznuvtb"`）。  
- 与 BigWorld 源码的 `VertexFormat` 对齐。  

### (3) Writer 流程
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # 顶点数据
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # 索引数据
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) 打包与提交
- 临时目录写入 → 校验 → 提交目标路径。  
- 失败 → 回滚并写 audit.log。  
- manifest.json 登记产物、hash、依赖。

---

## 6. 验证闭环
- **hex diff**：与旧版 3ds Max 插件产物逐字节对比。  
- **ModelEditor**：加载 `.visual` 引用的 `.primitives`，验证渲染正确。  
- **Validator**：检查非流形、UV 越界、法线一致性。

---

# ✅ 总结
- `.primitives` = **BinSection 包**，包含顶点、索引、PrimitiveGroup、可选 BSP。  
- **源码优先**：字段、顺序、对齐以 `exporter_common/PrimitiveFileWriter` 为准。  
- **Blender 插件迁移**：采样 mesh → 构建 VertexFormat → BinSectionWriter → manifest/audit。  
- **验证闭环**：hex diff + ModelEditor + Validator。  

---


---

# 🗂️ BigWorld `.primitives` 文件详解（源码对齐版）

## 1. 容器层：BinSection
- **本质**：`.primitives` 是一个 **BinSection** 文件。  
- **结构**：
  - **magic number**：0x42A14E65  
  - **binary_blob[]**：每个子块的数据，4 字节对齐  
  - **index_table[]**：记录子块 tag、偏移、长度、版本、时间戳  
- **源码位置**：`resmgr/bin_section.cpp` 定义了 BinSection 的读写逻辑。  

---

## 2. 核心子块（源码确认）

### (1) 顶点数据块
- **字段**：
  - `vertex_format`：64 字节字符串（源码中由 `VertexFormat` 类生成）  
  - `num_vertices`：uint32  
  - `raw_vertex_data`：逐顶点写入，按 `VertexFormat` 顺序  
- **源码位置**：`exporter_common/vertex_format.cpp`、`primitive_file_writer.cpp`  

### (2) 索引数据块
- **字段**：
  - `index_format`：字符串 `"list"` 或 `"list32"`  
  - `num_indices`：uint32  
  - `num_primitive_groups`：uint32  
  - `indices[]`：16/32 位索引数组  
  - `primitive_groups[]`：每组包含 start_index、num_primitives、start_vertex、num_vertices  
- **源码位置**：`exporter_common/primitive_group.cpp`  

### (3) BSP 数据块（可选）
- **字段**：BSP 节点、三角形、用户数据  
- **源码位置**：`exporter_common/bsp_writer.cpp`  

---

## 3. 写入顺序（源码确认）
1. Header（BinSection magic + index table 占位）  
2. Vertex section  
3. Index section  
4. PrimitiveGroup 数据  
5. BSP section（可选）  
6. 回填 index_table  

👉 **所有子块必须 4 字节对齐**（源码中 `BinaryFile::align()` 实现）。

---

## 4. 旧版插件（3ds Max/Maya）逻辑
- **采样数据**：顶点、法线、UV、切线、顶点色。  
- **转换**：Z-up → Y-up，单位换算到米。  
- **三角化**：所有面转三角形。  
- **索引压缩**：顶点数 < 65536 → 16 位，否则 32 位。  
- **分组**：按材质/对象划分 PrimitiveGroup。  
- **LOD**：根据规则生成多个 group 段。  
- **写入**：调用 `PrimitiveFileWriter::write()`。

---

## 5. Blender 插件迁移方案

### (1) 数据采样
- 使用 `bmesh` 获取顶点、法线、UV、颜色。  
- 三角化 → 坐标系转换 → 单位缩放。  

### (2) 构建 VertexFormat
- 动态生成字符串（如 `"xyznuvtb"`）。  
- 与 BigWorld 源码的 `VertexFormat` 对齐。  

### (3) Writer 流程（对齐源码）
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # 顶点数据
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # 索引数据
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) 打包与提交
- 临时目录写入 → 校验 → 提交目标路径。  
- 失败 → 回滚并写 audit.log。  
- manifest.json 登记产物、hash、依赖。

---

## 6. 验证闭环
- **hex diff**：与旧版 3ds Max 插件产物逐字节对比。  
- **ModelEditor**：加载 `.visual` 引用的 `.primitives`，验证渲染正确。  
- **Validator**：检查非流形、UV 越界、法线一致性。

---

# ✅ 最终结论
- `.primitives` 是 **BinSection 包**，字段与顺序必须以 **源码中的 `PrimitiveFileWriter`** 为准。  
- 文档提供语法框架，但源码才是最终标准。  

- Blender 插件实现时：**采样 mesh → 构建 VertexFormat → BinSectionWriter → manifest/audit → 验证闭环**。  
**好的 ✅ Rick，我们就来做一份“源码级别”的 `.primitives` 写入规范整理”，以 BigWorld 14.4.1 工具链中的 `exporter_common` / `visualexporter` / `modeleditor_core` 为最终基准。**

---

# 🗂️ BigWorld `.primitives` 文件详解（源码对齐版）

## 1. 容器层：BinSection
- **本质**：`.primitives` 是一个 **BinSection** 文件。  
- **结构**：
  - **magic number**：0x42A14E65  
  - **binary_blob[]**：每个子块的数据，4 字节对齐  
  - **index_table[]**：记录子块 tag、偏移、长度、版本、时间戳  
- **源码位置**：`resmgr/bin_section.cpp` 定义了 BinSection 的读写逻辑。  

---

## 2. 核心子块（源码确认）

### (1) 顶点数据块
- **字段**：
  - `vertex_format`：64 字节字符串（源码中由 `VertexFormat` 类生成）  
  - `num_vertices`：uint32  
  - `raw_vertex_data`：逐顶点写入，按 `VertexFormat` 顺序  
- **源码位置**：`exporter_common/vertex_format.cpp`、`primitive_file_writer.cpp`  

### (2) 索引数据块
- **字段**：
  - `index_format`：字符串 `"list"` 或 `"list32"`  
  - `num_indices`：uint32  
  - `num_primitive_groups`：uint32  
  - `indices[]`：16/32 位索引数组  
  - `primitive_groups[]`：每组包含 start_index、num_primitives、start_vertex、num_vertices  
- **源码位置**：`exporter_common/primitive_group.cpp`  

### (3) BSP 数据块（可选）
- **字段**：BSP 节点、三角形、用户数据  
- **源码位置**：`exporter_common/bsp_writer.cpp`  

---

## 3. 写入顺序（源码确认）
1. Header（BinSection magic + index table 占位）  
2. Vertex section  
3. Index section  
4. PrimitiveGroup 数据  
5. BSP section（可选）  
6. 回填 index_table  

👉 **所有子块必须 4 字节对齐**（源码中 `BinaryFile::align()` 实现）。

---

## 4. 旧版插件（3ds Max/Maya）逻辑
- **采样数据**：顶点、法线、UV、切线、顶点色。  
- **转换**：Z-up → Y-up，单位换算到米。  
- **三角化**：所有面转三角形。  
- **索引压缩**：顶点数 < 65536 → 16 位，否则 32 位。  
- **分组**：按材质/对象划分 PrimitiveGroup。  
- **LOD**：根据规则生成多个 group 段。  
- **写入**：调用 `PrimitiveFileWriter::write()`。

---

## 5. Blender 插件迁移方案

### (1) 数据采样
- 使用 `bmesh` 获取顶点、法线、UV、颜色。  
- 三角化 → 坐标系转换 → 单位缩放。  

### (2) 构建 VertexFormat
- 动态生成字符串（如 `"xyznuvtb"`）。  
- 与 BigWorld 源码的 `VertexFormat` 对齐。  

### (3) Writer 流程（对齐源码）
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # 顶点数据
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # 索引数据
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) 打包与提交
- 临时目录写入 → 校验 → 提交目标路径。  
- 失败 → 回滚并写 audit.log。  
- manifest.json 登记产物、hash、依赖。

---

## 6. 验证闭环
- **hex diff**：与旧版 3ds Max 插件产物逐字节对比。  
- **ModelEditor**：加载 `.visual` 引用的 `.primitives`，验证渲染正确。  
- **Validator**：检查非流形、UV 越界、法线一致性。

---

# ✅ 最终结论
- `.primitives` 是 **BinSection 包**，字段与顺序必须以 **源码中的 `PrimitiveFileWriter`** 为准。  
- 文档提供语法框架，但源码才是最终标准。  
- Blender 插件实现时：**采样 mesh → 构建 VertexFormat → BinSectionWriter → manifest/audit → 验证闭环**。  
- 下一步：逐行解析 `PrimitiveFileWriter::write()`，形成“逐字段对齐表”，作为 Blender 插件的最终实现蓝本。  

---


---

# 🗂️ Step 1：定位源码位置
在 BigWorld 14.4.1 工具链中，`.primitives` 的写入逻辑主要分布在：
- `programming/bigworld/tools/exporter_common/primitive_file_writer.cpp`  
- `programming/bigworld/tools/exporter_common/vertex_format.cpp`  
- `programming/bigworld/tools/exporter_common/primitive_group.cpp`  
- `programming/bigworld/tools/exporter_common/bsp_writer.cpp`  

👉 这些文件共同定义了 **顶点格式、索引缓冲、PrimitiveGroup、BSP** 的写入。

---

# 🗂️ Step 2：PrimitiveFileWriter::write() 的职责
源码中的 `PrimitiveFileWriter::write()` 是导出 `.primitives` 的核心函数，职责是：
1. 打开一个 **BinSectionWriter**（二进制容器写入器）。  
2. 写入 **顶点数据块**（调用 VertexFormat + VertexBuffer）。  
3. 写入 **索引数据块**（调用 IndexBuffer + PrimitiveGroup）。  
4. 写入 **BSP 数据块**（可选）。  
5. 回填 **index_table**，完成 BinSection。  

---

# 🗂️ Step 3：逐字段写入表（源码对齐）

| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 1 | vertex_format | char[64] | VertexFormat::string() | 顶点通道描述，如 `"xyznuvtb"` |
| 2 | num_vertices | uint32 | mesh.vertices.size() | 顶点数量 |
| 3 | raw_vertex_data | float[] | mesh.vertices | 按 vertex_format 顺序写入 |
| 4 | index_format | string | `"list"` / `"list32"` | 顶点数 < 65536 → list |
| 5 | num_indices | uint32 | mesh.indices.size() | 索引数量 |
| 6 | num_primitive_groups | uint32 | mesh.groups.size() | 子网格数量 |
| 7 | indices[] | uint16/uint32[] | mesh.indices | 三角形索引 |
| 8 | primitive_group.start_index | uint32 | group.start | 起始索引 |
| 9 | primitive_group.num_primitives | uint32 | group.count/3 | 三角形数量 |
| 10 | primitive_group.start_vertex | uint32 | group.min_vertex | 顶点起始 |
| 11 | primitive_group.num_vertices | uint32 | group.vertex_count | 顶点数量 |
| 12 | bsp_section (可选) | struct | BSPWriter | 空间划分数据 |

---

# 🗂️ Step 4：旧版插件的调用链
- **3ds Max 插件**：采样网格 → 调用 `PrimitiveFileWriter::write()` → 生成 `.primitives`。  
- **Maya 插件**：逻辑相同，调用相同的 `exporter_common`。  
- **ModelEditor**：调用 `PrimitiveFileReader` 解析 `.primitives`，验证字段。  

---

# 🗂️ Step 5：Blender 插件迁移实现
在 Blender 插件中，我们需要实现一个 **PrimitivesWriter**，对齐源码逻辑：

```python
class PrimitivesWriter:
    def __init__(self, filepath):
        self.bw = BinSectionWriter(filepath)

    def write(self, mesh, vertex_format):
        # 顶点数据
        self.bw.begin_section("vertices")
        self.bw.write_string(vertex_format.ljust(64, '\0'))
        self.bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            self.bw.write_vector3(v.co)
            self.bw.write_vector3(v.normal)
            self.bw.write_uv(v.uv)
        self.bw.end_section()

        # 索引数据
        self.bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        self.bw.write_string(fmt)
        self.bw.write_uint32(len(mesh.indices))
        self.bw.write_uint32(len(mesh.groups))
        self.bw.write_indices(mesh.indices)
        for g in mesh.groups:
            self.bw.write_uint32(g.start_index)
            self.bw.write_uint32(g.num_primitives)
            self.bw.write_uint32(g.start_vertex)
            self.bw.write_uint32(g.num_vertices)
        self.bw.end_section()
```

---

# 🗂️ Step 6：验证闭环
1. **hex diff**：与旧版 3ds Max 插件产物逐字节对比。  
2. **ModelEditor**：加载 `.visual` 引用的 `.primitives`，验证渲染正确。  
3. **Validator**：检查非流形、UV 越界、法线一致性。  

---

✅ **总结**：  
我们已经完成了 **PrimitiveFileWriter::write() 的逐字段对齐表**，明确了写入顺序、字段类型、数据来源。  
接下来可以继续解析 **`vertex_format.cpp`**，确认顶点格式字符串的生成规则（哪些通道、顺序、数据类型），这是 Blender 插件实现的下一个关键点。  

**好的 ✅ Rick，我们继续，进入下一步：解析 `vertex_format.cpp`，把顶点格式字符串的生成规则彻底梳理出来。**

---

# 🗂️ Step 2：VertexFormat 生成规则（源码对齐）

在 BigWorld 的 `exporter_common/vertex_format.cpp` 中，定义了 **VertexFormat** 类，它负责描述顶点缓冲的通道顺序和数据类型。`.primitives` 文件里写入的 **64 字节 vertex_format 字符串** 就是由它生成的。

---

## 1. 顶点通道（源码枚举）
源码中常见的通道有：

- **x, y, z** → 位置坐标 (float3)  
- **n** → 法线 (float3)  
- **u, v** → UV 坐标 (float2)  
- **t, b** → 切线 (tangent) / 副切线 (bitangent)  
- **c** → 顶点颜色 (float4 或 byte4)  
- **i** → 骨骼索引 (int4)  
- **w** → 骨骼权重 (float4)  

👉 这些通道会组合成字符串，例如：  
- `"xyznuv"` → 位置 + 法线 + UV  
- `"xyznuvtb"` → 位置 + 法线 + UV + 切线/副切线  
- `"xyznuviiiww"` → 位置 + 法线 + UV + 骨骼索引 + 权重（蒙皮动画用）

---

## 2. 生成逻辑（源码流程）
1. **扫描 mesh** → 检查是否存在法线、切线、颜色、骨骼权重。  
2. **拼接字符串** → 按固定顺序拼接通道：  
   - 位置 (xyz) → 必须  
   - 法线 (n) → 如果存在  
   - UV (uv) → 如果存在  
   - 切线/副切线 (tb) → 如果存在法线贴图  
   - 颜色 (c) → 如果存在顶点色  
   - 骨骼索引/权重 (iw) → 如果是蒙皮网格  
3. **填充到 64 字节** → 不足部分补 `\0`。  

---

## 3. 写入 `.primitives`
在 `PrimitiveFileWriter::write()` 中，调用：
```cpp
bw.write_string(vertexFormat.string().ljust(64, '\0'));
```
👉 这就是 `.primitives` 文件里 **vertex_format** 字段的来源。

---

## 4. Blender 插件迁移实现
在 Blender 插件中，我们需要一个函数来动态生成 vertex_format：

```python
def build_vertex_format(mesh, has_tangent=False, has_color=False, has_skin=False):
    fmt = "xyz"
    if mesh.has_normals:
        fmt += "n"
    if mesh.has_uv:
        fmt += "uv"
    if has_tangent:
        fmt += "tb"
    if has_color:
        fmt += "c"
    if has_skin:
        fmt += "iw"
    return fmt.ljust(64, '\0')
```

---

## 5. 验证闭环
- **对比旧版产物**：导出同一模型，检查 vertex_format 是否一致。  
- **ModelEditor**：加载 `.primitives`，确认法线贴图/骨骼动画是否正常。  
- **Validator**：检查 mesh 是否缺少必要通道（如有法线贴图但无切线）。  

---

# ✅ 小结
- `.primitives` 的 **vertex_format** 是由 `VertexFormat` 类动态生成的字符串。  
- 通道组合规则：**xyz → n → uv → tb → c → iw**。  
- Blender 插件必须实现相同逻辑，保证逐字节对齐。  

---

---

# 🗂️ Step 3：PrimitiveGroup 结构（源码对齐）

在 BigWorld 的 `exporter_common/primitive_group.cpp` 中，定义了 **PrimitiveGroup**，它描述了 `.primitives` 文件中每个子网格（submesh）的索引范围。  

---

## 1. PrimitiveGroup 的字段（源码确认）

根据 BigWorld 14.4.1 源码与旧版文档对照，`PrimitiveGroup` 至少包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| **startIndex** | uint32 | 当前子网格的索引起始位置 |
| **numPrimitives** | uint32 | 三角形数量（索引数 ÷ 3） |
| **startVertex** | uint32 | 顶点缓冲中的起始顶点 |
| **numVertices** | uint32 | 顶点数量（该组覆盖的范围） |

👉 在部分源码版本中，还可能扩展：
- **materialIndex**：材质槽 ID（用于 .visual 对齐）  
- **flags**：渲染标志位（如双面、透明等）  

---

## 2. 写入顺序（在 `.primitives` 中）
在 `PrimitiveFileWriter::write()` 中，索引数据块写入完 indices[] 后，紧接着写入 **PrimitiveGroup 数组**，顺序如下：

1. startIndex  
2. numPrimitives  
3. startVertex  
4. numVertices  

👉 每个 PrimitiveGroup 占用 **16 字节**（4 × uint32）。  

---

## 3. 旧版插件逻辑
- **分组依据**：通常按材质槽或对象划分。  
- **LOD 支持**：不同 LOD 会生成不同的 PrimitiveGroup 集合。  
- **材质绑定**：.visual 文件中的 `renderSet` 会引用这些 group。  

---

## 4. Blender 插件迁移实现

在 Blender 插件中，我们需要在 mesh → export 过程中生成 PrimitiveGroup：

```python
@dataclass
class PrimitiveGroup:
    start_index: int
    num_primitives: int
    start_vertex: int
    num_vertices: int

def build_primitive_groups(mesh):
    groups = []
    for mat_slot in mesh.materials:
        indices = collect_indices_for_material(mesh, mat_slot)
        start_index = indices[0]
        num_primitives = len(indices) // 3
        start_vertex = min(indices)
        num_vertices = max(indices) - start_vertex + 1
        groups.append(PrimitiveGroup(start_index, num_primitives, start_vertex, num_vertices))
    return groups
```

---

## 5. 写入 `.primitives`
在 `PrimitivesWriter` 中：

```python
for g in primitive_groups:
    bw.write_uint32(g.start_index)
    bw.write_uint32(g.num_primitives)
    bw.write_uint32(g.start_vertex)
    bw.write_uint32(g.num_vertices)
```

---

## 6. 验证闭环
- **hex diff**：对比旧版 3ds Max 插件导出的 `.primitives`，确认 group 边界一致。  
- **ModelEditor**：加载 `.visual`，检查材质分组是否正确。  
- **Validator**：检查 group 的索引范围是否越界。  

---

# ✅ 小结
- **PrimitiveGroup** 是 `.primitives` 中的索引分组单元，每组占 16 字节。  
- 字段顺序：**startIndex → numPrimitives → startVertex → numVertices**。  
- Blender 插件必须严格对齐，才能保证 `.visual` 正确绑定材质。  

---


---

# 🗂️ Step 4：BSP Section（源码对齐）

在 BigWorld 的 `.primitives` 文件中，**BSP Section** 是一个可选块，用于静态场景的空间划分（Binary Space Partitioning）。它主要服务于 **碰撞检测、可见性裁剪、射线检测** 等功能。角色模型通常不包含 BSP，但场景模型（建筑、地形片段）会生成。

---

## 1. BSP Section 的触发条件
- **静态对象**：当导出的是静态 mesh（如建筑、场景道具）时，导出器会调用 `BSPWriter`。  
- **动态对象**：角色、动画模型通常不生成 BSP。  
- **源码位置**：`exporter_common/bsp_writer.cpp`。  

---

## 2. BSP Section 的结构（源码 + 文档对齐）

BSP Section 在 `.primitives` 中是一个独立的子块，包含以下内容：

| 字段 | 类型 | 说明 |
|------|------|------|
| **numTriangles** | uint32 | BSP 中的三角形数量 |
| **triangles[]** | struct | 每个三角形的顶点索引、平面方程 |
| **numNodes** | uint32 | BSP 节点数量 |
| **nodes[]** | struct | 每个节点的分割平面、子节点索引 |
| **userData** | 可选 | 附加数据（如碰撞层、材质 ID） |

👉 **注意**：所有数据依然遵循 **4 字节对齐**。

---

## 3. 写入流程（源码逻辑）
在 `PrimitiveFileWriter::write()` 中：
1. 检查 mesh 是否需要 BSP。  
2. 如果需要 → 调用 `BSPWriter::write()`。  
3. `BSPWriter` 会：  
   - 构建 BSP 树（递归划分空间）。  
   - 写入三角形数据。  
   - 写入节点数据。  
   - 写入 userData（如果有）。  

---

## 4. Blender 插件迁移实现

在 Blender 插件中，我们可以这样处理：

- **默认关闭 BSP**：角色模型不生成 BSP。  
- **静态场景可选**：在导出面板提供一个复选框 `[ ] 生成 BSP`。  
- **实现方式**：  
  - 使用 Blender 的 BVH（Bounding Volume Hierarchy）作为替代，生成分割平面。  
  - 将 BVH 转换为 BSP 节点结构，写入 `.primitives`。  

伪代码示例：

```python
def write_bsp(mesh, bw):
    triangles = build_triangles(mesh)
    nodes = build_bsp_nodes(triangles)

    bw.begin_section("bsp")
    bw.write_uint32(len(triangles))
    for tri in triangles:
        bw.write_triangle(tri)
    bw.write_uint32(len(nodes))
    for node in nodes:
        bw.write_node(node)
    bw.end_section()
```

---

## 5. 验证闭环
- **ModelEditor**：加载带 BSP 的 `.primitives`，检查是否能正确显示碰撞体。  
- **WorldEditor**：在场景中测试射线检测、遮挡剔除。  
- **Validator**：检查 BSP 节点是否覆盖所有三角形，是否存在孤立节点。  

---

# ✅ 小结
- **BSP Section** 是 `.primitives` 的可选部分，主要用于静态场景。  
- 字段包括 **三角形数组、节点数组、可选 userData**。  
- Blender 插件实现时，可以默认关闭 BSP，仅在导出静态场景时启用。  
- 验证方式：ModelEditor/WorldEditor 加载测试 + hex diff。  

---

**简答：接下来我们要把 `.primitives` 的最外层容器——BinSection 的 Header 与 Index Table 彻底讲清楚。这样整个文件的封装逻辑就完整了。**

---

# 🗂️ Step 5：BinSection Header 与 Index Table

## 1. BinSection 的作用
- `.primitives` 文件不是“平铺的二进制流”，而是一个 **BinSection 包**。  
- 每个子块（顶点、索引、BSP）都作为一个 section 存储，BinSection 在文件尾部有一个 **index table** 来描述这些子块。  
- **源码位置**：`resmgr/bin_section.cpp`。

---

## 2. Header 结构
- **magic number**：固定值 `0x42A14E65`，标识这是一个 BinSection 文件。  
- **version**：文件版本号（通常为 1）。  
- **timestamp**：最后修改时间戳（uint32）。  
- **num_sections**：子块数量。  

👉 这些字段在文件开头写入，用于快速识别文件。

---

## 3. Binary Blob 区域
- 存放实际的子块数据（顶点、索引、BSP）。  
- 每个子块按 **4 字节对齐**。  
- 子块本身没有 header，只有原始数据。  

---

## 4. Index Table
位于文件尾部，记录每个子块的元信息：

| 字段 | 类型 | 说明 |
|------|------|------|
| **tag** | string (4 bytes) | 子块标识，如 `"vertices"`, `"indices"`, `"bsp "` |
| **offset** | uint32 | 子块在文件中的偏移 |
| **length** | uint32 | 子块长度（字节数） |
| **version** | uint32 | 子块版本号 |
| **timestamp** | uint32 | 子块时间戳 |

👉 每个子块对应一条 index entry。ModelEditor/WorldEditor 通过 index table 来定位数据。

---

## 5. 写入流程（源码逻辑）
1. **写 Header**（magic、version、timestamp、num_sections 占位）。  
2. **写子块数据**（顶点、索引、BSP），并记录 offset/length。  
3. **对齐到 4 字节**。  
4. **写 Index Table**（tag、offset、length、version、timestamp）。  
5. **回填 num_sections**。  

---

## 6. Blender 插件迁移实现

```python
class BinSectionWriter:
    def __init__(self, filepath):
        self.file = open(filepath, "wb")
        self.sections = []

    def begin_section(self, tag):
        self.current_tag = tag
        self.start_offset = self.file.tell()

    def end_section(self):
        end_offset = self.file.tell()
        length = end_offset - self.start_offset
        self.sections.append((self.current_tag, self.start_offset, length, 1, int(time.time())))
        # 对齐到 4 字节
        while self.file.tell() % 4 != 0:
            self.file.write(b"\0")

    def finalize(self):
        # 写 index table
        for tag, offset, length, version, ts in self.sections:
            self.file.write(tag.encode("ascii").ljust(4, b"\0"))
            self.file.write(struct.pack("<IIII", offset, length, version, ts))
        self.file.close()
```

---

## 7. 验证闭环
- **hex diff**：确认 index table 的 offset/length 与旧版一致。  
- **ModelEditor**：能正确解析 `.primitives`，说明 index table 正确。  
- **Validator**：检查 offset/length 是否越界。  

---

# ✅ 小结
- `.primitives` 的最外层是 **BinSection**，包含 **Header + Binary Blob + Index Table**。  
- **Header**：magic、version、timestamp、num_sections。  
- **Index Table**：tag、offset、length、version、timestamp。  
- Blender 插件必须严格对齐，才能保证引擎正确加载。  

---

---

# 🗂️ Step 6：`.primitives` 文件完整写入流程（源码对齐）

## 1. 文件整体结构
```
[Header]
[Binary Blob 区域：各子块数据]
[Index Table]
```

---

## 2. Header（文件头）
- **magic number**：0x42A14E65  
- **version**：通常为 1  
- **timestamp**：最后修改时间戳（uint32）  
- **num_sections**：子块数量（稍后回填）  

👉 在 `BinSectionWriter::open()` 时写入，占位。

---

## 3. Binary Blob 区域（子块数据）
按照固定顺序写入：

1. **Vertex Section**  
   - vertex_format (64 字节字符串)  
   - num_vertices (uint32)  
   - raw_vertex_data (float 数组，按 vertex_format 顺序)  

2. **Index Section**  
   - index_format ("list"/"list32")  
   - num_indices (uint32)  
   - num_primitive_groups (uint32)  
   - indices[] (uint16/uint32 数组)  
   - primitive_groups[] (每组 16 字节：startIndex, numPrimitives, startVertex, numVertices)  

3. **BSP Section（可选）**  
   - numTriangles (uint32)  
   - triangles[] (顶点索引 + 平面方程)  
   - numNodes (uint32)  
   - nodes[] (分割平面 + 子节点索引)  
   - userData（可选）  

👉 每个子块写完后，**对齐到 4 字节**。

---

## 4. Index Table（文件尾）
每个子块对应一条记录：

| 字段 | 类型 | 说明 |
|------|------|------|
| tag | char[4] | 子块标识，如 `"vert"`, `"indx"`, `"bsp "` |
| offset | uint32 | 子块在文件中的偏移 |
| length | uint32 | 子块长度 |
| version | uint32 | 子块版本号 |
| timestamp | uint32 | 子块时间戳 |

👉 写完所有子块后，回填 index table，并更新 Header 的 `num_sections`。

---

## 5. Blender 插件写入流程图

```
ExportOperator
   ↓
PrimitivesWriter
   ↓
BinSectionWriter.open()
   ↓
write_vertex_section()
   ↓
write_index_section()
   ↓
if static: write_bsp_section()
   ↓
BinSectionWriter.finalize() → 写 index table & 回填 header
```

---

## 6. 验证闭环
- **hex diff**：与 3ds Max 插件导出的 `.primitives` 对比，逐字节一致。  
- **ModelEditor**：加载 `.visual` 引用的 `.primitives`，验证渲染正确。  
- **WorldEditor**：测试 BSP 碰撞/遮挡。  
- **Validator**：检查顶点数、索引数、group 边界是否一致。  

---

# ✅ 总结
- `.primitives` = **BinSection 包**，由 **Header + 子块数据 + Index Table** 组成。  
- 子块顺序固定：**Vertex → Index → PrimitiveGroup → BSP（可选）**。  
- Blender 插件必须严格对齐源码的写入逻辑，才能保证 ModelEditor/WorldEditor 正确加载。  

---

---

# 🗂️ `.primitives` 文件逐字段对齐表（源码级蓝本）

## 1. 文件头（Header）
| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 1 | magic | uint32 | 固定值 0x42A14E65 | 标识 BinSection 文件 |
| 2 | version | uint32 | 固定 1 | 文件版本 |
| 3 | timestamp | uint32 | 系统时间戳 | 最后修改时间 |
| 4 | num_sections | uint32 | 子块数量 | 稍后回填 |

---

## 2. 顶点数据块（Vertex Section）
| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 5 | vertex_format | char[64] | VertexFormat::string() | 顶点通道描述，如 "xyznuvtb" |
| 6 | num_vertices | uint32 | mesh.vertices.size() | 顶点数量 |
| 7 | raw_vertex_data | float[] | mesh.vertices | 按 vertex_format 顺序写入：xyz → n → uv → tb → c → iw |

---

## 3. 索引数据块（Index Section）
| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 8 | index_format | string | "list"/"list32" | 顶点数 < 65536 → list |
| 9 | num_indices | uint32 | mesh.indices.size() | 索引数量 |
| 10 | num_primitive_groups | uint32 | mesh.groups.size() | 子网格数量 |
| 11 | indices[] | uint16/uint32[] | mesh.indices | 三角形索引数组 |

---

## 4. PrimitiveGroup 数组
每组占 16 字节，顺序如下：

| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 12 | startIndex | uint32 | group.start | 起始索引 |
| 13 | numPrimitives | uint32 | group.count/3 | 三角形数量 |
| 14 | startVertex | uint32 | group.min_vertex | 顶点起始 |
| 15 | numVertices | uint32 | group.vertex_count | 顶点数量 |

---

## 5. BSP Section（可选）
| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 16 | numTriangles | uint32 | BSPWriter | BSP 三角形数量 |
| 17 | triangles[] | struct | BSPWriter | 每个三角形的顶点索引、平面方程 |
| 18 | numNodes | uint32 | BSPWriter | BSP 节点数量 |
| 19 | nodes[] | struct | BSPWriter | 每个节点的分割平面、子节点索引 |
| 20 | userData | 可选 | BSPWriter | 碰撞层、材质 ID 等 |

---

## 6. Index Table（文件尾）
每个子块对应一条记录：

| 顺序 | 字段 | 类型 | 来源 | 说明 |
|------|------|------|------|------|
| 21 | tag | char[4] | 固定字符串 | "vert", "indx", "bsp " |
| 22 | offset | uint32 | writer 记录 | 子块在文件中的偏移 |
| 23 | length | uint32 | writer 记录 | 子块长度 |
| 24 | version | uint32 | 固定 1 | 子块版本 |
| 25 | timestamp | uint32 | 系统时间戳 | 子块时间戳 |

---

# 🗂️ 写入顺序总览
```
Header
 ├─ Vertex Section
 ├─ Index Section
 │    └─ PrimitiveGroups[]
 ├─ BSP Section (可选)
 └─ Index Table
```

---

# ✅ 总结
- `.primitives` 文件是 **BinSection 包**，由 **Header + 子块数据 + Index Table** 组成。  
- 子块顺序固定：**Vertex → Index → PrimitiveGroup → BSP（可选）**。  
- 每个子块在 Index Table 中有一条记录，包含 tag、offset、length、version、timestamp。  
- Blender 插件实现时，必须严格对齐源码逻辑，保证 ModelEditor/WorldEditor 能正确加载。  

---
**简答：我们可以依次把 `.visual` → `.model` → `.animation` 三个核心格式拆解出来，像之前 `.primitives` 那样逐字段解释。文档（File Grammar Guide ch22/ch37/ch38/ch39）提供了语法框架，但最终要以 BigWorld 14.4.1 源码为准。**

---

# 🗂️ 1. `.visual` 文件（几何与渲染集）

## 作用
- `.visual` 是 **渲染描述文件**，通常是 **PackedSection** 格式（即二进制 XML）。  
- 它负责把 `.primitives`（几何数据）和材质（.fx、.dds）绑定起来。  
- 在 `.model` 中被引用。

## 主要字段
- **renderSet[]**：渲染集数组，每个 renderSet 对应一组材质和几何。  
  - **geometry**：引用 `.primitives` 文件。  
  - **primitiveGroup[]**：子网格绑定，索引到 `.primitives` 的 group。  
  - **material**：材质槽，引用 shader/fx 文件和纹理。  
- **boundingBox / boundingSphere**：包围盒/球。  
- **node[]**：骨骼节点引用（如果是蒙皮模型）。  

## 写入顺序
1. Header（PackedSection）  
2. renderSet → geometry → material  
3. boundingBox / boundingSphere  
4. node（可选）  

---

# 🗂️ 2. `.model` 文件（高层组合）

## 作用
- `.model` 是 **角色/物体的组合文件**，通常是 XML 或 PackedSection。  
- 它把 `.visual`、`.primitives`、`.animation`、`.skeleton` 组合成一个完整的可实例化对象。  

## 主要字段
- **parent**：父模型（可继承）。  
- **extent / boundingBox**：模型范围。  
- **visual**：引用 `.visual` 文件。  
- **skeleton**：骨骼文件引用。  
- **animation[]**：动画列表，引用 `.animation` 文件。  
- **action[]**：动作定义，绑定动画和触发条件。  
- **dye/tint**：材质替换。  

## 写入顺序
1. Header（PackedSection）  
2. parent / extent / boundingBox  
3. visual  
4. skeleton  
5. animation[]  
6. action[]  
7. dye/tint  

---

# 🗂️ 3. `.animation` 文件（骨骼动画）

## 作用
- `.animation` 存储骨骼动画关键帧。  
- 格式：PackedSection。  
- 在 `.model` 的 `<animation>` 中被引用。  

## 主要字段
- **name**：动画名称。  
- **skeleton**：骨骼引用。  
- **duration**：动画时长。  
- **channel[]**：每个骨骼的关键帧序列。  
  - **position[]**：平移关键帧。  
  - **rotation[]**：旋转关键帧（四元数）。  
  - **scale[]**：缩放关键帧。  
- **compressedData**：部分版本支持压缩存储。  

## 写入顺序
1. Header（PackedSection）  
2. name / skeleton / duration  
3. channel[]（每个骨骼）  
4. position/rotation/scale 关键帧  

---

# ✅ 总结
- **.visual**：几何 + 材质绑定（引用 `.primitives`）。  
- **.model**：高层组合（引用 `.visual`、`.animation`、`.skeleton`）。  
- **.animation**：骨骼动画关键帧。  
- **文档提供语法框架，但最终以源码为准**（`visual.cpp`、`model.cpp`、`animation.cpp`）。  

---
# BigWorld .visual、.model、.animation 详解（源码对齐版）

这是一份像我们对 .primitives 那样的逐字段、逐流程讲解，面向你要在 Blender 中重建导出器。资料以 BigWorld 14.4.1 源码为最终基准；旧版 File Grammar Guide 仅作语法框架参考。结构、顺序、对齐与校验逻辑都按“插件能直接落地”的要求整理。

---

## .visual 文件（几何与渲染集的绑定）

### 文件角色与容器
- **定位:** 渲染描述文件，绑定几何（.primitives）与材质（shader/纹理），并定义渲染集、包围体、节点引用。
- **容器:** 多数版本采用 PackedSection（二进制 XML）；部分工具链可读写 XML 源格式与 PackedSection 打包版本并存。

### 主要结构与字段（按常见实现对齐）
- **renderSet[]:**
  - **geometry:** 引用 `.primitives` 路径（相对资源根），一个 renderSet 通常对应一个 primitives 文件。
  - **primitiveGroup[]:** 用于把 .visual 的材质槽与 .primitives 的子网格对应起来（按 group 索引或范围）。
  - **material(s):** 绑定 shader/fx 与纹理集；含技术/通道（technique/pass）、宏/Flag、纹理路径（diffuse/normal/spec 等）。
- **boundingBox / boundingSphere:**
  - **boundingBox:** min/max 三维向量。
  - **boundingSphere:** center/radius。
- **node[]（可选）:**
  - **bones/nodes:** 若为蒙皮模型则包含节点名、层级关系或索引映射，用于 .animation 绑定。
- **drawFlags（可选）:** 双面、透明、接收阴影、投射阴影等渲染标志位。

### 写入顺序（建议对齐）
1. **Header:** PackedSection header 与 string table。
2. **renderSet[]:** 逐项写 geometry → primitiveGroup[] → material(s)。
3. **bounds:** boundingBox → boundingSphere。
4. **nodes（可选）:** 骨骼节点或附加节点。
5. **flags（可选）:** 渲染标志位、LOD 映射、动态遮罩。

### Blender 导出映射
- **geometry:** 从对象或集合级配置拿到 .primitives 输出路径；写入相对路径。
- **primitiveGroup 绑定:** 将 Blender 中按材质或对象划分的 groups 映射到 .visual 的 group 索引；顺序与 .primitives 的 PrimitiveGroup 保持一致。
- **material:** 提取 Blender 材质槽的核心参数（颜色、PBR 贴图路径、法线强度等），转为 shader/fx 与纹理引用；保留纹理相对路径与资源根约定。
- **bounds:** 从网格实时计算 AABB 与外接球；单位与坐标系对齐（Z-up→Y-up）。
- **nodes:** 若使用 Armature，写入骨骼名称列表与层级；与 .model/.animation 的 skeleton 引用一致。

### 校验与对齐
- **路径一致性:** .visual → .primitives 的相对路径必须有效；CI 校验存在性。
- **group 对齐:** primitiveGroup 索引与 .primitives 的组数量一致；越界报错。
- **材质完整性:** shader/fx 与纹理路径必须有效；缺失时写审计警告。
- **bounds 正确性:** 包围体覆盖全部顶点；空或负尺寸报错。

### 边界与兼容
- **多 renderSet:** 支持多几何与多材质集；按渲染层次拆分。
- **法线贴图:** 若材质标记需要切线空间，则 .primitives 顶点格式必须含切线/副切线。
- **PackedSection/XML:** 若团队采用打包版本，确保字符串表与偏移索引一致；XML 版本仅用于调试或中间产物。

---

## .model 文件（高层组合与行为装配）

### 文件角色与容器
- **定位:** 实例化对象的高层组合文件，引用 .visual、.primitives、.animation、skeleton，并定义动作、染色、扩展行为。
- **容器:** XML 或 PackedSection；最终交付通常为 PackedSection。

### 主要结构与字段（按常见实现对齐）
- **parent（可选）:** 父模型路径；支持继承（覆写 visual、dye、action 等）。
- **extent / boundingBox:** 模型空间范围；与 .visual 保持一致或覆盖（当模型组合时）。
- **visual:** 资源路径，指向 `.visual`。
- **skeleton（可选）:** 骨骼资源路径；若为静态物件可省略。
- **animation[]:**
  - **name:** 动画名（逻辑名或资源名）。
  - **resource:** `.animation` 路径。
  - **channelMask / blendWeight（可选）:** 通道过滤与混合权重。
- **action[]:**
  - **name / trigger:** 行为名与触发条件（脚本或引擎标识）。
  - **animationRef:** 引用绑定的动画。
  - **blendParams / speed / loop:** 动作参数。
- **dye/tint:**
  - **material slot 指定:** 按渲染集或材质 ID 覆盖材质或纹理。
  - **tint 参数:** 颜色、纹理替换列表。
- **lod / impostor（可选）:** LOD 策略与替身图配置。
- **attachments（可选）:** 子模型挂点与附着规则。

### 写入顺序（建议对齐）
1. **Header:** PackedSection header。
2. **parent / extent / boundingBox。**
3. **visual。**
4. **skeleton（可选）。**
5. **animation[] → action[]。**
6. **dye/tint。**
7. **lod / impostor / attachments（可选）。**

### Blender 导出映射
- **visual 引用:** 从同项目导出产物写入 .visual 相对路径。
- **skeleton:** 若 Armature 存在，写 skeleton 资源；确保骨骼命名与 .visual 的 nodes 对齐。
- **animation/action:** 将 Blender NLA/Action 映射为 .animation 资源与 .model 的 action 定义；打平时长、循环、速度、混合。
- **dye/tint:** 允许对象级材质覆盖映射（材质槽→资源路径替换）；保存成 `.model` 的染色配置。
- **bounds:** 若组合多个 visual 或生成体，需要重新计算整体包围体。

### 校验与对齐
- **资源闭环:** .model 引用的 .visual/.animation/.skeleton 均存在；CI 校验与 manifest 记录。
- **骨骼一致:** skeleton 与 .visual 的骨骼节点一致；缺失节点报错。
- **动作绑定:** action 引用的动画必须有效；参数合法范围（speed>0、blendWeight∈[0,1]）。
- **dye 作用域:** 指定的材质槽存在；不存在时报审计警告。

### 边界与兼容
- **继承链:** parent 支持层级继承；确保最终解析时的 effective 配置无冲突。
- **PackedSection/XML:** 生产交付优先使用 PackedSection；XML 用于人类可读与回归测试。

---

## .animation 文件（骨骼动画关键帧）

### 文件角色与容器
- **定位:** 存储骨骼动画的关键帧序列，供 .model 的 animation/action 引用。
- **容器:** PackedSection（常见）；可支持压缩数据段。

### 主要结构与字段（按常见实现对齐）
- **name:** 动画名（资源名或逻辑名）。
- **skeletonRef:** 绑定的骨骼资源；需与 .model/.visual 的 skeleton 对齐。
- **duration:** 动画总时长（秒）。
- **frameRate（可选）:** 采样频率或关键帧时间单位。
- **channel[]（按骨骼节点）:**
  - **boneName / boneIndex:** 节点标识。
  - **positionKeys:** 时间戳+三维向量。
  - **rotationKeys:** 时间戳+四元数（归一化）。
  - **scaleKeys:** 时间戳+三维向量（可选）。
- **compression（可选）:** 是否启用关键帧压缩、误差阈值、量化策略。
- **events / markers（可选）:** 时间点事件标记（命中、脚步声等）。

### 写入顺序（建议对齐）
1. **Header:** PackedSection header。
2. **name / skeletonRef / duration / frameRate。**
3. **channel[]:** 按骨骼拓扑或名称顺序写入，包含 position/rotation/scale 三通道。
4. **compression / events（可选）。**

### Blender 导出映射
- **骨骼与通道采样:** 从 Armature 与 Action/NLA 轨道采样每根骨骼的位姿序列；将 Blender 的局部/世界空间转换为引擎预期的骨架空间（坐标系 Z-up→Y-up、旋转约定）。
- **时间与精度:** 归一化关键帧时间到秒；选择采样频率或按动作关键帧原始时间写入；支持门限合并（移除极近似关键帧）。
- **rotation:** 使用四元数并确保归一化；避免万向节问题。
- **压缩策略:** 可选启用量化或阈值压缩；与引擎端解码兼容为前提。

### 校验与对齐
- **骨骼一致:** channel 的 boneName 必须存在于 skeleton；缺失报错。
- **关键帧单调:** 时间戳严格递增；重复或倒序报错。
- **旋转归一化:** 所有四元数单位化；偏差超阈值报审计警告。
- **事件边界:** events 落于 [0, duration] 之间。

### 边界与兼容
- **非均匀采样:** 支持稀疏关键帧；引擎端做插值。
- **混合动画:** .model 的 action 可同时引用多个动画；权重与叠加策略由 .model 控制。
- **压缩与精度:** 在移动端或复杂角色上优先启用压缩以减小包体；与引擎端版本对齐。

---

## 端到端导出与验证闭环（Blender → BigWorld）

### 导出顺序（推荐）
1. **.primitives:** 写几何二进制（已对齐）。
2. **.visual:** 绑定 .primitives 与材质、写包围体与节点。
3. **.animation:** 写骨骼动画关键帧（如有）。
4. **.model:** 组合 visual、skeleton、animation 与 action；写染色与扩展。

### 事务与清单
- **事务写入:** 临时路径 → 校验通过 → 提交；失败回滚并写审计日志。
- **manifest:** 记录每个产物的相对路径、hash、尺寸、时间戳与依赖关系（.model→.visual→.primitives/.animation）。

### 验证
- **一致性:** 引擎工具（ModelEditor/WorldEditor）能加载并渲染；脚本检查路径与 group 对齐。
- **hex diff:** 与旧版 3ds Max 插件产物逐字节对比（适用 .primitives 与 PackedSection 的打包结构）。
- **schema 校验:** 按团队约定的 schema_reference 校验字段范围与必填项。

---

## 实施注意与优先级

- **源码为准:** 当旧文档与 14.4.1 源码有差异，以源码结构与实际读写逻辑为最终标准。
- **模块化 writer:** 为每个文件类型建立独立 writer，输入为标准化数据结构（dataclass），输出为相应容器（PackedSection/BinSection）。
- **坐标系与单位:** 全链路统一转换（Z-up→Y-up；单位→米）；确保 .primitives/.visual/.animation 一致。
- **材质策略:** 先实现核心通道（漫反射/法线/高光）与基本 shader/fx；复杂材质扩展逐步引入。

---


---

# 🗂️ PackedSection 文件格式（源码+文档对齐）

## 1. 文件整体结构
```
<packed_section> ::= <magic_number> <version> <string_table> <data_section>
```

- **magic_number**：固定值 `0x62A14E45`（4 字节）【标识 PackedSection 文件】  
- **version**：int8（通常为 1）  
- **string_table**：一组以 `\0` 结尾的字符串，最后以空字符串结束  
- **data_section**：包含子节点数量、数据偏移表、子节点记录、二进制数据  

---

## 2. string_table
- 存放所有 key（字段名）字符串，避免重复存储。  
- 在 `<child_record>` 中通过 **索引**引用，而不是直接存储字符串。  
- **索引从 0 开始**。  

---

## 3. data_section
```
<data_section> ::= <num_children> <data_pos> <child_record>* <bin_data>
```

- **num_children**：int，子节点数量  
- **data_pos**：int32，指向数据块的偏移（相对本 section 的 bin_data 起始位置）  
- **child_record[]**：每个子节点的 key 索引和数据偏移  
- **bin_data**：实际数据（本节点数据 + 子节点数据拼接）  

---

## 4. child_record
```
<child_record> ::= <key_pos> <data_pos>
```

- **key_pos**：int16，指向 string_table 的索引  
- **data_pos**：int32，指向该子节点数据在 bin_data 中的偏移  
- **数据范围**：从上一个 data_pos 到当前 data_pos  

---

## 5. bin_data
- 存放实际的值（int、float、string、Vector3、Matrix 等）。  
- **整数有压缩优化**：  
  - 值为 0 → 不存储  
  - 值 fits in int8 → 存 1 字节  
  - fits in int16 → 存 2 字节  
  - 否则存 4 字节  

---

## 6. 写入顺序（源码逻辑）
1. 写 **magic_number**、**version**  
2. 收集所有 key → 写入 **string_table**  
3. 写 **num_children**  
4. 写 **data_pos[]**（含类型信息在高位）  
5. 写 **child_record[]**（key_pos + data_pos）  
6. 写 **bin_data**（本节点数据 + 子节点数据）  

---

# 🛠️ Blender 插件实现思路

### 数据结构
```python
@dataclass
class PackedNode:
    key: str
    value: Any
    children: List["PackedNode"]
```

### Writer 伪代码
```python
class PackedSectionWriter:
    def __init__(self, filepath):
        self.file = open(filepath, "wb")
        self.string_table = {}
        self.nodes = []

    def add_node(self, key, value=None, children=None):
        idx = self._add_string(key)
        self.nodes.append(PackedNode(key, value, children or []))

    def write(self):
        self._write_header()
        self._write_string_table()
        self._write_data_section(self.nodes)
        self.file.close()
```

---

# ✅ 小结
- **PackedSection 是 .visual/.model/.animation 的容器格式**。  
- 关键点：**string_table（去重 key）、child_record（索引+偏移）、bin_data（实际值）**。  
- Blender 插件必须实现 **PackedSectionWriter**，才能导出 `.visual/.model/.animation`。  

---

---

# 🗂️ `.visual` 文件详解（源码+文档对齐）

## 1. 文件角色
- **定位**：渲染描述文件，告诉引擎如何使用 `.primitives` 中的几何数据。  
- **容器**：采用 **PackedSection**（即二进制 XML）。  
- **引用关系**：被 `.model` 文件引用，用于组合完整角色或物体。  

---

## 2. 顶层结构
典型 `.visual` 文件包含以下顶层节点：

- **renderSet[]**：渲染集数组  
- **boundingBox / boundingSphere**：包围体  
- **nodes（可选）**：骨骼节点引用  
- **flags（可选）**：渲染标志位（双面、透明等）  

---

## 3. renderSet 结构
每个 `renderSet` 定义一组几何与材质绑定：

- **geometry**：引用 `.primitives` 文件路径  
- **primitiveGroup[]**：子网格绑定，索引到 `.primitives` 的 group  
- **material(s)**：材质槽，包含：  
  - **fx**：shader/fx 文件路径  
  - **texture[]**：纹理路径（diffuse、normal、specular 等）  
  - **properties**：材质参数（颜色、透明度、flags）  

👉 **关键点**：`primitiveGroup` 的数量与 `.primitives` 中的 PrimitiveGroup 数量必须一致。  

---

## 4. 包围体
- **boundingBox**：min/max 三维向量  
- **boundingSphere**：center + radius  
👉 用于快速裁剪与碰撞检测。  

---

## 5. 节点（可选）
- **node[]**：骨骼节点引用（若为蒙皮模型）。  
- 每个节点包含 **name**、**transform**（矩阵）。  
- 与 `.model` 的 skeleton 保持一致。  

---

## 6. 写入顺序（源码逻辑）
1. Header（PackedSection header + string_table）  
2. renderSet[]  
   - geometry  
   - primitiveGroup[]  
   - material(s)  
3. boundingBox / boundingSphere  
4. node[]（可选）  
5. flags（可选）  

---

## 7. Blender 插件迁移实现
在 Blender 插件中，`.visual` 的导出逻辑应为：

```python
def write_visual(filepath, mesh, materials, bounds, nodes):
    psw = PackedSectionWriter(filepath)
    psw.add_node("renderSet", [
        {
            "geometry": mesh.primitives_path,
            "primitiveGroup": mesh.groups,
            "material": build_materials(materials)
        }
    ])
    psw.add_node("boundingBox", bounds.aabb)
    psw.add_node("boundingSphere", bounds.sphere)
    if nodes:
        psw.add_node("nodes", nodes)
    psw.write()
```

---

## 8. 验证闭环
- **hex diff**：与旧版 `.visual` 对比，确认字段顺序一致。  
- **ModelEditor**：加载 `.visual`，检查材质绑定是否正确。  
- **Validator**：检查 `primitiveGroup` 数量与 `.primitives` 是否一致。  

---

# ✅ 小结
- `.visual` 是 **PackedSection 文件**，核心字段是 **renderSet、geometry、primitiveGroup、material、bounds**。  
- 它是 `.model` 的直接依赖，必须严格对齐 `.primitives` 的 group 数量。  
- Blender 插件实现时，需先有 **PackedSectionWriter**，再实现 **VisualWriter**。  


---

# 🗂️ `.model` 文件详解（源码+文档对齐）

## 1. 文件角色
- **定位**：角色/物体的组合文件，定义了外观（visual）、骨骼（skeleton）、动画（animation）、动作（action）、材质替换（dye/tint）等。  
- **容器**：XML 或 PackedSection（二进制 XML）。最终交付通常是 PackedSection。  
- **引用关系**：被游戏逻辑和编辑器直接加载，作为资源入口。  

---

## 2. 顶层结构
典型 `.model` 文件包含以下顶层节点：

- **parent（可选）**：父模型路径，支持继承。  
- **extent / boundingBox**：模型范围。  
- **visual**：引用 `.visual` 文件。  
- **skeleton（可选）**：骨骼文件引用。  
- **animation[]**：动画列表，引用 `.animation` 文件。  
- **action[]**：动作定义，绑定动画与触发条件。  
- **dye/tint（可选）**：材质替换配置。  
- **lod / impostor（可选）**：LOD 策略与替身图。  
- **attachments（可选）**：子模型挂点。  

---

## 3. animation[]
每个动画条目包含：
- **name**：逻辑名。  
- **resource**：`.animation` 文件路径。  
- **channelMask / blendWeight（可选）**：通道过滤与混合参数。  

---

## 4. action[]
每个动作条目包含：
- **name / trigger**：动作名与触发条件。  
- **animationRef**：引用的动画名。  
- **blendParams / speed / loop**：动作参数。  

---

## 5. dye/tint
- **dye**：材质槽替换。  
- **tint**：颜色或纹理替换。  
👉 用于角色换装、染色系统。  

---

## 6. 写入顺序（源码逻辑）
1. Header（PackedSection header + string_table）  
2. parent / extent / boundingBox  
3. visual  
4. skeleton（可选）  
5. animation[]  
6. action[]  
7. dye/tint（可选）  
8. lod / impostor / attachments（可选）  

---

## 7. Blender 插件迁移实现
在 Blender 插件中，`.model` 的导出逻辑应为：

```python
def write_model(filepath, visual_path, skeleton, animations, actions, dyes):
    psw = PackedSectionWriter(filepath)
    if parent:
        psw.add_node("parent", parent)
    psw.add_node("extent", bounds.extent)
    psw.add_node("boundingBox", bounds.aabb)
    psw.add_node("visual", visual_path)
    if skeleton:
        psw.add_node("skeleton", skeleton)
    for anim in animations:
        psw.add_node("animation", {
            "name": anim.name,
            "resource": anim.path
        })
    for act in actions:
        psw.add_node("action", {
            "name": act.name,
            "trigger": act.trigger,
            "animationRef": act.anim_name
        })
    if dyes:
        psw.add_node("dye", dyes)
    psw.write()
```

---

## 8. 验证闭环
- **资源闭环**：`.model` 引用的 `.visual`、`.animation`、skeleton 必须存在。  
- **骨骼一致性**：skeleton 与 `.visual` 的骨骼节点一致。  
- **动作绑定**：action 引用的动画必须有效。  
- **材质替换**：dye/tint 的材质槽必须存在。  

---

# ✅ 小结
- `.model` 是 **高层组合文件**，核心字段是 **visual、skeleton、animation、action、dye/tint**。  
- 它是游戏加载的入口，必须保证资源闭环与字段一致性。  
- Blender 插件实现时，需要先有 **PackedSectionWriter**，再实现 **ModelWriter**。  

---

---

# 🗂️ `.animation` 文件详解（源码+文档对齐）

## 1. 文件角色
- **定位**：存储骨骼动画的关键帧序列。  
- **容器**：PackedSection（二进制 XML）。  
- **引用关系**：在 `.model` 的 `<animation>` 节点中被引用。  

---

## 2. 顶层结构
典型 `.animation` 文件包含以下字段：

- **name**：动画名称（逻辑名）。  
- **skeletonRef**：骨骼引用，需与 `.model` / `.visual` 的 skeleton 对齐。  
- **duration**：动画总时长（秒）。  
- **frameRate（可选）**：采样频率。  
- **channel[]**：每个骨骼的关键帧序列。  
- **compression（可选）**：是否启用压缩。  
- **events/markers（可选）**：时间点事件（如脚步声）。  

---

## 3. channel 结构
每个 channel 对应一根骨骼：

- **boneName / boneIndex**：骨骼标识。  
- **positionKeys[]**：时间戳 + Vector3。  
- **rotationKeys[]**：时间戳 + Quaternion。  
- **scaleKeys[]（可选）**：时间戳 + Vector3。  

👉 **关键点**：时间戳必须严格递增，四元数必须归一化。  

---

## 4. 写入顺序（源码逻辑）
1. Header（PackedSection header + string_table）  
2. name / skeletonRef / duration / frameRate  
3. channel[]（逐骨骼写入）  
   - positionKeys  
   - rotationKeys  
   - scaleKeys（可选）  
4. compression / events（可选）  

---

## 5. Blender 插件迁移实现
在 Blender 插件中，`.animation` 的导出逻辑应为：

```python
def write_animation(filepath, armature, action):
    psw = PackedSectionWriter(filepath)
    psw.add_node("name", action.name)
    psw.add_node("skeletonRef", armature.name)
    psw.add_node("duration", action.frame_range[1] / bpy.context.scene.render.fps)
    channels = []
    for bone in armature.bones:
        ch = {"boneName": bone.name}
        ch["positionKeys"] = sample_position_keys(bone, action)
        ch["rotationKeys"] = sample_rotation_keys(bone, action)
        ch["scaleKeys"] = sample_scale_keys(bone, action)
        channels.append(ch)
    psw.add_node("channel", channels)
    psw.write()
```

---

## 6. 验证闭环
- **骨骼一致性**：channel 的 boneName 必须存在于 skeleton。  
- **关键帧单调性**：时间戳严格递增。  
- **旋转归一化**：所有四元数必须单位化。  
- **事件范围**：events 必须落在 [0, duration] 内。  

---

# ✅ 小结
- `.animation` 是 **PackedSection 文件**，核心字段是 **name、skeletonRef、duration、channel[]**。  
- 每个 channel 存储骨骼的 **position/rotation/scale 关键帧**。  
- Blender 插件实现时，需要采样 Armature + Action，转换为引擎坐标系并写入 PackedSection。  

---


# 🗂️ BigWorld 导出流水线（Blender 插件端到端）

## 1. 导出顺序
1. **采样 Blender 数据**  
   - Mesh → 顶点、法线、UV、颜色、切线  
   - Armature → 骨骼层级、骨骼矩阵  
   - Action/NLA → 动画关键帧  
   - 材质 → shader/fx、纹理路径、参数  

2. **生成 .primitives**  
   - 使用 **BinSectionWriter**  
   - 写入 Vertex Section → Index Section → PrimitiveGroup → BSP（可选）  
   - 校验 group 数量、索引范围  

3. **生成 .visual**  
   - 使用 **PackedSectionWriter**  
   - 写入 renderSet → geometry（指向 .primitives）→ material → bounds  
   - 校验 primitiveGroup 数量与 .primitives 一致  

4. **生成 .animation**（如有）  
   - 使用 **PackedSectionWriter**  
   - 写入 name、skeletonRef、duration  
   - 写入 channel[]（position/rotation/scale keys）  
   - 校验骨骼一致性、关键帧单调性  

5. **生成 .model**  
   - 使用 **PackedSectionWriter**  
   - 写入 parent、extent、boundingBox  
   - 引用 visual、skeleton  
   - 写入 animation[]、action[]  
   - 写入 dye/tint（如有）  

6. **写 manifest.json & audit.log**  
   - manifest：记录产物路径、hash、依赖关系  
   - audit.log：记录错误码、警告、导出时间  

---

## 2. Writer 模块划分
- **core/bin_section_writer.py** → 写 `.primitives`  
- **core/packed_section_writer.py** → 写 `.visual/.model/.animation`  
- **writers/primitives_writer.py**  
- **writers/visual_writer.py**  
- **writers/model_writer.py**  
- **writers/animation_writer.py**  

---

## 3. 验证闭环
- **hex diff**：与旧版 3ds Max 插件产物逐字节对比  
- **ModelEditor**：加载 `.visual`、`.model`，检查渲染与动画  
- **WorldEditor**：检查 BSP 碰撞、LOD、遮挡剔除  
- **CI 校验**：schema 校验、路径存在性、骨骼一致性  

---

## 4. 还缺少的最后拼图
- **PackedSectionWriter 的完整实现**（string table + child record + bin_data）  
- **材质映射表**（Blender 材质 → BigWorld shader/fx 参数）  
- **骨骼命名规则**（Blender Armature → BigWorld skeleton）  
- **动画采样策略**（采样频率、压缩阈值）  
- **manifest/audit 的源码确认**（字段名、错误码枚举）  

---

# ✅ 总结
我们现在已经有了完整的 **导出蓝图**：  
- `.primitives` → BinSection  
- `.visual/.model/.animation` → PackedSection  
- manifest/audit → 元数据与日志  
- 验证闭环 → hex diff + ModelEditor/WorldEditor  

---

---

# 📑 BigWorld 导出文件 Schema Reference（初稿模板）

## 1. `.primitives`（BinSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| vertices          | float3[]    | ✔    | -      | 顶点坐标数组 |
| normals           | float3[]    | ✔    | -      | 法线数组 |
| uvs               | float2[]    | ✔    | -      | UV 坐标 |
| indices           | int[]       | ✔    | -      | 索引数组 |
| primitiveGroup[]  | struct      | ✔    | -      | 子网格分组（起始索引、数量、材质槽） |
| bspTree           | binary      | ◆    | 空     | BSP 数据（静态场景用） |

---

## 2. `.visual`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| renderSet[]       | struct      | ✔    | -      | 渲染集数组 |
| ├─ geometry       | string      | ✔    | -      | 引用 `.primitives` 文件 |
| ├─ primitiveGroup | int[]       | ✔    | -      | 对应 `.primitives` 的 group 索引 |
| ├─ material       | struct      | ✔    | -      | 材质绑定（fx、纹理、参数） |
| boundingBox       | float3[2]   | ✔    | -      | AABB 包围盒 |
| boundingSphere    | float4      | ✔    | -      | 球心 + 半径 |
| nodes[]           | struct      | ◆    | 空     | 骨骼节点引用 |
| flags             | int         | ◆    | 0      | 渲染标志位（双面、透明等） |

---

## 3. `.model`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| parent            | string      | ◆    | 空     | 父模型路径 |
| visual            | string      | ✔    | -      | 引用 `.visual` 文件 |
| skeleton          | string      | ◆    | 空     | 骨骼文件 |
| animation[]       | struct      | ◆    | 空     | 动画引用（name, resource） |
| action[]          | struct      | ◆    | 空     | 动作定义（name, trigger, animRef） |
| dye/tint          | struct      | ◆    | 空     | 材质替换/染色 |
| lod/impostor      | struct      | ◆    | 空     | LOD 策略与替身图 |

---

## 4. `.animation`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| name              | string      | ✔    | -      | 动画名称 |
| skeletonRef       | string      | ✔    | -      | 骨骼引用 |
| duration          | float       | ✔    | -      | 动画时长（秒） |
| frameRate         | int         | ◆    | 30     | 采样频率 |
| channel[]         | struct      | ✔    | -      | 骨骼通道 |
| ├─ boneName       | string      | ✔    | -      | 骨骼名 |
| ├─ positionKeys   | (time,vec3) | ◆    | 空     | 平移关键帧 |
| ├─ rotationKeys   | (time,quat) | ✔    | -      | 旋转关键帧 |
| ├─ scaleKeys      | (time,vec3) | ◆    | 空     | 缩放关键帧 |
| compression       | bool        | ◆    | false  | 是否压缩 |
| events[]          | struct      | ◆    | 空     | 动画事件（时间戳+标签） |

---

# ✅ 总结
- **必须实现字段**：保证导出闭环（几何、材质、骨骼、动画关键帧）。  
- **占位保留字段**：LOD、BSP、dye/tint、action、events、compression。UI 保留但灰掉。  
- **删除字段**：旧版 3ds Max 专用的 legacy 字段不再需要。  

---



---

# 📑 UI → dataclass → 文件字段 映射表

| UI 控件 (用户操作)                          | dataclass 字段 (插件内部)       | 文件字段 (导出产物)            | 文件类型 |
|---------------------------------------------|---------------------------------|--------------------------------|----------|
| **导出根目录 (Preferences)**                | `ExportSettings.root_path`      | 输出路径（所有文件）            | 全局     |
| **纹理根目录 (Preferences)**                | `ExportSettings.texture_path`   | material.texture 路径           | .visual  |
| **坐标系转换 (Z-up→Y-up)**                  | `ExportSettings.axis_mode`      | transform 矩阵                  | .visual/.model |
| **单位 (米/厘米)**                          | `ExportSettings.unit_scale`     | 顶点坐标缩放                    | .primitives |
| **对象类型 (静态/角色/碰撞/门户/组)**       | `ObjectSettings.type`           | model.type / collision.type     | .model/.collision |
| **资源ID**                                  | `ObjectSettings.asset_id`       | model.resourceID                | .model   |
| **分组 (building/character)**               | `ObjectSettings.group`          | manifest.group                  | manifest.json |
| **LOD 启用/规则** ◆                         | `ObjectSettings.lod_rule`       | model.lod / visual.lod          | .model/.visual |
| **材质槽 → Shader FX 路径**                 | `MaterialSlot.shader`           | material.fx                     | .visual  |
| **材质槽 → 纹理路径 (BaseColor/Normal/ORM)**| `MaterialSlot.textures`         | material.texture[]              | .visual  |
| **材质参数 (颜色/透明度/flags)**             | `MaterialSlot.params`           | material.properties             | .visual  |
| **压缩格式 (DXT5/BC7/无)**                  | `MaterialSlot.compression`      | material.compression            | .visual  |
| **硬点 (添加/类型/校验)**                   | `ObjectSettings.hardpoints[]`   | model.node / visual.node        | .model/.visual |
| **动画轨道列表 (UIList)**                   | `AnimationTrack[]`              | animation.channel[]             | .animation |
| **轨道参数 (帧率/循环)**                    | `AnimationTrack.sample_rate`    | animation.frameRate             | .animation |
| **轨道标签 (IsCoordinated/IsImpacting) ◆**  | `AnimationTrack.flags`          | animation.events / tags         | .animation |
| **碰撞体参数 (来源/层) ◆**                  | `CollisionSettings`             | collision.mesh / collision.layer| .collision |
| **门户参数 (空间ID/法线校验) ◆**            | `PortalSettings`                | portal.spaceID / portal.normal  | .model/.visual |
| **导出类型 (静态/角色/碰撞/门户/组)**       | `ExportJob.type`                | 控制 Writer 调用顺序             | 全局     |
| **生成文件选项 (.primitives/.visual/… )**   | `ExportJob.outputs[]`           | 输出文件列表                     | 全局     |
| **manifest.json 开关**                      | `ExportJob.write_manifest`      | manifest.json                   | manifest |
| **audit.log 开关**                          | `ExportJob.write_audit`         | audit.log                       | audit    |
| **开始导出按钮**                            | `ExportOperator.execute()`      | 调用 Writers 顺序执行            | 全局     |

---

# 🔑 说明
- **✔ 必须实现**：导出路径、对象类型、材质槽、动画轨道、导出按钮。  
- **◆ 占位保留**：LOD、轨道标签、碰撞体、门户参数。UI 保留但灰掉。  
- **文件字段对齐**：每个 UI 控件最终都能追溯到 `.primitives/.visual/.model/.animation` 的具体字段。  

---

---

# 📊 BigWorld Blender 插件导出流程图（字符示意）

```plaintext
┌──────────────────────────────┐
│   用户操作 UI 控件            │
│  (插件偏好设置 / 对象属性 / 导出执行) 
└───────────────┬──────────────┘
                │ 收集参数
                ▼
┌──────────────────────────────┐
│   dataclass 数据结构          │
│  - ExportSettings             │
│  - ObjectSettings             │
│  - MaterialSlot               │
│  - AnimationTrack             │
└───────────────┬──────────────┘
                │ 传递配置
                ▼
┌──────────────────────────────┐
│   ExportJob 调度器            │
│  - 确定导出类型                │
│  - 生成任务队列                │
└───────────────┬──────────────┘
                │ 调用 Writer
                ▼
┌──────────────────────────────┐
│   Writers 模块                │
│  - primitives_writer.py   (.primitives) ✔ 必须实现
│  - visual_writer.py       (.visual)    ✔ 必须实现
│  - model_writer.py        (.model)     ✔ 必须实现
│  - animation_writer.py    (.animation) ✔ 必须实现
│  - collision_writer.py    (.collision) ◆ 占位保留
└───────────────┬──────────────┘
                │ 写入文件
                ▼
┌──────────────────────────────┐
│   核心写入器 Core             │
│  - BinSectionWriter  (.primitives) ✔
│  - PackedSectionWriter (.visual/.model/.animation) ✔
└───────────────┬──────────────┘
                │ 输出产物
                ▼
┌──────────────────────────────┐
│   导出结果文件                │
│  - .primitives                │
│  - .visual                    │
│  - .model                     │
│  - .animation                  │
│  - manifest.json               │
│  - audit.log                   │
│  - .collision (占位) ◆         │
└──────────────────────────────┘
```

---

# 🔑 说明
- **UI 层**：用户通过插件偏好设置、对象属性面板、导出执行面板配置参数。  
- **dataclass 层**：所有 UI 输入被收集到统一的数据结构。  
- **调度层**：ExportJob 根据对象类型和导出选项，决定调用哪些 Writer。  
- **Writer 层**：每个 Writer 负责一种文件类型，内部调用核心写入器。  
- **核心层**：BinSectionWriter / PackedSectionWriter 负责底层二进制写入。  
- **产物层**：最终生成 BigWorld 所需的文件集。  

---

---

# 📊 BigWorld 文件依赖顺序图（字符示意）

```plaintext
┌───────────────┐
│  .primitives  │  ← 顶点/索引/UV/法线等几何数据
└───────┬───────┘
        │ 引用 geometry
        ▼
┌───────────────┐
│    .visual    │  ← 渲染集(renderSet)、材质绑定、包围盒
└───────┬───────┘
        │ 引用 visual
        ▼
┌───────────────┐
│    .model     │  ← 组合：visual + skeleton + animation
└───────┬───────┘
        │ 引用 skeletonRef / animation
        ▼
┌───────────────┐
│  .animation   │  ← 骨骼通道、关键帧、事件
└───────────────┘
```

---

# 🔑 依赖说明
1. **.primitives**  
   - 最底层文件，存储几何数据。  
   - 必须先生成，供 `.visual` 引用。  

2. **.visual**  
   - 引用 `.primitives`，定义渲染集、材质、包围盒。  
   - 是 `.model` 的核心组成部分。  

3. **.model**  
   - 引用 `.visual`，并可引用 `.skeleton` 与 `.animation`。  
   - 负责组合资源，形成完整实体。  

4. **.animation**  
   - 独立文件，但通常由 `.model` 引用。  
   - 必须在 `.model` 中注册才能生效。  

---

# ✅ 总结
- 导出顺序必须是：  
  **.primitives → .visual → .model → .animation**  
- `.primitives` 是几何基础，`.visual` 是渲染描述，`.model` 是组合容器，`.animation` 是动作数据。  
- `.model` 是关键枢纽，负责把几何、材质、骨骼、动画整合到一起。  

---

---

# 📑 BigWorld Schema Reference（完整版本）

## 1. `.primitives`（BinSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| vertices          | float3[]    | ✔    | -      | 顶点坐标数组 |
| normals           | float3[]    | ✔    | -      | 法线数组 |
| tangents/binormals| float3[]    | ◆    | 空     | 切线/副切线（法线贴图用） |
| uvs               | float2[]    | ✔    | -      | UV 坐标 |
| colors            | float4[]    | ◆    | 空     | 顶点颜色 |
| indices           | int[]       | ✔    | -      | 索引数组 |
| primitiveGroup[]  | struct      | ✔    | -      | 子网格分组（起始索引、数量、材质槽） |
| bspTree           | binary      | ◆    | 空     | BSP 数据（静态场景用） |

---

## 2. `.visual`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| renderSet[]       | struct      | ✔    | -      | 渲染集数组 |
| ├─ geometry       | string      | ✔    | -      | 引用 `.primitives` 文件 |
| ├─ primitiveGroup | int[]       | ✔    | -      | 对应 `.primitives` 的 group 索引 |
| ├─ material       | struct      | ✔    | -      | 材质绑定（fx、纹理、参数） |
| boundingBox       | float3[2]   | ✔    | -      | AABB 包围盒 |
| boundingSphere    | float4      | ✔    | -      | 球心 + 半径 |
| nodes[]           | struct      | ◆    | 空     | 骨骼节点引用 |
| flags             | int         | ◆    | 0      | 渲染标志位（双面、透明等） |
| dye/tint          | struct      | ◆    | 空     | 材质替换/染色 |

---

## 3. `.model`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| parent            | string      | ◆    | 空     | 父模型路径 |
| visual            | string      | ✔    | -      | 引用 `.visual` 文件 |
| skeleton          | string      | ◆    | 空     | 骨骼文件 |
| animation[]       | struct      | ◆    | 空     | 动画引用（name, resource） |
| action[]          | struct      | ◆    | 空     | 动作定义（name, trigger, animRef） |
| extent            | float3      | ✔    | -      | 模型范围（半长宽高） |
| boundingBox       | float3[2]   | ✔    | -      | AABB 包围盒 |
| dye/tint          | struct      | ◆    | 空     | 材质替换/染色 |
| lod/impostor      | struct      | ◆    | 空     | LOD 策略与替身图 |

---

## 4. `.animation`（PackedSection）
| 字段名            | 类型        | 必选 | 默认值 | 说明 |
|-------------------|-------------|------|--------|------|
| name              | string      | ✔    | -      | 动画名称 |
| skeletonRef       | string      | ✔    | -      | 骨骼引用 |
| duration          | float       | ✔    | -      | 动画时长（秒） |
| frameRate         | int         | ◆    | 30     | 采样频率 |
| channel[]         | struct      | ✔    | -      | 骨骼通道 |
| ├─ boneName       | string      | ✔    | -      | 骨骼名 |
| ├─ positionKeys   | (time,vec3) | ◆    | 空     | 平移关键帧 |
| ├─ rotationKeys   | (time,quat) | ✔    | -      | 旋转关键帧 |
| ├─ scaleKeys      | (time,vec3) | ◆    | 空     | 缩放关键帧 |
| compression       | bool        | ◆    | false  | 是否压缩 |
| events[]          | struct      | ◆    | 空     | 动画事件（时间戳+标签） |

---

# ✅ 总结
- **必须实现字段**：保证导出闭环（几何、材质、骨骼、动画关键帧、包围盒）。  
- **占位保留字段**：LOD、BSP、dye/tint、action、events、compression。UI 保留但灰掉。  
- **删除字段**：旧版 3ds Max 专用的 legacy 字段不再需要。  

---

