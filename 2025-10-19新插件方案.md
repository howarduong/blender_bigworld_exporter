
---

# ğŸ–¥ï¸ BigWorld Blender æ’ä»¶ UI å­—ç¬¦ç¤ºæ„å›¾ï¼ˆæœ€ç»ˆç‰ˆï¼‰


- **ç»¿è‰²ï¼ˆâœ” å¿…é¡»å®ç°ï¼‰**  
- **é»„è‰²ï¼ˆâ—† å ä½ä¿ç•™ï¼Œæš‚ä¸å¼€å‘ï¼‰**  
- **çº¢è‰²ï¼ˆâœ˜ åˆ é™¤ï¼Œä¸å†éœ€è¦ï¼‰**

åœ¨ 3ds Max æ’ä»¶é‡Œå¸¸ç”¨çš„æ§ä»¶æœ‰ï¼š  
- **ä¸‹æ‹‰æ¡†ï¼ˆComboBoxï¼‰** â†’ å¯¹è±¡ç±»å‹ã€LOD æ¨¡æ¿ã€ç›®å½•ç­–ç•¥  
- **å¤é€‰æ¡†ï¼ˆCheckBoxï¼‰** â†’ å¯¼å‡ºé€‰é¡¹ã€æ¸²æŸ“æ ‡å¿—ã€åŠŸèƒ½å¼€å…³  
- **æ–‡æœ¬æ¡†ï¼ˆEditTextï¼‰** â†’ è·¯å¾„ã€èµ„æºID  
- **æŒ‰é’®ï¼ˆButtonï¼‰** â†’ æµè§ˆã€è¿è¡Œæ£€æµ‹ã€å¯¼å‡º  
- **é¢œè‰²é€‰æ‹©å™¨ï¼ˆColorSwatchï¼‰** â†’ Tint é¢œè‰²  
- **åˆ—è¡¨ï¼ˆUIList/ListBoxï¼‰** â†’ åŠ¨ç”»è½¨é“ã€äº‹ä»¶åˆ—è¡¨  
- **æ»‘å—ï¼ˆSpinner/Sliderï¼‰** â†’ å‹ç¼©é˜ˆå€¼ã€æ•°å€¼å‚æ•°  

---

# ğŸ›ï¸ æ”¹è¿›åçš„ä¸‰å¤§åŒºåŸŸ UI ç¤ºæ„å›¾ï¼ˆå¸¦é¢œè‰²æ ‡è®°ï¼‰

## 1. æ’ä»¶åå¥½è®¾ç½®ï¼ˆå…¨å±€è®¾ç½®ï¼‰
```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BigWorld æ’ä»¶å…¨å±€è®¾ç½®                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¼å‡ºæ ¹ç›®å½•ï¼š [è·¯å¾„] [ğŸ“]              âœ”                     â”‚
â”‚ çº¹ç†æ ¹ç›®å½•ï¼š [è·¯å¾„] [ğŸ“]              âœ”                     â”‚
â”‚ åæ ‡ç³»è½¬æ¢ï¼š (Z-up â†’ Y-up) ä¸‹æ‹‰æ¡†     âœ”                     â”‚
â”‚ å•ä½ï¼š (ç±³/å˜ç±³) ä¸‹æ‹‰æ¡†               âœ”                     â”‚
â”‚ å‘½åè§„èŒƒæ¨¡æ¿ï¼š ä¸‹æ‹‰æ¡†                 âœ”                     â”‚
â”‚ LOD è§„åˆ™æ¨¡æ¿ï¼š ä¸‹æ‹‰æ¡†                 â—†                     â”‚
â”‚ å¯¼å‡ºç»„åˆ schemaï¼š [é»˜è®¤/é€‰æ‹©æ–‡ä»¶]     â—†                     â”‚
â”‚ ç›®å½•/æ‰“åŒ…ç­–ç•¥ï¼š ä¸‹æ‹‰æ¡†                â—†                     â”‚
â”‚------------------------------------------------------------â”‚
â”‚ [âœ”] å¯¼å‡ºå‰è‡ªåŠ¨æ£€æµ‹                  âœ”                      â”‚
â”‚ [âœ”] å†™å…¥å®¡è®¡æ—¥å¿—                    âœ”                      â”‚
â”‚ [ä¿å­˜è®¾ç½®] [é‡ç½®]                   âœ”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å¯¹è±¡å±æ€§é¢æ¿ï¼ˆå¯¹è±¡çº§è®¾ç½®ï¼‰
```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BigWorld å¯¹è±¡å±æ€§                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è±¡ç±»å‹ï¼š ä¸‹æ‹‰æ¡† (é™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·/ç»„)   âœ”              â”‚
â”‚ èµ„æºIDï¼š [æ–‡æœ¬æ¡†]   åˆ†ç»„ï¼š [æ–‡æœ¬æ¡†]          âœ”              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ LODï¼š [å¯ç”¨] [è‡ªåŠ¨ç”ŸæˆLOD] ä¸‹æ‹‰æ¡†è§„åˆ™        â—†              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ æè´¨æ§½ï¼š æ¨¡æ¿ä¸‹æ‹‰æ¡† [é»˜è®¤PBR]               âœ”              â”‚
â”‚ BaseColor [è·¯å¾„] Normal [è·¯å¾„] ORM [è·¯å¾„]    âœ”              â”‚
â”‚ å‹ç¼©ï¼š ä¸‹æ‹‰æ¡† (DXT5/BC7/æ— )                 âœ”              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ ç¡¬ç‚¹ï¼š [æ·»åŠ æŒ‰é’®] åç§°/ç±»å‹ ä¸‹æ‹‰æ¡†           âœ”              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ åŠ¨ç”»è½¨é“ï¼ˆä»…è§’è‰²ï¼‰ï¼š UIList                 âœ”              â”‚
â”‚   - è½¨é“å / å¸§ç‡ / å¾ªç¯ / äº‹ä»¶æ ‡ç­¾                          â”‚
â”‚ æ ‡ç­¾ï¼š IsCoordinated [âœ”]  IsImpacting [âœ”]   â—†              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ ç¢°æ’ä½“å‚æ•°ï¼š æ¥æºä¸‹æ‹‰æ¡† å±‚ä¸‹æ‹‰æ¡†             â—†              â”‚
â”‚ é—¨æˆ·å‚æ•°ï¼š ç©ºé—´ID [æ–‡æœ¬æ¡†] æ³•çº¿æ ¡éªŒ[æŒ‰é’®]    â—†              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ [è¿è¡Œå¯¼å‡ºå‰æ£€æµ‹æŒ‰é’®]                     âœ”                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å¯¼å‡ºæ‰§è¡Œé¢æ¿ï¼ˆFile > Export > BigWorldï¼‰
```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BigWorld å¯¼å‡ºæ‰§è¡Œ                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¼å‡ºç±»å‹ï¼š ä¸‹æ‹‰æ¡† (é™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·/ç»„)   âœ”              â”‚
â”‚ å‡ ä½•æ ¼å¼ï¼š ä¸‹æ‹‰æ¡† (primitives/processed)     â—†              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ ç”Ÿæˆæ–‡ä»¶ï¼š                                                  â”‚
â”‚  - .primitives [âœ”]                          âœ”              â”‚
â”‚  - .visual [âœ”]                              âœ”              â”‚
â”‚  - .animation [âœ”]                           âœ”              â”‚
â”‚  - .collision [âœ”]                           â—†              â”‚
â”‚  - .model/.xml [âœ”]                          âœ”              â”‚
â”‚  - manifest.json [âœ”]                        âœ”              â”‚
â”‚  - audit.log [âœ”]                            âœ”              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ ç›®å½•ç­–ç•¥ï¼š ä¸‹æ‹‰æ¡† (æŒ‰ç±»å‹/æŒ‰åŒ…/æŒ‰LOD)        â—†              â”‚
â”‚ å¯¼å‡ºé¢„è®¾ï¼š [ä¿å­˜æŒ‰é’®] [é€‰æ‹©æŒ‰é’®]             â—†              â”‚
â”‚------------------------------------------------------------â”‚
â”‚ [å¼€å§‹å¯¼å‡ºæŒ‰é’®]                             âœ”                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# âœ… æ€»ç»“
- **ç»¿è‰²ï¼ˆâœ”ï¼‰å¿…é¡»å®ç°**ï¼šä¿è¯å¯¼å‡ºé—­ç¯ï¼ˆè·¯å¾„ã€å¯¹è±¡ç±»å‹ã€æè´¨ã€åŠ¨ç”»ã€å¯¼å‡ºæŒ‰é’®ï¼‰ã€‚  
- **é»„è‰²ï¼ˆâ—†ï¼‰å ä½ä¿ç•™**ï¼šLODã€BSPã€å‹ç¼©ã€äº‹ä»¶ã€é—¨æˆ·ã€ç¢°æ’ä½“ã€ç›®å½•ç­–ç•¥ã€å¯¼å‡ºé¢„è®¾ã€‚UI ä¿ç•™ä½†ç°æ‰ã€‚  
- **çº¢è‰²ï¼ˆâœ˜ï¼‰åˆ é™¤**ï¼šå†—ä½™åŠŸèƒ½ï¼ˆå¦‚ UV æ ¡éªŒç‹¬ç«‹æŒ‰é’®ã€æç¤ºæ€§æ–‡å­—ï¼‰ï¼Œå·²å»æ‰ã€‚  
- **å…¨å±€è®¾ç½®**ï¼šä¸€æ¬¡è®¾å®šï¼Œå…¨å±€ç”Ÿæ•ˆï¼ˆè·¯å¾„ã€åæ ‡ç³»ã€å‘½å/LOD è§„åˆ™ã€schemaã€ç›®å½•ç­–ç•¥ï¼‰  
- **å¯¹è±¡å±æ€§**ï¼šå¯¹è±¡è‡ªèº«çš„é…ç½®ï¼ˆç±»å‹ã€LODã€æè´¨ã€ç¡¬ç‚¹ã€åŠ¨ç”»ã€ç¢°æ’ã€é—¨æˆ·ï¼‰  
- **å¯¼å‡ºæ‰§è¡Œ**ï¼šå¯¼å‡ºä»»åŠ¡æ§åˆ¶ï¼ˆå¯¼å‡ºç±»å‹ã€å¯¼å‡ºé€‰é¡¹ã€ç”Ÿæˆæ–‡ä»¶ã€ç›®å½•ç­–ç•¥ã€æ‰§è¡ŒæŒ‰é’®ï¼‰  



---

# ğŸ—‚ï¸ æ§ä»¶ç±»å‹å¯¹ç…§è¡¨ï¼ˆ3ds Max â†’ Blenderï¼‰

| åŠŸèƒ½ç±»åˆ«         | 3ds Max æ’ä»¶æ§ä»¶ç±»å‹              | Blender æ’ä»¶å¯¹åº”æ§ä»¶ (bpy.types) | å…¸å‹ç”¨é€”ç¤ºä¾‹ |
|------------------|----------------------------------|----------------------------------|--------------|
| **å¸ƒå°”å¼€å…³**     | CheckBox (å¤é€‰æ¡†)                | BoolProperty + CheckBox          | å¯¼å‡ºé€‰é¡¹ã€å¯ç”¨LODã€æ˜¯å¦å¾ªç¯ |
| **å•é€‰/æšä¸¾**    | ComboBox (ä¸‹æ‹‰æ¡†)                | EnumProperty + Dropdown          | å¯¹è±¡ç±»å‹ã€å‡ ä½•æ ¼å¼ã€LOD æ¨¡æ¿ |
| **æ–‡æœ¬è¾“å…¥**     | EditText (æ–‡æœ¬æ¡†)                | StringProperty + TextField       | è·¯å¾„ã€èµ„æºIDã€ç©ºé—´ID |
| **æ•°å€¼è¾“å…¥**     | Spinner (æ•°å€¼å¾®è°ƒå™¨)             | IntProperty / FloatProperty + NumberField | å¸§ç‡ã€å‹ç¼©é˜ˆå€¼ã€ç¼©æ”¾æ¯”ä¾‹ |
| **æ»‘å—**         | Slider (æ»‘åŠ¨æ¡)                  | FloatProperty + Slider           | å‹ç¼©é˜ˆå€¼ã€é€æ˜åº¦ã€æƒé‡ |
| **æŒ‰é’®**         | Button                           | Operator (bpy.types.Operator)    | æµè§ˆè·¯å¾„ã€è¿è¡Œæ£€æµ‹ã€å¼€å§‹å¯¼å‡º |
| **é¢œè‰²é€‰æ‹©**     | ColorSwatch (é¢œè‰²å—)             | FloatVectorProperty(subtype='COLOR') | Tint æŸ“è‰²ã€æè´¨é¢œè‰² |
| **æ–‡ä»¶é€‰æ‹©**     | FilePicker (æ–‡ä»¶æµè§ˆå™¨)           | bpy.props.StringProperty(subtype='FILE_PATH') | é€‰æ‹© Visual/Animation æ–‡ä»¶ |
| **æ–‡ä»¶å¤¹é€‰æ‹©**   | FolderPicker (ç›®å½•æµè§ˆå™¨)         | bpy.props.StringProperty(subtype='DIR_PATH')  | å¯¼å‡ºæ ¹ç›®å½•ã€çº¹ç†æ ¹ç›®å½• |
| **åˆ—è¡¨**         | ListBox / UIList                 | UIList (bpy.types.UIList)        | åŠ¨ç”»è½¨é“åˆ—è¡¨ã€äº‹ä»¶åˆ—è¡¨ã€æè´¨æ§½ |
| **åˆ†ç»„æ¡†**       | GroupBox (åˆ†ç»„å®¹å™¨)              | Panel / BoxLayout                | æ¿å—åˆ’åˆ†ï¼ˆæè´¨ã€LODã€åŠ¨ç”»ï¼‰ |
| **æ ‡ç­¾**         | StaticText (é™æ€æ–‡æœ¬)            | Label                            | å­—æ®µè¯´æ˜ã€æç¤ºä¿¡æ¯ |

---

# ğŸ”‘ è¿ç§»è¦ç‚¹
1. **CheckBox â†’ BoolProperty**  
   - Max æ’ä»¶é‡Œå¸¸è§çš„ `[âœ”] å¯¼å‡º .visual` â†’ Blender ç”¨ `BoolProperty` + `layout.prop()`ã€‚  

2. **ComboBox â†’ EnumProperty**  
   - Max æ’ä»¶çš„ä¸‹æ‹‰æ¡†ï¼ˆå¯¹è±¡ç±»å‹ã€LOD æ¨¡æ¿ï¼‰ â†’ Blender ç”¨ `EnumProperty`ã€‚  

3. **EditText â†’ StringProperty**  
   - Max æ’ä»¶çš„è·¯å¾„è¾“å…¥æ¡† â†’ Blender ç”¨ `StringProperty`ï¼Œå¯åŠ  `subtype='FILE_PATH'`ã€‚  

4. **Spinner/Slider â†’ Int/FloatProperty**  
   - Max æ’ä»¶çš„æ•°å€¼å¾®è°ƒå™¨ â†’ Blender ç”¨ `FloatProperty`ï¼Œå¯è®¾ç½® `min/max/step`ã€‚  

5. **UIList â†’ bpy.types.UIList**  
   - åŠ¨ç”»è½¨é“ã€æè´¨æ§½åˆ—è¡¨ â†’ Blender åŸç”Ÿæ”¯æŒ UIListï¼ŒåŠŸèƒ½æ›´å¼ºã€‚  

---

# âœ… æ€»ç»“
- **å¿…é¡»è¿ç§»çš„æ§ä»¶**ï¼šCheckBoxã€ComboBoxã€EditTextã€Buttonã€UIListã€‚  
- **å¯å¢å¼ºçš„æ§ä»¶**ï¼šé¢œè‰²é€‰æ‹©ã€æ–‡ä»¶/ç›®å½•é€‰æ‹©ï¼ˆBlender åŸç”Ÿæ”¯æŒæ›´å¥½ï¼‰ã€‚  
- **å¸ƒå±€æ–¹å¼**ï¼š3ds Max ç”¨ GroupBoxï¼ŒBlender ç”¨ Panel/BoxLayoutã€‚  

---


---

# ğŸ“‚ BigWorld Blender æ’ä»¶æ–‡ä»¶ç»“æ„ï¼ˆå¸¦å¼€å‘ä¼˜å…ˆçº§æ ‡æ³¨ï¼‰

```plaintext
blender_bigworld_exporter/
â”‚
â”œâ”€ core/                               # æ ¸å¿ƒå†™å…¥å™¨ä¸é€šç”¨é€»è¾‘
â”‚   â”œâ”€ bin_section_writer.py            # âœ” å¿…é¡»å®ç°ï¼šå†™ .primitives
â”‚   â”œâ”€ packed_section_writer.py         # âœ” å¿…é¡»å®ç°ï¼šå†™ .visual/.model/.animation
â”‚   â”œâ”€ schema.py                        # âœ” å¿…é¡»å®ç°ï¼šdataclass å®šä¹‰ï¼ˆPrimitives/Visual/Model/Animationï¼‰
â”‚   â””â”€ validators.py                    # âœ” å¿…é¡»å®ç°ï¼šé€šç”¨æ ¡éªŒå™¨ï¼ˆéª¨éª¼ä¸€è‡´æ€§ã€group å¯¹é½ã€å…³é”®å¸§å•è°ƒæ€§ï¼‰
â”‚
â”œâ”€ writers/                            # å„æ–‡ä»¶ç±»å‹å¯¼å‡ºå™¨
â”‚   â”œâ”€ primitives_writer.py             # âœ” å¿…é¡»å®ç°
â”‚   â”œâ”€ visual_writer.py                 # âœ” å¿…é¡»å®ç°
â”‚   â”œâ”€ model_writer.py                  # âœ” å¿…é¡»å®ç°
â”‚   â”œâ”€ animation_writer.py              # âœ” å¿…é¡»å®ç°
â”‚   â””â”€ collision_writer.py              # â—† å ä½ä¿ç•™ï¼šç¢°æ’ä½“å¯¼å‡ºï¼ˆæš‚ä¸å¼€å‘ï¼‰
â”‚
â”œâ”€ ui/                                 # Blender æ’ä»¶ UI
â”‚   â”œâ”€ preferences_panel.py             # âœ” å¿…é¡»å®ç°ï¼šæ’ä»¶åå¥½è®¾ç½®ï¼ˆå…¨å±€è®¾ç½®ï¼‰
â”‚   â”œâ”€ object_panel.py                  # âœ” å¿…é¡»å®ç°ï¼šå¯¹è±¡å±æ€§é¢æ¿
â”‚   â”œâ”€ export_panel.py                  # âœ” å¿…é¡»å®ç°ï¼šå¯¼å‡ºæ‰§è¡Œé¢æ¿
â”‚   â”œâ”€ material_panel.py                # â—† å ä½ä¿ç•™ï¼šæè´¨é«˜çº§å‚æ•°ï¼ˆDye/Tintã€PBR æ‰©å±•ï¼‰
â”‚   â”œâ”€ lod_panel.py                     # â—† å ä½ä¿ç•™ï¼šLOD é…ç½®
â”‚   â”œâ”€ portal_panel.py                  # â—† å ä½ä¿ç•™ï¼šé—¨æˆ·å¯¹è±¡é…ç½®
â”‚   â””â”€ collision_panel.py               # â—† å ä½ä¿ç•™ï¼šç¢°æ’ä½“å‚æ•°é…ç½®
â”‚
â”œâ”€ utils/                              # å·¥å…·å‡½æ•°
â”‚   â”œâ”€ mesh_utils.py                    # âœ” å¿…é¡»å®ç°ï¼šä¸‰è§’åŒ–ã€æ³•çº¿/åˆ‡çº¿ç”Ÿæˆ
â”‚   â”œâ”€ armature_utils.py                # âœ” å¿…é¡»å®ç°ï¼šéª¨éª¼é‡‡æ ·ã€åŠ¨ç”»é‡‡æ ·
â”‚   â”œâ”€ material_utils.py                # âœ” å¿…é¡»å®ç°ï¼šæè´¨æ˜ å°„è¡¨
â”‚   â”œâ”€ audit_utils.py                   # âœ” å¿…é¡»å®ç°ï¼šmanifest.json & audit.log å†™å…¥
â”‚   â”œâ”€ lod_utils.py                     # â—† å ä½ä¿ç•™ï¼šLOD è‡ªåŠ¨ç”Ÿæˆ
â”‚   â”œâ”€ portal_utils.py                  # â—† å ä½ä¿ç•™ï¼šé—¨æˆ·ç©ºé—´æ ¡éªŒ
â”‚   â””â”€ collision_utils.py               # â—† å ä½ä¿ç•™ï¼šç¢°æ’ä½“ç”Ÿæˆ
â”‚
â”œâ”€ tests/                              # æµ‹è¯•ä¸éªŒè¯
â”‚   â”œâ”€ test_hex_diff.py                 # âœ” å¿…é¡»å®ç°ï¼šä¸æ—§ç‰ˆäº§ç‰©å¯¹æ¯”
â”‚   â”œâ”€ test_model_editor.py             # âœ” å¿…é¡»å®ç°ï¼šè°ƒç”¨ ModelEditor éªŒè¯
â”‚   â”œâ”€ test_schema.py                   # âœ” å¿…é¡»å®ç°ï¼šschema æ ¡éªŒ
â”‚   â””â”€ test_lod_collision.py            # â—† å ä½ä¿ç•™ï¼šLOD/ç¢°æ’ä½“æµ‹è¯•
â”‚
â””â”€ docs/                               # æ–‡æ¡£
    â”œâ”€ schema_reference.md              # âœ” å¿…é¡»å®ç°ï¼šå­—æ®µå¯¹ç…§è¡¨
    â”œâ”€ ui_mapping.md                    # âœ” å¿…é¡»å®ç°ï¼šUI â†’ æ–‡ä»¶å­—æ®µæ˜ å°„
    â””â”€ roadmap.md                       # âœ” å¿…é¡»å®ç°ï¼šå¼€å‘è®¡åˆ’ï¼ˆæ ‡æ³¨å ä½åŠŸèƒ½ï¼‰
```

---

# âœ… æ€»ç»“
- **å¿…é¡»å®ç°ï¼ˆâœ”ï¼‰**ï¼šä¿è¯å¯¼å‡ºé—­ç¯çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆprimitives/visual/model/animationã€åŸºç¡€æè´¨ã€åŠ¨ç”»é‡‡æ ·ã€manifest/auditã€éªŒè¯å·¥å…·ï¼‰ã€‚  
- **å ä½ä¿ç•™ï¼ˆâ—†ï¼‰**ï¼šLODã€ç¢°æ’ä½“ã€é—¨æˆ·ã€æè´¨é«˜çº§å‚æ•°ï¼ˆDye/Tintï¼‰ã€å‹ç¼©ç­‰é«˜çº§åŠŸèƒ½ï¼ŒUI å’Œæ–‡ä»¶ç»“æ„ä¿ç•™ï¼Œä½†æš‚ä¸å¼€å‘ã€‚  
- **åˆ é™¤ï¼ˆâœ˜ï¼‰**ï¼šå†—ä½™åŠŸèƒ½å·²åœ¨ç›®å½•ä¸­å»æ‰ï¼Œä¸å†å•ç‹¬åˆ—å‡ºã€‚  

---


```

---

# âš™ï¸ åŠŸèƒ½æè¿°ï¼ˆæœ€ç»ˆç‰ˆï¼‰

- **å¯¼å‡ºæ–‡ä»¶ç±»å‹ä¸é¡ºåº**  
  - é™æ€æ¨¡å‹ï¼š`.primitives â†’ .collision(é€‰) â†’ .visual â†’ .model/.xml â†’ manifest/log`  
  - åŠ¨ç”»è§’è‰²ï¼š`.primitives â†’ .animation â†’ .visual â†’ .model/.xml â†’ manifest/log`  
  - ç¢°æ’ä½“ï¼š`.collision â†’ .model/.xml(é€‰) â†’ manifest/log`  
  - é—¨æˆ·ï¼š`.visual â†’ .model/.xml â†’ manifest/log`  

- **è·¯å¾„ç­–ç•¥ä¸å¼•ç”¨**  
  - æ‰€æœ‰å¼•ç”¨è·¯å¾„ç”± `utils.path_policy` ç”Ÿæˆ  
  - `.visual` å¼•ç”¨ `.primitives`ã€`.collision`  
  - `.model/.xml` å¼•ç”¨ `.visual`ã€`.animation`ã€`.collision`  
  - `.portal.xml` å¼•ç”¨ç©ºé—´ IDã€æ³•çº¿æ–¹å‘  

- **åæ ‡ç³»ç»Ÿ**  
  - é»˜è®¤ï¼šBlender Z-up â†’ BigWorld Y-up  
  - ç»Ÿä¸€å…¥å£ï¼š`core.coordinate_system`  
  - è¦†ç›–ï¼šé¡¶ç‚¹/æ³•çº¿/åˆ‡çº¿ã€ç¡¬ç‚¹ã€åŠ¨ç”»å…³é”®å¸§ã€ç¢°æ’ä½“ã€é—¨æˆ·æ³•çº¿  

- **XML æ¨¡æ¿ä½“ç³»**  
  - æ‰€æœ‰ XML ç±»æ–‡ä»¶ï¼ˆvisualã€modelã€portalã€åŠ¨ç”»ç»‘å®šï¼‰é€šè¿‡ `core.xml_writer` æ¸²æŸ“  
  - æ¨¡æ¿å­˜æ”¾åœ¨ `templates/*.tpl.xml`  
  - writer åªå‡†å¤‡æ•°æ®å­—å…¸ï¼Œè°ƒç”¨ `xml_writer.render(template, data)`  
  - ä¿è¯å­—æ®µé¡ºåºã€ç¼©è¿›ã€æ ‡ç­¾å‘½åä¸å®˜æ–¹ä¸€è‡´  

- **primitives å¯¹é½**  
  - ä¸¥æ ¼å¯¹é½é¡¶ç‚¹ç¼“å†²ã€ç´¢å¼•ç¼“å†²ã€å±æ€§é€šé“ã€LOD  
  - `core.serializer` ç»Ÿä¸€å­—èŠ‚åºä¸å—å¤´  
  - `utils.hex_diff` ä¸æ—§äº§ç‰©å¯¹æ¯”  

- **éªŒè¯ä¸å¯è¿½è¸ª**  
  - `validate_operator` è¾“å‡º UI æ‘˜è¦ä¸ audit.log  
  - `manifest_writer` è¾“å‡ºæ¸…å•ï¼Œåˆ—å‡ºäº§ç‰©ä¸ä¾èµ–å…³ç³»  

---


---

# ğŸš€ å¯¼å‡ºæµç¨‹ï¼ˆæœ€ç»ˆç‰ˆï¼‰

### 1. å¯¹è±¡é…ç½®é˜¶æ®µ
- **åœ¨ N é”®å¯¹è±¡é¢æ¿**ä¸­å®Œæˆå¯¹è±¡çº§è®¾ç½®ï¼š  
  - ç±»å‹ï¼ˆé™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·ï¼‰  
  - LOD é…ç½®ï¼ˆè‡ªåŠ¨ç”Ÿæˆ/å‘½åè§„åˆ™ï¼‰  
  - æè´¨æ§½ä¸çº¹ç†è·¯å¾„ï¼ˆBaseColor/Normal/ORMï¼‰  
  - ç¡¬ç‚¹ï¼ˆåç§°ã€ç±»å‹ã€å˜æ¢æ ¡éªŒï¼‰  
  - åŠ¨ç”»è½¨é“ï¼ˆè½¨é“åã€å¸§ç‡ã€å¾ªç¯ã€äº‹ä»¶æ ‡ç­¾ï¼‰  
  - ç¢°æ’ä½“å‚æ•°ï¼ˆæ¥æºï¼šç½‘æ ¼/ç®€åŒ–/å‡¸åŒ…ï¼Œå±‚çº§ï¼‰  
  - é—¨æˆ·å‚æ•°ï¼ˆç©ºé—´IDã€æ³•çº¿æ–¹å‘æ ¡éªŒï¼‰  

ğŸ‘‰ è¿™ä¸€é˜¶æ®µåªæ¶‰åŠå¯¹è±¡è‡ªèº«å±æ€§ï¼Œä¸æ¶‰åŠå¯¼å‡ºé¡ºåºã€‚

---

### 2. é¢„æ£€é˜¶æ®µ
- **è°ƒç”¨ `validate_operator`**ï¼Œæ‰§è¡Œä»¥ä¸‹æ ¡éªŒï¼š  
  - å‡ ä½•ï¼šéæµå½¢ã€ä¸‰è§’åŒ–ã€æ³•çº¿ä¸€è‡´æ€§  
  - UVï¼šé‡å ã€è¶Šç•Œã€åˆ‡çº¿ç©ºé—´  
  - æè´¨ï¼šæ§½ä½å®Œæ•´æ€§ã€çº¹ç†è·¯å¾„å­˜åœ¨æ€§ã€å‹ç¼©ç­–ç•¥  
  - å‘½åï¼šå¯¹è±¡/LOD/ç¡¬ç‚¹å‘½åç¬¦åˆ schema  
  - åŠ¨ç”»ï¼šè½¨é“å‚æ•°å®Œæ•´ã€éª¨æ¶ä¸€è‡´æ€§  
  - ç¢°æ’/é—¨æˆ·ï¼šå‡¸åŒ…ç”Ÿæˆå¯ç”¨ã€é—¨æˆ·æ³•çº¿æ–¹å‘æ­£ç¡®  

- **è¾“å‡ºç»“æœ**ï¼š  
  - UI é¢æ¿æ‘˜è¦ï¼ˆçº¢/é»„/ç»¿çŠ¶æ€ï¼‰  
  - audit.log è¯¦ç»†è®°å½•ï¼ˆé”™è¯¯ç ã€è­¦å‘Šã€å»ºè®®ï¼‰  

ğŸ‘‰ æœªé€šè¿‡æ ¡éªŒåˆ™ç¦æ­¢è¿›å…¥å¯¼å‡ºã€‚

---

### 3. å¯¼å‡ºæ‰§è¡Œé˜¶æ®µï¼ˆpipeline å›ºå®šé¡ºåºï¼‰
- **è°ƒç”¨ `export_operator`**ï¼Œæ ¹æ®å¯¹è±¡ç±»å‹é€‰æ‹©å¯¹åº” pipelineï¼š  

| ç±»å‹       | å¯¼å‡ºé¡ºåºï¼ˆå›ºå®šï¼‰ |
|------------|------------------|
| é™æ€æ¨¡å‹   | primitives â†’ collision(é€‰) â†’ visual â†’ model/xml â†’ manifest/log |
| åŠ¨ç”»è§’è‰²   | primitives â†’ animation â†’ visual â†’ model/xml â†’ manifest/log |
| ç¢°æ’ä½“     | collision â†’ model/xml(é€‰) â†’ manifest/log |
| é—¨æˆ·       | visual â†’ model/xml â†’ manifest/log |

- **æ¯ä¸€æ­¥ writer çš„èŒè´£**ï¼š  
  - primitives_writerï¼šå†™å‡ ä½•æ•°æ®ï¼ˆè°ƒç”¨ coordinate_system è½¬æ¢ï¼‰  
  - collision_writerï¼šå†™ç¢°æ’ä½“æ•°æ®  
  - animation_writerï¼šå†™éª¨éª¼åŠ¨ç”»è½¨é“  
  - visual_writerï¼šè°ƒç”¨ xml_writer æ¸²æŸ“ visual.tpl.xml  
  - model_writerï¼šè°ƒç”¨ xml_writer æ¸²æŸ“ model.tpl.xml  
  - portal_writerï¼šè°ƒç”¨ xml_writer æ¸²æŸ“ portal.tpl.xml  
  - manifest_writerï¼šç”Ÿæˆæ¸…å•  
  - audit_writerï¼šç”Ÿæˆæ—¥å¿—  

ğŸ‘‰ æ‰€æœ‰ writer çš„è·¯å¾„ä¸å¼•ç”¨ç”± `utils.path_policy` æä¾›ï¼Œç¦æ­¢è‡ªè¡Œæ‹¼æ¥ã€‚

---

### 4. æäº¤ä¸æ¸…å•é˜¶æ®µ
- **äº‹åŠ¡æ§åˆ¶**ï¼š  
  - æ‰€æœ‰æ–‡ä»¶å…ˆå†™å…¥ä¸´æ—¶ç›®å½•  
  - ä¾èµ–æ ¡éªŒé€šè¿‡åç»Ÿä¸€æäº¤åˆ°ç›®æ ‡è·¯å¾„  
  - ä»»ä¸€æ­¥å¤±è´¥åˆ™å›æ»šï¼Œaudit.log è®°å½•é”™è¯¯  

- **ç”Ÿæˆæ¸…å•ä¸æ—¥å¿—**ï¼š  
  - manifest.jsonï¼šåˆ—å‡ºæ‰€æœ‰äº§ç‰©ä¸å¼•ç”¨å…³ç³»  
  - audit.logï¼šè®°å½•å¯¼å‡ºå…¨è¿‡ç¨‹ã€é”™è¯¯ç ã€è­¦å‘Š  

---

### 5. éªŒè¯é—­ç¯é˜¶æ®µ
- **äºŒè¿›åˆ¶å¯¹æ¯”**ï¼š  
  - ä½¿ç”¨ `utils.hex_diff` ä¸æ—§ 3ds Max æ’ä»¶äº§ç‰©å¯¹æ¯”ï¼Œç¡®ä¿ primitives/visual å­—æ®µå¯¹é½  
- **å¼•æ“åŠ è½½æµ‹è¯•**ï¼š  
  - åœ¨ BigWorld å®˜æ–¹å·¥å…·ï¼ˆModelEditor/WorldEditorï¼‰ä¸­åŠ è½½ï¼ŒéªŒè¯ visual/model/collision/animation å¼•ç”¨æ­£ç¡®  

---

# âœ… æœ€ç»ˆæ–¹æ¡ˆæ€»ç»“

1. **UI åˆ†å·¥åˆç†**ï¼š  
   - åå¥½è®¾ç½®ï¼šå…¨å±€è·¯å¾„/åæ ‡ç³»/è§„åˆ™  
   - å¯¹è±¡é¢æ¿ï¼šå¯¹è±¡å±æ€§ï¼ˆLOD/æè´¨/ç¡¬ç‚¹/åŠ¨ç”»/ç¢°æ’/é—¨æˆ·ï¼‰  
   - å¯¼å‡ºé¢æ¿ï¼šæ‰§è¡Œå¯¼å‡ºï¼ˆç±»å‹é€‰æ‹©ã€æ–‡ä»¶ç»„åˆã€é¢„è®¾ï¼‰  

2. **ç›®å½•æ¶æ„ç§‘å­¦**ï¼š  
   - core å±‚ï¼šæ•°æ®ç»“æ„ã€åæ ‡ç³»ã€åºåˆ—åŒ–ã€ä¾èµ–ã€XML æ¸²æŸ“  
   - writersï¼šå•ä¸€èŒè´£å†™æ–‡ä»¶  
   - pipelineï¼šå›ºå®šé¡ºåºè°ƒåº¦  
   - utilsï¼šè·¯å¾„ç­–ç•¥ã€æè´¨ç»‘å®šã€çº¹ç†æ ¡éªŒã€å·®å¼‚å¯¹æ¯”  
   - templatesï¼šXML æ¨¡æ¿åº“  

3. **å¯¼å‡ºé¡ºåºå›ºå®š**ï¼š  
   - æŒ‰ç±»å‹å†…ç½®é¡ºåºæ‰§è¡Œï¼Œé¿å…å¼•ç”¨ç¼ºå¤±  

4. **è·¯å¾„ä¸å¼•ç”¨ç»Ÿä¸€**ï¼š  
   - path_policy ç”Ÿæˆæ‰€æœ‰è·¯å¾„ä¸å¼•ç”¨ï¼Œwriters ç¦æ­¢æ‹¼æ¥  

5. **XML æ¨¡æ¿é©±åŠ¨**ï¼š  
   - visual/model/portal/åŠ¨ç”»ç»‘å®šç»Ÿä¸€é€šè¿‡ xml_writer æ¸²æŸ“æ¨¡æ¿  
   - ä¿è¯å­—æ®µé¡ºåºã€æ ‡ç­¾å‘½åä¸å®˜æ–¹ä¸€è‡´  

6. **primitives ä¸¥æ ¼å¯¹é½**ï¼š  
   - serializer æ§åˆ¶å­—èŠ‚åºä¸å—å¤´  
   - hex_diff å¯¹æ¯”æ—§äº§ç‰©  

7. **éªŒè¯ä¸å¯è¿½è¸ª**ï¼š  
   - validate_operator æ ¡éªŒ  
   - audit.log + manifest.json å½¢æˆå¯è¿½è¸ªé—­ç¯  

---

**å¥½çš„ âœ… æ€»ç»“ä¸€å¥ï¼šæˆ‘ä»¬è¦æŠŠ BigWorld æºç é‡Œçš„å·¥å…·é“¾é€å±‚æ‹†è§£ï¼Œæç‚¼å‡ºå­—æ®µï¼ˆæ•°æ®ç»“æ„ï¼‰ã€æ¨¡å—èŒè´£ã€è°ƒç”¨å…³ç³»ï¼Œç„¶åæ˜ å°„åˆ° Blender æ’ä»¶çš„åŠŸèƒ½ â†’ æ¨¡å— â†’ æ–‡ä»¶ â†’ æ¥å£ã€‚**

ä¸‹é¢æˆ‘å…ˆä» **tools ç›®å½•**çš„æ ¸å¿ƒå­é¡¹ç›®å¼€å§‹é€ä¸ªè§£æï¼Œé€æ­¥å»ºç«‹æ˜ å°„è¡¨ã€‚  

---

## ğŸ” Step 1ï¼šexporter_common  
è¿™æ˜¯ BigWorld å·¥å…·é“¾çš„â€œåº•å±‚åº“â€ï¼Œæ‰€æœ‰å¯¼å‡ºå™¨ï¼ˆ3ds Maxã€Mayaï¼‰éƒ½ä¼šä¾èµ–å®ƒã€‚

### å­—æ®µï¼ˆæ•°æ®ç»“æ„ï¼‰
- **VisualHeader / ModelHeader**ï¼šå®šä¹‰ `.visual`ã€`.model` æ–‡ä»¶çš„å¤´éƒ¨å­—æ®µï¼ˆç‰ˆæœ¬å·ã€ä¾èµ–ã€å¼•ç”¨è·¯å¾„ï¼‰ã€‚  
- **PrimitiveGroup / VertexFormat**ï¼šå‡ ä½•ç¼“å†²çš„å­—æ®µï¼ˆé¡¶ç‚¹å±æ€§ã€ç´¢å¼•ã€LODï¼‰ã€‚  
- **MaterialDesc**ï¼šæè´¨æ§½å­—æ®µï¼ˆè´´å›¾è·¯å¾„ã€å‹ç¼©æ–¹å¼ã€UV é€šé“ï¼‰ã€‚  
- **AnimationChannel / Track**ï¼šåŠ¨ç”»è½¨é“å­—æ®µï¼ˆåç§°ã€å¸§ç‡ã€å¾ªç¯ã€äº‹ä»¶ï¼‰ã€‚  

### æ¨¡å—èŒè´£
- æä¾› **é€šç”¨æ•°æ®ç»“æ„**ï¼ˆå‡ ä½•ã€æè´¨ã€åŠ¨ç”»ã€LODï¼‰ã€‚  
- æä¾› **åºåˆ—åŒ–æ¥å£**ï¼ˆå­—èŠ‚åºã€å—å¤´ã€ç‰ˆæœ¬å·ï¼‰ã€‚  
- æä¾› **é”™è¯¯ç ä¸æ—¥å¿—æ¥å£**ï¼ˆå¯¼å‡ºå™¨ç»Ÿä¸€è°ƒç”¨ï¼‰ã€‚  

### è°ƒç”¨å…³ç³»
- `visualexporter` / `mayavisualexporter` â†’ è°ƒç”¨ exporter_common çš„æ•°æ®ç»“æ„å’Œå†™å…¥å‡½æ•°ã€‚  
- `modeleditor` â†’ è¯»å–è¿™äº›ç»“æ„ï¼ŒéªŒè¯å¯¼å‡ºç»“æœã€‚  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`core/data_structures.py`ã€`core/serializer.py`ã€`core/logger.py`ã€‚

---

## ğŸ” Step 2ï¼švisualexporterï¼ˆ3ds Max å¯¼å‡ºå™¨ï¼‰
è¿™æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå®šä¹‰äº†ä» DCC åˆ° BigWorld æ–‡ä»¶çš„å¯¼å‡ºæµç¨‹ã€‚

### å­—æ®µ
- **ExportSettings**ï¼šå¯¼å‡ºæ ¹ç›®å½•ã€çº¹ç†è·¯å¾„ã€åæ ‡ç³»ã€å•ä½ã€‚  
- **ExportObject**ï¼šå¯¹è±¡ç±»å‹ï¼ˆé™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·ï¼‰ã€èµ„æºIDã€åˆ†ç»„ã€‚  
- **LODInfo**ï¼šLOD å±‚çº§ã€è‡ªåŠ¨ç”Ÿæˆè§„åˆ™ã€‚  
- **HardPoint**ï¼šåç§°ã€ç±»å‹ã€çŸ©é˜µã€‚  

### æ¨¡å—èŒè´£
- è´Ÿè´£ **UI â†’ æ•°æ®ç»“æ„** çš„æ˜ å°„ã€‚  
- è°ƒç”¨ exporter_common å†™ `.primitives`ã€`.visual`ã€`.model`ã€‚  
- è°ƒç”¨ animationexporter å†™ `.animation`ã€‚  
- è°ƒç”¨ collisionexporter å†™ `.collision`ã€‚  

### è°ƒç”¨å…³ç³»
- UI â†’ ExportOperator â†’ ExportPipeline â†’ Writer â†’ exporter_commonã€‚  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`operators/export_operator.py`ã€`pipeline/static_pipeline.py`ã€`writers/*_writer.py`ã€‚

---

## ğŸ” Step 3ï¼šmayavisualexporter
ä¸ visualexporter ç±»ä¼¼ï¼Œä½†é’ˆå¯¹ Mayaã€‚  
ä½œç”¨ï¼š**äº¤å‰éªŒè¯å­—æ®µä¸€è‡´æ€§**ï¼Œç¡®ä¿ä¸åŒ DCC å¯¼å‡ºç»“æœç›¸åŒã€‚  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­ä¸»è¦ç”¨äº **å¯¹ç…§éªŒè¯**ï¼Œä¸ç›´æ¥å®ç°ã€‚

---

## ğŸ” Step 4ï¼šmodeleditor / modeleditor_core
è¿™æ˜¯ BigWorld çš„äº§ç‰©æ¶ˆè´¹ç«¯ï¼Œèƒ½åæ¨å¯¼å‡ºæ–‡ä»¶çš„å­—æ®µè¦æ±‚ã€‚

### å­—æ®µ
- `.visual`ï¼šå‡ ä½•å¼•ç”¨ã€æè´¨æ§½ã€LODã€‚  
- `.model`ï¼šå¼•ç”¨ `.visual`ã€`.animation`ã€`.collision`ã€‚  
- `.portal`ï¼šç©ºé—´ IDã€æ³•çº¿æ–¹å‘ã€‚  

### æ¨¡å—èŒè´£
- åŠ è½½å¹¶éªŒè¯å¯¼å‡ºæ–‡ä»¶ã€‚  
- æä¾›é”™è¯¯æç¤ºï¼ˆç¼ºå°‘å¼•ç”¨ã€å­—æ®µä¸ä¸€è‡´ï¼‰ã€‚  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`validate_operator.py` + `core/validator.py`ã€‚

---

## ğŸ” Step 5ï¼šasset_pipeline / resourcechecker
è´Ÿè´£èµ„æºæ‰“åŒ…ã€è·¯å¾„ç­–ç•¥ã€æ ¡éªŒã€‚

### å­—æ®µ
- **ManifestEntry**ï¼šäº§ç‰©æ¸…å•ï¼ˆæ–‡ä»¶åã€ä¾èµ–ã€æ—¶é—´æˆ³ï¼‰ã€‚  
- **AuditEntry**ï¼šæ—¥å¿—æ¡ç›®ï¼ˆé”™è¯¯ç ã€è­¦å‘Šã€å»ºè®®ï¼‰ã€‚  

### æ¨¡å—èŒè´£
- å®šä¹‰ç›®å½•ç­–ç•¥ï¼ˆæŒ‰ç±»å‹/åŒ…/LODï¼‰ã€‚  
- å®šä¹‰æ ¡éªŒè§„åˆ™ï¼ˆUVã€æ³•çº¿ã€å‘½åã€çº¹ç†è·¯å¾„ï¼‰ã€‚  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`utils/path_policy.py`ã€`writers/manifest_writer.py`ã€`writers/audit_writer.py`ã€‚

---

## âœ… åŠŸèƒ½ â†’ æ¨¡å— â†’ æ–‡ä»¶ â†’ æ¥å£ï¼ˆç¤ºä¾‹è¡¨ï¼‰

| åŠŸèƒ½éœ€æ±‚        | æ¨¡å—èŒè´£         | æ–‡ä»¶ä½ç½® (Blender æ’ä»¶) | æ¥å£/ç±» |
|-----------------|------------------|-------------------------|---------|
| å¯¼å‡ºå‰æ£€æµ‹      | æ ¡éªŒ             | core/validator.py       | `validate_object()` |
| å†™ primitives   | å‡ ä½•å†™å…¥         | writers/primitives_writer.py | `write_primitives()` |
| å†™ visual.xml   | XML æ¸²æŸ“         | writers/visual_writer.py | `write_visual()` |
| å†™ model.xml    | XML æ¸²æŸ“         | writers/model_writer.py | `write_model()` |
| å†™ animation    | åŠ¨ç”»å†™å…¥         | writers/animation_writer.py | `write_animation()` |
| å†™ collision    | ç¢°æ’å†™å…¥         | writers/collision_writer.py | `write_collision()` |
| å†™ portal.xml   | é—¨æˆ·å†™å…¥         | writers/portal_writer.py | `write_portal()` |
| ç”Ÿæˆ manifest   | æ¸…å•ç”Ÿæˆ         | writers/manifest_writer.py | `write_manifest()` |
| å†™ audit.log    | æ—¥å¿—ç”Ÿæˆ         | writers/audit_writer.py | `write_audit()` |
| åæ ‡ç³»è½¬æ¢      | åæ ‡é€‚é…         | core/coordinate_system.py | `convert_coords()` |
| è·¯å¾„ç­–ç•¥        | è·¯å¾„ç”Ÿæˆ         | utils/path_policy.py    | `resolve_path()` |

---


---

## ğŸ” Step 2ï¼šæŠ½å– `.visual` æ–‡ä»¶ç»“æ„ï¼ˆæ ¸å¿ƒï¼‰

åœ¨ BigWorld å·¥å…·é“¾ï¼ˆ`exporter_common` + `visualexporter` + `modeleditor`ï¼‰ä¸­ï¼Œ`.visual` æ–‡ä»¶æ˜¯æœ€å…³é”®çš„æè¿°æ–‡ä»¶ï¼Œè´Ÿè´£æŠŠå‡ ä½•ã€æè´¨ã€LODã€ç¡¬ç‚¹ç­‰ä¿¡æ¯ç»„ç»‡èµ·æ¥ã€‚

### `.visual` ä¸»è¦å­—æ®µ
- **header**ï¼šç‰ˆæœ¬å·ã€ä¾èµ–ä¿¡æ¯  
- **renderSet[]**ï¼šæ¸²æŸ“é›†ï¼ˆæ¯ä¸ª renderSet å¯¹åº”ä¸€ä¸ªæè´¨/å‡ ä½•ç»„åˆï¼‰  
  - **geometry**ï¼šå¼•ç”¨ `.primitives` æ–‡ä»¶  
  - **material**ï¼šæè´¨æ§½ï¼ˆè´´å›¾è·¯å¾„ã€shaderã€å‹ç¼©æ–¹å¼ï¼‰  
- **LOD**ï¼šLOD å±‚çº§ã€åˆ‡æ¢è·ç¦»  
- **hardPoints[]**ï¼šç¡¬ç‚¹ï¼ˆåç§°ã€ç±»å‹ã€çŸ©é˜µï¼‰  
- **boundingBox / boundingSphere**ï¼šåŒ…å›´ç›’/çƒ  
- **portal / bsp**ï¼šé—¨æˆ·æˆ–ç©ºé—´åˆ†å‰²ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`writers/visual_writer.py` + `core/data_structures.Visual`.

---

## ğŸ” Step 3ï¼šæŠ½å– `.model` æ–‡ä»¶ç»“æ„

`.model` æ˜¯æ›´é«˜å±‚çš„æè¿°æ–‡ä»¶ï¼Œè´Ÿè´£æŠŠ `.visual`ã€`.animation`ã€`.collision` ç­‰ç»„åˆèµ·æ¥ã€‚

### `.model` ä¸»è¦å­—æ®µ
- **header**ï¼šç‰ˆæœ¬å·ã€ä¾èµ–  
- **visual**ï¼šå¼•ç”¨ `.visual` æ–‡ä»¶  
- **animations[]**ï¼šåŠ¨ç”»è½¨é“åˆ—è¡¨ï¼ˆå¼•ç”¨ `.animation` æ–‡ä»¶ï¼‰  
- **collision**ï¼šå¼•ç”¨ `.collision` æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰  
- **portal**ï¼šå¼•ç”¨ `.portal` æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰  
- **meta**ï¼šèµ„æº IDã€åˆ†ç»„ã€æ ‡ç­¾  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`writers/model_writer.py`.

---

## ğŸ” Step 4ï¼šæŠ½å– `.primitives` æ–‡ä»¶ç»“æ„

`.primitives` æ˜¯äºŒè¿›åˆ¶å‡ ä½•æ–‡ä»¶ï¼ŒåŒ…å«é¡¶ç‚¹ç¼“å†²ã€ç´¢å¼•ç¼“å†²ã€LOD ä¿¡æ¯ã€‚

### `.primitives` ä¸»è¦å­—æ®µ
- **header**ï¼šmagicã€ç‰ˆæœ¬å·ã€å­—èŠ‚åº  
- **vertexBuffer[]**ï¼šé¡¶ç‚¹å±æ€§ï¼ˆä½ç½®ã€æ³•çº¿ã€åˆ‡çº¿ã€UVã€é¢œè‰²ï¼‰  
- **indexBuffer[]**ï¼šç´¢å¼•æ•°æ®  
- **primitiveGroup[]**ï¼šå­ç½‘æ ¼ï¼ˆèµ·å§‹ç´¢å¼•ã€æ•°é‡ã€æè´¨ IDï¼‰  
- **LOD[]**ï¼šLOD å±‚çº§å¯¹åº”çš„ primitiveGroup èŒƒå›´  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`writers/primitives_writer.py` + `core/serializer.py`.

---

## ğŸ” Step 5ï¼šdataclass è‰ç¨¿ï¼ˆPython ç‰ˆï¼‰

```python
@dataclass
class HardPoint:
    name: str
    type: str   # mount / interact / fx
    matrix: List[List[float]]

@dataclass
class MaterialSlot:
    name: str
    base_color: str
    normal: str
    orm: str
    compression: str  # DXT5 / BC7 / None

@dataclass
class Visual:
    version: int
    render_sets: List[str]
    materials: List[MaterialSlot]
    lod_levels: List[str]
    hardpoints: List[HardPoint]
    bounding_box: Tuple[float, float, float, float, float, float]

@dataclass
class Model:
    version: int
    visual: str
    animations: List[str]
    collision: Optional[str]
    portal: Optional[str]
    meta: Dict[str, str]

@dataclass
class Primitives:
    version: int
    vertex_buffer: bytes
    index_buffer: bytes
    primitive_groups: List[Dict]
    lods: List[Dict]
```

---



## ğŸ” Step 6ï¼š`.animation` æ–‡ä»¶ç»“æ„

åœ¨ BigWorld å·¥å…·é“¾ä¸­ï¼Œ`.animation` æ–‡ä»¶æ˜¯è§’è‰²åŠ¨ç”»çš„æ ¸å¿ƒæ•°æ®æ–‡ä»¶ï¼Œé€šå¸¸ç”± **animationexporter** æˆ– **visualexporter** è°ƒç”¨ç”Ÿæˆã€‚

### ä¸»è¦å­—æ®µ
- **header**ï¼šç‰ˆæœ¬å·ã€å¸§ç‡ã€æ€»å¸§æ•°  
- **skeleton**ï¼šéª¨æ¶å¼•ç”¨ï¼ˆéª¨éª¼åç§°ã€å±‚çº§å…³ç³»ï¼‰  
- **channels[]**ï¼šåŠ¨ç”»è½¨é“åˆ—è¡¨  
  - **name**ï¼šè½¨é“åï¼ˆé€šå¸¸å¯¹åº”éª¨éª¼åï¼‰  
  - **keyframes[]**ï¼šå…³é”®å¸§æ•°æ®ï¼ˆæ—¶é—´æˆ³ã€ä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰  
  - **loop**ï¼šæ˜¯å¦å¾ªç¯  
  - **events[]**ï¼šäº‹ä»¶æ ‡ç­¾ï¼ˆå¦‚ IsCoordinatedã€IsImpactingï¼‰  

### æ¨¡å—èŒè´£
- æä¾›è§’è‰²åŠ¨ç”»çš„å…³é”®å¸§æ•°æ®  
- æ”¯æŒäº‹ä»¶æ ‡ç­¾ï¼ˆäº¤äº’åŠ¨ç”»ã€ç¢°æ’å“åº”ï¼‰  
- ä¸ `.model` æ–‡ä»¶ä¸­çš„ `animations[]` å­—æ®µå…³è”  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`writers/animation_writer.py`ï¼Œæ•°æ®ç»“æ„åœ¨ `core/data_structures.AnimationTrack`ã€‚

---

## ğŸ” Step 7ï¼š`.collision` æ–‡ä»¶ç»“æ„

`.collision` æ–‡ä»¶æ˜¯ç‰©ç†ç¢°æ’ä½“çš„æè¿°æ–‡ä»¶ï¼Œé€šå¸¸ç”± **collisionexporter** æˆ– **visualexporter** ç”Ÿæˆã€‚

### ä¸»è¦å­—æ®µ
- **header**ï¼šç‰ˆæœ¬å·ã€ç¢°æ’ä½“ç±»å‹  
- **mesh**ï¼šç½‘æ ¼æ•°æ®ï¼ˆé¡¶ç‚¹ã€ç´¢å¼•ï¼‰  
- **hull**ï¼šå‡¸åŒ…æ•°æ®ï¼ˆå¯é€‰ï¼‰  
- **simplified**ï¼šç®€åŒ–ç½‘æ ¼ï¼ˆLOD ç”¨ï¼‰  
- **layer**ï¼šç¢°æ’å±‚ï¼ˆç‰©ç†åˆ†ç»„ï¼‰  
- **boundingBox**ï¼šåŒ…å›´ç›’  

### æ¨¡å—èŒè´£
- æä¾›ç‰©ç†å¼•æ“ä½¿ç”¨çš„ç¢°æ’ä½“æ•°æ®  
- æ”¯æŒå¤šç§ç”Ÿæˆæ–¹å¼ï¼ˆç½‘æ ¼ã€ç®€åŒ–ã€å‡¸åŒ…ï¼‰  
- ä¸ `.model` æ–‡ä»¶ä¸­çš„ `collision` å­—æ®µå…³è”  

ğŸ‘‰ åœ¨ Blender æ’ä»¶ä¸­å¯¹åº”ï¼š`writers/collision_writer.py`ï¼Œæ•°æ®ç»“æ„åœ¨ `core/data_structures.Collision`.

---

## ğŸ” Step 8ï¼šdataclass è‰ç¨¿ï¼ˆPython ç‰ˆï¼‰

```python
@dataclass
class AnimationEvent:
    name: str
    frame: int

@dataclass
class AnimationChannel:
    bone_name: str
    keyframes: List[Dict]  # {time, position, rotation, scale}
    loop: bool
    events: List[AnimationEvent]

@dataclass
class Animation:
    version: int
    frame_rate: int
    total_frames: int
    skeleton: str
    channels: List[AnimationChannel]

@dataclass
class Collision:
    version: int
    type: str  # mesh / hull / simplified
    vertices: List[Tuple[float, float, float]]
    indices: List[int]
    layer: str
    bounding_box: Tuple[float, float, float, float, float, float]
```

---

## ğŸ” Step 9ï¼šè°ƒç”¨å…³ç³»ï¼ˆåŠŸèƒ½ â†’ æ¨¡å— â†’ æ–‡ä»¶ â†’ æ¥å£ï¼‰

| åŠŸèƒ½éœ€æ±‚        | æ¨¡å—èŒè´£         | æ–‡ä»¶ä½ç½® (Blender æ’ä»¶) | æ¥å£/ç±» |
|-----------------|------------------|-------------------------|---------|
| å†™ animation    | åŠ¨ç”»å†™å…¥         | writers/animation_writer.py | `write_animation(Animation)` |
| å†™ collision    | ç¢°æ’å†™å…¥         | writers/collision_writer.py | `write_collision(Collision)` |
| åŠ¨ç”»è½¨é“æ ¡éªŒ    | éª¨æ¶ä¸€è‡´æ€§ã€äº‹ä»¶æ ‡ç­¾ | core/validator.py | `validate_animation()` |
| ç¢°æ’ä½“æ ¡éªŒ      | å‡¸åŒ…/ç®€åŒ–å¯ç”¨æ€§  | core/validator.py | `validate_collision()` |

---



---

## ğŸ” Step 10ï¼š`.portal` æ–‡ä»¶ç»“æ„

åœ¨ BigWorld å·¥å…·é“¾ä¸­ï¼Œ`.portal` æ–‡ä»¶ç”¨äºæè¿° **ç©ºé—´è¿æ¥ä¸å¯è§æ€§**ï¼Œä¸»è¦å‡ºç°åœ¨å®¤å†…/åˆ†åŒºåœºæ™¯ä¸­ã€‚å®ƒé€šå¸¸ç”± **visualexporter** æˆ– **worldeditor** ç”Ÿæˆï¼Œå¹¶åœ¨ `.model` æ–‡ä»¶ä¸­è¢«å¼•ç”¨ã€‚

### ä¸»è¦å­—æ®µ
- **header**ï¼šç‰ˆæœ¬å·ã€ç©ºé—´ ID  
- **plane**ï¼šé—¨æˆ·å¹³é¢ï¼ˆæ³•çº¿å‘é‡ + è·ç¦»ï¼‰  
- **vertices[]**ï¼šé—¨æˆ·å¤šè¾¹å½¢é¡¶ç‚¹ï¼ˆé€šå¸¸æ˜¯çŸ©å½¢æˆ–å‡¸å¤šè¾¹å½¢ï¼‰  
- **normalCheck**ï¼šæ³•çº¿æ–¹å‘æ ¡éªŒï¼ˆä¿è¯æœå‘ä¸€è‡´ï¼‰  
- **adjacentSpace**ï¼šç›¸é‚»ç©ºé—´ IDï¼ˆportal è¿æ¥çš„å¦ä¸€ä¾§ç©ºé—´ï¼‰  
- **flags**ï¼šé—¨æˆ·å±æ€§ï¼ˆåŒå‘/å•å‘/é®æŒ¡ï¼‰  

---

## ğŸ” Step 11ï¼šdataclass è‰ç¨¿ï¼ˆPython ç‰ˆï¼‰

```python
@dataclass
class Portal:
    version: int
    space_id: str
    adjacent_space: str
    plane: Tuple[float, float, float, float]  # æ³•çº¿ + è·ç¦»
    vertices: List[Tuple[float, float, float]]
    normal_check: bool
    flags: List[str]  # e.g. ["two_sided", "occluder"]
```

---

## ğŸ” Step 12ï¼šè°ƒç”¨å…³ç³»ï¼ˆåŠŸèƒ½ â†’ æ¨¡å— â†’ æ–‡ä»¶ â†’ æ¥å£ï¼‰

| åŠŸèƒ½éœ€æ±‚        | æ¨¡å—èŒè´£         | æ–‡ä»¶ä½ç½® (Blender æ’ä»¶) | æ¥å£/ç±» |
|-----------------|------------------|-------------------------|---------|
| å†™ portal.xml   | é—¨æˆ·å†™å…¥         | writers/portal_writer.py | `write_portal(Portal)` |
| é—¨æˆ·æ ¡éªŒ        | ç©ºé—´ IDã€æ³•çº¿æ–¹å‘ | core/validator.py       | `validate_portal()` |
| é—¨æˆ·è·¯å¾„ç­–ç•¥    | ç›®å½•/å¼•ç”¨ç”Ÿæˆ     | utils/path_policy.py    | `resolve_portal_path()` |

---

## ğŸ” Step 13ï¼šäº”å¤§äº§ç‰© schema æ€»ç»“

1. **Primitives** â†’ å‡ ä½•ç¼“å†²ï¼ˆé¡¶ç‚¹/ç´¢å¼•/LODï¼‰  
2. **Visual** â†’ æ¸²æŸ“é›†ï¼ˆæè´¨æ§½ã€å‡ ä½•å¼•ç”¨ã€ç¡¬ç‚¹ã€åŒ…å›´ç›’ï¼‰  
3. **Model** â†’ ç»„åˆæ–‡ä»¶ï¼ˆå¼•ç”¨ visual/animation/collision/portalï¼‰  
4. **Animation** â†’ éª¨æ¶è½¨é“ï¼ˆå…³é”®å¸§ã€å¾ªç¯ã€äº‹ä»¶ï¼‰  
5. **Collision** â†’ ç¢°æ’ä½“ï¼ˆç½‘æ ¼/å‡¸åŒ…/ç®€åŒ–ã€å±‚çº§ï¼‰  
6. **Portal** â†’ ç©ºé—´è¿æ¥ï¼ˆplaneã€verticesã€adjacentSpaceã€flagsï¼‰

---


---

## ğŸ—‚ï¸ åŠŸèƒ½ â†’ æ¨¡å— â†’ æ–‡ä»¶ â†’ æ¥å£ï¼ˆæ€»è¡¨ï¼‰

### 1. å¯¼å‡ºå‰æ£€æµ‹ï¼ˆValidatorï¼‰
- **åŠŸèƒ½**ï¼šå‡ ä½•ã€UVã€æè´¨ã€å‘½åã€åŠ¨ç”»ã€ç¢°æ’ã€é—¨æˆ·æ ¡éªŒ  
- **æ¨¡å—èŒè´£**ï¼šç»Ÿä¸€æ ¡éªŒé€»è¾‘ï¼Œè¾“å‡º UI æ‘˜è¦ + audit.log  
- **æ–‡ä»¶**ï¼š`core/validator.py`  
- **æ¥å£**ï¼š  
  - `validate_geometry(obj)`  
  - `validate_uv(obj)`  
  - `validate_material(obj)`  
  - `validate_naming(obj)`  
  - `validate_animation(anim)`  
  - `validate_collision(col)`  
  - `validate_portal(portal)`  

---

### 2. å‡ ä½•å¯¼å‡ºï¼ˆPrimitivesï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.primitives` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šé¡¶ç‚¹ç¼“å†²ã€ç´¢å¼•ç¼“å†²ã€LODã€å­—èŠ‚åº  
- **æ–‡ä»¶**ï¼š`writers/primitives_writer.py`  
- **æ¥å£**ï¼š  
  - `write_primitives(Primitives, path)`  

---

### 3. æ¸²æŸ“æè¿°ï¼ˆVisualï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.visual` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šæè´¨æ§½ã€å‡ ä½•å¼•ç”¨ã€LODã€ç¡¬ç‚¹ã€åŒ…å›´ç›’  
- **æ–‡ä»¶**ï¼š`writers/visual_writer.py`  
- **æ¥å£**ï¼š  
  - `write_visual(Visual, path)`  

---

### 4. æ¨¡å‹ç»„åˆï¼ˆModelï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.model/.xml` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šç»„åˆ visual/animation/collision/portal  
- **æ–‡ä»¶**ï¼š`writers/model_writer.py`  
- **æ¥å£**ï¼š  
  - `write_model(Model, path)`  

---

### 5. åŠ¨ç”»å¯¼å‡ºï¼ˆAnimationï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.animation` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šéª¨æ¶è½¨é“ã€å…³é”®å¸§ã€å¾ªç¯ã€äº‹ä»¶æ ‡ç­¾  
- **æ–‡ä»¶**ï¼š`writers/animation_writer.py`  
- **æ¥å£**ï¼š  
  - `write_animation(Animation, path)`  

---

### 6. ç¢°æ’å¯¼å‡ºï¼ˆCollisionï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.collision` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šç½‘æ ¼/å‡¸åŒ…/ç®€åŒ–ã€å±‚çº§ã€åŒ…å›´ç›’  
- **æ–‡ä»¶**ï¼š`writers/collision_writer.py`  
- **æ¥å£**ï¼š  
  - `write_collision(Collision, path)`  

---

### 7. é—¨æˆ·å¯¼å‡ºï¼ˆPortalï¼‰
- **åŠŸèƒ½**ï¼šå†™å…¥ `.portal.xml` æ–‡ä»¶  
- **æ¨¡å—èŒè´£**ï¼šç©ºé—´ IDã€æ³•çº¿æ–¹å‘ã€ç›¸é‚»ç©ºé—´ã€é¡¶ç‚¹  
- **æ–‡ä»¶**ï¼š`writers/portal_writer.py`  
- **æ¥å£**ï¼š  
  - `write_portal(Portal, path)`  

---

### 8. æ¸…å•ä¸æ—¥å¿—
- **åŠŸèƒ½**ï¼šç”Ÿæˆ `manifest.json` ä¸ `audit.log`  
- **æ¨¡å—èŒè´£**ï¼šäº§ç‰©æ¸…å•ã€ä¾èµ–å…³ç³»ã€é”™è¯¯ç è¿½è¸ª  
- **æ–‡ä»¶**ï¼š  
  - `writers/manifest_writer.py`  
  - `writers/audit_writer.py`  
- **æ¥å£**ï¼š  
  - `write_manifest(entries, path)`  
  - `write_audit(logs, path)`  

---

### 9. å…¬å…±æ ¸å¿ƒå±‚ï¼ˆCoreï¼‰
- **åŠŸèƒ½**ï¼šæä¾›é€šç”¨æœåŠ¡  
- **æ–‡ä»¶ä¸æ¥å£**ï¼š  
  - `core/serializer.py` â†’ `serialize_vertex_buffer()`  
  - `core/coordinate_system.py` â†’ `convert_coords()`  
  - `core/dependency_graph.py` â†’ `resolve_dependencies()`  
  - `core/logger.py` â†’ `log_error(code, msg)`  
  - `core/xml_writer.py` â†’ `render(template, data)`  

---

### 10. å·¥å…·å±‚ï¼ˆUtilsï¼‰
- **åŠŸèƒ½**ï¼šè·¯å¾„ç­–ç•¥ã€å‘½åè§„åˆ™ã€æè´¨ç»‘å®šã€çº¹ç†æ ¡éªŒã€äºŒè¿›åˆ¶å¯¹æ¯”  
- **æ–‡ä»¶ä¸æ¥å£**ï¼š  
  - `utils/path_policy.py` â†’ `resolve_path(obj)`  
  - `utils/naming_checker.py` â†’ `check_naming(obj)`  
  - `utils/material_binder.py` â†’ `bind_material(blender_mat)`  
  - `utils/texture_resolver.py` â†’ `check_texture(path)`  
  - `utils/hex_diff.py` â†’ `compare_binary(file1, file2)`  

---


---

## 1. éª¨æ¶ç»“æ„ï¼ˆSkeletonï¼‰

### æ•°æ®ç»“æ„
```python
@dataclass
class SkeletonBone:
    name: str
    parent: Optional[str]
    bind_matrix: List[List[float]]   # 4x4 ç»‘å®šçŸ©é˜µ
    inverse_bind_matrix: List[List[float]]

@dataclass
class Skeleton:
    bones: List[SkeletonBone]
    root: str
    version: int
```

### è¦ç‚¹
- **éª¨éª¼å±‚çº§**ï¼šçˆ¶å­å…³ç³»å¿…é¡»å®Œæ•´ï¼Œé¿å…å­¤ç«‹éª¨éª¼ã€‚  
- **çŸ©é˜µ**ï¼šåŒæ—¶ä¿å­˜ç»‘å®šçŸ©é˜µä¸é€†çŸ©é˜µï¼Œæ–¹ä¾¿åŠ¨ç”»è®¡ç®—ã€‚  
- **å¼•ç”¨**ï¼š`.animation` æ–‡ä»¶ä¸­çš„è½¨é“å¿…é¡»å¼•ç”¨ `SkeletonBone.name`ã€‚  

---

## 2. åŠ¨ç”»äº‹ä»¶æšä¸¾

### æšä¸¾å®šä¹‰
```python
class AnimationEventType(Enum):
    IS_COORDINATED = "IsCoordinated"
    IS_IMPACTING = "IsImpacting"
    FOOTSTEP = "Footstep"
    ATTACK = "Attack"
    CUSTOM = "Custom"
```

### è¦ç‚¹
- **æ ‡å‡†äº‹ä»¶**ï¼šIsCoordinatedã€IsImpactingï¼ˆBigWorld åŸç”Ÿï¼‰ã€‚  
- **æ‰©å±•äº‹ä»¶**ï¼šFootstepã€Attack ç­‰å¸¸è§äº¤äº’ã€‚  
- **è‡ªå®šä¹‰äº‹ä»¶**ï¼šå…è®¸å¼€å‘è€…æ‰©å±•ï¼Œå†™å…¥ `.animation` çš„ events[]ã€‚  

---

## 3. æè´¨æ§½æ‰©å±•å­—æ®µ

### æ•°æ®ç»“æ„
```python
@dataclass
class MaterialSlot:
    name: str
    base_color: str
    normal: str
    orm: str
    specular: Optional[str] = None
    emissive: Optional[str] = None
    alpha: Optional[str] = None
    compression: str = "None"  # DXT5 / BC7 / None
    uv_channel: int = 0
```

### è¦ç‚¹
- **å¿…é€‰æ§½**ï¼šBaseColorã€Normalã€ORMã€‚  
- **å¯é€‰æ§½**ï¼šSpecularã€Emissiveã€Alphaã€‚  
- **å‹ç¼©ç­–ç•¥**ï¼šä¸ BigWorld å·¥å…·é“¾ä¸€è‡´ï¼ˆDXT5/BC7ï¼‰ã€‚  

---

## 4. manifest.json ç»“æ„

### æ•°æ®ç»“æ„
```python
@dataclass
class ManifestEntry:
    file: str
    type: str  # primitives / visual / model / animation / collision / portal
    dependencies: List[str]
    hash: str
    timestamp: str

@dataclass
class Manifest:
    version: int
    entries: List[ManifestEntry]
```

### è¦ç‚¹
- **ä¾èµ–å…³ç³»**ï¼švisual â†’ primitives/collisionï¼Œmodel â†’ visual/animationã€‚  
- **hash**ï¼šMD5 æˆ– SHA1ï¼Œä¿è¯å¯è¿½æº¯æ€§ã€‚  
- **timestamp**ï¼šå¯¼å‡ºæ—¶é—´ï¼Œä¾¿äºæ¯”å¯¹ã€‚  

---

## 5. audit.log é”™è¯¯ç ä½“ç³»

### é”™è¯¯ç åˆ†ç±»
- **GEO001**ï¼šéæµå½¢å‡ ä½•  
- **GEO002**ï¼šæ³•çº¿ä¸ä¸€è‡´  
- **UV001**ï¼šUV è¶Šç•Œ  
- **UV002**ï¼šUV é‡å   
- **MAT001**ï¼šæè´¨æ§½ç¼ºå¤±  
- **MAT002**ï¼šçº¹ç†è·¯å¾„æ— æ•ˆ  
- **NAM001**ï¼šå‘½åä¸ç¬¦åˆè§„èŒƒ  
- **ANM001**ï¼šåŠ¨ç”»è½¨é“ç¼ºå¤±éª¨éª¼  
- **ANM002**ï¼šäº‹ä»¶æ ‡ç­¾æ— æ•ˆ  
- **COL001**ï¼šç¢°æ’ä½“ç”Ÿæˆå¤±è´¥  
- **POR001**ï¼šé—¨æˆ·æ³•çº¿æ–¹å‘é”™è¯¯  

### æ•°æ®ç»“æ„
```python
@dataclass
class AuditEntry:
    code: str
    message: str
    severity: str  # ERROR / WARNING / INFO
    object: Optional[str]
```

---

## 6. äº‹åŠ¡æ§åˆ¶æ¨¡å—

### è®¾è®¡
- **ä¸´æ—¶ç›®å½•**ï¼šæ‰€æœ‰å¯¼å‡ºæ–‡ä»¶å…ˆå†™å…¥ä¸´æ—¶ç›®å½•ã€‚  
- **æ ¡éªŒ**ï¼šè°ƒç”¨ validator æ ¡éªŒäº§ç‰©ã€‚  
- **æäº¤**ï¼šæ ¡éªŒé€šè¿‡åç§»åŠ¨åˆ°ç›®æ ‡è·¯å¾„ã€‚  
- **å›æ»š**ï¼šå¤±è´¥æ—¶æ¸…ç†ä¸´æ—¶ç›®å½•ï¼Œå†™å…¥ audit.logã€‚  

### æ¥å£
```python
class ExportTransaction:
    def __init__(self, target_dir: str): ...
    def begin(self): ...
    def commit(self): ...
    def rollback(self, reason: str): ...
```

---

## 7. UI â†’ æ•°æ®ç»“æ„æ˜ å°„æ–¹æ³•

### è®¾è®¡
- **åå¥½è®¾ç½®ï¼ˆPreferencesï¼‰** â†’ å…¨å±€é…ç½® dataclassï¼ˆè·¯å¾„ã€åæ ‡ç³»ã€å•ä½ã€æ¨¡æ¿ï¼‰ã€‚  
- **å¯¹è±¡é¢æ¿ï¼ˆObject Panelï¼‰** â†’ `Visual` / `Collision` / `Animation` / `Portal` dataclassã€‚  
- **å¯¼å‡ºé¢æ¿ï¼ˆExport Panelï¼‰** â†’ `ExportSettings` dataclassã€‚  

### ç¤ºä¾‹
```python
def collect_object_settings(obj) -> Visual:
    return Visual(
        version=1,
        render_sets=[...],
        materials=[...],
        lod_levels=[...],
        hardpoints=[...],
        bounding_box=compute_bbox(obj)
    )
```

---
**ç®€è¦å›ç­”ï¼šæ—§ç‰ˆ BigWorld æ’ä»¶çš„è·¯å¾„ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘æ˜¯ï¼šUI/å¯¼å‡ºå™¨æ”¶é›†ç”¨æˆ·è®¾ç½® â†’ ç»Ÿä¸€è°ƒç”¨ PathManager/PathResolver â†’ å†…éƒ¨å°† Blender/Max çš„ç»å¯¹è·¯å¾„è½¬æ¢ä¸º BigWorld èµ„æºç›¸å¯¹è·¯å¾„ â†’ Writer å†™å…¥æ–‡ä»¶æ—¶åªä¿å­˜ç›¸å¯¹è·¯å¾„ã€‚è¯»å–æ—¶ï¼Œå·¥å…·é“¾ï¼ˆModelEditor/WorldEditorï¼‰å†é€šè¿‡èµ„æºæ ¹ç›®å½•æ‹¼æ¥æˆç»å¯¹è·¯å¾„ã€‚**

---

## ğŸ” æ—§ç‰ˆæ’ä»¶è·¯å¾„ç³»ç»Ÿå®ç°æ–¹æ³•

### 1. è·¯å¾„ç±»å‹
- **ç»å¯¹è·¯å¾„**ï¼šç”¨æˆ·åœ¨ DCC å·¥å…·ï¼ˆ3ds Max/Maya/Blenderï¼‰é‡Œé€‰æ‹©çš„ç£ç›˜è·¯å¾„ï¼Œä¾‹å¦‚ï¼š  
  `D:/project/assets/characters/hero.fbx`
- **ç›¸å¯¹è·¯å¾„**ï¼šBigWorld å¼•æ“å†…éƒ¨ä½¿ç”¨çš„èµ„æºè·¯å¾„ï¼Œç›¸å¯¹äºèµ„æºæ ¹ç›®å½•ï¼Œä¾‹å¦‚ï¼š  
  `characters/hero.visual`

### 2. æ¨¡å—èŒè´£
- **UI å±‚**ï¼šç”¨æˆ·åœ¨æ’ä»¶åå¥½è®¾ç½®é‡ŒæŒ‡å®šâ€œå¯¼å‡ºæ ¹ç›®å½•â€â€œçº¹ç†æ ¹ç›®å½•â€ã€‚  
- **PathManager / PathResolver**ï¼šè´Ÿè´£è·¯å¾„è½¬æ¢é€»è¾‘ã€‚  
- **Writer å±‚**ï¼šå†™å…¥ `.visual/.model/.xml` æ—¶è°ƒç”¨ PathResolverï¼Œç¡®ä¿å†™å…¥ç›¸å¯¹è·¯å¾„ã€‚  
- **Reader å±‚ï¼ˆModelEditor/WorldEditorï¼‰**ï¼šåŠ è½½æ—¶å†æ‹¼æ¥èµ„æºæ ¹ç›®å½•ï¼Œè§£æä¸ºç»å¯¹è·¯å¾„ã€‚

### 3. è°ƒç”¨å…³ç³»
```
UI (preferences.py) â†’ ExportOperator â†’ PathPolicy/PathResolver â†’ Writer
```

- **å¯¼å‡ºæ—¶**ï¼š  
  - `ExportOperator` æ”¶é›†å¯¹è±¡æ•°æ®ï¼ˆç»å¯¹è·¯å¾„ï¼‰ã€‚  
  - è°ƒç”¨ `utils/path_policy.py` â†’ `resolve_path()`ã€‚  
  - è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„ï¼Œä¼ ç»™ Writerã€‚  
  - Writer å†™å…¥æ–‡ä»¶æ—¶åªä¿å­˜ç›¸å¯¹è·¯å¾„ã€‚

- **è¯»å–æ—¶**ï¼š  
  - `modeleditor` æ‰“å¼€ `.visual` æˆ– `.model`ã€‚  
  - è§£æç›¸å¯¹è·¯å¾„å­—æ®µã€‚  
  - æ‹¼æ¥èµ„æºæ ¹ç›®å½•ï¼ˆengine_config.xml ä¸­å®šä¹‰çš„ res_pathï¼‰ã€‚  
  - è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼ŒåŠ è½½æ–‡ä»¶ã€‚

---

## ğŸ” æºç å®ç°æ–¹å¼ï¼ˆæ—§ç‰ˆ Max/Maya æ’ä»¶å‚è€ƒï¼‰

### 1. è·¯å¾„è§£æå‡½æ•°
```python
def resolve_path(abs_path: str, root: str) -> str:
    """
    å°†ç»å¯¹è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
    abs_path: D:/project/assets/characters/hero.fbx
    root: D:/project/assets/
    return: characters/hero.fbx
    """
    if abs_path.startswith(root):
        return os.path.relpath(abs_path, root).replace("\\", "/")
    else:
        raise ValueError("è·¯å¾„ä¸åœ¨èµ„æºæ ¹ç›®å½•ä¸‹")
```

### 2. å†™å…¥æ—¶è°ƒç”¨
```python
def write_visual(visual: Visual, path: str, root: str):
    rel_path = resolve_path(visual.geometry, root)
    xml = f"<geometry>{rel_path}</geometry>"
    save_file(path, xml)
```

### 3. è¯»å–æ—¶è°ƒç”¨ï¼ˆModelEditorï¼‰
```cpp
// C++ ä¼ªä»£ç 
std::string VisualLoader::resolvePath(const std::string& relPath) {
    return ResourceSystem::instance().root() + "/" + relPath;
}
```

---

## ğŸ” å…³é”®ç‚¹æ€»ç»“
- **å¯¼å‡ºæ—¶**ï¼šå§‹ç»ˆå†™ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºå¯¼å‡ºæ ¹/çº¹ç†æ ¹ï¼‰ã€‚  
- **è¯»å–æ—¶**ï¼šå¼•æ“å·¥å…·æ‹¼æ¥èµ„æºæ ¹ç›®å½•ï¼Œæ¢å¤ç»å¯¹è·¯å¾„ã€‚  
- **è°ƒç”¨é“¾**ï¼šUI â†’ ExportOperator â†’ PathResolver â†’ Writerã€‚  
- **å‡½æ•°æ ¸å¿ƒ**ï¼š`resolve_path(abs_path, root)`ï¼ˆå¯¼å‡ºï¼‰ï¼Œ`resolvePath(relPath)`ï¼ˆè¯»å–ï¼‰ã€‚  

---

Rickï¼Œè¦ä¸è¦æˆ‘å¸®ä½ æŠŠ **æ–°ç‰ˆ Blender æ’ä»¶çš„ PathPolicy è®¾è®¡ç¨¿**å†™å‡ºæ¥ï¼ŸåŒ…æ‹¬ï¼š  
- `resolve_export_path()`ï¼ˆå¯¼å‡ºæ—¶ç»å¯¹â†’ç›¸å¯¹ï¼‰  
- `resolve_import_path()`ï¼ˆè¯»å–æ—¶ç›¸å¯¹â†’ç»å¯¹ï¼‰  
- `validate_path()`ï¼ˆæ ¡éªŒè·¯å¾„æ˜¯å¦åœ¨æ ¹ç›®å½•ä¸‹ï¼‰  

è¿™æ ·ä½ å°±èƒ½ç›´æ¥è½åœ°åˆ° `utils/path_policy.py`ã€‚


**ç®€ç­”ï¼šè¦å½»åº•ææ¸… `.primitives` æ ¼å¼ï¼Œå¿…é¡»ç»“åˆ BigWorld æœ€æ–°æºç ï¼ˆ14.4.1 å·¥å…·é“¾ï¼‰ä¸æ—§ç‰ˆæ–‡æ¡£ï¼ˆFile Grammar Guide ch03/ch27/ch30ï¼‰ã€‚æ–‡æ¡£æä¾›è¯­æ³•æ¡†æ¶ï¼Œæºç æä¾›æœ€ç»ˆå®ç°ã€‚ä¸‹é¢æˆ‘ä¸ºä½ æ•´ç†ä¸€ä»½å®Œæ•´è¯¦è§£ï¼Œæ¶µç›–å®¹å™¨ç»“æ„ã€å­—æ®µã€å†™å…¥æµç¨‹ã€æ—§ç‰ˆæ’ä»¶é€»è¾‘ã€Blender è¿ç§»æ–¹æ¡ˆä¸éªŒè¯é—­ç¯ã€‚**

---

# ğŸ—‚ï¸ BigWorld `.primitives` æ–‡ä»¶è¯¦è§£ï¼ˆæºç å¯¹é½ç‰ˆï¼‰

## 1. å®¹å™¨å±‚ï¼šBinSection
- **æœ¬è´¨**ï¼š`.primitives` æ˜¯ä¸€ä¸ª **BinSection åŒ…**ã€‚  
- **ç»“æ„**ï¼š
  - **magic number**ï¼š0x42A14E65  
  - **binary_blob[]**ï¼šæ¯ä¸ªå­å—çš„æ•°æ®ï¼Œ4 å­—èŠ‚å¯¹é½  
  - **index_table[]**ï¼šè®°å½•å­å— tagã€åç§»ã€é•¿åº¦ã€ç‰ˆæœ¬ã€æ—¶é—´æˆ³  
- **æ„ä¹‰**ï¼šå…è®¸åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å­˜æ”¾å¤šä¸ª sectionï¼ˆé¡¶ç‚¹ã€ç´¢å¼•ã€BSPï¼‰ã€‚

---

## 2. æ ¸å¿ƒå­å—ï¼ˆæºç  + æ–‡æ¡£å¯¹é½ï¼‰

### (1) é¡¶ç‚¹æ•°æ®å—
- **vertex_format**ï¼š64 å­—èŠ‚å­—ç¬¦ä¸²ï¼ˆå¦‚ `"xyznuv"`, `"xyznuvtb"`ï¼‰ï¼Œæºç ä¸­ç”± `VertexFormat` åŠ¨æ€ç”Ÿæˆã€‚  
- **num_vertices**ï¼šé¡¶ç‚¹æ•°é‡ã€‚  
- **raw_vertex_data**ï¼šé€é¡¶ç‚¹å†™å…¥ï¼ŒæŒ‰ vertex_format é¡ºåºï¼š  
  - ä½ç½® (x,y,z)  
  - æ³•çº¿ (nx,ny,nz)  
  - UV (u,v)  
  - å¯é€‰ï¼šåˆ‡çº¿ã€å‰¯åˆ‡çº¿ã€é¢œè‰²ã€é¢å¤– UV  

### (2) ç´¢å¼•æ•°æ®å—
- **index_format**ï¼š`list` (16 ä½) æˆ– `list32` (32 ä½)ï¼Œæºç ä¸­æ ¹æ®é¡¶ç‚¹æ•°é€‰æ‹©ã€‚  
- **num_indices**ï¼šç´¢å¼•æ•°é‡ã€‚  
- **num_primitive_groups**ï¼šå­ç½‘æ ¼æ•°é‡ã€‚  
- **indices[]**ï¼šç´¢å¼•æ•°ç»„ã€‚  
- **primitive_groups[]**ï¼šæ¯ç»„åŒ…å«ï¼š  
  - start_index  
  - num_primitives  
  - start_vertex  
  - num_vertices  
  - material_idï¼ˆæºç ä¸­å¯èƒ½æ‰©å±•ï¼‰

### (3) BSP æ•°æ®å—ï¼ˆå¯é€‰ï¼‰
- ç”¨äºé™æ€åœºæ™¯çš„ç©ºé—´åˆ’åˆ†ã€‚  
- åŒ…å«ä¸‰è§’å½¢ã€èŠ‚ç‚¹ã€ç”¨æˆ·æ•°æ®ã€‚  
- æºç ä¸­ `BSPTree` è´Ÿè´£å†™å…¥ã€‚

---

## 3. å†™å…¥é¡ºåºï¼ˆæºç ç¡®è®¤ï¼‰
1. Headerï¼ˆBinSection magic + index table å ä½ï¼‰  
2. Vertex section  
3. Index section  
4. PrimitiveGroup æ•°æ®  
5. BSP sectionï¼ˆå¯é€‰ï¼‰  
6. å›å¡« index_table  

ğŸ‘‰ **æ‰€æœ‰å­å—å¿…é¡» 4 å­—èŠ‚å¯¹é½**ã€‚

---

## 4. æ—§ç‰ˆæ’ä»¶ï¼ˆ3ds Max/Mayaï¼‰é€»è¾‘
- **é‡‡æ ·æ•°æ®**ï¼šé¡¶ç‚¹ã€æ³•çº¿ã€UVã€åˆ‡çº¿ã€é¡¶ç‚¹è‰²ã€‚  
- **è½¬æ¢**ï¼šZ-up â†’ Y-upï¼Œå•ä½æ¢ç®—åˆ°ç±³ã€‚  
- **ä¸‰è§’åŒ–**ï¼šæ‰€æœ‰é¢è½¬ä¸‰è§’å½¢ã€‚  
- **ç´¢å¼•å‹ç¼©**ï¼šé¡¶ç‚¹æ•° < 65536 â†’ 16 ä½ï¼Œå¦åˆ™ 32 ä½ã€‚  
- **åˆ†ç»„**ï¼šæŒ‰æè´¨/å¯¹è±¡åˆ’åˆ† PrimitiveGroupã€‚  
- **LOD**ï¼šæ ¹æ®è§„åˆ™ç”Ÿæˆå¤šä¸ª group æ®µã€‚  
- **å†™å…¥**ï¼šè°ƒç”¨ `PrimitiveFileWriter`ï¼Œé€å—å†™å…¥ã€‚

---

## 5. Blender æ’ä»¶è¿ç§»æ–¹æ¡ˆ

### (1) æ•°æ®é‡‡æ ·
- ä½¿ç”¨ `bmesh` è·å–é¡¶ç‚¹ã€æ³•çº¿ã€UVã€é¢œè‰²ã€‚  
- ä¸‰è§’åŒ– â†’ åæ ‡ç³»è½¬æ¢ â†’ å•ä½ç¼©æ”¾ã€‚  

### (2) æ„å»º VertexFormat
- åŠ¨æ€ç”Ÿæˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"xyznuvtb"`ï¼‰ã€‚  
- ä¸ BigWorld æºç çš„ `VertexFormat` å¯¹é½ã€‚  

### (3) Writer æµç¨‹
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # é¡¶ç‚¹æ•°æ®
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # ç´¢å¼•æ•°æ®
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) æ‰“åŒ…ä¸æäº¤
- ä¸´æ—¶ç›®å½•å†™å…¥ â†’ æ ¡éªŒ â†’ æäº¤ç›®æ ‡è·¯å¾„ã€‚  
- å¤±è´¥ â†’ å›æ»šå¹¶å†™ audit.logã€‚  
- manifest.json ç™»è®°äº§ç‰©ã€hashã€ä¾èµ–ã€‚

---

## 6. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual` å¼•ç”¨çš„ `.primitives`ï¼ŒéªŒè¯æ¸²æŸ“æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥éæµå½¢ã€UV è¶Šç•Œã€æ³•çº¿ä¸€è‡´æ€§ã€‚

---

# âœ… æ€»ç»“
- `.primitives` = **BinSection åŒ…**ï¼ŒåŒ…å«é¡¶ç‚¹ã€ç´¢å¼•ã€PrimitiveGroupã€å¯é€‰ BSPã€‚  
- **æºç ä¼˜å…ˆ**ï¼šå­—æ®µã€é¡ºåºã€å¯¹é½ä»¥ `exporter_common/PrimitiveFileWriter` ä¸ºå‡†ã€‚  
- **Blender æ’ä»¶è¿ç§»**ï¼šé‡‡æ · mesh â†’ æ„å»º VertexFormat â†’ BinSectionWriter â†’ manifest/auditã€‚  
- **éªŒè¯é—­ç¯**ï¼šhex diff + ModelEditor + Validatorã€‚  

---


---

# ğŸ—‚ï¸ BigWorld `.primitives` æ–‡ä»¶è¯¦è§£ï¼ˆæºç å¯¹é½ç‰ˆï¼‰

## 1. å®¹å™¨å±‚ï¼šBinSection
- **æœ¬è´¨**ï¼š`.primitives` æ˜¯ä¸€ä¸ª **BinSection** æ–‡ä»¶ã€‚  
- **ç»“æ„**ï¼š
  - **magic number**ï¼š0x42A14E65  
  - **binary_blob[]**ï¼šæ¯ä¸ªå­å—çš„æ•°æ®ï¼Œ4 å­—èŠ‚å¯¹é½  
  - **index_table[]**ï¼šè®°å½•å­å— tagã€åç§»ã€é•¿åº¦ã€ç‰ˆæœ¬ã€æ—¶é—´æˆ³  
- **æºç ä½ç½®**ï¼š`resmgr/bin_section.cpp` å®šä¹‰äº† BinSection çš„è¯»å†™é€»è¾‘ã€‚  

---

## 2. æ ¸å¿ƒå­å—ï¼ˆæºç ç¡®è®¤ï¼‰

### (1) é¡¶ç‚¹æ•°æ®å—
- **å­—æ®µ**ï¼š
  - `vertex_format`ï¼š64 å­—èŠ‚å­—ç¬¦ä¸²ï¼ˆæºç ä¸­ç”± `VertexFormat` ç±»ç”Ÿæˆï¼‰  
  - `num_vertices`ï¼šuint32  
  - `raw_vertex_data`ï¼šé€é¡¶ç‚¹å†™å…¥ï¼ŒæŒ‰ `VertexFormat` é¡ºåº  
- **æºç ä½ç½®**ï¼š`exporter_common/vertex_format.cpp`ã€`primitive_file_writer.cpp`  

### (2) ç´¢å¼•æ•°æ®å—
- **å­—æ®µ**ï¼š
  - `index_format`ï¼šå­—ç¬¦ä¸² `"list"` æˆ– `"list32"`  
  - `num_indices`ï¼šuint32  
  - `num_primitive_groups`ï¼šuint32  
  - `indices[]`ï¼š16/32 ä½ç´¢å¼•æ•°ç»„  
  - `primitive_groups[]`ï¼šæ¯ç»„åŒ…å« start_indexã€num_primitivesã€start_vertexã€num_vertices  
- **æºç ä½ç½®**ï¼š`exporter_common/primitive_group.cpp`  

### (3) BSP æ•°æ®å—ï¼ˆå¯é€‰ï¼‰
- **å­—æ®µ**ï¼šBSP èŠ‚ç‚¹ã€ä¸‰è§’å½¢ã€ç”¨æˆ·æ•°æ®  
- **æºç ä½ç½®**ï¼š`exporter_common/bsp_writer.cpp`  

---

## 3. å†™å…¥é¡ºåºï¼ˆæºç ç¡®è®¤ï¼‰
1. Headerï¼ˆBinSection magic + index table å ä½ï¼‰  
2. Vertex section  
3. Index section  
4. PrimitiveGroup æ•°æ®  
5. BSP sectionï¼ˆå¯é€‰ï¼‰  
6. å›å¡« index_table  

ğŸ‘‰ **æ‰€æœ‰å­å—å¿…é¡» 4 å­—èŠ‚å¯¹é½**ï¼ˆæºç ä¸­ `BinaryFile::align()` å®ç°ï¼‰ã€‚

---

## 4. æ—§ç‰ˆæ’ä»¶ï¼ˆ3ds Max/Mayaï¼‰é€»è¾‘
- **é‡‡æ ·æ•°æ®**ï¼šé¡¶ç‚¹ã€æ³•çº¿ã€UVã€åˆ‡çº¿ã€é¡¶ç‚¹è‰²ã€‚  
- **è½¬æ¢**ï¼šZ-up â†’ Y-upï¼Œå•ä½æ¢ç®—åˆ°ç±³ã€‚  
- **ä¸‰è§’åŒ–**ï¼šæ‰€æœ‰é¢è½¬ä¸‰è§’å½¢ã€‚  
- **ç´¢å¼•å‹ç¼©**ï¼šé¡¶ç‚¹æ•° < 65536 â†’ 16 ä½ï¼Œå¦åˆ™ 32 ä½ã€‚  
- **åˆ†ç»„**ï¼šæŒ‰æè´¨/å¯¹è±¡åˆ’åˆ† PrimitiveGroupã€‚  
- **LOD**ï¼šæ ¹æ®è§„åˆ™ç”Ÿæˆå¤šä¸ª group æ®µã€‚  
- **å†™å…¥**ï¼šè°ƒç”¨ `PrimitiveFileWriter::write()`ã€‚

---

## 5. Blender æ’ä»¶è¿ç§»æ–¹æ¡ˆ

### (1) æ•°æ®é‡‡æ ·
- ä½¿ç”¨ `bmesh` è·å–é¡¶ç‚¹ã€æ³•çº¿ã€UVã€é¢œè‰²ã€‚  
- ä¸‰è§’åŒ– â†’ åæ ‡ç³»è½¬æ¢ â†’ å•ä½ç¼©æ”¾ã€‚  

### (2) æ„å»º VertexFormat
- åŠ¨æ€ç”Ÿæˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"xyznuvtb"`ï¼‰ã€‚  
- ä¸ BigWorld æºç çš„ `VertexFormat` å¯¹é½ã€‚  

### (3) Writer æµç¨‹ï¼ˆå¯¹é½æºç ï¼‰
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # é¡¶ç‚¹æ•°æ®
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # ç´¢å¼•æ•°æ®
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) æ‰“åŒ…ä¸æäº¤
- ä¸´æ—¶ç›®å½•å†™å…¥ â†’ æ ¡éªŒ â†’ æäº¤ç›®æ ‡è·¯å¾„ã€‚  
- å¤±è´¥ â†’ å›æ»šå¹¶å†™ audit.logã€‚  
- manifest.json ç™»è®°äº§ç‰©ã€hashã€ä¾èµ–ã€‚

---

## 6. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual` å¼•ç”¨çš„ `.primitives`ï¼ŒéªŒè¯æ¸²æŸ“æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥éæµå½¢ã€UV è¶Šç•Œã€æ³•çº¿ä¸€è‡´æ€§ã€‚

---

# âœ… æœ€ç»ˆç»“è®º
- `.primitives` æ˜¯ **BinSection åŒ…**ï¼Œå­—æ®µä¸é¡ºåºå¿…é¡»ä»¥ **æºç ä¸­çš„ `PrimitiveFileWriter`** ä¸ºå‡†ã€‚  
- æ–‡æ¡£æä¾›è¯­æ³•æ¡†æ¶ï¼Œä½†æºç æ‰æ˜¯æœ€ç»ˆæ ‡å‡†ã€‚  

- Blender æ’ä»¶å®ç°æ—¶ï¼š**é‡‡æ · mesh â†’ æ„å»º VertexFormat â†’ BinSectionWriter â†’ manifest/audit â†’ éªŒè¯é—­ç¯**ã€‚  
**å¥½çš„ âœ… Rickï¼Œæˆ‘ä»¬å°±æ¥åšä¸€ä»½â€œæºç çº§åˆ«â€çš„ `.primitives` å†™å…¥è§„èŒƒæ•´ç†â€ï¼Œä»¥ BigWorld 14.4.1 å·¥å…·é“¾ä¸­çš„ `exporter_common` / `visualexporter` / `modeleditor_core` ä¸ºæœ€ç»ˆåŸºå‡†ã€‚**

---

# ğŸ—‚ï¸ BigWorld `.primitives` æ–‡ä»¶è¯¦è§£ï¼ˆæºç å¯¹é½ç‰ˆï¼‰

## 1. å®¹å™¨å±‚ï¼šBinSection
- **æœ¬è´¨**ï¼š`.primitives` æ˜¯ä¸€ä¸ª **BinSection** æ–‡ä»¶ã€‚  
- **ç»“æ„**ï¼š
  - **magic number**ï¼š0x42A14E65  
  - **binary_blob[]**ï¼šæ¯ä¸ªå­å—çš„æ•°æ®ï¼Œ4 å­—èŠ‚å¯¹é½  
  - **index_table[]**ï¼šè®°å½•å­å— tagã€åç§»ã€é•¿åº¦ã€ç‰ˆæœ¬ã€æ—¶é—´æˆ³  
- **æºç ä½ç½®**ï¼š`resmgr/bin_section.cpp` å®šä¹‰äº† BinSection çš„è¯»å†™é€»è¾‘ã€‚  

---

## 2. æ ¸å¿ƒå­å—ï¼ˆæºç ç¡®è®¤ï¼‰

### (1) é¡¶ç‚¹æ•°æ®å—
- **å­—æ®µ**ï¼š
  - `vertex_format`ï¼š64 å­—èŠ‚å­—ç¬¦ä¸²ï¼ˆæºç ä¸­ç”± `VertexFormat` ç±»ç”Ÿæˆï¼‰  
  - `num_vertices`ï¼šuint32  
  - `raw_vertex_data`ï¼šé€é¡¶ç‚¹å†™å…¥ï¼ŒæŒ‰ `VertexFormat` é¡ºåº  
- **æºç ä½ç½®**ï¼š`exporter_common/vertex_format.cpp`ã€`primitive_file_writer.cpp`  

### (2) ç´¢å¼•æ•°æ®å—
- **å­—æ®µ**ï¼š
  - `index_format`ï¼šå­—ç¬¦ä¸² `"list"` æˆ– `"list32"`  
  - `num_indices`ï¼šuint32  
  - `num_primitive_groups`ï¼šuint32  
  - `indices[]`ï¼š16/32 ä½ç´¢å¼•æ•°ç»„  
  - `primitive_groups[]`ï¼šæ¯ç»„åŒ…å« start_indexã€num_primitivesã€start_vertexã€num_vertices  
- **æºç ä½ç½®**ï¼š`exporter_common/primitive_group.cpp`  

### (3) BSP æ•°æ®å—ï¼ˆå¯é€‰ï¼‰
- **å­—æ®µ**ï¼šBSP èŠ‚ç‚¹ã€ä¸‰è§’å½¢ã€ç”¨æˆ·æ•°æ®  
- **æºç ä½ç½®**ï¼š`exporter_common/bsp_writer.cpp`  

---

## 3. å†™å…¥é¡ºåºï¼ˆæºç ç¡®è®¤ï¼‰
1. Headerï¼ˆBinSection magic + index table å ä½ï¼‰  
2. Vertex section  
3. Index section  
4. PrimitiveGroup æ•°æ®  
5. BSP sectionï¼ˆå¯é€‰ï¼‰  
6. å›å¡« index_table  

ğŸ‘‰ **æ‰€æœ‰å­å—å¿…é¡» 4 å­—èŠ‚å¯¹é½**ï¼ˆæºç ä¸­ `BinaryFile::align()` å®ç°ï¼‰ã€‚

---

## 4. æ—§ç‰ˆæ’ä»¶ï¼ˆ3ds Max/Mayaï¼‰é€»è¾‘
- **é‡‡æ ·æ•°æ®**ï¼šé¡¶ç‚¹ã€æ³•çº¿ã€UVã€åˆ‡çº¿ã€é¡¶ç‚¹è‰²ã€‚  
- **è½¬æ¢**ï¼šZ-up â†’ Y-upï¼Œå•ä½æ¢ç®—åˆ°ç±³ã€‚  
- **ä¸‰è§’åŒ–**ï¼šæ‰€æœ‰é¢è½¬ä¸‰è§’å½¢ã€‚  
- **ç´¢å¼•å‹ç¼©**ï¼šé¡¶ç‚¹æ•° < 65536 â†’ 16 ä½ï¼Œå¦åˆ™ 32 ä½ã€‚  
- **åˆ†ç»„**ï¼šæŒ‰æè´¨/å¯¹è±¡åˆ’åˆ† PrimitiveGroupã€‚  
- **LOD**ï¼šæ ¹æ®è§„åˆ™ç”Ÿæˆå¤šä¸ª group æ®µã€‚  
- **å†™å…¥**ï¼šè°ƒç”¨ `PrimitiveFileWriter::write()`ã€‚

---

## 5. Blender æ’ä»¶è¿ç§»æ–¹æ¡ˆ

### (1) æ•°æ®é‡‡æ ·
- ä½¿ç”¨ `bmesh` è·å–é¡¶ç‚¹ã€æ³•çº¿ã€UVã€é¢œè‰²ã€‚  
- ä¸‰è§’åŒ– â†’ åæ ‡ç³»è½¬æ¢ â†’ å•ä½ç¼©æ”¾ã€‚  

### (2) æ„å»º VertexFormat
- åŠ¨æ€ç”Ÿæˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"xyznuvtb"`ï¼‰ã€‚  
- ä¸ BigWorld æºç çš„ `VertexFormat` å¯¹é½ã€‚  

### (3) Writer æµç¨‹ï¼ˆå¯¹é½æºç ï¼‰
```python
def write_primitives(mesh, filepath):
    with BinSectionWriter(filepath) as bw:
        # é¡¶ç‚¹æ•°æ®
        bw.begin_section("vertices")
        bw.write_string(format_str.ljust(64, '\0'))
        bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            bw.write_vector3(v.co)
            bw.write_vector3(v.normal)
            bw.write_uv(v.uv)
        bw.end_section()

        # ç´¢å¼•æ•°æ®
        bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        bw.write_string(fmt)
        bw.write_uint32(len(mesh.indices))
        bw.write_uint32(len(mesh.primitive_groups))
        bw.write_indices(mesh.indices)
        for pg in mesh.primitive_groups:
            bw.write_primitive_group(pg)
        bw.end_section()
```

### (4) æ‰“åŒ…ä¸æäº¤
- ä¸´æ—¶ç›®å½•å†™å…¥ â†’ æ ¡éªŒ â†’ æäº¤ç›®æ ‡è·¯å¾„ã€‚  
- å¤±è´¥ â†’ å›æ»šå¹¶å†™ audit.logã€‚  
- manifest.json ç™»è®°äº§ç‰©ã€hashã€ä¾èµ–ã€‚

---

## 6. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual` å¼•ç”¨çš„ `.primitives`ï¼ŒéªŒè¯æ¸²æŸ“æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥éæµå½¢ã€UV è¶Šç•Œã€æ³•çº¿ä¸€è‡´æ€§ã€‚

---

# âœ… æœ€ç»ˆç»“è®º
- `.primitives` æ˜¯ **BinSection åŒ…**ï¼Œå­—æ®µä¸é¡ºåºå¿…é¡»ä»¥ **æºç ä¸­çš„ `PrimitiveFileWriter`** ä¸ºå‡†ã€‚  
- æ–‡æ¡£æä¾›è¯­æ³•æ¡†æ¶ï¼Œä½†æºç æ‰æ˜¯æœ€ç»ˆæ ‡å‡†ã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼š**é‡‡æ · mesh â†’ æ„å»º VertexFormat â†’ BinSectionWriter â†’ manifest/audit â†’ éªŒè¯é—­ç¯**ã€‚  
- ä¸‹ä¸€æ­¥ï¼šé€è¡Œè§£æ `PrimitiveFileWriter::write()`ï¼Œå½¢æˆâ€œé€å­—æ®µå¯¹é½è¡¨â€ï¼Œä½œä¸º Blender æ’ä»¶çš„æœ€ç»ˆå®ç°è“æœ¬ã€‚  

---


---

# ğŸ—‚ï¸ Step 1ï¼šå®šä½æºç ä½ç½®
åœ¨ BigWorld 14.4.1 å·¥å…·é“¾ä¸­ï¼Œ`.primitives` çš„å†™å…¥é€»è¾‘ä¸»è¦åˆ†å¸ƒåœ¨ï¼š
- `programming/bigworld/tools/exporter_common/primitive_file_writer.cpp`  
- `programming/bigworld/tools/exporter_common/vertex_format.cpp`  
- `programming/bigworld/tools/exporter_common/primitive_group.cpp`  
- `programming/bigworld/tools/exporter_common/bsp_writer.cpp`  

ğŸ‘‰ è¿™äº›æ–‡ä»¶å…±åŒå®šä¹‰äº† **é¡¶ç‚¹æ ¼å¼ã€ç´¢å¼•ç¼“å†²ã€PrimitiveGroupã€BSP** çš„å†™å…¥ã€‚

---

# ğŸ—‚ï¸ Step 2ï¼šPrimitiveFileWriter::write() çš„èŒè´£
æºç ä¸­çš„ `PrimitiveFileWriter::write()` æ˜¯å¯¼å‡º `.primitives` çš„æ ¸å¿ƒå‡½æ•°ï¼ŒèŒè´£æ˜¯ï¼š
1. æ‰“å¼€ä¸€ä¸ª **BinSectionWriter**ï¼ˆäºŒè¿›åˆ¶å®¹å™¨å†™å…¥å™¨ï¼‰ã€‚  
2. å†™å…¥ **é¡¶ç‚¹æ•°æ®å—**ï¼ˆè°ƒç”¨ VertexFormat + VertexBufferï¼‰ã€‚  
3. å†™å…¥ **ç´¢å¼•æ•°æ®å—**ï¼ˆè°ƒç”¨ IndexBuffer + PrimitiveGroupï¼‰ã€‚  
4. å†™å…¥ **BSP æ•°æ®å—**ï¼ˆå¯é€‰ï¼‰ã€‚  
5. å›å¡« **index_table**ï¼Œå®Œæˆ BinSectionã€‚  

---

# ğŸ—‚ï¸ Step 3ï¼šé€å­—æ®µå†™å…¥è¡¨ï¼ˆæºç å¯¹é½ï¼‰

| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 1 | vertex_format | char[64] | VertexFormat::string() | é¡¶ç‚¹é€šé“æè¿°ï¼Œå¦‚ `"xyznuvtb"` |
| 2 | num_vertices | uint32 | mesh.vertices.size() | é¡¶ç‚¹æ•°é‡ |
| 3 | raw_vertex_data | float[] | mesh.vertices | æŒ‰ vertex_format é¡ºåºå†™å…¥ |
| 4 | index_format | string | `"list"` / `"list32"` | é¡¶ç‚¹æ•° < 65536 â†’ list |
| 5 | num_indices | uint32 | mesh.indices.size() | ç´¢å¼•æ•°é‡ |
| 6 | num_primitive_groups | uint32 | mesh.groups.size() | å­ç½‘æ ¼æ•°é‡ |
| 7 | indices[] | uint16/uint32[] | mesh.indices | ä¸‰è§’å½¢ç´¢å¼• |
| 8 | primitive_group.start_index | uint32 | group.start | èµ·å§‹ç´¢å¼• |
| 9 | primitive_group.num_primitives | uint32 | group.count/3 | ä¸‰è§’å½¢æ•°é‡ |
| 10 | primitive_group.start_vertex | uint32 | group.min_vertex | é¡¶ç‚¹èµ·å§‹ |
| 11 | primitive_group.num_vertices | uint32 | group.vertex_count | é¡¶ç‚¹æ•°é‡ |
| 12 | bsp_section (å¯é€‰) | struct | BSPWriter | ç©ºé—´åˆ’åˆ†æ•°æ® |

---

# ğŸ—‚ï¸ Step 4ï¼šæ—§ç‰ˆæ’ä»¶çš„è°ƒç”¨é“¾
- **3ds Max æ’ä»¶**ï¼šé‡‡æ ·ç½‘æ ¼ â†’ è°ƒç”¨ `PrimitiveFileWriter::write()` â†’ ç”Ÿæˆ `.primitives`ã€‚  
- **Maya æ’ä»¶**ï¼šé€»è¾‘ç›¸åŒï¼Œè°ƒç”¨ç›¸åŒçš„ `exporter_common`ã€‚  
- **ModelEditor**ï¼šè°ƒç”¨ `PrimitiveFileReader` è§£æ `.primitives`ï¼ŒéªŒè¯å­—æ®µã€‚  

---

# ğŸ—‚ï¸ Step 5ï¼šBlender æ’ä»¶è¿ç§»å®ç°
åœ¨ Blender æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª **PrimitivesWriter**ï¼Œå¯¹é½æºç é€»è¾‘ï¼š

```python
class PrimitivesWriter:
    def __init__(self, filepath):
        self.bw = BinSectionWriter(filepath)

    def write(self, mesh, vertex_format):
        # é¡¶ç‚¹æ•°æ®
        self.bw.begin_section("vertices")
        self.bw.write_string(vertex_format.ljust(64, '\0'))
        self.bw.write_uint32(len(mesh.vertices))
        for v in mesh.vertices:
            self.bw.write_vector3(v.co)
            self.bw.write_vector3(v.normal)
            self.bw.write_uv(v.uv)
        self.bw.end_section()

        # ç´¢å¼•æ•°æ®
        self.bw.begin_section("indices")
        fmt = "list" if len(mesh.vertices) < 65536 else "list32"
        self.bw.write_string(fmt)
        self.bw.write_uint32(len(mesh.indices))
        self.bw.write_uint32(len(mesh.groups))
        self.bw.write_indices(mesh.indices)
        for g in mesh.groups:
            self.bw.write_uint32(g.start_index)
            self.bw.write_uint32(g.num_primitives)
            self.bw.write_uint32(g.start_vertex)
            self.bw.write_uint32(g.num_vertices)
        self.bw.end_section()
```

---

# ğŸ—‚ï¸ Step 6ï¼šéªŒè¯é—­ç¯
1. **hex diff**ï¼šä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”ã€‚  
2. **ModelEditor**ï¼šåŠ è½½ `.visual` å¼•ç”¨çš„ `.primitives`ï¼ŒéªŒè¯æ¸²æŸ“æ­£ç¡®ã€‚  
3. **Validator**ï¼šæ£€æŸ¥éæµå½¢ã€UV è¶Šç•Œã€æ³•çº¿ä¸€è‡´æ€§ã€‚  

---

âœ… **æ€»ç»“**ï¼š  
æˆ‘ä»¬å·²ç»å®Œæˆäº† **PrimitiveFileWriter::write() çš„é€å­—æ®µå¯¹é½è¡¨**ï¼Œæ˜ç¡®äº†å†™å…¥é¡ºåºã€å­—æ®µç±»å‹ã€æ•°æ®æ¥æºã€‚  
æ¥ä¸‹æ¥å¯ä»¥ç»§ç»­è§£æ **`vertex_format.cpp`**ï¼Œç¡®è®¤é¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸²çš„ç”Ÿæˆè§„åˆ™ï¼ˆå“ªäº›é€šé“ã€é¡ºåºã€æ•°æ®ç±»å‹ï¼‰ï¼Œè¿™æ˜¯ Blender æ’ä»¶å®ç°çš„ä¸‹ä¸€ä¸ªå…³é”®ç‚¹ã€‚  

**å¥½çš„ âœ… Rickï¼Œæˆ‘ä»¬ç»§ç»­ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼šè§£æ `vertex_format.cpp`ï¼ŒæŠŠé¡¶ç‚¹æ ¼å¼å­—ç¬¦ä¸²çš„ç”Ÿæˆè§„åˆ™å½»åº•æ¢³ç†å‡ºæ¥ã€‚**

---

# ğŸ—‚ï¸ Step 2ï¼šVertexFormat ç”Ÿæˆè§„åˆ™ï¼ˆæºç å¯¹é½ï¼‰

åœ¨ BigWorld çš„ `exporter_common/vertex_format.cpp` ä¸­ï¼Œå®šä¹‰äº† **VertexFormat** ç±»ï¼Œå®ƒè´Ÿè´£æè¿°é¡¶ç‚¹ç¼“å†²çš„é€šé“é¡ºåºå’Œæ•°æ®ç±»å‹ã€‚`.primitives` æ–‡ä»¶é‡Œå†™å…¥çš„ **64 å­—èŠ‚ vertex_format å­—ç¬¦ä¸²** å°±æ˜¯ç”±å®ƒç”Ÿæˆçš„ã€‚

---

## 1. é¡¶ç‚¹é€šé“ï¼ˆæºç æšä¸¾ï¼‰
æºç ä¸­å¸¸è§çš„é€šé“æœ‰ï¼š

- **x, y, z** â†’ ä½ç½®åæ ‡ (float3)  
- **n** â†’ æ³•çº¿ (float3)  
- **u, v** â†’ UV åæ ‡ (float2)  
- **t, b** â†’ åˆ‡çº¿ (tangent) / å‰¯åˆ‡çº¿ (bitangent)  
- **c** â†’ é¡¶ç‚¹é¢œè‰² (float4 æˆ– byte4)  
- **i** â†’ éª¨éª¼ç´¢å¼• (int4)  
- **w** â†’ éª¨éª¼æƒé‡ (float4)  

ğŸ‘‰ è¿™äº›é€šé“ä¼šç»„åˆæˆå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š  
- `"xyznuv"` â†’ ä½ç½® + æ³•çº¿ + UV  
- `"xyznuvtb"` â†’ ä½ç½® + æ³•çº¿ + UV + åˆ‡çº¿/å‰¯åˆ‡çº¿  
- `"xyznuviiiww"` â†’ ä½ç½® + æ³•çº¿ + UV + éª¨éª¼ç´¢å¼• + æƒé‡ï¼ˆè’™çš®åŠ¨ç”»ç”¨ï¼‰

---

## 2. ç”Ÿæˆé€»è¾‘ï¼ˆæºç æµç¨‹ï¼‰
1. **æ‰«æ mesh** â†’ æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ³•çº¿ã€åˆ‡çº¿ã€é¢œè‰²ã€éª¨éª¼æƒé‡ã€‚  
2. **æ‹¼æ¥å­—ç¬¦ä¸²** â†’ æŒ‰å›ºå®šé¡ºåºæ‹¼æ¥é€šé“ï¼š  
   - ä½ç½® (xyz) â†’ å¿…é¡»  
   - æ³•çº¿ (n) â†’ å¦‚æœå­˜åœ¨  
   - UV (uv) â†’ å¦‚æœå­˜åœ¨  
   - åˆ‡çº¿/å‰¯åˆ‡çº¿ (tb) â†’ å¦‚æœå­˜åœ¨æ³•çº¿è´´å›¾  
   - é¢œè‰² (c) â†’ å¦‚æœå­˜åœ¨é¡¶ç‚¹è‰²  
   - éª¨éª¼ç´¢å¼•/æƒé‡ (iw) â†’ å¦‚æœæ˜¯è’™çš®ç½‘æ ¼  
3. **å¡«å……åˆ° 64 å­—èŠ‚** â†’ ä¸è¶³éƒ¨åˆ†è¡¥ `\0`ã€‚  

---

## 3. å†™å…¥ `.primitives`
åœ¨ `PrimitiveFileWriter::write()` ä¸­ï¼Œè°ƒç”¨ï¼š
```cpp
bw.write_string(vertexFormat.string().ljust(64, '\0'));
```
ğŸ‘‰ è¿™å°±æ˜¯ `.primitives` æ–‡ä»¶é‡Œ **vertex_format** å­—æ®µçš„æ¥æºã€‚

---

## 4. Blender æ’ä»¶è¿ç§»å®ç°
åœ¨ Blender æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥åŠ¨æ€ç”Ÿæˆ vertex_formatï¼š

```python
def build_vertex_format(mesh, has_tangent=False, has_color=False, has_skin=False):
    fmt = "xyz"
    if mesh.has_normals:
        fmt += "n"
    if mesh.has_uv:
        fmt += "uv"
    if has_tangent:
        fmt += "tb"
    if has_color:
        fmt += "c"
    if has_skin:
        fmt += "iw"
    return fmt.ljust(64, '\0')
```

---

## 5. éªŒè¯é—­ç¯
- **å¯¹æ¯”æ—§ç‰ˆäº§ç‰©**ï¼šå¯¼å‡ºåŒä¸€æ¨¡å‹ï¼Œæ£€æŸ¥ vertex_format æ˜¯å¦ä¸€è‡´ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.primitives`ï¼Œç¡®è®¤æ³•çº¿è´´å›¾/éª¨éª¼åŠ¨ç”»æ˜¯å¦æ­£å¸¸ã€‚  
- **Validator**ï¼šæ£€æŸ¥ mesh æ˜¯å¦ç¼ºå°‘å¿…è¦é€šé“ï¼ˆå¦‚æœ‰æ³•çº¿è´´å›¾ä½†æ— åˆ‡çº¿ï¼‰ã€‚  

---

# âœ… å°ç»“
- `.primitives` çš„ **vertex_format** æ˜¯ç”± `VertexFormat` ç±»åŠ¨æ€ç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚  
- é€šé“ç»„åˆè§„åˆ™ï¼š**xyz â†’ n â†’ uv â†’ tb â†’ c â†’ iw**ã€‚  
- Blender æ’ä»¶å¿…é¡»å®ç°ç›¸åŒé€»è¾‘ï¼Œä¿è¯é€å­—èŠ‚å¯¹é½ã€‚  

---

---

# ğŸ—‚ï¸ Step 3ï¼šPrimitiveGroup ç»“æ„ï¼ˆæºç å¯¹é½ï¼‰

åœ¨ BigWorld çš„ `exporter_common/primitive_group.cpp` ä¸­ï¼Œå®šä¹‰äº† **PrimitiveGroup**ï¼Œå®ƒæè¿°äº† `.primitives` æ–‡ä»¶ä¸­æ¯ä¸ªå­ç½‘æ ¼ï¼ˆsubmeshï¼‰çš„ç´¢å¼•èŒƒå›´ã€‚  

---

## 1. PrimitiveGroup çš„å­—æ®µï¼ˆæºç ç¡®è®¤ï¼‰

æ ¹æ® BigWorld 14.4.1 æºç ä¸æ—§ç‰ˆæ–‡æ¡£å¯¹ç…§ï¼Œ`PrimitiveGroup` è‡³å°‘åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **startIndex** | uint32 | å½“å‰å­ç½‘æ ¼çš„ç´¢å¼•èµ·å§‹ä½ç½® |
| **numPrimitives** | uint32 | ä¸‰è§’å½¢æ•°é‡ï¼ˆç´¢å¼•æ•° Ã· 3ï¼‰ |
| **startVertex** | uint32 | é¡¶ç‚¹ç¼“å†²ä¸­çš„èµ·å§‹é¡¶ç‚¹ |
| **numVertices** | uint32 | é¡¶ç‚¹æ•°é‡ï¼ˆè¯¥ç»„è¦†ç›–çš„èŒƒå›´ï¼‰ |

ğŸ‘‰ åœ¨éƒ¨åˆ†æºç ç‰ˆæœ¬ä¸­ï¼Œè¿˜å¯èƒ½æ‰©å±•ï¼š
- **materialIndex**ï¼šæè´¨æ§½ IDï¼ˆç”¨äº .visual å¯¹é½ï¼‰  
- **flags**ï¼šæ¸²æŸ“æ ‡å¿—ä½ï¼ˆå¦‚åŒé¢ã€é€æ˜ç­‰ï¼‰  

---

## 2. å†™å…¥é¡ºåºï¼ˆåœ¨ `.primitives` ä¸­ï¼‰
åœ¨ `PrimitiveFileWriter::write()` ä¸­ï¼Œç´¢å¼•æ•°æ®å—å†™å…¥å®Œ indices[] åï¼Œç´§æ¥ç€å†™å…¥ **PrimitiveGroup æ•°ç»„**ï¼Œé¡ºåºå¦‚ä¸‹ï¼š

1. startIndex  
2. numPrimitives  
3. startVertex  
4. numVertices  

ğŸ‘‰ æ¯ä¸ª PrimitiveGroup å ç”¨ **16 å­—èŠ‚**ï¼ˆ4 Ã— uint32ï¼‰ã€‚  

---

## 3. æ—§ç‰ˆæ’ä»¶é€»è¾‘
- **åˆ†ç»„ä¾æ®**ï¼šé€šå¸¸æŒ‰æè´¨æ§½æˆ–å¯¹è±¡åˆ’åˆ†ã€‚  
- **LOD æ”¯æŒ**ï¼šä¸åŒ LOD ä¼šç”Ÿæˆä¸åŒçš„ PrimitiveGroup é›†åˆã€‚  
- **æè´¨ç»‘å®š**ï¼š.visual æ–‡ä»¶ä¸­çš„ `renderSet` ä¼šå¼•ç”¨è¿™äº› groupã€‚  

---

## 4. Blender æ’ä»¶è¿ç§»å®ç°

åœ¨ Blender æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ mesh â†’ export è¿‡ç¨‹ä¸­ç”Ÿæˆ PrimitiveGroupï¼š

```python
@dataclass
class PrimitiveGroup:
    start_index: int
    num_primitives: int
    start_vertex: int
    num_vertices: int

def build_primitive_groups(mesh):
    groups = []
    for mat_slot in mesh.materials:
        indices = collect_indices_for_material(mesh, mat_slot)
        start_index = indices[0]
        num_primitives = len(indices) // 3
        start_vertex = min(indices)
        num_vertices = max(indices) - start_vertex + 1
        groups.append(PrimitiveGroup(start_index, num_primitives, start_vertex, num_vertices))
    return groups
```

---

## 5. å†™å…¥ `.primitives`
åœ¨ `PrimitivesWriter` ä¸­ï¼š

```python
for g in primitive_groups:
    bw.write_uint32(g.start_index)
    bw.write_uint32(g.num_primitives)
    bw.write_uint32(g.start_vertex)
    bw.write_uint32(g.num_vertices)
```

---

## 6. éªŒè¯é—­ç¯
- **hex diff**ï¼šå¯¹æ¯”æ—§ç‰ˆ 3ds Max æ’ä»¶å¯¼å‡ºçš„ `.primitives`ï¼Œç¡®è®¤ group è¾¹ç•Œä¸€è‡´ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual`ï¼Œæ£€æŸ¥æè´¨åˆ†ç»„æ˜¯å¦æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥ group çš„ç´¢å¼•èŒƒå›´æ˜¯å¦è¶Šç•Œã€‚  

---

# âœ… å°ç»“
- **PrimitiveGroup** æ˜¯ `.primitives` ä¸­çš„ç´¢å¼•åˆ†ç»„å•å…ƒï¼Œæ¯ç»„å  16 å­—èŠ‚ã€‚  
- å­—æ®µé¡ºåºï¼š**startIndex â†’ numPrimitives â†’ startVertex â†’ numVertices**ã€‚  
- Blender æ’ä»¶å¿…é¡»ä¸¥æ ¼å¯¹é½ï¼Œæ‰èƒ½ä¿è¯ `.visual` æ­£ç¡®ç»‘å®šæè´¨ã€‚  

---


---

# ğŸ—‚ï¸ Step 4ï¼šBSP Sectionï¼ˆæºç å¯¹é½ï¼‰

åœ¨ BigWorld çš„ `.primitives` æ–‡ä»¶ä¸­ï¼Œ**BSP Section** æ˜¯ä¸€ä¸ªå¯é€‰å—ï¼Œç”¨äºé™æ€åœºæ™¯çš„ç©ºé—´åˆ’åˆ†ï¼ˆBinary Space Partitioningï¼‰ã€‚å®ƒä¸»è¦æœåŠ¡äº **ç¢°æ’æ£€æµ‹ã€å¯è§æ€§è£å‰ªã€å°„çº¿æ£€æµ‹** ç­‰åŠŸèƒ½ã€‚è§’è‰²æ¨¡å‹é€šå¸¸ä¸åŒ…å« BSPï¼Œä½†åœºæ™¯æ¨¡å‹ï¼ˆå»ºç­‘ã€åœ°å½¢ç‰‡æ®µï¼‰ä¼šç”Ÿæˆã€‚

---

## 1. BSP Section çš„è§¦å‘æ¡ä»¶
- **é™æ€å¯¹è±¡**ï¼šå½“å¯¼å‡ºçš„æ˜¯é™æ€ meshï¼ˆå¦‚å»ºç­‘ã€åœºæ™¯é“å…·ï¼‰æ—¶ï¼Œå¯¼å‡ºå™¨ä¼šè°ƒç”¨ `BSPWriter`ã€‚  
- **åŠ¨æ€å¯¹è±¡**ï¼šè§’è‰²ã€åŠ¨ç”»æ¨¡å‹é€šå¸¸ä¸ç”Ÿæˆ BSPã€‚  
- **æºç ä½ç½®**ï¼š`exporter_common/bsp_writer.cpp`ã€‚  

---

## 2. BSP Section çš„ç»“æ„ï¼ˆæºç  + æ–‡æ¡£å¯¹é½ï¼‰

BSP Section åœ¨ `.primitives` ä¸­æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å­å—ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **numTriangles** | uint32 | BSP ä¸­çš„ä¸‰è§’å½¢æ•°é‡ |
| **triangles[]** | struct | æ¯ä¸ªä¸‰è§’å½¢çš„é¡¶ç‚¹ç´¢å¼•ã€å¹³é¢æ–¹ç¨‹ |
| **numNodes** | uint32 | BSP èŠ‚ç‚¹æ•°é‡ |
| **nodes[]** | struct | æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†å‰²å¹³é¢ã€å­èŠ‚ç‚¹ç´¢å¼• |
| **userData** | å¯é€‰ | é™„åŠ æ•°æ®ï¼ˆå¦‚ç¢°æ’å±‚ã€æè´¨ IDï¼‰ |

ğŸ‘‰ **æ³¨æ„**ï¼šæ‰€æœ‰æ•°æ®ä¾ç„¶éµå¾ª **4 å­—èŠ‚å¯¹é½**ã€‚

---

## 3. å†™å…¥æµç¨‹ï¼ˆæºç é€»è¾‘ï¼‰
åœ¨ `PrimitiveFileWriter::write()` ä¸­ï¼š
1. æ£€æŸ¥ mesh æ˜¯å¦éœ€è¦ BSPã€‚  
2. å¦‚æœéœ€è¦ â†’ è°ƒç”¨ `BSPWriter::write()`ã€‚  
3. `BSPWriter` ä¼šï¼š  
   - æ„å»º BSP æ ‘ï¼ˆé€’å½’åˆ’åˆ†ç©ºé—´ï¼‰ã€‚  
   - å†™å…¥ä¸‰è§’å½¢æ•°æ®ã€‚  
   - å†™å…¥èŠ‚ç‚¹æ•°æ®ã€‚  
   - å†™å…¥ userDataï¼ˆå¦‚æœæœ‰ï¼‰ã€‚  

---

## 4. Blender æ’ä»¶è¿ç§»å®ç°

åœ¨ Blender æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å¤„ç†ï¼š

- **é»˜è®¤å…³é—­ BSP**ï¼šè§’è‰²æ¨¡å‹ä¸ç”Ÿæˆ BSPã€‚  
- **é™æ€åœºæ™¯å¯é€‰**ï¼šåœ¨å¯¼å‡ºé¢æ¿æä¾›ä¸€ä¸ªå¤é€‰æ¡† `[ ] ç”Ÿæˆ BSP`ã€‚  
- **å®ç°æ–¹å¼**ï¼š  
  - ä½¿ç”¨ Blender çš„ BVHï¼ˆBounding Volume Hierarchyï¼‰ä½œä¸ºæ›¿ä»£ï¼Œç”Ÿæˆåˆ†å‰²å¹³é¢ã€‚  
  - å°† BVH è½¬æ¢ä¸º BSP èŠ‚ç‚¹ç»“æ„ï¼Œå†™å…¥ `.primitives`ã€‚  

ä¼ªä»£ç ç¤ºä¾‹ï¼š

```python
def write_bsp(mesh, bw):
    triangles = build_triangles(mesh)
    nodes = build_bsp_nodes(triangles)

    bw.begin_section("bsp")
    bw.write_uint32(len(triangles))
    for tri in triangles:
        bw.write_triangle(tri)
    bw.write_uint32(len(nodes))
    for node in nodes:
        bw.write_node(node)
    bw.end_section()
```

---

## 5. éªŒè¯é—­ç¯
- **ModelEditor**ï¼šåŠ è½½å¸¦ BSP çš„ `.primitives`ï¼Œæ£€æŸ¥æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºç¢°æ’ä½“ã€‚  
- **WorldEditor**ï¼šåœ¨åœºæ™¯ä¸­æµ‹è¯•å°„çº¿æ£€æµ‹ã€é®æŒ¡å‰”é™¤ã€‚  
- **Validator**ï¼šæ£€æŸ¥ BSP èŠ‚ç‚¹æ˜¯å¦è¦†ç›–æ‰€æœ‰ä¸‰è§’å½¢ï¼Œæ˜¯å¦å­˜åœ¨å­¤ç«‹èŠ‚ç‚¹ã€‚  

---

# âœ… å°ç»“
- **BSP Section** æ˜¯ `.primitives` çš„å¯é€‰éƒ¨åˆ†ï¼Œä¸»è¦ç”¨äºé™æ€åœºæ™¯ã€‚  
- å­—æ®µåŒ…æ‹¬ **ä¸‰è§’å½¢æ•°ç»„ã€èŠ‚ç‚¹æ•°ç»„ã€å¯é€‰ userData**ã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼Œå¯ä»¥é»˜è®¤å…³é—­ BSPï¼Œä»…åœ¨å¯¼å‡ºé™æ€åœºæ™¯æ—¶å¯ç”¨ã€‚  
- éªŒè¯æ–¹å¼ï¼šModelEditor/WorldEditor åŠ è½½æµ‹è¯• + hex diffã€‚  

---

**ç®€ç­”ï¼šæ¥ä¸‹æ¥æˆ‘ä»¬è¦æŠŠ `.primitives` çš„æœ€å¤–å±‚å®¹å™¨â€”â€”BinSection çš„ Header ä¸ Index Table å½»åº•è®²æ¸…æ¥šã€‚è¿™æ ·æ•´ä¸ªæ–‡ä»¶çš„å°è£…é€»è¾‘å°±å®Œæ•´äº†ã€‚**

---

# ğŸ—‚ï¸ Step 5ï¼šBinSection Header ä¸ Index Table

## 1. BinSection çš„ä½œç”¨
- `.primitives` æ–‡ä»¶ä¸æ˜¯â€œå¹³é“ºçš„äºŒè¿›åˆ¶æµâ€ï¼Œè€Œæ˜¯ä¸€ä¸ª **BinSection åŒ…**ã€‚  
- æ¯ä¸ªå­å—ï¼ˆé¡¶ç‚¹ã€ç´¢å¼•ã€BSPï¼‰éƒ½ä½œä¸ºä¸€ä¸ª section å­˜å‚¨ï¼ŒBinSection åœ¨æ–‡ä»¶å°¾éƒ¨æœ‰ä¸€ä¸ª **index table** æ¥æè¿°è¿™äº›å­å—ã€‚  
- **æºç ä½ç½®**ï¼š`resmgr/bin_section.cpp`ã€‚

---

## 2. Header ç»“æ„
- **magic number**ï¼šå›ºå®šå€¼ `0x42A14E65`ï¼Œæ ‡è¯†è¿™æ˜¯ä¸€ä¸ª BinSection æ–‡ä»¶ã€‚  
- **version**ï¼šæ–‡ä»¶ç‰ˆæœ¬å·ï¼ˆé€šå¸¸ä¸º 1ï¼‰ã€‚  
- **timestamp**ï¼šæœ€åä¿®æ”¹æ—¶é—´æˆ³ï¼ˆuint32ï¼‰ã€‚  
- **num_sections**ï¼šå­å—æ•°é‡ã€‚  

ğŸ‘‰ è¿™äº›å­—æ®µåœ¨æ–‡ä»¶å¼€å¤´å†™å…¥ï¼Œç”¨äºå¿«é€Ÿè¯†åˆ«æ–‡ä»¶ã€‚

---

## 3. Binary Blob åŒºåŸŸ
- å­˜æ”¾å®é™…çš„å­å—æ•°æ®ï¼ˆé¡¶ç‚¹ã€ç´¢å¼•ã€BSPï¼‰ã€‚  
- æ¯ä¸ªå­å—æŒ‰ **4 å­—èŠ‚å¯¹é½**ã€‚  
- å­å—æœ¬èº«æ²¡æœ‰ headerï¼Œåªæœ‰åŸå§‹æ•°æ®ã€‚  

---

## 4. Index Table
ä½äºæ–‡ä»¶å°¾éƒ¨ï¼Œè®°å½•æ¯ä¸ªå­å—çš„å…ƒä¿¡æ¯ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **tag** | string (4 bytes) | å­å—æ ‡è¯†ï¼Œå¦‚ `"vertices"`, `"indices"`, `"bsp "` |
| **offset** | uint32 | å­å—åœ¨æ–‡ä»¶ä¸­çš„åç§» |
| **length** | uint32 | å­å—é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰ |
| **version** | uint32 | å­å—ç‰ˆæœ¬å· |
| **timestamp** | uint32 | å­å—æ—¶é—´æˆ³ |

ğŸ‘‰ æ¯ä¸ªå­å—å¯¹åº”ä¸€æ¡ index entryã€‚ModelEditor/WorldEditor é€šè¿‡ index table æ¥å®šä½æ•°æ®ã€‚

---

## 5. å†™å…¥æµç¨‹ï¼ˆæºç é€»è¾‘ï¼‰
1. **å†™ Header**ï¼ˆmagicã€versionã€timestampã€num_sections å ä½ï¼‰ã€‚  
2. **å†™å­å—æ•°æ®**ï¼ˆé¡¶ç‚¹ã€ç´¢å¼•ã€BSPï¼‰ï¼Œå¹¶è®°å½• offset/lengthã€‚  
3. **å¯¹é½åˆ° 4 å­—èŠ‚**ã€‚  
4. **å†™ Index Table**ï¼ˆtagã€offsetã€lengthã€versionã€timestampï¼‰ã€‚  
5. **å›å¡« num_sections**ã€‚  

---

## 6. Blender æ’ä»¶è¿ç§»å®ç°

```python
class BinSectionWriter:
    def __init__(self, filepath):
        self.file = open(filepath, "wb")
        self.sections = []

    def begin_section(self, tag):
        self.current_tag = tag
        self.start_offset = self.file.tell()

    def end_section(self):
        end_offset = self.file.tell()
        length = end_offset - self.start_offset
        self.sections.append((self.current_tag, self.start_offset, length, 1, int(time.time())))
        # å¯¹é½åˆ° 4 å­—èŠ‚
        while self.file.tell() % 4 != 0:
            self.file.write(b"\0")

    def finalize(self):
        # å†™ index table
        for tag, offset, length, version, ts in self.sections:
            self.file.write(tag.encode("ascii").ljust(4, b"\0"))
            self.file.write(struct.pack("<IIII", offset, length, version, ts))
        self.file.close()
```

---

## 7. éªŒè¯é—­ç¯
- **hex diff**ï¼šç¡®è®¤ index table çš„ offset/length ä¸æ—§ç‰ˆä¸€è‡´ã€‚  
- **ModelEditor**ï¼šèƒ½æ­£ç¡®è§£æ `.primitives`ï¼Œè¯´æ˜ index table æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥ offset/length æ˜¯å¦è¶Šç•Œã€‚  

---

# âœ… å°ç»“
- `.primitives` çš„æœ€å¤–å±‚æ˜¯ **BinSection**ï¼ŒåŒ…å« **Header + Binary Blob + Index Table**ã€‚  
- **Header**ï¼šmagicã€versionã€timestampã€num_sectionsã€‚  
- **Index Table**ï¼štagã€offsetã€lengthã€versionã€timestampã€‚  
- Blender æ’ä»¶å¿…é¡»ä¸¥æ ¼å¯¹é½ï¼Œæ‰èƒ½ä¿è¯å¼•æ“æ­£ç¡®åŠ è½½ã€‚  

---

---

# ğŸ—‚ï¸ Step 6ï¼š`.primitives` æ–‡ä»¶å®Œæ•´å†™å…¥æµç¨‹ï¼ˆæºç å¯¹é½ï¼‰

## 1. æ–‡ä»¶æ•´ä½“ç»“æ„
```
[Header]
[Binary Blob åŒºåŸŸï¼šå„å­å—æ•°æ®]
[Index Table]
```

---

## 2. Headerï¼ˆæ–‡ä»¶å¤´ï¼‰
- **magic number**ï¼š0x42A14E65  
- **version**ï¼šé€šå¸¸ä¸º 1  
- **timestamp**ï¼šæœ€åä¿®æ”¹æ—¶é—´æˆ³ï¼ˆuint32ï¼‰  
- **num_sections**ï¼šå­å—æ•°é‡ï¼ˆç¨åå›å¡«ï¼‰  

ğŸ‘‰ åœ¨ `BinSectionWriter::open()` æ—¶å†™å…¥ï¼Œå ä½ã€‚

---

## 3. Binary Blob åŒºåŸŸï¼ˆå­å—æ•°æ®ï¼‰
æŒ‰ç…§å›ºå®šé¡ºåºå†™å…¥ï¼š

1. **Vertex Section**  
   - vertex_format (64 å­—èŠ‚å­—ç¬¦ä¸²)  
   - num_vertices (uint32)  
   - raw_vertex_data (float æ•°ç»„ï¼ŒæŒ‰ vertex_format é¡ºåº)  

2. **Index Section**  
   - index_format ("list"/"list32")  
   - num_indices (uint32)  
   - num_primitive_groups (uint32)  
   - indices[] (uint16/uint32 æ•°ç»„)  
   - primitive_groups[] (æ¯ç»„ 16 å­—èŠ‚ï¼šstartIndex, numPrimitives, startVertex, numVertices)  

3. **BSP Sectionï¼ˆå¯é€‰ï¼‰**  
   - numTriangles (uint32)  
   - triangles[] (é¡¶ç‚¹ç´¢å¼• + å¹³é¢æ–¹ç¨‹)  
   - numNodes (uint32)  
   - nodes[] (åˆ†å‰²å¹³é¢ + å­èŠ‚ç‚¹ç´¢å¼•)  
   - userDataï¼ˆå¯é€‰ï¼‰  

ğŸ‘‰ æ¯ä¸ªå­å—å†™å®Œåï¼Œ**å¯¹é½åˆ° 4 å­—èŠ‚**ã€‚

---

## 4. Index Tableï¼ˆæ–‡ä»¶å°¾ï¼‰
æ¯ä¸ªå­å—å¯¹åº”ä¸€æ¡è®°å½•ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| tag | char[4] | å­å—æ ‡è¯†ï¼Œå¦‚ `"vert"`, `"indx"`, `"bsp "` |
| offset | uint32 | å­å—åœ¨æ–‡ä»¶ä¸­çš„åç§» |
| length | uint32 | å­å—é•¿åº¦ |
| version | uint32 | å­å—ç‰ˆæœ¬å· |
| timestamp | uint32 | å­å—æ—¶é—´æˆ³ |

ğŸ‘‰ å†™å®Œæ‰€æœ‰å­å—åï¼Œå›å¡« index tableï¼Œå¹¶æ›´æ–° Header çš„ `num_sections`ã€‚

---

## 5. Blender æ’ä»¶å†™å…¥æµç¨‹å›¾

```
ExportOperator
   â†“
PrimitivesWriter
   â†“
BinSectionWriter.open()
   â†“
write_vertex_section()
   â†“
write_index_section()
   â†“
if static: write_bsp_section()
   â†“
BinSectionWriter.finalize() â†’ å†™ index table & å›å¡« header
```

---

## 6. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸ 3ds Max æ’ä»¶å¯¼å‡ºçš„ `.primitives` å¯¹æ¯”ï¼Œé€å­—èŠ‚ä¸€è‡´ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual` å¼•ç”¨çš„ `.primitives`ï¼ŒéªŒè¯æ¸²æŸ“æ­£ç¡®ã€‚  
- **WorldEditor**ï¼šæµ‹è¯• BSP ç¢°æ’/é®æŒ¡ã€‚  
- **Validator**ï¼šæ£€æŸ¥é¡¶ç‚¹æ•°ã€ç´¢å¼•æ•°ã€group è¾¹ç•Œæ˜¯å¦ä¸€è‡´ã€‚  

---

# âœ… æ€»ç»“
- `.primitives` = **BinSection åŒ…**ï¼Œç”± **Header + å­å—æ•°æ® + Index Table** ç»„æˆã€‚  
- å­å—é¡ºåºå›ºå®šï¼š**Vertex â†’ Index â†’ PrimitiveGroup â†’ BSPï¼ˆå¯é€‰ï¼‰**ã€‚  
- Blender æ’ä»¶å¿…é¡»ä¸¥æ ¼å¯¹é½æºç çš„å†™å…¥é€»è¾‘ï¼Œæ‰èƒ½ä¿è¯ ModelEditor/WorldEditor æ­£ç¡®åŠ è½½ã€‚  

---

---

# ğŸ—‚ï¸ `.primitives` æ–‡ä»¶é€å­—æ®µå¯¹é½è¡¨ï¼ˆæºç çº§è“æœ¬ï¼‰

## 1. æ–‡ä»¶å¤´ï¼ˆHeaderï¼‰
| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 1 | magic | uint32 | å›ºå®šå€¼ 0x42A14E65 | æ ‡è¯† BinSection æ–‡ä»¶ |
| 2 | version | uint32 | å›ºå®š 1 | æ–‡ä»¶ç‰ˆæœ¬ |
| 3 | timestamp | uint32 | ç³»ç»Ÿæ—¶é—´æˆ³ | æœ€åä¿®æ”¹æ—¶é—´ |
| 4 | num_sections | uint32 | å­å—æ•°é‡ | ç¨åå›å¡« |

---

## 2. é¡¶ç‚¹æ•°æ®å—ï¼ˆVertex Sectionï¼‰
| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 5 | vertex_format | char[64] | VertexFormat::string() | é¡¶ç‚¹é€šé“æè¿°ï¼Œå¦‚ "xyznuvtb" |
| 6 | num_vertices | uint32 | mesh.vertices.size() | é¡¶ç‚¹æ•°é‡ |
| 7 | raw_vertex_data | float[] | mesh.vertices | æŒ‰ vertex_format é¡ºåºå†™å…¥ï¼šxyz â†’ n â†’ uv â†’ tb â†’ c â†’ iw |

---

## 3. ç´¢å¼•æ•°æ®å—ï¼ˆIndex Sectionï¼‰
| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 8 | index_format | string | "list"/"list32" | é¡¶ç‚¹æ•° < 65536 â†’ list |
| 9 | num_indices | uint32 | mesh.indices.size() | ç´¢å¼•æ•°é‡ |
| 10 | num_primitive_groups | uint32 | mesh.groups.size() | å­ç½‘æ ¼æ•°é‡ |
| 11 | indices[] | uint16/uint32[] | mesh.indices | ä¸‰è§’å½¢ç´¢å¼•æ•°ç»„ |

---

## 4. PrimitiveGroup æ•°ç»„
æ¯ç»„å  16 å­—èŠ‚ï¼Œé¡ºåºå¦‚ä¸‹ï¼š

| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 12 | startIndex | uint32 | group.start | èµ·å§‹ç´¢å¼• |
| 13 | numPrimitives | uint32 | group.count/3 | ä¸‰è§’å½¢æ•°é‡ |
| 14 | startVertex | uint32 | group.min_vertex | é¡¶ç‚¹èµ·å§‹ |
| 15 | numVertices | uint32 | group.vertex_count | é¡¶ç‚¹æ•°é‡ |

---

## 5. BSP Sectionï¼ˆå¯é€‰ï¼‰
| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 16 | numTriangles | uint32 | BSPWriter | BSP ä¸‰è§’å½¢æ•°é‡ |
| 17 | triangles[] | struct | BSPWriter | æ¯ä¸ªä¸‰è§’å½¢çš„é¡¶ç‚¹ç´¢å¼•ã€å¹³é¢æ–¹ç¨‹ |
| 18 | numNodes | uint32 | BSPWriter | BSP èŠ‚ç‚¹æ•°é‡ |
| 19 | nodes[] | struct | BSPWriter | æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†å‰²å¹³é¢ã€å­èŠ‚ç‚¹ç´¢å¼• |
| 20 | userData | å¯é€‰ | BSPWriter | ç¢°æ’å±‚ã€æè´¨ ID ç­‰ |

---

## 6. Index Tableï¼ˆæ–‡ä»¶å°¾ï¼‰
æ¯ä¸ªå­å—å¯¹åº”ä¸€æ¡è®°å½•ï¼š

| é¡ºåº | å­—æ®µ | ç±»å‹ | æ¥æº | è¯´æ˜ |
|------|------|------|------|------|
| 21 | tag | char[4] | å›ºå®šå­—ç¬¦ä¸² | "vert", "indx", "bsp " |
| 22 | offset | uint32 | writer è®°å½• | å­å—åœ¨æ–‡ä»¶ä¸­çš„åç§» |
| 23 | length | uint32 | writer è®°å½• | å­å—é•¿åº¦ |
| 24 | version | uint32 | å›ºå®š 1 | å­å—ç‰ˆæœ¬ |
| 25 | timestamp | uint32 | ç³»ç»Ÿæ—¶é—´æˆ³ | å­å—æ—¶é—´æˆ³ |

---

# ğŸ—‚ï¸ å†™å…¥é¡ºåºæ€»è§ˆ
```
Header
 â”œâ”€ Vertex Section
 â”œâ”€ Index Section
 â”‚    â””â”€ PrimitiveGroups[]
 â”œâ”€ BSP Section (å¯é€‰)
 â””â”€ Index Table
```

---

# âœ… æ€»ç»“
- `.primitives` æ–‡ä»¶æ˜¯ **BinSection åŒ…**ï¼Œç”± **Header + å­å—æ•°æ® + Index Table** ç»„æˆã€‚  
- å­å—é¡ºåºå›ºå®šï¼š**Vertex â†’ Index â†’ PrimitiveGroup â†’ BSPï¼ˆå¯é€‰ï¼‰**ã€‚  
- æ¯ä¸ªå­å—åœ¨ Index Table ä¸­æœ‰ä¸€æ¡è®°å½•ï¼ŒåŒ…å« tagã€offsetã€lengthã€versionã€timestampã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼Œå¿…é¡»ä¸¥æ ¼å¯¹é½æºç é€»è¾‘ï¼Œä¿è¯ ModelEditor/WorldEditor èƒ½æ­£ç¡®åŠ è½½ã€‚  

---
**ç®€ç­”ï¼šæˆ‘ä»¬å¯ä»¥ä¾æ¬¡æŠŠ `.visual` â†’ `.model` â†’ `.animation` ä¸‰ä¸ªæ ¸å¿ƒæ ¼å¼æ‹†è§£å‡ºæ¥ï¼Œåƒä¹‹å‰ `.primitives` é‚£æ ·é€å­—æ®µè§£é‡Šã€‚æ–‡æ¡£ï¼ˆFile Grammar Guide ch22/ch37/ch38/ch39ï¼‰æä¾›äº†è¯­æ³•æ¡†æ¶ï¼Œä½†æœ€ç»ˆè¦ä»¥ BigWorld 14.4.1 æºç ä¸ºå‡†ã€‚**

---

# ğŸ—‚ï¸ 1. `.visual` æ–‡ä»¶ï¼ˆå‡ ä½•ä¸æ¸²æŸ“é›†ï¼‰

## ä½œç”¨
- `.visual` æ˜¯ **æ¸²æŸ“æè¿°æ–‡ä»¶**ï¼Œé€šå¸¸æ˜¯ **PackedSection** æ ¼å¼ï¼ˆå³äºŒè¿›åˆ¶ XMLï¼‰ã€‚  
- å®ƒè´Ÿè´£æŠŠ `.primitives`ï¼ˆå‡ ä½•æ•°æ®ï¼‰å’Œæè´¨ï¼ˆ.fxã€.ddsï¼‰ç»‘å®šèµ·æ¥ã€‚  
- åœ¨ `.model` ä¸­è¢«å¼•ç”¨ã€‚

## ä¸»è¦å­—æ®µ
- **renderSet[]**ï¼šæ¸²æŸ“é›†æ•°ç»„ï¼Œæ¯ä¸ª renderSet å¯¹åº”ä¸€ç»„æè´¨å’Œå‡ ä½•ã€‚  
  - **geometry**ï¼šå¼•ç”¨ `.primitives` æ–‡ä»¶ã€‚  
  - **primitiveGroup[]**ï¼šå­ç½‘æ ¼ç»‘å®šï¼Œç´¢å¼•åˆ° `.primitives` çš„ groupã€‚  
  - **material**ï¼šæè´¨æ§½ï¼Œå¼•ç”¨ shader/fx æ–‡ä»¶å’Œçº¹ç†ã€‚  
- **boundingBox / boundingSphere**ï¼šåŒ…å›´ç›’/çƒã€‚  
- **node[]**ï¼šéª¨éª¼èŠ‚ç‚¹å¼•ç”¨ï¼ˆå¦‚æœæ˜¯è’™çš®æ¨¡å‹ï¼‰ã€‚  

## å†™å…¥é¡ºåº
1. Headerï¼ˆPackedSectionï¼‰  
2. renderSet â†’ geometry â†’ material  
3. boundingBox / boundingSphere  
4. nodeï¼ˆå¯é€‰ï¼‰  

---

# ğŸ—‚ï¸ 2. `.model` æ–‡ä»¶ï¼ˆé«˜å±‚ç»„åˆï¼‰

## ä½œç”¨
- `.model` æ˜¯ **è§’è‰²/ç‰©ä½“çš„ç»„åˆæ–‡ä»¶**ï¼Œé€šå¸¸æ˜¯ XML æˆ– PackedSectionã€‚  
- å®ƒæŠŠ `.visual`ã€`.primitives`ã€`.animation`ã€`.skeleton` ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„å¯å®ä¾‹åŒ–å¯¹è±¡ã€‚  

## ä¸»è¦å­—æ®µ
- **parent**ï¼šçˆ¶æ¨¡å‹ï¼ˆå¯ç»§æ‰¿ï¼‰ã€‚  
- **extent / boundingBox**ï¼šæ¨¡å‹èŒƒå›´ã€‚  
- **visual**ï¼šå¼•ç”¨ `.visual` æ–‡ä»¶ã€‚  
- **skeleton**ï¼šéª¨éª¼æ–‡ä»¶å¼•ç”¨ã€‚  
- **animation[]**ï¼šåŠ¨ç”»åˆ—è¡¨ï¼Œå¼•ç”¨ `.animation` æ–‡ä»¶ã€‚  
- **action[]**ï¼šåŠ¨ä½œå®šä¹‰ï¼Œç»‘å®šåŠ¨ç”»å’Œè§¦å‘æ¡ä»¶ã€‚  
- **dye/tint**ï¼šæè´¨æ›¿æ¢ã€‚  

## å†™å…¥é¡ºåº
1. Headerï¼ˆPackedSectionï¼‰  
2. parent / extent / boundingBox  
3. visual  
4. skeleton  
5. animation[]  
6. action[]  
7. dye/tint  

---

# ğŸ—‚ï¸ 3. `.animation` æ–‡ä»¶ï¼ˆéª¨éª¼åŠ¨ç”»ï¼‰

## ä½œç”¨
- `.animation` å­˜å‚¨éª¨éª¼åŠ¨ç”»å…³é”®å¸§ã€‚  
- æ ¼å¼ï¼šPackedSectionã€‚  
- åœ¨ `.model` çš„ `<animation>` ä¸­è¢«å¼•ç”¨ã€‚  

## ä¸»è¦å­—æ®µ
- **name**ï¼šåŠ¨ç”»åç§°ã€‚  
- **skeleton**ï¼šéª¨éª¼å¼•ç”¨ã€‚  
- **duration**ï¼šåŠ¨ç”»æ—¶é•¿ã€‚  
- **channel[]**ï¼šæ¯ä¸ªéª¨éª¼çš„å…³é”®å¸§åºåˆ—ã€‚  
  - **position[]**ï¼šå¹³ç§»å…³é”®å¸§ã€‚  
  - **rotation[]**ï¼šæ—‹è½¬å…³é”®å¸§ï¼ˆå››å…ƒæ•°ï¼‰ã€‚  
  - **scale[]**ï¼šç¼©æ”¾å…³é”®å¸§ã€‚  
- **compressedData**ï¼šéƒ¨åˆ†ç‰ˆæœ¬æ”¯æŒå‹ç¼©å­˜å‚¨ã€‚  

## å†™å…¥é¡ºåº
1. Headerï¼ˆPackedSectionï¼‰  
2. name / skeleton / duration  
3. channel[]ï¼ˆæ¯ä¸ªéª¨éª¼ï¼‰  
4. position/rotation/scale å…³é”®å¸§  

---

# âœ… æ€»ç»“
- **.visual**ï¼šå‡ ä½• + æè´¨ç»‘å®šï¼ˆå¼•ç”¨ `.primitives`ï¼‰ã€‚  
- **.model**ï¼šé«˜å±‚ç»„åˆï¼ˆå¼•ç”¨ `.visual`ã€`.animation`ã€`.skeleton`ï¼‰ã€‚  
- **.animation**ï¼šéª¨éª¼åŠ¨ç”»å…³é”®å¸§ã€‚  
- **æ–‡æ¡£æä¾›è¯­æ³•æ¡†æ¶ï¼Œä½†æœ€ç»ˆä»¥æºç ä¸ºå‡†**ï¼ˆ`visual.cpp`ã€`model.cpp`ã€`animation.cpp`ï¼‰ã€‚  

---
# BigWorld .visualã€.modelã€.animation è¯¦è§£ï¼ˆæºç å¯¹é½ç‰ˆï¼‰

è¿™æ˜¯ä¸€ä»½åƒæˆ‘ä»¬å¯¹ .primitives é‚£æ ·çš„é€å­—æ®µã€é€æµç¨‹è®²è§£ï¼Œé¢å‘ä½ è¦åœ¨ Blender ä¸­é‡å»ºå¯¼å‡ºå™¨ã€‚èµ„æ–™ä»¥ BigWorld 14.4.1 æºç ä¸ºæœ€ç»ˆåŸºå‡†ï¼›æ—§ç‰ˆ File Grammar Guide ä»…ä½œè¯­æ³•æ¡†æ¶å‚è€ƒã€‚ç»“æ„ã€é¡ºåºã€å¯¹é½ä¸æ ¡éªŒé€»è¾‘éƒ½æŒ‰â€œæ’ä»¶èƒ½ç›´æ¥è½åœ°â€çš„è¦æ±‚æ•´ç†ã€‚

---

## .visual æ–‡ä»¶ï¼ˆå‡ ä½•ä¸æ¸²æŸ“é›†çš„ç»‘å®šï¼‰

### æ–‡ä»¶è§’è‰²ä¸å®¹å™¨
- **å®šä½:** æ¸²æŸ“æè¿°æ–‡ä»¶ï¼Œç»‘å®šå‡ ä½•ï¼ˆ.primitivesï¼‰ä¸æè´¨ï¼ˆshader/çº¹ç†ï¼‰ï¼Œå¹¶å®šä¹‰æ¸²æŸ“é›†ã€åŒ…å›´ä½“ã€èŠ‚ç‚¹å¼•ç”¨ã€‚
- **å®¹å™¨:** å¤šæ•°ç‰ˆæœ¬é‡‡ç”¨ PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼‰ï¼›éƒ¨åˆ†å·¥å…·é“¾å¯è¯»å†™ XML æºæ ¼å¼ä¸ PackedSection æ‰“åŒ…ç‰ˆæœ¬å¹¶å­˜ã€‚

### ä¸»è¦ç»“æ„ä¸å­—æ®µï¼ˆæŒ‰å¸¸è§å®ç°å¯¹é½ï¼‰
- **renderSet[]:**
  - **geometry:** å¼•ç”¨ `.primitives` è·¯å¾„ï¼ˆç›¸å¯¹èµ„æºæ ¹ï¼‰ï¼Œä¸€ä¸ª renderSet é€šå¸¸å¯¹åº”ä¸€ä¸ª primitives æ–‡ä»¶ã€‚
  - **primitiveGroup[]:** ç”¨äºæŠŠ .visual çš„æè´¨æ§½ä¸ .primitives çš„å­ç½‘æ ¼å¯¹åº”èµ·æ¥ï¼ˆæŒ‰ group ç´¢å¼•æˆ–èŒƒå›´ï¼‰ã€‚
  - **material(s):** ç»‘å®š shader/fx ä¸çº¹ç†é›†ï¼›å«æŠ€æœ¯/é€šé“ï¼ˆtechnique/passï¼‰ã€å®/Flagã€çº¹ç†è·¯å¾„ï¼ˆdiffuse/normal/spec ç­‰ï¼‰ã€‚
- **boundingBox / boundingSphere:**
  - **boundingBox:** min/max ä¸‰ç»´å‘é‡ã€‚
  - **boundingSphere:** center/radiusã€‚
- **node[]ï¼ˆå¯é€‰ï¼‰:**
  - **bones/nodes:** è‹¥ä¸ºè’™çš®æ¨¡å‹åˆ™åŒ…å«èŠ‚ç‚¹åã€å±‚çº§å…³ç³»æˆ–ç´¢å¼•æ˜ å°„ï¼Œç”¨äº .animation ç»‘å®šã€‚
- **drawFlagsï¼ˆå¯é€‰ï¼‰:** åŒé¢ã€é€æ˜ã€æ¥æ”¶é˜´å½±ã€æŠ•å°„é˜´å½±ç­‰æ¸²æŸ“æ ‡å¿—ä½ã€‚

### å†™å…¥é¡ºåºï¼ˆå»ºè®®å¯¹é½ï¼‰
1. **Header:** PackedSection header ä¸ string tableã€‚
2. **renderSet[]:** é€é¡¹å†™ geometry â†’ primitiveGroup[] â†’ material(s)ã€‚
3. **bounds:** boundingBox â†’ boundingSphereã€‚
4. **nodesï¼ˆå¯é€‰ï¼‰:** éª¨éª¼èŠ‚ç‚¹æˆ–é™„åŠ èŠ‚ç‚¹ã€‚
5. **flagsï¼ˆå¯é€‰ï¼‰:** æ¸²æŸ“æ ‡å¿—ä½ã€LOD æ˜ å°„ã€åŠ¨æ€é®ç½©ã€‚

### Blender å¯¼å‡ºæ˜ å°„
- **geometry:** ä»å¯¹è±¡æˆ–é›†åˆçº§é…ç½®æ‹¿åˆ° .primitives è¾“å‡ºè·¯å¾„ï¼›å†™å…¥ç›¸å¯¹è·¯å¾„ã€‚
- **primitiveGroup ç»‘å®š:** å°† Blender ä¸­æŒ‰æè´¨æˆ–å¯¹è±¡åˆ’åˆ†çš„ groups æ˜ å°„åˆ° .visual çš„ group ç´¢å¼•ï¼›é¡ºåºä¸ .primitives çš„ PrimitiveGroup ä¿æŒä¸€è‡´ã€‚
- **material:** æå– Blender æè´¨æ§½çš„æ ¸å¿ƒå‚æ•°ï¼ˆé¢œè‰²ã€PBR è´´å›¾è·¯å¾„ã€æ³•çº¿å¼ºåº¦ç­‰ï¼‰ï¼Œè½¬ä¸º shader/fx ä¸çº¹ç†å¼•ç”¨ï¼›ä¿ç•™çº¹ç†ç›¸å¯¹è·¯å¾„ä¸èµ„æºæ ¹çº¦å®šã€‚
- **bounds:** ä»ç½‘æ ¼å®æ—¶è®¡ç®— AABB ä¸å¤–æ¥çƒï¼›å•ä½ä¸åæ ‡ç³»å¯¹é½ï¼ˆZ-upâ†’Y-upï¼‰ã€‚
- **nodes:** è‹¥ä½¿ç”¨ Armatureï¼Œå†™å…¥éª¨éª¼åç§°åˆ—è¡¨ä¸å±‚çº§ï¼›ä¸ .model/.animation çš„ skeleton å¼•ç”¨ä¸€è‡´ã€‚

### æ ¡éªŒä¸å¯¹é½
- **è·¯å¾„ä¸€è‡´æ€§:** .visual â†’ .primitives çš„ç›¸å¯¹è·¯å¾„å¿…é¡»æœ‰æ•ˆï¼›CI æ ¡éªŒå­˜åœ¨æ€§ã€‚
- **group å¯¹é½:** primitiveGroup ç´¢å¼•ä¸ .primitives çš„ç»„æ•°é‡ä¸€è‡´ï¼›è¶Šç•ŒæŠ¥é”™ã€‚
- **æè´¨å®Œæ•´æ€§:** shader/fx ä¸çº¹ç†è·¯å¾„å¿…é¡»æœ‰æ•ˆï¼›ç¼ºå¤±æ—¶å†™å®¡è®¡è­¦å‘Šã€‚
- **bounds æ­£ç¡®æ€§:** åŒ…å›´ä½“è¦†ç›–å…¨éƒ¨é¡¶ç‚¹ï¼›ç©ºæˆ–è´Ÿå°ºå¯¸æŠ¥é”™ã€‚

### è¾¹ç•Œä¸å…¼å®¹
- **å¤š renderSet:** æ”¯æŒå¤šå‡ ä½•ä¸å¤šæè´¨é›†ï¼›æŒ‰æ¸²æŸ“å±‚æ¬¡æ‹†åˆ†ã€‚
- **æ³•çº¿è´´å›¾:** è‹¥æè´¨æ ‡è®°éœ€è¦åˆ‡çº¿ç©ºé—´ï¼Œåˆ™ .primitives é¡¶ç‚¹æ ¼å¼å¿…é¡»å«åˆ‡çº¿/å‰¯åˆ‡çº¿ã€‚
- **PackedSection/XML:** è‹¥å›¢é˜Ÿé‡‡ç”¨æ‰“åŒ…ç‰ˆæœ¬ï¼Œç¡®ä¿å­—ç¬¦ä¸²è¡¨ä¸åç§»ç´¢å¼•ä¸€è‡´ï¼›XML ç‰ˆæœ¬ä»…ç”¨äºè°ƒè¯•æˆ–ä¸­é—´äº§ç‰©ã€‚

---

## .model æ–‡ä»¶ï¼ˆé«˜å±‚ç»„åˆä¸è¡Œä¸ºè£…é…ï¼‰

### æ–‡ä»¶è§’è‰²ä¸å®¹å™¨
- **å®šä½:** å®ä¾‹åŒ–å¯¹è±¡çš„é«˜å±‚ç»„åˆæ–‡ä»¶ï¼Œå¼•ç”¨ .visualã€.primitivesã€.animationã€skeletonï¼Œå¹¶å®šä¹‰åŠ¨ä½œã€æŸ“è‰²ã€æ‰©å±•è¡Œä¸ºã€‚
- **å®¹å™¨:** XML æˆ– PackedSectionï¼›æœ€ç»ˆäº¤ä»˜é€šå¸¸ä¸º PackedSectionã€‚

### ä¸»è¦ç»“æ„ä¸å­—æ®µï¼ˆæŒ‰å¸¸è§å®ç°å¯¹é½ï¼‰
- **parentï¼ˆå¯é€‰ï¼‰:** çˆ¶æ¨¡å‹è·¯å¾„ï¼›æ”¯æŒç»§æ‰¿ï¼ˆè¦†å†™ visualã€dyeã€action ç­‰ï¼‰ã€‚
- **extent / boundingBox:** æ¨¡å‹ç©ºé—´èŒƒå›´ï¼›ä¸ .visual ä¿æŒä¸€è‡´æˆ–è¦†ç›–ï¼ˆå½“æ¨¡å‹ç»„åˆæ—¶ï¼‰ã€‚
- **visual:** èµ„æºè·¯å¾„ï¼ŒæŒ‡å‘ `.visual`ã€‚
- **skeletonï¼ˆå¯é€‰ï¼‰:** éª¨éª¼èµ„æºè·¯å¾„ï¼›è‹¥ä¸ºé™æ€ç‰©ä»¶å¯çœç•¥ã€‚
- **animation[]:**
  - **name:** åŠ¨ç”»åï¼ˆé€»è¾‘åæˆ–èµ„æºåï¼‰ã€‚
  - **resource:** `.animation` è·¯å¾„ã€‚
  - **channelMask / blendWeightï¼ˆå¯é€‰ï¼‰:** é€šé“è¿‡æ»¤ä¸æ··åˆæƒé‡ã€‚
- **action[]:**
  - **name / trigger:** è¡Œä¸ºåä¸è§¦å‘æ¡ä»¶ï¼ˆè„šæœ¬æˆ–å¼•æ“æ ‡è¯†ï¼‰ã€‚
  - **animationRef:** å¼•ç”¨ç»‘å®šçš„åŠ¨ç”»ã€‚
  - **blendParams / speed / loop:** åŠ¨ä½œå‚æ•°ã€‚
- **dye/tint:**
  - **material slot æŒ‡å®š:** æŒ‰æ¸²æŸ“é›†æˆ–æè´¨ ID è¦†ç›–æè´¨æˆ–çº¹ç†ã€‚
  - **tint å‚æ•°:** é¢œè‰²ã€çº¹ç†æ›¿æ¢åˆ—è¡¨ã€‚
- **lod / impostorï¼ˆå¯é€‰ï¼‰:** LOD ç­–ç•¥ä¸æ›¿èº«å›¾é…ç½®ã€‚
- **attachmentsï¼ˆå¯é€‰ï¼‰:** å­æ¨¡å‹æŒ‚ç‚¹ä¸é™„ç€è§„åˆ™ã€‚

### å†™å…¥é¡ºåºï¼ˆå»ºè®®å¯¹é½ï¼‰
1. **Header:** PackedSection headerã€‚
2. **parent / extent / boundingBoxã€‚**
3. **visualã€‚**
4. **skeletonï¼ˆå¯é€‰ï¼‰ã€‚**
5. **animation[] â†’ action[]ã€‚**
6. **dye/tintã€‚**
7. **lod / impostor / attachmentsï¼ˆå¯é€‰ï¼‰ã€‚**

### Blender å¯¼å‡ºæ˜ å°„
- **visual å¼•ç”¨:** ä»åŒé¡¹ç›®å¯¼å‡ºäº§ç‰©å†™å…¥ .visual ç›¸å¯¹è·¯å¾„ã€‚
- **skeleton:** è‹¥ Armature å­˜åœ¨ï¼Œå†™ skeleton èµ„æºï¼›ç¡®ä¿éª¨éª¼å‘½åä¸ .visual çš„ nodes å¯¹é½ã€‚
- **animation/action:** å°† Blender NLA/Action æ˜ å°„ä¸º .animation èµ„æºä¸ .model çš„ action å®šä¹‰ï¼›æ‰“å¹³æ—¶é•¿ã€å¾ªç¯ã€é€Ÿåº¦ã€æ··åˆã€‚
- **dye/tint:** å…è®¸å¯¹è±¡çº§æè´¨è¦†ç›–æ˜ å°„ï¼ˆæè´¨æ§½â†’èµ„æºè·¯å¾„æ›¿æ¢ï¼‰ï¼›ä¿å­˜æˆ `.model` çš„æŸ“è‰²é…ç½®ã€‚
- **bounds:** è‹¥ç»„åˆå¤šä¸ª visual æˆ–ç”Ÿæˆä½“ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ•´ä½“åŒ…å›´ä½“ã€‚

### æ ¡éªŒä¸å¯¹é½
- **èµ„æºé—­ç¯:** .model å¼•ç”¨çš„ .visual/.animation/.skeleton å‡å­˜åœ¨ï¼›CI æ ¡éªŒä¸ manifest è®°å½•ã€‚
- **éª¨éª¼ä¸€è‡´:** skeleton ä¸ .visual çš„éª¨éª¼èŠ‚ç‚¹ä¸€è‡´ï¼›ç¼ºå¤±èŠ‚ç‚¹æŠ¥é”™ã€‚
- **åŠ¨ä½œç»‘å®š:** action å¼•ç”¨çš„åŠ¨ç”»å¿…é¡»æœ‰æ•ˆï¼›å‚æ•°åˆæ³•èŒƒå›´ï¼ˆspeed>0ã€blendWeightâˆˆ[0,1]ï¼‰ã€‚
- **dye ä½œç”¨åŸŸ:** æŒ‡å®šçš„æè´¨æ§½å­˜åœ¨ï¼›ä¸å­˜åœ¨æ—¶æŠ¥å®¡è®¡è­¦å‘Šã€‚

### è¾¹ç•Œä¸å…¼å®¹
- **ç»§æ‰¿é“¾:** parent æ”¯æŒå±‚çº§ç»§æ‰¿ï¼›ç¡®ä¿æœ€ç»ˆè§£ææ—¶çš„ effective é…ç½®æ— å†²çªã€‚
- **PackedSection/XML:** ç”Ÿäº§äº¤ä»˜ä¼˜å…ˆä½¿ç”¨ PackedSectionï¼›XML ç”¨äºäººç±»å¯è¯»ä¸å›å½’æµ‹è¯•ã€‚

---

## .animation æ–‡ä»¶ï¼ˆéª¨éª¼åŠ¨ç”»å…³é”®å¸§ï¼‰

### æ–‡ä»¶è§’è‰²ä¸å®¹å™¨
- **å®šä½:** å­˜å‚¨éª¨éª¼åŠ¨ç”»çš„å…³é”®å¸§åºåˆ—ï¼Œä¾› .model çš„ animation/action å¼•ç”¨ã€‚
- **å®¹å™¨:** PackedSectionï¼ˆå¸¸è§ï¼‰ï¼›å¯æ”¯æŒå‹ç¼©æ•°æ®æ®µã€‚

### ä¸»è¦ç»“æ„ä¸å­—æ®µï¼ˆæŒ‰å¸¸è§å®ç°å¯¹é½ï¼‰
- **name:** åŠ¨ç”»åï¼ˆèµ„æºåæˆ–é€»è¾‘åï¼‰ã€‚
- **skeletonRef:** ç»‘å®šçš„éª¨éª¼èµ„æºï¼›éœ€ä¸ .model/.visual çš„ skeleton å¯¹é½ã€‚
- **duration:** åŠ¨ç”»æ€»æ—¶é•¿ï¼ˆç§’ï¼‰ã€‚
- **frameRateï¼ˆå¯é€‰ï¼‰:** é‡‡æ ·é¢‘ç‡æˆ–å…³é”®å¸§æ—¶é—´å•ä½ã€‚
- **channel[]ï¼ˆæŒ‰éª¨éª¼èŠ‚ç‚¹ï¼‰:**
  - **boneName / boneIndex:** èŠ‚ç‚¹æ ‡è¯†ã€‚
  - **positionKeys:** æ—¶é—´æˆ³+ä¸‰ç»´å‘é‡ã€‚
  - **rotationKeys:** æ—¶é—´æˆ³+å››å…ƒæ•°ï¼ˆå½’ä¸€åŒ–ï¼‰ã€‚
  - **scaleKeys:** æ—¶é—´æˆ³+ä¸‰ç»´å‘é‡ï¼ˆå¯é€‰ï¼‰ã€‚
- **compressionï¼ˆå¯é€‰ï¼‰:** æ˜¯å¦å¯ç”¨å…³é”®å¸§å‹ç¼©ã€è¯¯å·®é˜ˆå€¼ã€é‡åŒ–ç­–ç•¥ã€‚
- **events / markersï¼ˆå¯é€‰ï¼‰:** æ—¶é—´ç‚¹äº‹ä»¶æ ‡è®°ï¼ˆå‘½ä¸­ã€è„šæ­¥å£°ç­‰ï¼‰ã€‚

### å†™å…¥é¡ºåºï¼ˆå»ºè®®å¯¹é½ï¼‰
1. **Header:** PackedSection headerã€‚
2. **name / skeletonRef / duration / frameRateã€‚**
3. **channel[]:** æŒ‰éª¨éª¼æ‹“æ‰‘æˆ–åç§°é¡ºåºå†™å…¥ï¼ŒåŒ…å« position/rotation/scale ä¸‰é€šé“ã€‚
4. **compression / eventsï¼ˆå¯é€‰ï¼‰ã€‚**

### Blender å¯¼å‡ºæ˜ å°„
- **éª¨éª¼ä¸é€šé“é‡‡æ ·:** ä» Armature ä¸ Action/NLA è½¨é“é‡‡æ ·æ¯æ ¹éª¨éª¼çš„ä½å§¿åºåˆ—ï¼›å°† Blender çš„å±€éƒ¨/ä¸–ç•Œç©ºé—´è½¬æ¢ä¸ºå¼•æ“é¢„æœŸçš„éª¨æ¶ç©ºé—´ï¼ˆåæ ‡ç³» Z-upâ†’Y-upã€æ—‹è½¬çº¦å®šï¼‰ã€‚
- **æ—¶é—´ä¸ç²¾åº¦:** å½’ä¸€åŒ–å…³é”®å¸§æ—¶é—´åˆ°ç§’ï¼›é€‰æ‹©é‡‡æ ·é¢‘ç‡æˆ–æŒ‰åŠ¨ä½œå…³é”®å¸§åŸå§‹æ—¶é—´å†™å…¥ï¼›æ”¯æŒé—¨é™åˆå¹¶ï¼ˆç§»é™¤æè¿‘ä¼¼å…³é”®å¸§ï¼‰ã€‚
- **rotation:** ä½¿ç”¨å››å…ƒæ•°å¹¶ç¡®ä¿å½’ä¸€åŒ–ï¼›é¿å…ä¸‡å‘èŠ‚é—®é¢˜ã€‚
- **å‹ç¼©ç­–ç•¥:** å¯é€‰å¯ç”¨é‡åŒ–æˆ–é˜ˆå€¼å‹ç¼©ï¼›ä¸å¼•æ“ç«¯è§£ç å…¼å®¹ä¸ºå‰æã€‚

### æ ¡éªŒä¸å¯¹é½
- **éª¨éª¼ä¸€è‡´:** channel çš„ boneName å¿…é¡»å­˜åœ¨äº skeletonï¼›ç¼ºå¤±æŠ¥é”™ã€‚
- **å…³é”®å¸§å•è°ƒ:** æ—¶é—´æˆ³ä¸¥æ ¼é€’å¢ï¼›é‡å¤æˆ–å€’åºæŠ¥é”™ã€‚
- **æ—‹è½¬å½’ä¸€åŒ–:** æ‰€æœ‰å››å…ƒæ•°å•ä½åŒ–ï¼›åå·®è¶…é˜ˆå€¼æŠ¥å®¡è®¡è­¦å‘Šã€‚
- **äº‹ä»¶è¾¹ç•Œ:** events è½äº [0, duration] ä¹‹é—´ã€‚

### è¾¹ç•Œä¸å…¼å®¹
- **éå‡åŒ€é‡‡æ ·:** æ”¯æŒç¨€ç–å…³é”®å¸§ï¼›å¼•æ“ç«¯åšæ’å€¼ã€‚
- **æ··åˆåŠ¨ç”»:** .model çš„ action å¯åŒæ—¶å¼•ç”¨å¤šä¸ªåŠ¨ç”»ï¼›æƒé‡ä¸å åŠ ç­–ç•¥ç”± .model æ§åˆ¶ã€‚
- **å‹ç¼©ä¸ç²¾åº¦:** åœ¨ç§»åŠ¨ç«¯æˆ–å¤æ‚è§’è‰²ä¸Šä¼˜å…ˆå¯ç”¨å‹ç¼©ä»¥å‡å°åŒ…ä½“ï¼›ä¸å¼•æ“ç«¯ç‰ˆæœ¬å¯¹é½ã€‚

---

## ç«¯åˆ°ç«¯å¯¼å‡ºä¸éªŒè¯é—­ç¯ï¼ˆBlender â†’ BigWorldï¼‰

### å¯¼å‡ºé¡ºåºï¼ˆæ¨èï¼‰
1. **.primitives:** å†™å‡ ä½•äºŒè¿›åˆ¶ï¼ˆå·²å¯¹é½ï¼‰ã€‚
2. **.visual:** ç»‘å®š .primitives ä¸æè´¨ã€å†™åŒ…å›´ä½“ä¸èŠ‚ç‚¹ã€‚
3. **.animation:** å†™éª¨éª¼åŠ¨ç”»å…³é”®å¸§ï¼ˆå¦‚æœ‰ï¼‰ã€‚
4. **.model:** ç»„åˆ visualã€skeletonã€animation ä¸ actionï¼›å†™æŸ“è‰²ä¸æ‰©å±•ã€‚

### äº‹åŠ¡ä¸æ¸…å•
- **äº‹åŠ¡å†™å…¥:** ä¸´æ—¶è·¯å¾„ â†’ æ ¡éªŒé€šè¿‡ â†’ æäº¤ï¼›å¤±è´¥å›æ»šå¹¶å†™å®¡è®¡æ—¥å¿—ã€‚
- **manifest:** è®°å½•æ¯ä¸ªäº§ç‰©çš„ç›¸å¯¹è·¯å¾„ã€hashã€å°ºå¯¸ã€æ—¶é—´æˆ³ä¸ä¾èµ–å…³ç³»ï¼ˆ.modelâ†’.visualâ†’.primitives/.animationï¼‰ã€‚

### éªŒè¯
- **ä¸€è‡´æ€§:** å¼•æ“å·¥å…·ï¼ˆModelEditor/WorldEditorï¼‰èƒ½åŠ è½½å¹¶æ¸²æŸ“ï¼›è„šæœ¬æ£€æŸ¥è·¯å¾„ä¸ group å¯¹é½ã€‚
- **hex diff:** ä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”ï¼ˆé€‚ç”¨ .primitives ä¸ PackedSection çš„æ‰“åŒ…ç»“æ„ï¼‰ã€‚
- **schema æ ¡éªŒ:** æŒ‰å›¢é˜Ÿçº¦å®šçš„ schema_reference æ ¡éªŒå­—æ®µèŒƒå›´ä¸å¿…å¡«é¡¹ã€‚

---

## å®æ–½æ³¨æ„ä¸ä¼˜å…ˆçº§

- **æºç ä¸ºå‡†:** å½“æ—§æ–‡æ¡£ä¸ 14.4.1 æºç æœ‰å·®å¼‚ï¼Œä»¥æºç ç»“æ„ä¸å®é™…è¯»å†™é€»è¾‘ä¸ºæœ€ç»ˆæ ‡å‡†ã€‚
- **æ¨¡å—åŒ– writer:** ä¸ºæ¯ä¸ªæ–‡ä»¶ç±»å‹å»ºç«‹ç‹¬ç«‹ writerï¼Œè¾“å…¥ä¸ºæ ‡å‡†åŒ–æ•°æ®ç»“æ„ï¼ˆdataclassï¼‰ï¼Œè¾“å‡ºä¸ºç›¸åº”å®¹å™¨ï¼ˆPackedSection/BinSectionï¼‰ã€‚
- **åæ ‡ç³»ä¸å•ä½:** å…¨é“¾è·¯ç»Ÿä¸€è½¬æ¢ï¼ˆZ-upâ†’Y-upï¼›å•ä½â†’ç±³ï¼‰ï¼›ç¡®ä¿ .primitives/.visual/.animation ä¸€è‡´ã€‚
- **æè´¨ç­–ç•¥:** å…ˆå®ç°æ ¸å¿ƒé€šé“ï¼ˆæ¼«åå°„/æ³•çº¿/é«˜å…‰ï¼‰ä¸åŸºæœ¬ shader/fxï¼›å¤æ‚æè´¨æ‰©å±•é€æ­¥å¼•å…¥ã€‚

---


---

# ğŸ—‚ï¸ PackedSection æ–‡ä»¶æ ¼å¼ï¼ˆæºç +æ–‡æ¡£å¯¹é½ï¼‰

## 1. æ–‡ä»¶æ•´ä½“ç»“æ„
```
<packed_section> ::= <magic_number> <version> <string_table> <data_section>
```

- **magic_number**ï¼šå›ºå®šå€¼ `0x62A14E45`ï¼ˆ4 å­—èŠ‚ï¼‰ã€æ ‡è¯† PackedSection æ–‡ä»¶ã€‘  
- **version**ï¼šint8ï¼ˆé€šå¸¸ä¸º 1ï¼‰  
- **string_table**ï¼šä¸€ç»„ä»¥ `\0` ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œæœ€åä»¥ç©ºå­—ç¬¦ä¸²ç»“æŸ  
- **data_section**ï¼šåŒ…å«å­èŠ‚ç‚¹æ•°é‡ã€æ•°æ®åç§»è¡¨ã€å­èŠ‚ç‚¹è®°å½•ã€äºŒè¿›åˆ¶æ•°æ®  

---

## 2. string_table
- å­˜æ”¾æ‰€æœ‰ keyï¼ˆå­—æ®µåï¼‰å­—ç¬¦ä¸²ï¼Œé¿å…é‡å¤å­˜å‚¨ã€‚  
- åœ¨ `<child_record>` ä¸­é€šè¿‡ **ç´¢å¼•**å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å­˜å‚¨å­—ç¬¦ä¸²ã€‚  
- **ç´¢å¼•ä» 0 å¼€å§‹**ã€‚  

---

## 3. data_section
```
<data_section> ::= <num_children> <data_pos> <child_record>* <bin_data>
```

- **num_children**ï¼šintï¼Œå­èŠ‚ç‚¹æ•°é‡  
- **data_pos**ï¼šint32ï¼ŒæŒ‡å‘æ•°æ®å—çš„åç§»ï¼ˆç›¸å¯¹æœ¬ section çš„ bin_data èµ·å§‹ä½ç½®ï¼‰  
- **child_record[]**ï¼šæ¯ä¸ªå­èŠ‚ç‚¹çš„ key ç´¢å¼•å’Œæ•°æ®åç§»  
- **bin_data**ï¼šå®é™…æ•°æ®ï¼ˆæœ¬èŠ‚ç‚¹æ•°æ® + å­èŠ‚ç‚¹æ•°æ®æ‹¼æ¥ï¼‰  

---

## 4. child_record
```
<child_record> ::= <key_pos> <data_pos>
```

- **key_pos**ï¼šint16ï¼ŒæŒ‡å‘ string_table çš„ç´¢å¼•  
- **data_pos**ï¼šint32ï¼ŒæŒ‡å‘è¯¥å­èŠ‚ç‚¹æ•°æ®åœ¨ bin_data ä¸­çš„åç§»  
- **æ•°æ®èŒƒå›´**ï¼šä»ä¸Šä¸€ä¸ª data_pos åˆ°å½“å‰ data_pos  

---

## 5. bin_data
- å­˜æ”¾å®é™…çš„å€¼ï¼ˆintã€floatã€stringã€Vector3ã€Matrix ç­‰ï¼‰ã€‚  
- **æ•´æ•°æœ‰å‹ç¼©ä¼˜åŒ–**ï¼š  
  - å€¼ä¸º 0 â†’ ä¸å­˜å‚¨  
  - å€¼ fits in int8 â†’ å­˜ 1 å­—èŠ‚  
  - fits in int16 â†’ å­˜ 2 å­—èŠ‚  
  - å¦åˆ™å­˜ 4 å­—èŠ‚  

---

## 6. å†™å…¥é¡ºåºï¼ˆæºç é€»è¾‘ï¼‰
1. å†™ **magic_number**ã€**version**  
2. æ”¶é›†æ‰€æœ‰ key â†’ å†™å…¥ **string_table**  
3. å†™ **num_children**  
4. å†™ **data_pos[]**ï¼ˆå«ç±»å‹ä¿¡æ¯åœ¨é«˜ä½ï¼‰  
5. å†™ **child_record[]**ï¼ˆkey_pos + data_posï¼‰  
6. å†™ **bin_data**ï¼ˆæœ¬èŠ‚ç‚¹æ•°æ® + å­èŠ‚ç‚¹æ•°æ®ï¼‰  

---

# ğŸ› ï¸ Blender æ’ä»¶å®ç°æ€è·¯

### æ•°æ®ç»“æ„
```python
@dataclass
class PackedNode:
    key: str
    value: Any
    children: List["PackedNode"]
```

### Writer ä¼ªä»£ç 
```python
class PackedSectionWriter:
    def __init__(self, filepath):
        self.file = open(filepath, "wb")
        self.string_table = {}
        self.nodes = []

    def add_node(self, key, value=None, children=None):
        idx = self._add_string(key)
        self.nodes.append(PackedNode(key, value, children or []))

    def write(self):
        self._write_header()
        self._write_string_table()
        self._write_data_section(self.nodes)
        self.file.close()
```

---

# âœ… å°ç»“
- **PackedSection æ˜¯ .visual/.model/.animation çš„å®¹å™¨æ ¼å¼**ã€‚  
- å…³é”®ç‚¹ï¼š**string_tableï¼ˆå»é‡ keyï¼‰ã€child_recordï¼ˆç´¢å¼•+åç§»ï¼‰ã€bin_dataï¼ˆå®é™…å€¼ï¼‰**ã€‚  
- Blender æ’ä»¶å¿…é¡»å®ç° **PackedSectionWriter**ï¼Œæ‰èƒ½å¯¼å‡º `.visual/.model/.animation`ã€‚  

---

---

# ğŸ—‚ï¸ `.visual` æ–‡ä»¶è¯¦è§£ï¼ˆæºç +æ–‡æ¡£å¯¹é½ï¼‰

## 1. æ–‡ä»¶è§’è‰²
- **å®šä½**ï¼šæ¸²æŸ“æè¿°æ–‡ä»¶ï¼Œå‘Šè¯‰å¼•æ“å¦‚ä½•ä½¿ç”¨ `.primitives` ä¸­çš„å‡ ä½•æ•°æ®ã€‚  
- **å®¹å™¨**ï¼šé‡‡ç”¨ **PackedSection**ï¼ˆå³äºŒè¿›åˆ¶ XMLï¼‰ã€‚  
- **å¼•ç”¨å…³ç³»**ï¼šè¢« `.model` æ–‡ä»¶å¼•ç”¨ï¼Œç”¨äºç»„åˆå®Œæ•´è§’è‰²æˆ–ç‰©ä½“ã€‚  

---

## 2. é¡¶å±‚ç»“æ„
å…¸å‹ `.visual` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é¡¶å±‚èŠ‚ç‚¹ï¼š

- **renderSet[]**ï¼šæ¸²æŸ“é›†æ•°ç»„  
- **boundingBox / boundingSphere**ï¼šåŒ…å›´ä½“  
- **nodesï¼ˆå¯é€‰ï¼‰**ï¼šéª¨éª¼èŠ‚ç‚¹å¼•ç”¨  
- **flagsï¼ˆå¯é€‰ï¼‰**ï¼šæ¸²æŸ“æ ‡å¿—ä½ï¼ˆåŒé¢ã€é€æ˜ç­‰ï¼‰  

---

## 3. renderSet ç»“æ„
æ¯ä¸ª `renderSet` å®šä¹‰ä¸€ç»„å‡ ä½•ä¸æè´¨ç»‘å®šï¼š

- **geometry**ï¼šå¼•ç”¨ `.primitives` æ–‡ä»¶è·¯å¾„  
- **primitiveGroup[]**ï¼šå­ç½‘æ ¼ç»‘å®šï¼Œç´¢å¼•åˆ° `.primitives` çš„ group  
- **material(s)**ï¼šæè´¨æ§½ï¼ŒåŒ…å«ï¼š  
  - **fx**ï¼šshader/fx æ–‡ä»¶è·¯å¾„  
  - **texture[]**ï¼šçº¹ç†è·¯å¾„ï¼ˆdiffuseã€normalã€specular ç­‰ï¼‰  
  - **properties**ï¼šæè´¨å‚æ•°ï¼ˆé¢œè‰²ã€é€æ˜åº¦ã€flagsï¼‰  

ğŸ‘‰ **å…³é”®ç‚¹**ï¼š`primitiveGroup` çš„æ•°é‡ä¸ `.primitives` ä¸­çš„ PrimitiveGroup æ•°é‡å¿…é¡»ä¸€è‡´ã€‚  

---

## 4. åŒ…å›´ä½“
- **boundingBox**ï¼šmin/max ä¸‰ç»´å‘é‡  
- **boundingSphere**ï¼šcenter + radius  
ğŸ‘‰ ç”¨äºå¿«é€Ÿè£å‰ªä¸ç¢°æ’æ£€æµ‹ã€‚  

---

## 5. èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰
- **node[]**ï¼šéª¨éª¼èŠ‚ç‚¹å¼•ç”¨ï¼ˆè‹¥ä¸ºè’™çš®æ¨¡å‹ï¼‰ã€‚  
- æ¯ä¸ªèŠ‚ç‚¹åŒ…å« **name**ã€**transform**ï¼ˆçŸ©é˜µï¼‰ã€‚  
- ä¸ `.model` çš„ skeleton ä¿æŒä¸€è‡´ã€‚  

---

## 6. å†™å…¥é¡ºåºï¼ˆæºç é€»è¾‘ï¼‰
1. Headerï¼ˆPackedSection header + string_tableï¼‰  
2. renderSet[]  
   - geometry  
   - primitiveGroup[]  
   - material(s)  
3. boundingBox / boundingSphere  
4. node[]ï¼ˆå¯é€‰ï¼‰  
5. flagsï¼ˆå¯é€‰ï¼‰  

---

## 7. Blender æ’ä»¶è¿ç§»å®ç°
åœ¨ Blender æ’ä»¶ä¸­ï¼Œ`.visual` çš„å¯¼å‡ºé€»è¾‘åº”ä¸ºï¼š

```python
def write_visual(filepath, mesh, materials, bounds, nodes):
    psw = PackedSectionWriter(filepath)
    psw.add_node("renderSet", [
        {
            "geometry": mesh.primitives_path,
            "primitiveGroup": mesh.groups,
            "material": build_materials(materials)
        }
    ])
    psw.add_node("boundingBox", bounds.aabb)
    psw.add_node("boundingSphere", bounds.sphere)
    if nodes:
        psw.add_node("nodes", nodes)
    psw.write()
```

---

## 8. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸æ—§ç‰ˆ `.visual` å¯¹æ¯”ï¼Œç¡®è®¤å­—æ®µé¡ºåºä¸€è‡´ã€‚  
- **ModelEditor**ï¼šåŠ è½½ `.visual`ï¼Œæ£€æŸ¥æè´¨ç»‘å®šæ˜¯å¦æ­£ç¡®ã€‚  
- **Validator**ï¼šæ£€æŸ¥ `primitiveGroup` æ•°é‡ä¸ `.primitives` æ˜¯å¦ä¸€è‡´ã€‚  

---

# âœ… å°ç»“
- `.visual` æ˜¯ **PackedSection æ–‡ä»¶**ï¼Œæ ¸å¿ƒå­—æ®µæ˜¯ **renderSetã€geometryã€primitiveGroupã€materialã€bounds**ã€‚  
- å®ƒæ˜¯ `.model` çš„ç›´æ¥ä¾èµ–ï¼Œå¿…é¡»ä¸¥æ ¼å¯¹é½ `.primitives` çš„ group æ•°é‡ã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼Œéœ€å…ˆæœ‰ **PackedSectionWriter**ï¼Œå†å®ç° **VisualWriter**ã€‚  


---

# ğŸ—‚ï¸ `.model` æ–‡ä»¶è¯¦è§£ï¼ˆæºç +æ–‡æ¡£å¯¹é½ï¼‰

## 1. æ–‡ä»¶è§’è‰²
- **å®šä½**ï¼šè§’è‰²/ç‰©ä½“çš„ç»„åˆæ–‡ä»¶ï¼Œå®šä¹‰äº†å¤–è§‚ï¼ˆvisualï¼‰ã€éª¨éª¼ï¼ˆskeletonï¼‰ã€åŠ¨ç”»ï¼ˆanimationï¼‰ã€åŠ¨ä½œï¼ˆactionï¼‰ã€æè´¨æ›¿æ¢ï¼ˆdye/tintï¼‰ç­‰ã€‚  
- **å®¹å™¨**ï¼šXML æˆ– PackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼‰ã€‚æœ€ç»ˆäº¤ä»˜é€šå¸¸æ˜¯ PackedSectionã€‚  
- **å¼•ç”¨å…³ç³»**ï¼šè¢«æ¸¸æˆé€»è¾‘å’Œç¼–è¾‘å™¨ç›´æ¥åŠ è½½ï¼Œä½œä¸ºèµ„æºå…¥å£ã€‚  

---

## 2. é¡¶å±‚ç»“æ„
å…¸å‹ `.model` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é¡¶å±‚èŠ‚ç‚¹ï¼š

- **parentï¼ˆå¯é€‰ï¼‰**ï¼šçˆ¶æ¨¡å‹è·¯å¾„ï¼Œæ”¯æŒç»§æ‰¿ã€‚  
- **extent / boundingBox**ï¼šæ¨¡å‹èŒƒå›´ã€‚  
- **visual**ï¼šå¼•ç”¨ `.visual` æ–‡ä»¶ã€‚  
- **skeletonï¼ˆå¯é€‰ï¼‰**ï¼šéª¨éª¼æ–‡ä»¶å¼•ç”¨ã€‚  
- **animation[]**ï¼šåŠ¨ç”»åˆ—è¡¨ï¼Œå¼•ç”¨ `.animation` æ–‡ä»¶ã€‚  
- **action[]**ï¼šåŠ¨ä½œå®šä¹‰ï¼Œç»‘å®šåŠ¨ç”»ä¸è§¦å‘æ¡ä»¶ã€‚  
- **dye/tintï¼ˆå¯é€‰ï¼‰**ï¼šæè´¨æ›¿æ¢é…ç½®ã€‚  
- **lod / impostorï¼ˆå¯é€‰ï¼‰**ï¼šLOD ç­–ç•¥ä¸æ›¿èº«å›¾ã€‚  
- **attachmentsï¼ˆå¯é€‰ï¼‰**ï¼šå­æ¨¡å‹æŒ‚ç‚¹ã€‚  

---

## 3. animation[]
æ¯ä¸ªåŠ¨ç”»æ¡ç›®åŒ…å«ï¼š
- **name**ï¼šé€»è¾‘åã€‚  
- **resource**ï¼š`.animation` æ–‡ä»¶è·¯å¾„ã€‚  
- **channelMask / blendWeightï¼ˆå¯é€‰ï¼‰**ï¼šé€šé“è¿‡æ»¤ä¸æ··åˆå‚æ•°ã€‚  

---

## 4. action[]
æ¯ä¸ªåŠ¨ä½œæ¡ç›®åŒ…å«ï¼š
- **name / trigger**ï¼šåŠ¨ä½œåä¸è§¦å‘æ¡ä»¶ã€‚  
- **animationRef**ï¼šå¼•ç”¨çš„åŠ¨ç”»åã€‚  
- **blendParams / speed / loop**ï¼šåŠ¨ä½œå‚æ•°ã€‚  

---

## 5. dye/tint
- **dye**ï¼šæè´¨æ§½æ›¿æ¢ã€‚  
- **tint**ï¼šé¢œè‰²æˆ–çº¹ç†æ›¿æ¢ã€‚  
ğŸ‘‰ ç”¨äºè§’è‰²æ¢è£…ã€æŸ“è‰²ç³»ç»Ÿã€‚  

---

## 6. å†™å…¥é¡ºåºï¼ˆæºç é€»è¾‘ï¼‰
1. Headerï¼ˆPackedSection header + string_tableï¼‰  
2. parent / extent / boundingBox  
3. visual  
4. skeletonï¼ˆå¯é€‰ï¼‰  
5. animation[]  
6. action[]  
7. dye/tintï¼ˆå¯é€‰ï¼‰  
8. lod / impostor / attachmentsï¼ˆå¯é€‰ï¼‰  

---

## 7. Blender æ’ä»¶è¿ç§»å®ç°
åœ¨ Blender æ’ä»¶ä¸­ï¼Œ`.model` çš„å¯¼å‡ºé€»è¾‘åº”ä¸ºï¼š

```python
def write_model(filepath, visual_path, skeleton, animations, actions, dyes):
    psw = PackedSectionWriter(filepath)
    if parent:
        psw.add_node("parent", parent)
    psw.add_node("extent", bounds.extent)
    psw.add_node("boundingBox", bounds.aabb)
    psw.add_node("visual", visual_path)
    if skeleton:
        psw.add_node("skeleton", skeleton)
    for anim in animations:
        psw.add_node("animation", {
            "name": anim.name,
            "resource": anim.path
        })
    for act in actions:
        psw.add_node("action", {
            "name": act.name,
            "trigger": act.trigger,
            "animationRef": act.anim_name
        })
    if dyes:
        psw.add_node("dye", dyes)
    psw.write()
```

---

## 8. éªŒè¯é—­ç¯
- **èµ„æºé—­ç¯**ï¼š`.model` å¼•ç”¨çš„ `.visual`ã€`.animation`ã€skeleton å¿…é¡»å­˜åœ¨ã€‚  
- **éª¨éª¼ä¸€è‡´æ€§**ï¼šskeleton ä¸ `.visual` çš„éª¨éª¼èŠ‚ç‚¹ä¸€è‡´ã€‚  
- **åŠ¨ä½œç»‘å®š**ï¼šaction å¼•ç”¨çš„åŠ¨ç”»å¿…é¡»æœ‰æ•ˆã€‚  
- **æè´¨æ›¿æ¢**ï¼šdye/tint çš„æè´¨æ§½å¿…é¡»å­˜åœ¨ã€‚  

---

# âœ… å°ç»“
- `.model` æ˜¯ **é«˜å±‚ç»„åˆæ–‡ä»¶**ï¼Œæ ¸å¿ƒå­—æ®µæ˜¯ **visualã€skeletonã€animationã€actionã€dye/tint**ã€‚  
- å®ƒæ˜¯æ¸¸æˆåŠ è½½çš„å…¥å£ï¼Œå¿…é¡»ä¿è¯èµ„æºé—­ç¯ä¸å­—æ®µä¸€è‡´æ€§ã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼Œéœ€è¦å…ˆæœ‰ **PackedSectionWriter**ï¼Œå†å®ç° **ModelWriter**ã€‚  

---

---

# ğŸ—‚ï¸ `.animation` æ–‡ä»¶è¯¦è§£ï¼ˆæºç +æ–‡æ¡£å¯¹é½ï¼‰

## 1. æ–‡ä»¶è§’è‰²
- **å®šä½**ï¼šå­˜å‚¨éª¨éª¼åŠ¨ç”»çš„å…³é”®å¸§åºåˆ—ã€‚  
- **å®¹å™¨**ï¼šPackedSectionï¼ˆäºŒè¿›åˆ¶ XMLï¼‰ã€‚  
- **å¼•ç”¨å…³ç³»**ï¼šåœ¨ `.model` çš„ `<animation>` èŠ‚ç‚¹ä¸­è¢«å¼•ç”¨ã€‚  

---

## 2. é¡¶å±‚ç»“æ„
å…¸å‹ `.animation` æ–‡ä»¶åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- **name**ï¼šåŠ¨ç”»åç§°ï¼ˆé€»è¾‘åï¼‰ã€‚  
- **skeletonRef**ï¼šéª¨éª¼å¼•ç”¨ï¼Œéœ€ä¸ `.model` / `.visual` çš„ skeleton å¯¹é½ã€‚  
- **duration**ï¼šåŠ¨ç”»æ€»æ—¶é•¿ï¼ˆç§’ï¼‰ã€‚  
- **frameRateï¼ˆå¯é€‰ï¼‰**ï¼šé‡‡æ ·é¢‘ç‡ã€‚  
- **channel[]**ï¼šæ¯ä¸ªéª¨éª¼çš„å…³é”®å¸§åºåˆ—ã€‚  
- **compressionï¼ˆå¯é€‰ï¼‰**ï¼šæ˜¯å¦å¯ç”¨å‹ç¼©ã€‚  
- **events/markersï¼ˆå¯é€‰ï¼‰**ï¼šæ—¶é—´ç‚¹äº‹ä»¶ï¼ˆå¦‚è„šæ­¥å£°ï¼‰ã€‚  

---

## 3. channel ç»“æ„
æ¯ä¸ª channel å¯¹åº”ä¸€æ ¹éª¨éª¼ï¼š

- **boneName / boneIndex**ï¼šéª¨éª¼æ ‡è¯†ã€‚  
- **positionKeys[]**ï¼šæ—¶é—´æˆ³ + Vector3ã€‚  
- **rotationKeys[]**ï¼šæ—¶é—´æˆ³ + Quaternionã€‚  
- **scaleKeys[]ï¼ˆå¯é€‰ï¼‰**ï¼šæ—¶é—´æˆ³ + Vector3ã€‚  

ğŸ‘‰ **å…³é”®ç‚¹**ï¼šæ—¶é—´æˆ³å¿…é¡»ä¸¥æ ¼é€’å¢ï¼Œå››å…ƒæ•°å¿…é¡»å½’ä¸€åŒ–ã€‚  

---

## 4. å†™å…¥é¡ºåºï¼ˆæºç é€»è¾‘ï¼‰
1. Headerï¼ˆPackedSection header + string_tableï¼‰  
2. name / skeletonRef / duration / frameRate  
3. channel[]ï¼ˆé€éª¨éª¼å†™å…¥ï¼‰  
   - positionKeys  
   - rotationKeys  
   - scaleKeysï¼ˆå¯é€‰ï¼‰  
4. compression / eventsï¼ˆå¯é€‰ï¼‰  

---

## 5. Blender æ’ä»¶è¿ç§»å®ç°
åœ¨ Blender æ’ä»¶ä¸­ï¼Œ`.animation` çš„å¯¼å‡ºé€»è¾‘åº”ä¸ºï¼š

```python
def write_animation(filepath, armature, action):
    psw = PackedSectionWriter(filepath)
    psw.add_node("name", action.name)
    psw.add_node("skeletonRef", armature.name)
    psw.add_node("duration", action.frame_range[1] / bpy.context.scene.render.fps)
    channels = []
    for bone in armature.bones:
        ch = {"boneName": bone.name}
        ch["positionKeys"] = sample_position_keys(bone, action)
        ch["rotationKeys"] = sample_rotation_keys(bone, action)
        ch["scaleKeys"] = sample_scale_keys(bone, action)
        channels.append(ch)
    psw.add_node("channel", channels)
    psw.write()
```

---

## 6. éªŒè¯é—­ç¯
- **éª¨éª¼ä¸€è‡´æ€§**ï¼šchannel çš„ boneName å¿…é¡»å­˜åœ¨äº skeletonã€‚  
- **å…³é”®å¸§å•è°ƒæ€§**ï¼šæ—¶é—´æˆ³ä¸¥æ ¼é€’å¢ã€‚  
- **æ—‹è½¬å½’ä¸€åŒ–**ï¼šæ‰€æœ‰å››å…ƒæ•°å¿…é¡»å•ä½åŒ–ã€‚  
- **äº‹ä»¶èŒƒå›´**ï¼ševents å¿…é¡»è½åœ¨ [0, duration] å†…ã€‚  

---

# âœ… å°ç»“
- `.animation` æ˜¯ **PackedSection æ–‡ä»¶**ï¼Œæ ¸å¿ƒå­—æ®µæ˜¯ **nameã€skeletonRefã€durationã€channel[]**ã€‚  
- æ¯ä¸ª channel å­˜å‚¨éª¨éª¼çš„ **position/rotation/scale å…³é”®å¸§**ã€‚  
- Blender æ’ä»¶å®ç°æ—¶ï¼Œéœ€è¦é‡‡æ · Armature + Actionï¼Œè½¬æ¢ä¸ºå¼•æ“åæ ‡ç³»å¹¶å†™å…¥ PackedSectionã€‚  

---


# ğŸ—‚ï¸ BigWorld å¯¼å‡ºæµæ°´çº¿ï¼ˆBlender æ’ä»¶ç«¯åˆ°ç«¯ï¼‰

## 1. å¯¼å‡ºé¡ºåº
1. **é‡‡æ · Blender æ•°æ®**  
   - Mesh â†’ é¡¶ç‚¹ã€æ³•çº¿ã€UVã€é¢œè‰²ã€åˆ‡çº¿  
   - Armature â†’ éª¨éª¼å±‚çº§ã€éª¨éª¼çŸ©é˜µ  
   - Action/NLA â†’ åŠ¨ç”»å…³é”®å¸§  
   - æè´¨ â†’ shader/fxã€çº¹ç†è·¯å¾„ã€å‚æ•°  

2. **ç”Ÿæˆ .primitives**  
   - ä½¿ç”¨ **BinSectionWriter**  
   - å†™å…¥ Vertex Section â†’ Index Section â†’ PrimitiveGroup â†’ BSPï¼ˆå¯é€‰ï¼‰  
   - æ ¡éªŒ group æ•°é‡ã€ç´¢å¼•èŒƒå›´  

3. **ç”Ÿæˆ .visual**  
   - ä½¿ç”¨ **PackedSectionWriter**  
   - å†™å…¥ renderSet â†’ geometryï¼ˆæŒ‡å‘ .primitivesï¼‰â†’ material â†’ bounds  
   - æ ¡éªŒ primitiveGroup æ•°é‡ä¸ .primitives ä¸€è‡´  

4. **ç”Ÿæˆ .animation**ï¼ˆå¦‚æœ‰ï¼‰  
   - ä½¿ç”¨ **PackedSectionWriter**  
   - å†™å…¥ nameã€skeletonRefã€duration  
   - å†™å…¥ channel[]ï¼ˆposition/rotation/scale keysï¼‰  
   - æ ¡éªŒéª¨éª¼ä¸€è‡´æ€§ã€å…³é”®å¸§å•è°ƒæ€§  

5. **ç”Ÿæˆ .model**  
   - ä½¿ç”¨ **PackedSectionWriter**  
   - å†™å…¥ parentã€extentã€boundingBox  
   - å¼•ç”¨ visualã€skeleton  
   - å†™å…¥ animation[]ã€action[]  
   - å†™å…¥ dye/tintï¼ˆå¦‚æœ‰ï¼‰  

6. **å†™ manifest.json & audit.log**  
   - manifestï¼šè®°å½•äº§ç‰©è·¯å¾„ã€hashã€ä¾èµ–å…³ç³»  
   - audit.logï¼šè®°å½•é”™è¯¯ç ã€è­¦å‘Šã€å¯¼å‡ºæ—¶é—´  

---

## 2. Writer æ¨¡å—åˆ’åˆ†
- **core/bin_section_writer.py** â†’ å†™ `.primitives`  
- **core/packed_section_writer.py** â†’ å†™ `.visual/.model/.animation`  
- **writers/primitives_writer.py**  
- **writers/visual_writer.py**  
- **writers/model_writer.py**  
- **writers/animation_writer.py**  

---

## 3. éªŒè¯é—­ç¯
- **hex diff**ï¼šä¸æ—§ç‰ˆ 3ds Max æ’ä»¶äº§ç‰©é€å­—èŠ‚å¯¹æ¯”  
- **ModelEditor**ï¼šåŠ è½½ `.visual`ã€`.model`ï¼Œæ£€æŸ¥æ¸²æŸ“ä¸åŠ¨ç”»  
- **WorldEditor**ï¼šæ£€æŸ¥ BSP ç¢°æ’ã€LODã€é®æŒ¡å‰”é™¤  
- **CI æ ¡éªŒ**ï¼šschema æ ¡éªŒã€è·¯å¾„å­˜åœ¨æ€§ã€éª¨éª¼ä¸€è‡´æ€§  

---

## 4. è¿˜ç¼ºå°‘çš„æœ€åæ‹¼å›¾
- **PackedSectionWriter çš„å®Œæ•´å®ç°**ï¼ˆstring table + child record + bin_dataï¼‰  
- **æè´¨æ˜ å°„è¡¨**ï¼ˆBlender æè´¨ â†’ BigWorld shader/fx å‚æ•°ï¼‰  
- **éª¨éª¼å‘½åè§„åˆ™**ï¼ˆBlender Armature â†’ BigWorld skeletonï¼‰  
- **åŠ¨ç”»é‡‡æ ·ç­–ç•¥**ï¼ˆé‡‡æ ·é¢‘ç‡ã€å‹ç¼©é˜ˆå€¼ï¼‰  
- **manifest/audit çš„æºç ç¡®è®¤**ï¼ˆå­—æ®µåã€é”™è¯¯ç æšä¸¾ï¼‰  

---

# âœ… æ€»ç»“
æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†å®Œæ•´çš„ **å¯¼å‡ºè“å›¾**ï¼š  
- `.primitives` â†’ BinSection  
- `.visual/.model/.animation` â†’ PackedSection  
- manifest/audit â†’ å…ƒæ•°æ®ä¸æ—¥å¿—  
- éªŒè¯é—­ç¯ â†’ hex diff + ModelEditor/WorldEditor  

---

---

# ğŸ“‘ BigWorld å¯¼å‡ºæ–‡ä»¶ Schema Referenceï¼ˆåˆç¨¿æ¨¡æ¿ï¼‰

## 1. `.primitives`ï¼ˆBinSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| vertices          | float3[]    | âœ”    | -      | é¡¶ç‚¹åæ ‡æ•°ç»„ |
| normals           | float3[]    | âœ”    | -      | æ³•çº¿æ•°ç»„ |
| uvs               | float2[]    | âœ”    | -      | UV åæ ‡ |
| indices           | int[]       | âœ”    | -      | ç´¢å¼•æ•°ç»„ |
| primitiveGroup[]  | struct      | âœ”    | -      | å­ç½‘æ ¼åˆ†ç»„ï¼ˆèµ·å§‹ç´¢å¼•ã€æ•°é‡ã€æè´¨æ§½ï¼‰ |
| bspTree           | binary      | â—†    | ç©º     | BSP æ•°æ®ï¼ˆé™æ€åœºæ™¯ç”¨ï¼‰ |

---

## 2. `.visual`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| renderSet[]       | struct      | âœ”    | -      | æ¸²æŸ“é›†æ•°ç»„ |
| â”œâ”€ geometry       | string      | âœ”    | -      | å¼•ç”¨ `.primitives` æ–‡ä»¶ |
| â”œâ”€ primitiveGroup | int[]       | âœ”    | -      | å¯¹åº” `.primitives` çš„ group ç´¢å¼• |
| â”œâ”€ material       | struct      | âœ”    | -      | æè´¨ç»‘å®šï¼ˆfxã€çº¹ç†ã€å‚æ•°ï¼‰ |
| boundingBox       | float3[2]   | âœ”    | -      | AABB åŒ…å›´ç›’ |
| boundingSphere    | float4      | âœ”    | -      | çƒå¿ƒ + åŠå¾„ |
| nodes[]           | struct      | â—†    | ç©º     | éª¨éª¼èŠ‚ç‚¹å¼•ç”¨ |
| flags             | int         | â—†    | 0      | æ¸²æŸ“æ ‡å¿—ä½ï¼ˆåŒé¢ã€é€æ˜ç­‰ï¼‰ |

---

## 3. `.model`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| parent            | string      | â—†    | ç©º     | çˆ¶æ¨¡å‹è·¯å¾„ |
| visual            | string      | âœ”    | -      | å¼•ç”¨ `.visual` æ–‡ä»¶ |
| skeleton          | string      | â—†    | ç©º     | éª¨éª¼æ–‡ä»¶ |
| animation[]       | struct      | â—†    | ç©º     | åŠ¨ç”»å¼•ç”¨ï¼ˆname, resourceï¼‰ |
| action[]          | struct      | â—†    | ç©º     | åŠ¨ä½œå®šä¹‰ï¼ˆname, trigger, animRefï¼‰ |
| dye/tint          | struct      | â—†    | ç©º     | æè´¨æ›¿æ¢/æŸ“è‰² |
| lod/impostor      | struct      | â—†    | ç©º     | LOD ç­–ç•¥ä¸æ›¿èº«å›¾ |

---

## 4. `.animation`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| name              | string      | âœ”    | -      | åŠ¨ç”»åç§° |
| skeletonRef       | string      | âœ”    | -      | éª¨éª¼å¼•ç”¨ |
| duration          | float       | âœ”    | -      | åŠ¨ç”»æ—¶é•¿ï¼ˆç§’ï¼‰ |
| frameRate         | int         | â—†    | 30     | é‡‡æ ·é¢‘ç‡ |
| channel[]         | struct      | âœ”    | -      | éª¨éª¼é€šé“ |
| â”œâ”€ boneName       | string      | âœ”    | -      | éª¨éª¼å |
| â”œâ”€ positionKeys   | (time,vec3) | â—†    | ç©º     | å¹³ç§»å…³é”®å¸§ |
| â”œâ”€ rotationKeys   | (time,quat) | âœ”    | -      | æ—‹è½¬å…³é”®å¸§ |
| â”œâ”€ scaleKeys      | (time,vec3) | â—†    | ç©º     | ç¼©æ”¾å…³é”®å¸§ |
| compression       | bool        | â—†    | false  | æ˜¯å¦å‹ç¼© |
| events[]          | struct      | â—†    | ç©º     | åŠ¨ç”»äº‹ä»¶ï¼ˆæ—¶é—´æˆ³+æ ‡ç­¾ï¼‰ |

---

# âœ… æ€»ç»“
- **å¿…é¡»å®ç°å­—æ®µ**ï¼šä¿è¯å¯¼å‡ºé—­ç¯ï¼ˆå‡ ä½•ã€æè´¨ã€éª¨éª¼ã€åŠ¨ç”»å…³é”®å¸§ï¼‰ã€‚  
- **å ä½ä¿ç•™å­—æ®µ**ï¼šLODã€BSPã€dye/tintã€actionã€eventsã€compressionã€‚UI ä¿ç•™ä½†ç°æ‰ã€‚  
- **åˆ é™¤å­—æ®µ**ï¼šæ—§ç‰ˆ 3ds Max ä¸“ç”¨çš„ legacy å­—æ®µä¸å†éœ€è¦ã€‚  

---



---

# ğŸ“‘ UI â†’ dataclass â†’ æ–‡ä»¶å­—æ®µ æ˜ å°„è¡¨

| UI æ§ä»¶ (ç”¨æˆ·æ“ä½œ)                          | dataclass å­—æ®µ (æ’ä»¶å†…éƒ¨)       | æ–‡ä»¶å­—æ®µ (å¯¼å‡ºäº§ç‰©)            | æ–‡ä»¶ç±»å‹ |
|---------------------------------------------|---------------------------------|--------------------------------|----------|
| **å¯¼å‡ºæ ¹ç›®å½• (Preferences)**                | `ExportSettings.root_path`      | è¾“å‡ºè·¯å¾„ï¼ˆæ‰€æœ‰æ–‡ä»¶ï¼‰            | å…¨å±€     |
| **çº¹ç†æ ¹ç›®å½• (Preferences)**                | `ExportSettings.texture_path`   | material.texture è·¯å¾„           | .visual  |
| **åæ ‡ç³»è½¬æ¢ (Z-upâ†’Y-up)**                  | `ExportSettings.axis_mode`      | transform çŸ©é˜µ                  | .visual/.model |
| **å•ä½ (ç±³/å˜ç±³)**                          | `ExportSettings.unit_scale`     | é¡¶ç‚¹åæ ‡ç¼©æ”¾                    | .primitives |
| **å¯¹è±¡ç±»å‹ (é™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·/ç»„)**       | `ObjectSettings.type`           | model.type / collision.type     | .model/.collision |
| **èµ„æºID**                                  | `ObjectSettings.asset_id`       | model.resourceID                | .model   |
| **åˆ†ç»„ (building/character)**               | `ObjectSettings.group`          | manifest.group                  | manifest.json |
| **LOD å¯ç”¨/è§„åˆ™** â—†                         | `ObjectSettings.lod_rule`       | model.lod / visual.lod          | .model/.visual |
| **æè´¨æ§½ â†’ Shader FX è·¯å¾„**                 | `MaterialSlot.shader`           | material.fx                     | .visual  |
| **æè´¨æ§½ â†’ çº¹ç†è·¯å¾„ (BaseColor/Normal/ORM)**| `MaterialSlot.textures`         | material.texture[]              | .visual  |
| **æè´¨å‚æ•° (é¢œè‰²/é€æ˜åº¦/flags)**             | `MaterialSlot.params`           | material.properties             | .visual  |
| **å‹ç¼©æ ¼å¼ (DXT5/BC7/æ— )**                  | `MaterialSlot.compression`      | material.compression            | .visual  |
| **ç¡¬ç‚¹ (æ·»åŠ /ç±»å‹/æ ¡éªŒ)**                   | `ObjectSettings.hardpoints[]`   | model.node / visual.node        | .model/.visual |
| **åŠ¨ç”»è½¨é“åˆ—è¡¨ (UIList)**                   | `AnimationTrack[]`              | animation.channel[]             | .animation |
| **è½¨é“å‚æ•° (å¸§ç‡/å¾ªç¯)**                    | `AnimationTrack.sample_rate`    | animation.frameRate             | .animation |
| **è½¨é“æ ‡ç­¾ (IsCoordinated/IsImpacting) â—†**  | `AnimationTrack.flags`          | animation.events / tags         | .animation |
| **ç¢°æ’ä½“å‚æ•° (æ¥æº/å±‚) â—†**                  | `CollisionSettings`             | collision.mesh / collision.layer| .collision |
| **é—¨æˆ·å‚æ•° (ç©ºé—´ID/æ³•çº¿æ ¡éªŒ) â—†**            | `PortalSettings`                | portal.spaceID / portal.normal  | .model/.visual |
| **å¯¼å‡ºç±»å‹ (é™æ€/è§’è‰²/ç¢°æ’/é—¨æˆ·/ç»„)**       | `ExportJob.type`                | æ§åˆ¶ Writer è°ƒç”¨é¡ºåº             | å…¨å±€     |
| **ç”Ÿæˆæ–‡ä»¶é€‰é¡¹ (.primitives/.visual/â€¦ )**   | `ExportJob.outputs[]`           | è¾“å‡ºæ–‡ä»¶åˆ—è¡¨                     | å…¨å±€     |
| **manifest.json å¼€å…³**                      | `ExportJob.write_manifest`      | manifest.json                   | manifest |
| **audit.log å¼€å…³**                          | `ExportJob.write_audit`         | audit.log                       | audit    |
| **å¼€å§‹å¯¼å‡ºæŒ‰é’®**                            | `ExportOperator.execute()`      | è°ƒç”¨ Writers é¡ºåºæ‰§è¡Œ            | å…¨å±€     |

---

# ğŸ”‘ è¯´æ˜
- **âœ” å¿…é¡»å®ç°**ï¼šå¯¼å‡ºè·¯å¾„ã€å¯¹è±¡ç±»å‹ã€æè´¨æ§½ã€åŠ¨ç”»è½¨é“ã€å¯¼å‡ºæŒ‰é’®ã€‚  
- **â—† å ä½ä¿ç•™**ï¼šLODã€è½¨é“æ ‡ç­¾ã€ç¢°æ’ä½“ã€é—¨æˆ·å‚æ•°ã€‚UI ä¿ç•™ä½†ç°æ‰ã€‚  
- **æ–‡ä»¶å­—æ®µå¯¹é½**ï¼šæ¯ä¸ª UI æ§ä»¶æœ€ç»ˆéƒ½èƒ½è¿½æº¯åˆ° `.primitives/.visual/.model/.animation` çš„å…·ä½“å­—æ®µã€‚  

---

---

# ğŸ“Š BigWorld Blender æ’ä»¶å¯¼å‡ºæµç¨‹å›¾ï¼ˆå­—ç¬¦ç¤ºæ„ï¼‰

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æ“ä½œ UI æ§ä»¶            â”‚
â”‚  (æ’ä»¶åå¥½è®¾ç½® / å¯¹è±¡å±æ€§ / å¯¼å‡ºæ‰§è¡Œ) 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ æ”¶é›†å‚æ•°
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   dataclass æ•°æ®ç»“æ„          â”‚
â”‚  - ExportSettings             â”‚
â”‚  - ObjectSettings             â”‚
â”‚  - MaterialSlot               â”‚
â”‚  - AnimationTrack             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ ä¼ é€’é…ç½®
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ExportJob è°ƒåº¦å™¨            â”‚
â”‚  - ç¡®å®šå¯¼å‡ºç±»å‹                â”‚
â”‚  - ç”Ÿæˆä»»åŠ¡é˜Ÿåˆ—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ è°ƒç”¨ Writer
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Writers æ¨¡å—                â”‚
â”‚  - primitives_writer.py   (.primitives) âœ” å¿…é¡»å®ç°
â”‚  - visual_writer.py       (.visual)    âœ” å¿…é¡»å®ç°
â”‚  - model_writer.py        (.model)     âœ” å¿…é¡»å®ç°
â”‚  - animation_writer.py    (.animation) âœ” å¿…é¡»å®ç°
â”‚  - collision_writer.py    (.collision) â—† å ä½ä¿ç•™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ å†™å…¥æ–‡ä»¶
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ ¸å¿ƒå†™å…¥å™¨ Core             â”‚
â”‚  - BinSectionWriter  (.primitives) âœ”
â”‚  - PackedSectionWriter (.visual/.model/.animation) âœ”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ è¾“å‡ºäº§ç‰©
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¯¼å‡ºç»“æœæ–‡ä»¶                â”‚
â”‚  - .primitives                â”‚
â”‚  - .visual                    â”‚
â”‚  - .model                     â”‚
â”‚  - .animation                  â”‚
â”‚  - manifest.json               â”‚
â”‚  - audit.log                   â”‚
â”‚  - .collision (å ä½) â—†         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ”‘ è¯´æ˜
- **UI å±‚**ï¼šç”¨æˆ·é€šè¿‡æ’ä»¶åå¥½è®¾ç½®ã€å¯¹è±¡å±æ€§é¢æ¿ã€å¯¼å‡ºæ‰§è¡Œé¢æ¿é…ç½®å‚æ•°ã€‚  
- **dataclass å±‚**ï¼šæ‰€æœ‰ UI è¾“å…¥è¢«æ”¶é›†åˆ°ç»Ÿä¸€çš„æ•°æ®ç»“æ„ã€‚  
- **è°ƒåº¦å±‚**ï¼šExportJob æ ¹æ®å¯¹è±¡ç±»å‹å’Œå¯¼å‡ºé€‰é¡¹ï¼Œå†³å®šè°ƒç”¨å“ªäº› Writerã€‚  
- **Writer å±‚**ï¼šæ¯ä¸ª Writer è´Ÿè´£ä¸€ç§æ–‡ä»¶ç±»å‹ï¼Œå†…éƒ¨è°ƒç”¨æ ¸å¿ƒå†™å…¥å™¨ã€‚  
- **æ ¸å¿ƒå±‚**ï¼šBinSectionWriter / PackedSectionWriter è´Ÿè´£åº•å±‚äºŒè¿›åˆ¶å†™å…¥ã€‚  
- **äº§ç‰©å±‚**ï¼šæœ€ç»ˆç”Ÿæˆ BigWorld æ‰€éœ€çš„æ–‡ä»¶é›†ã€‚  

---

---

# ğŸ“Š BigWorld æ–‡ä»¶ä¾èµ–é¡ºåºå›¾ï¼ˆå­—ç¬¦ç¤ºæ„ï¼‰

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  .primitives  â”‚  â† é¡¶ç‚¹/ç´¢å¼•/UV/æ³•çº¿ç­‰å‡ ä½•æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ å¼•ç”¨ geometry
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    .visual    â”‚  â† æ¸²æŸ“é›†(renderSet)ã€æè´¨ç»‘å®šã€åŒ…å›´ç›’
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ å¼•ç”¨ visual
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    .model     â”‚  â† ç»„åˆï¼švisual + skeleton + animation
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ å¼•ç”¨ skeletonRef / animation
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  .animation   â”‚  â† éª¨éª¼é€šé“ã€å…³é”®å¸§ã€äº‹ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ”‘ ä¾èµ–è¯´æ˜
1. **.primitives**  
   - æœ€åº•å±‚æ–‡ä»¶ï¼Œå­˜å‚¨å‡ ä½•æ•°æ®ã€‚  
   - å¿…é¡»å…ˆç”Ÿæˆï¼Œä¾› `.visual` å¼•ç”¨ã€‚  

2. **.visual**  
   - å¼•ç”¨ `.primitives`ï¼Œå®šä¹‰æ¸²æŸ“é›†ã€æè´¨ã€åŒ…å›´ç›’ã€‚  
   - æ˜¯ `.model` çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚  

3. **.model**  
   - å¼•ç”¨ `.visual`ï¼Œå¹¶å¯å¼•ç”¨ `.skeleton` ä¸ `.animation`ã€‚  
   - è´Ÿè´£ç»„åˆèµ„æºï¼Œå½¢æˆå®Œæ•´å®ä½“ã€‚  

4. **.animation**  
   - ç‹¬ç«‹æ–‡ä»¶ï¼Œä½†é€šå¸¸ç”± `.model` å¼•ç”¨ã€‚  
   - å¿…é¡»åœ¨ `.model` ä¸­æ³¨å†Œæ‰èƒ½ç”Ÿæ•ˆã€‚  

---

# âœ… æ€»ç»“
- å¯¼å‡ºé¡ºåºå¿…é¡»æ˜¯ï¼š  
  **.primitives â†’ .visual â†’ .model â†’ .animation**  
- `.primitives` æ˜¯å‡ ä½•åŸºç¡€ï¼Œ`.visual` æ˜¯æ¸²æŸ“æè¿°ï¼Œ`.model` æ˜¯ç»„åˆå®¹å™¨ï¼Œ`.animation` æ˜¯åŠ¨ä½œæ•°æ®ã€‚  
- `.model` æ˜¯å…³é”®æ¢çº½ï¼Œè´Ÿè´£æŠŠå‡ ä½•ã€æè´¨ã€éª¨éª¼ã€åŠ¨ç”»æ•´åˆåˆ°ä¸€èµ·ã€‚  

---

---

# ğŸ“‘ BigWorld Schema Referenceï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰

## 1. `.primitives`ï¼ˆBinSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| vertices          | float3[]    | âœ”    | -      | é¡¶ç‚¹åæ ‡æ•°ç»„ |
| normals           | float3[]    | âœ”    | -      | æ³•çº¿æ•°ç»„ |
| tangents/binormals| float3[]    | â—†    | ç©º     | åˆ‡çº¿/å‰¯åˆ‡çº¿ï¼ˆæ³•çº¿è´´å›¾ç”¨ï¼‰ |
| uvs               | float2[]    | âœ”    | -      | UV åæ ‡ |
| colors            | float4[]    | â—†    | ç©º     | é¡¶ç‚¹é¢œè‰² |
| indices           | int[]       | âœ”    | -      | ç´¢å¼•æ•°ç»„ |
| primitiveGroup[]  | struct      | âœ”    | -      | å­ç½‘æ ¼åˆ†ç»„ï¼ˆèµ·å§‹ç´¢å¼•ã€æ•°é‡ã€æè´¨æ§½ï¼‰ |
| bspTree           | binary      | â—†    | ç©º     | BSP æ•°æ®ï¼ˆé™æ€åœºæ™¯ç”¨ï¼‰ |

---

## 2. `.visual`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| renderSet[]       | struct      | âœ”    | -      | æ¸²æŸ“é›†æ•°ç»„ |
| â”œâ”€ geometry       | string      | âœ”    | -      | å¼•ç”¨ `.primitives` æ–‡ä»¶ |
| â”œâ”€ primitiveGroup | int[]       | âœ”    | -      | å¯¹åº” `.primitives` çš„ group ç´¢å¼• |
| â”œâ”€ material       | struct      | âœ”    | -      | æè´¨ç»‘å®šï¼ˆfxã€çº¹ç†ã€å‚æ•°ï¼‰ |
| boundingBox       | float3[2]   | âœ”    | -      | AABB åŒ…å›´ç›’ |
| boundingSphere    | float4      | âœ”    | -      | çƒå¿ƒ + åŠå¾„ |
| nodes[]           | struct      | â—†    | ç©º     | éª¨éª¼èŠ‚ç‚¹å¼•ç”¨ |
| flags             | int         | â—†    | 0      | æ¸²æŸ“æ ‡å¿—ä½ï¼ˆåŒé¢ã€é€æ˜ç­‰ï¼‰ |
| dye/tint          | struct      | â—†    | ç©º     | æè´¨æ›¿æ¢/æŸ“è‰² |

---

## 3. `.model`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| parent            | string      | â—†    | ç©º     | çˆ¶æ¨¡å‹è·¯å¾„ |
| visual            | string      | âœ”    | -      | å¼•ç”¨ `.visual` æ–‡ä»¶ |
| skeleton          | string      | â—†    | ç©º     | éª¨éª¼æ–‡ä»¶ |
| animation[]       | struct      | â—†    | ç©º     | åŠ¨ç”»å¼•ç”¨ï¼ˆname, resourceï¼‰ |
| action[]          | struct      | â—†    | ç©º     | åŠ¨ä½œå®šä¹‰ï¼ˆname, trigger, animRefï¼‰ |
| extent            | float3      | âœ”    | -      | æ¨¡å‹èŒƒå›´ï¼ˆåŠé•¿å®½é«˜ï¼‰ |
| boundingBox       | float3[2]   | âœ”    | -      | AABB åŒ…å›´ç›’ |
| dye/tint          | struct      | â—†    | ç©º     | æè´¨æ›¿æ¢/æŸ“è‰² |
| lod/impostor      | struct      | â—†    | ç©º     | LOD ç­–ç•¥ä¸æ›¿èº«å›¾ |

---

## 4. `.animation`ï¼ˆPackedSectionï¼‰
| å­—æ®µå            | ç±»å‹        | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------------------|-------------|------|--------|------|
| name              | string      | âœ”    | -      | åŠ¨ç”»åç§° |
| skeletonRef       | string      | âœ”    | -      | éª¨éª¼å¼•ç”¨ |
| duration          | float       | âœ”    | -      | åŠ¨ç”»æ—¶é•¿ï¼ˆç§’ï¼‰ |
| frameRate         | int         | â—†    | 30     | é‡‡æ ·é¢‘ç‡ |
| channel[]         | struct      | âœ”    | -      | éª¨éª¼é€šé“ |
| â”œâ”€ boneName       | string      | âœ”    | -      | éª¨éª¼å |
| â”œâ”€ positionKeys   | (time,vec3) | â—†    | ç©º     | å¹³ç§»å…³é”®å¸§ |
| â”œâ”€ rotationKeys   | (time,quat) | âœ”    | -      | æ—‹è½¬å…³é”®å¸§ |
| â”œâ”€ scaleKeys      | (time,vec3) | â—†    | ç©º     | ç¼©æ”¾å…³é”®å¸§ |
| compression       | bool        | â—†    | false  | æ˜¯å¦å‹ç¼© |
| events[]          | struct      | â—†    | ç©º     | åŠ¨ç”»äº‹ä»¶ï¼ˆæ—¶é—´æˆ³+æ ‡ç­¾ï¼‰ |

---

# âœ… æ€»ç»“
- **å¿…é¡»å®ç°å­—æ®µ**ï¼šä¿è¯å¯¼å‡ºé—­ç¯ï¼ˆå‡ ä½•ã€æè´¨ã€éª¨éª¼ã€åŠ¨ç”»å…³é”®å¸§ã€åŒ…å›´ç›’ï¼‰ã€‚  
- **å ä½ä¿ç•™å­—æ®µ**ï¼šLODã€BSPã€dye/tintã€actionã€eventsã€compressionã€‚UI ä¿ç•™ä½†ç°æ‰ã€‚  
- **åˆ é™¤å­—æ®µ**ï¼šæ—§ç‰ˆ 3ds Max ä¸“ç”¨çš„ legacy å­—æ®µä¸å†éœ€è¦ã€‚  

---

