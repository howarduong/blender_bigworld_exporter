# ğŸ—ï¸ BigWorld Blender æ’ä»¶æ¶æ„é‡æ„æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v2.0  
**æ—¥æœŸ**: 2025-10-22  
**ç›®æ ‡**: åŸºäºæ–°UIè®¾è®¡è§„èŒƒï¼Œé‡æ„ç›®å½•ç»“æ„ï¼Œä¼˜åŒ–æ¨¡å—èŒè´£

---

## ğŸ“Š é‡æ„åŸåˆ™

1. **æŒ‰åŠŸèƒ½åˆ’åˆ†** - è€Œä¸æ˜¯æŒ‰æ–‡ä»¶ç±»å‹
2. **æ¸…æ™°çš„æ•°æ®æµ** - ä»UIâ†’æ•°æ®â†’æ–‡ä»¶çš„å•å‘æµåŠ¨
3. **æ¨¡å—ç‹¬ç«‹** - æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œä¾¿äºæµ‹è¯•
4. **ä¾¿äºæ‰©å±•** - é¢„ç•™æ‰©å±•ç‚¹ï¼Œä½†ä¸å®ç°å ä½åŠŸèƒ½

---

## ğŸ¯ æ–°ç›®å½•ç»“æ„è®¾è®¡

```
blender_bigworld_exporter/
â”‚
â”œâ”€â”€ __init__.py                          # æ’ä»¶å…¥å£ï¼ˆç®€åŒ–ï¼‰
â”‚
â”œâ”€â”€ config/                              # ğŸ“‹ é…ç½®ç®¡ç†ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ export_settings.py               # å¯¼å‡ºé…ç½®æ•°æ®ç±»
â”‚   â””â”€â”€ constants.py                     # å¸¸é‡å®šä¹‰ï¼ˆé­”æ•°ã€ç‰ˆæœ¬å·ç­‰ï¼‰
â”‚
â”œâ”€â”€ ui/                                  # ğŸ–¥ï¸ ç”¨æˆ·ç•Œé¢
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ preferences.py                   # åå¥½è®¾ç½®é¢æ¿ï¼ˆé‡æ„ï¼‰
â”‚   â”œâ”€â”€ object_properties.py             # å¯¹è±¡å±æ€§é¢æ¿ï¼ˆé‡æ„ï¼‰
â”‚   â”œâ”€â”€ export_operator.py               # å¯¼å‡ºæ“ä½œç¬¦ï¼ˆé‡æ„ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                      # UIç»„ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ action_list.py               # Actionåˆ—è¡¨UIList
â”‚   â”‚   â””â”€â”€ hardpoint_list.py            # ç¡¬ç‚¹åˆ—è¡¨UIList
â”‚   â”‚
â”‚   â””â”€â”€ operators/                       # UIæ“ä½œç¬¦ï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ action_ops.py                # Actionæ·»åŠ /åˆ é™¤æ“ä½œ
â”‚       â””â”€â”€ hardpoint_ops.py             # ç¡¬ç‚¹æ·»åŠ /åˆ é™¤æ“ä½œ
â”‚
â”œâ”€â”€ core/                                # ğŸ”§ æ ¸å¿ƒç³»ç»Ÿ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ coordinate_converter.py          # åæ ‡è½¬æ¢å™¨
â”‚   â”œâ”€â”€ schema.py                        # æ•°æ®ç»“æ„å®šä¹‰ï¼ˆæ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ validator.py                     # æ•°æ®éªŒè¯å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ formats/                         # æ ¼å¼å¤„ç†ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ vertex_format.py             # é¡¶ç‚¹æ ¼å¼
â”‚   â”‚   â”œâ”€â”€ packed_normal.py             # Packed Normalå¤„ç†
â”‚   â”‚   â””â”€â”€ quaternion.py                # å››å…ƒæ•°å¤„ç†
â”‚   â”‚
â”‚   â””â”€â”€ io/                              # æ–‡ä»¶IOï¼ˆæ–°å¢ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ bin_section_writer.py        # BinSectionå†™å…¥
â”‚       â”œâ”€â”€ packed_section_writer.py     # PackedSectionå†™å…¥
â”‚       â””â”€â”€ xml_writer.py                # XMLå†™å…¥è¾…åŠ©
â”‚
â”œâ”€â”€ builders/                            # ğŸ—ï¸ æ•°æ®æ„å»ºå™¨ï¼ˆé‡ç»„ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ geometry/                        # å‡ ä½•æ•°æ®æ„å»ºï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ static_builder.py            # é™æ€å‡ ä½•æ„å»º
â”‚   â”‚   â”œâ”€â”€ skinning_builder.py          # è’™çš®æ•°æ®æ„å»º
â”‚   â”‚   â””â”€â”€ primitives_builder.py        # Primitivesç»„è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ visual/                          # è§†è§‰æ•°æ®æ„å»ºï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ material_builder.py          # æè´¨æ•°æ®æ„å»º
â”‚   â”‚   â”œâ”€â”€ renderSet_builder.py         # RenderSetæ„å»º
â”‚   â”‚   â””â”€â”€ visual_builder.py            # Visualç»„è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ skeleton/                        # éª¨éª¼æ•°æ®æ„å»ºï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ bone_hierarchy_builder.py    # éª¨éª¼å±‚çº§æ„å»º
â”‚   â”‚   â””â”€â”€ skeleton_builder.py          # Skeletonç»„è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ animation/                       # åŠ¨ç”»æ•°æ®æ„å»ºï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ keyframe_sampler.py          # å…³é”®å¸§é‡‡æ ·
â”‚   â”‚   â””â”€â”€ animation_builder.py         # Animationç»„è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ model/                           # æ¨¡å‹æ•°æ®æ„å»ºï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ hardpoint_builder.py         # ç¡¬ç‚¹æ•°æ®æ„å»º
â”‚   â”‚   â”œâ”€â”€ action_builder.py            # Actionæ•°æ®æ„å»º
â”‚   â”‚   â””â”€â”€ model_builder.py             # Modelç»„è£…
â”‚   â”‚
â”‚   â””â”€â”€ factory.py                       # Builderå·¥å‚ï¼ˆæ–°å¢ï¼‰
â”‚
â”œâ”€â”€ exporters/                           # ğŸ“¤ å¯¼å‡ºå™¨ï¼ˆé‡ç»„ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_exporter.py                 # åŸºç¡€å¯¼å‡ºå™¨ï¼ˆæŠ½è±¡ç±»ï¼‰
â”‚   â”œâ”€â”€ static_exporter.py               # é™æ€æ¨¡å‹å¯¼å‡ºå™¨
â”‚   â”œâ”€â”€ skinned_exporter.py              # è’™çš®æ¨¡å‹å¯¼å‡ºå™¨
â”‚   â”œâ”€â”€ character_exporter.py            # è§’è‰²åŠ¨ç”»å¯¼å‡ºå™¨
â”‚   â””â”€â”€ export_dispatcher.py             # å¯¼å‡ºè°ƒåº¦å™¨
â”‚
â”œâ”€â”€ writers/                             # âœï¸ æ–‡ä»¶å†™å…¥å™¨ï¼ˆä¿æŒï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ primitives_writer.py             # .primitiveså†™å…¥
â”‚   â”œâ”€â”€ visual_writer.py                 # .visualå†™å…¥
â”‚   â”œâ”€â”€ model_writer.py                  # .modelå†™å…¥ï¼ˆéœ€æ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ animation_writer.py              # .animationå†™å…¥
â”‚   â”œâ”€â”€ manifest_writer.py               # manifest.jsonå†™å…¥
â”‚   â””â”€â”€ audit_writer.py                  # audit.logå†™å…¥
â”‚
â”œâ”€â”€ utils/                               # ğŸ› ï¸ å·¥å…·å‡½æ•°ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ path_resolver.py                 # è·¯å¾„è§£æ
â”‚   â”œâ”€â”€ file_manager.py                  # æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ logger.py                        # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ mesh_utils.py                    # ç½‘æ ¼å·¥å…·
â”‚
â””â”€â”€ docs/                                # ğŸ“š æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ 20251019æ–°æ’ä»¶æ–¹æ¡ˆ.md            # ä¸»æ–¹æ¡ˆæ–‡æ¡£
    â”œâ”€â”€ UIè®¾è®¡è§„èŒƒ_æ ¸å¿ƒåŠŸèƒ½ç‰ˆ.md         # UIè®¾è®¡è§„èŒƒ
    â””â”€â”€ 20251019æ–°æ’ä»¶æ–¹æ¡ˆ_å¤‡ä»½.md       # å¤‡ä»½æ–‡æ¡£
```

---

## ğŸ”„ å½“å‰ç»“æ„ vs æ–°ç»“æ„å¯¹æ¯”

### **å½“å‰ç»“æ„ï¼ˆæ‰å¹³åŒ–ï¼‰**
```
å½“å‰ç›®å½•ï¼ˆé—®é¢˜ï¼‰ï¼š
â”œâ”€â”€ export_builders.py     # âŒ æ··æ‚æ‰€æœ‰Builder
â”œâ”€â”€ export_dispatcher.py   # âŒ è°ƒåº¦é€»è¾‘æ··ä¹±
â”œâ”€â”€ export_processor.py    # âŒ ä¸dispatcheré‡å¤
â”œâ”€â”€ core/                  # âŒ æ··æ‚IOå’Œé€»è¾‘
â”‚   â”œâ”€â”€ bin_section_writer.py
â”‚   â”œâ”€â”€ packed_section_writer.py
â”‚   â”œâ”€â”€ xml_writer.py
â”‚   â”œâ”€â”€ coordinate_converter.py
â”‚   â”œâ”€â”€ vertex_format.py
â”‚   â”œâ”€â”€ schema.py
â”‚   â”œâ”€â”€ validator.py
â”‚   â”œâ”€â”€ logger.py
â”‚   â”œâ”€â”€ file_manager.py
â”‚   â””â”€â”€ path_resolver.py
â”œâ”€â”€ ui/                    # âœ… åŸºæœ¬åˆç†
â””â”€â”€ writers/               # âœ… åŸºæœ¬åˆç†

é—®é¢˜ï¼š
1. Builderå…¨åœ¨ä¸€ä¸ªæ–‡ä»¶ï¼Œå¤ªè‡ƒè‚¿
2. coreç›®å½•èŒè´£ä¸æ¸…ï¼ˆIOã€æ ¼å¼ã€å·¥å…·æ··æ‚ï¼‰
3. ç¼ºå°‘æ˜ç¡®çš„å¯¼å‡ºæµç¨‹æŠ½è±¡
4. ç¼ºå°‘Actionå’ŒHardpointçš„Builder
```

### **æ–°ç»“æ„ï¼ˆæ¨¡å—åŒ–ï¼‰**
```
æ–°ç›®å½•ï¼ˆæ”¹è¿›ï¼‰ï¼š
â”œâ”€â”€ config/                # ğŸ“‹ é…ç½®é›†ä¸­ç®¡ç†
â”œâ”€â”€ ui/                    # ğŸ–¥ï¸ UIå®Œå…¨ç‹¬ç«‹
â”‚   â”œâ”€â”€ components/        # UIç»„ä»¶ç‹¬ç«‹
â”‚   â””â”€â”€ operators/         # UIæ“ä½œç‹¬ç«‹
â”œâ”€â”€ core/                  # ğŸ”§ æ ¸å¿ƒç³»ç»Ÿï¼ˆçº¯é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ formats/           # æ ¼å¼å¤„ç†ç‹¬ç«‹
â”‚   â””â”€â”€ io/                # IOç‹¬ç«‹
â”œâ”€â”€ builders/              # ğŸ—ï¸ æ„å»ºå™¨æŒ‰åŠŸèƒ½åˆ†ç±»
â”‚   â”œâ”€â”€ geometry/          # å‡ ä½•ç›¸å…³
â”‚   â”œâ”€â”€ visual/            # è§†è§‰ç›¸å…³
â”‚   â”œâ”€â”€ skeleton/          # éª¨éª¼ç›¸å…³
â”‚   â”œâ”€â”€ animation/         # åŠ¨ç”»ç›¸å…³
â”‚   â””â”€â”€ model/             # æ¨¡å‹ç›¸å…³ï¼ˆå«Actionã€Hardpointï¼‰
â”œâ”€â”€ exporters/             # ğŸ“¤ å¯¼å‡ºå™¨ï¼ˆæ¸…æ™°æµç¨‹ï¼‰
â”œâ”€â”€ writers/               # âœï¸ æ–‡ä»¶å†™å…¥ï¼ˆä¿æŒï¼‰
â””â”€â”€ utils/                 # ğŸ› ï¸ å·¥å…·å‡½æ•°ï¼ˆç‹¬ç«‹ï¼‰

ä¼˜åŠ¿ï¼š
1. åŠŸèƒ½åˆ’åˆ†æ¸…æ™°
2. æ¨¡å—èŒè´£å•ä¸€
3. ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
4. æ˜“äºæ‰©å±•æ–°åŠŸèƒ½
```

---

## ğŸ“ æ¨¡å—èŒè´£è¯¦ç»†è¯´æ˜

### 1ï¸âƒ£ `config/` - é…ç½®ç®¡ç†

**èŒè´£**ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®ç›¸å…³çš„ä»£ç 

#### `export_settings.py`
```python
"""
å¯¼å‡ºé…ç½®æ•°æ®ç±»
- ExportSettingsï¼ˆå…¨å±€é…ç½®ï¼‰
- ObjectExportSettingsï¼ˆå¯¹è±¡é…ç½®ï¼‰
- ä»UIå±æ€§è½¬æ¢ä¸ºå†…éƒ¨é…ç½®å¯¹è±¡
"""

@dataclass
class ExportSettings:
    """å…¨å±€å¯¼å‡ºé…ç½®"""
    root_path: str
    texture_path: str
    axis_mode: str
    unit_scale: float
    auto_validate: bool
    write_audit: bool

@dataclass  
class ObjectExportSettings:
    """å¯¹è±¡å¯¼å‡ºé…ç½®"""
    export_type: str  # STATIC / SKINNED / CHARACTER
    resource_id: str
    parent_model: Optional[str]
    actions: List[ActionConfig]  # Actioné…ç½®åˆ—è¡¨
    hardpoints: List[HardpointConfig]  # ç¡¬ç‚¹é…ç½®åˆ—è¡¨
```

#### `constants.py`
```python
"""
å¸¸é‡å®šä¹‰
- æ–‡ä»¶é­”æ•°
- ç‰ˆæœ¬å·
- é»˜è®¤å€¼
"""

BINSECTION_MAGIC = 0x42A14E65
BINSECTION_VERSION = 0x01
DEFAULT_EXTENT = 100.0
MAX_BONE_INDEX = 255
```

---

### 2ï¸âƒ£ `ui/` - ç”¨æˆ·ç•Œé¢ï¼ˆé‡æ„ï¼‰

**èŒè´£**ï¼šUIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

#### `preferences.py`ï¼ˆé‡æ„åï¼‰
```python
"""
æ’ä»¶åå¥½è®¾ç½®
- BigWorldAddonPreferencesï¼ˆ6ä¸ªæ ¸å¿ƒå±æ€§ï¼‰
- ç§»é™¤æ‰€æœ‰å ä½å±æ€§
"""

class BigWorldAddonPreferences(AddonPreferences):
    root_path: StringProperty()
    texture_path: StringProperty()
    axis_mode: EnumProperty()
    unit_scale: FloatProperty()
    auto_validate: BoolProperty()
    write_audit: BoolProperty()
    
    # âŒ ç§»é™¤ï¼šnaming_template, lod_rule, schema_file, directory_strategy
```

#### `object_properties.py`ï¼ˆé‡æ„åï¼‰
```python
"""
å¯¹è±¡å±æ€§
- BigWorldObjectPropertiesï¼ˆç²¾ç®€ï¼‰
- BigWorldActionï¼ˆæ–°å¢ï¼‰
- BigWorldHardpointï¼ˆä¿ç•™ï¼‰
- BIGWORLD_PT_object_panelï¼ˆé‡æ„ï¼‰
"""

class BigWorldObjectProperties(PropertyGroup):
    export_type: EnumProperty()  # STATIC/SKINNED/CHARACTER
    resource_id: StringProperty()
    parent_model: StringProperty()
    
class BigWorldAction(PropertyGroup):
    name: StringProperty()
    animation_name: StringProperty()
    blended: BoolProperty()
    track: IntProperty()

class BigWorldHardpoint(PropertyGroup):
    name: StringProperty()
    hardpoint_type: EnumProperty()
    bone_name: StringProperty()
    use_empty: BoolProperty()
    target_empty: PointerProperty()
```

#### `ui/components/` - UIç»„ä»¶

**action_list.py**
```python
"""
Actionåˆ—è¡¨UIList
- BIGWORLD_UL_actions
- æ˜¾ç¤ºActionåç§°ã€å…³è”åŠ¨ç”»ã€æ··åˆçŠ¶æ€ã€è½¨é“
"""

class BIGWORLD_UL_actions(UIList):
    def draw_item(self, context, layout, data, item, ...):
        # æ˜¾ç¤ºï¼šåç§° | åŠ¨ç”» | æ··åˆ | è½¨é“
```

**hardpoint_list.py**
```python
"""
ç¡¬ç‚¹åˆ—è¡¨UIList
- BIGWORLD_UL_hardpoints  
- æ˜¾ç¤ºç¡¬ç‚¹åç§°ã€ç±»å‹ã€ç»‘å®šä½ç½®
"""

class BIGWORLD_UL_hardpoints(UIList):
    def draw_item(self, context, layout, data, item, ...):
        # æ˜¾ç¤ºï¼šåç§° | ç±»å‹ | ç»‘å®šéª¨éª¼/Empty
```

#### `ui/operators/` - UIæ“ä½œç¬¦

**action_ops.py**
```python
"""
Actionç›¸å…³æ“ä½œ
- BIGWORLD_OT_action_add
- BIGWORLD_OT_action_remove
- BIGWORLD_OT_action_move_up
- BIGWORLD_OT_action_move_down
"""
```

**hardpoint_ops.py**
```python
"""
ç¡¬ç‚¹ç›¸å…³æ“ä½œ
- BIGWORLD_OT_hardpoint_add
- BIGWORLD_OT_hardpoint_remove
"""
```

---

### 3ï¸âƒ£ `core/` - æ ¸å¿ƒç³»ç»Ÿï¼ˆçº¯é€»è¾‘ï¼‰

**èŒè´£**ï¼šæä¾›çº¯ç²¹çš„æ•°æ®å¤„ç†å’Œè½¬æ¢ï¼Œä¸ä¾èµ–Blender

#### `core/formats/` - æ ¼å¼å¤„ç†

**vertex_format.py**
```python
"""
é¡¶ç‚¹æ ¼å¼å¤„ç†
- build_vertex_format()
- get_vertex_stride()
- parse_vertex_format()
"""
```

**packed_normal.py**
```python
"""
Packed Normalå¤„ç†
- pack_normal(nx, ny, nz) -> uint32
- unpack_normal(packed) -> (nx, ny, nz)
"""
```

**quaternion.py**
```python
"""
å››å…ƒæ•°å¤„ç†
- normalize_quaternion()
- quaternion_to_matrix()
"""
```

#### `core/io/` - æ–‡ä»¶IO

**bin_section_writer.py**
```python
"""
BinSectionå†™å…¥å™¨
- åªè´Ÿè´£äºŒè¿›åˆ¶å†™å…¥
- ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
"""
```

**packed_section_writer.py**
```python
"""
PackedSectionå†™å…¥å™¨
- äºŒè¿›åˆ¶XMLå†™å…¥
- ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
"""
```

---

### 4ï¸âƒ£ `builders/` - æ•°æ®æ„å»ºå™¨ï¼ˆé‡ç»„ï¼‰

**èŒè´£**ï¼šä»Blenderå¯¹è±¡æå–æ•°æ®ï¼Œè½¬æ¢ä¸ºBigWorldæ•°æ®ç»“æ„

#### `builders/geometry/` - å‡ ä½•æ„å»º

**static_builder.py**
```python
"""
é™æ€å‡ ä½•æ•°æ®æ„å»º
- extract_vertices(mesh) -> List[Vector3]
- extract_normals(mesh) -> List[Vector3]  # Vector3æ ¼å¼
- extract_uvs(mesh) -> List[Vector2]
- extract_indices(mesh) -> List[int]
"""
```

**skinning_builder.py**
```python
"""
è’™çš®æ•°æ®æ„å»º
- extract_bone_indices(mesh, armature) -> List[List[int]]
- extract_bone_weights(mesh, armature) -> List[List[int]]
- validate_bone_indices()
- normalize_weights()
"""
```

**primitives_builder.py**
```python
"""
Primitivesç»„è£…
- build_static_primitives(mesh)
- build_skinned_primitives(mesh, armature)
- build_primitive_groups(mesh)
"""
```

#### `builders/visual/` - è§†è§‰æ„å»º

**material_builder.py**
```python
"""
æè´¨æ•°æ®æ„å»º
- extract_textures(material) -> dict
- build_material_slot(material, texture_root)
"""
```

**renderSet_builder.py**
```python
"""
RenderSetæ„å»º
- build_renderSet(primitives_path, material_slot, group_index)
"""
```

**visual_builder.py**
```python
"""
Visualç»„è£…
- build_static_visual(renderSets, bbox)
- build_skinned_visual(renderSets, bbox, skeleton)
"""
```

#### `builders/skeleton/` - éª¨éª¼æ„å»º

**bone_hierarchy_builder.py**
```python
"""
éª¨éª¼å±‚çº§æ„å»º
- build_bone_tree(armature) -> List[BoneNode]
- calculate_bind_matrix(bone) -> Matrix4x3
- convert_to_y_up(matrix)
"""
```

**skeleton_builder.py**
```python
"""
Skeletonç»„è£…
- build_skeleton(armature) -> Skeleton
"""
```

#### `builders/animation/` - åŠ¨ç”»æ„å»º

**keyframe_sampler.py**
```python
"""
å…³é”®å¸§é‡‡æ ·
- sample_position_keys(action, bone, fps) -> List[Key]
- sample_rotation_keys(action, bone, fps) -> List[Key]
- sample_scale_keys(action, bone, fps) -> List[Key]
"""
```

**animation_builder.py**
```python
"""
Animationç»„è£…
- build_animation(action, armature) -> Animation
- build_animation_channel(bone, action) -> AnimationChannel
"""
```

#### `builders/model/` - æ¨¡å‹æ„å»º

**hardpoint_builder.py**ï¼ˆæ–°å¢ï¼‰
```python
"""
ç¡¬ç‚¹æ•°æ®æ„å»º
- build_hardpoint(hardpoint_config, skeleton) -> Hardpoint
- get_bone_path(bone_name, skeleton) -> str
- calculate_hardpoint_transform()
"""
```

**action_builder.py**ï¼ˆæ–°å¢ï¼‰
```python
"""
Actionæ•°æ®æ„å»º
- build_action(action_config) -> ModelAction
- validate_action_reference()
"""
```

**model_builder.py**
```python
"""
Modelç»„è£…
- build_static_model(visual_ref, bbox)
- build_skinned_model(visual_ref, bbox, parent, hardpoints)
- build_character_model(visual_ref, bbox, animations, actions, hardpoints)
"""
```

#### `builders/factory.py`ï¼ˆæ–°å¢ï¼‰
```python
"""
Builderå·¥å‚
- æ ¹æ®å¯¼å‡ºç±»å‹åˆ›å»ºå¯¹åº”çš„Builderç»„åˆ
"""

class BuilderFactory:
    @staticmethod
    def create_builders(export_type):
        if export_type == 'STATIC':
            return {
                'primitives': StaticPrimitivesBuilder,
                'visual': StaticVisualBuilder,
                'model': StaticModelBuilder
            }
        elif export_type == 'SKINNED':
            return {
                'primitives': SkinnedPrimitivesBuilder,
                'visual': SkinnedVisualBuilder,
                'model': SkinnedModelBuilder,
                'skeleton': SkeletonBuilder
            }
        elif export_type == 'CHARACTER':
            return {
                'primitives': SkinnedPrimitivesBuilder,
                'visual': SkinnedVisualBuilder,
                'model': CharacterModelBuilder,
                'skeleton': SkeletonBuilder,
                'animation': AnimationBuilder
            }
```

---

### 5ï¸âƒ£ `exporters/` - å¯¼å‡ºå™¨ï¼ˆæ–°è®¾è®¡ï¼‰

**èŒè´£**ï¼šåè°ƒæ•´ä¸ªå¯¼å‡ºæµç¨‹ï¼Œè°ƒç”¨Builderså’ŒWriters

#### `base_exporter.py`ï¼ˆæ–°å¢ï¼‰
```python
"""
åŸºç¡€å¯¼å‡ºå™¨æŠ½è±¡ç±»
- å®šä¹‰å¯¼å‡ºæµç¨‹æ¨¡æ¿
- å­ç±»å®ç°å…·ä½“æ­¥éª¤
"""

class BaseExporter:
    def export(self, obj, settings):
        # æ¨¡æ¿æ–¹æ³•æ¨¡å¼
        self.validate(obj)
        data = self.build_data(obj, settings)
        self.write_files(data, settings)
        self.post_process(settings)
    
    @abstractmethod
    def build_data(self, obj, settings):
        pass
```

#### `static_exporter.py`ï¼ˆæ–°å¢ï¼‰
```python
"""
é™æ€æ¨¡å‹å¯¼å‡ºå™¨
- åªå¯¼å‡º.primitives + .visual + .model
"""

class StaticExporter(BaseExporter):
    def build_data(self, obj, settings):
        primitives = PrimitivesBuilder.build_static(obj)
        visual = VisualBuilder.build_static(obj, primitives_path)
        model = ModelBuilder.build_static(visual_ref, bbox)
        return (primitives, visual, model)
    
    def write_files(self, data, settings):
        primitives_writer.write(data[0])
        visual_writer.write(data[1])
        model_writer.write(data[2])
```

#### `skinned_exporter.py`ï¼ˆæ–°å¢ï¼‰
```python
"""
è’™çš®æ¨¡å‹å¯¼å‡ºå™¨
- å¯¼å‡º.primitives + .visual + .modelï¼ˆå«éª¨éª¼å’Œç¡¬ç‚¹ï¼‰
"""

class SkinnedExporter(BaseExporter):
    def build_data(self, obj, settings):
        skeleton = SkeletonBuilder.build(armature)
        primitives = PrimitivesBuilder.build_skinned(obj, armature)
        visual = VisualBuilder.build_skinned(obj, skeleton)
        hardpoints = HardpointBuilder.build_all(settings.hardpoints, skeleton)
        model = ModelBuilder.build_skinned(visual_ref, hardpoints, parent)
        return (primitives, visual, model, skeleton)
```

#### `character_exporter.py`ï¼ˆæ–°å¢ï¼‰
```python
"""
è§’è‰²åŠ¨ç”»å¯¼å‡ºå™¨
- å®Œæ•´å¯¼å‡ºï¼ˆå«Actionç³»ç»Ÿï¼‰
"""

class CharacterExporter(BaseExporter):
    def build_data(self, obj, settings):
        skeleton = SkeletonBuilder.build(armature)
        primitives = PrimitivesBuilder.build_skinned(obj, armature)
        visual = VisualBuilder.build_skinned(obj, skeleton)
        animations = AnimationBuilder.build_all(actions, armature)
        actions = ActionBuilder.build_all(settings.actions, animations)
        hardpoints = HardpointBuilder.build_all(settings.hardpoints, skeleton)
        model = ModelBuilder.build_character(visual_ref, animations, actions, hardpoints)
        return (primitives, visual, animations, model, skeleton)
```

#### `export_dispatcher.py`ï¼ˆç®€åŒ–ï¼‰
```python
"""
å¯¼å‡ºè°ƒåº¦å™¨ï¼ˆç®€åŒ–ï¼‰
- æ ¹æ®export_typeé€‰æ‹©å¯¹åº”çš„Exporter
"""

class ExportDispatcher:
    def dispatch(self, obj, settings):
        exporter = self._get_exporter(settings.export_type)
        return exporter.export(obj, settings)
    
    def _get_exporter(self, export_type):
        if export_type == 'STATIC':
            return StaticExporter()
        elif export_type == 'SKINNED':
            return SkinnedExporter()
        elif export_type == 'CHARACTER':
            return CharacterExporter()
```

---

### 6ï¸âƒ£ `utils/` - å·¥å…·å‡½æ•°

**èŒè´£**ï¼šæä¾›é€šç”¨å·¥å…·å‡½æ•°ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

```python
utils/
â”œâ”€â”€ path_resolver.py      # è·¯å¾„è§£æå’Œè§„èŒƒåŒ–
â”œâ”€â”€ file_manager.py       # æ–‡ä»¶åˆ›å»ºã€åˆ é™¤ã€æ£€æŸ¥
â”œâ”€â”€ logger.py             # æ—¥å¿—è®°å½•
â””â”€â”€ mesh_utils.py         # ç½‘æ ¼å·¥å…·ï¼ˆä¸‰è§’åŒ–ã€æ³•çº¿è®¡ç®—ç­‰ï¼‰
```

---

## ğŸ”„ æ•°æ®æµç¨‹å›¾ï¼ˆæ–°æ¶æ„ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI Layer                                â”‚
â”‚  preferences.py  object_properties.py  export_operator.py   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ ç”¨æˆ·é…ç½®
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Config Layer                               â”‚
â”‚           export_settings.py  constants.py                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ é…ç½®å¯¹è±¡
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Exporter Layer                              â”‚
â”‚   static_exporter  skinned_exporter  character_exporter    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ åè°ƒæµç¨‹
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Builder Layer                               â”‚
â”‚  geometry/  visual/  skeleton/  animation/  model/         â”‚
â”‚    â”œâ”€ static_builder.py                                     â”‚
â”‚    â”œâ”€ skinning_builder.py                                   â”‚
â”‚    â”œâ”€ hardpoint_builder.py  â† æ–°å¢                         â”‚
â”‚    â””â”€ action_builder.py     â† æ–°å¢                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ•°æ®å¯¹è±¡
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Core Layer                                 â”‚
â”‚  coordinate_converter  schema  validator  formats/  io/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å¤„ç†åæ•°æ®
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Writer Layer                                â”‚
â”‚  primitives_writer  visual_writer  model_writer            â”‚
â”‚  animation_writer   manifest_writer  audit_writer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ–‡ä»¶
             â†“
        BigWorld Files
```

---

## ğŸ“¦ æ ¸å¿ƒæ•°æ®ç»“æ„æ‰©å±•

### æ‰©å±• `core/schema.py`

éœ€è¦æ·»åŠ ä»¥ä¸‹æ•°æ®ç±»ï¼š

```python
# æ–°å¢ï¼šActionæ•°æ®ç»“æ„
@dataclass
class ModelAction:
    """Modelä¸­çš„Actionå®šä¹‰"""
    name: str                    # Actionåç§°
    animation_ref: str           # å¼•ç”¨çš„animationåç§°
    blended: bool               # æ˜¯å¦æ··åˆ
    track: int                  # è½¨é“ç´¢å¼•
    # æœªæ¥æ‰©å±•ï¼š
    # filler: Optional[int]
    # match_info: Optional[MatchInfo]

# æ–°å¢ï¼šHardpointæ•°æ®ç»“æ„
@dataclass
class Hardpoint:
    """ç¡¬ç‚¹å®šä¹‰"""
    name: str                    # ç¡¬ç‚¹åç§°ï¼ˆå¦‚HP_RightHandï¼‰
    identifier: str              # éª¨éª¼å®Œæ•´è·¯å¾„
    transform: List[List[float]] # 4x3å˜æ¢çŸ©é˜µ
    hardpoint_type: str          # ç±»å‹æ ‡è¯†ï¼ˆå…ƒæ•°æ®ï¼‰

# æ‰©å±•ï¼šModelæ•°æ®ç»“æ„
@dataclass
class Model:
    visual_type: str            # nodelessæˆ–nodefull
    visual_ref: str
    extent: float
    bounding_box: BoundingBox
    parent: Optional[str]       # æ–°å¢
    animations: List[ModelAnimation]
    actions: List[ModelAction]  # æ–°å¢
    hardpoints: List[Hardpoint] # æ–°å¢
```

---

## ğŸ”€ è¿ç§»è®¡åˆ’

### é˜¶æ®µ1ï¼šåˆ›å»ºæ–°ç›®å½•ç»“æ„
```bash
1. åˆ›å»ºæ–°ç›®å½•ï¼š
   - config/
   - ui/components/
   - ui/operators/
   - core/formats/
   - core/io/
   - builders/geometry/
   - builders/visual/
   - builders/skeleton/
   - builders/animation/
   - builders/model/
   - exporters/
   - utils/

2. ä¿ç•™ç›®å½•ï¼š
   - writers/ (ä¸å˜)
```

### é˜¶æ®µ2ï¼šè¿ç§»å’Œæ‹†åˆ†æ–‡ä»¶
```
1. core/ â†’ åˆ†æ‹†
   â”œâ”€ coordinate_converter.py â†’ core/ (ä¿æŒ)
   â”œâ”€ schema.py â†’ core/ (æ‰©å±•)
   â”œâ”€ validator.py â†’ core/ (ä¿æŒ)
   â”œâ”€ vertex_format.py â†’ core/formats/
   â”œâ”€ bin_section_writer.py â†’ core/io/
   â”œâ”€ packed_section_writer.py â†’ core/io/
   â”œâ”€ xml_writer.py â†’ core/io/
   â”œâ”€ logger.py â†’ utils/
   â”œâ”€ file_manager.py â†’ utils/
   â””â”€ path_resolver.py â†’ utils/

2. export_builders.py â†’ æ‹†åˆ†
   â”œâ”€ PrimitivesBuilder â†’ builders/geometry/primitives_builder.py
   â”œâ”€ VisualBuilder â†’ builders/visual/visual_builder.py
   â”œâ”€ SkeletonBuilder â†’ builders/skeleton/skeleton_builder.py
   â”œâ”€ AnimationBuilder â†’ builders/animation/animation_builder.py
   â””â”€ ModelBuilder â†’ builders/model/model_builder.py

3. ui/ â†’ é‡æ„å’Œæ–°å¢
   â”œâ”€ preferences_panel.py â†’ ui/preferences.py (é‡æ„)
   â”œâ”€ object_panel.py â†’ ui/object_properties.py (é‡æ„)
   â”œâ”€ export_panel.py â†’ ui/export_operator.py (é‡æ„)
   â”œâ”€ æ–°å¢ ui/components/action_list.py
   â”œâ”€ æ–°å¢ ui/components/hardpoint_list.py
   â”œâ”€ æ–°å¢ ui/operators/action_ops.py
   â””â”€ æ–°å¢ ui/operators/hardpoint_ops.py

4. å¯¼å‡ºæµç¨‹ â†’ é‡ç»„
   â”œâ”€ export_dispatcher.py â†’ exporters/export_dispatcher.py (ç®€åŒ–)
   â”œâ”€ export_processor.py â†’ åˆ é™¤ï¼ˆåˆå¹¶åˆ°dispatcherï¼‰
   â”œâ”€ æ–°å¢ exporters/base_exporter.py
   â”œâ”€ æ–°å¢ exporters/static_exporter.py
   â”œâ”€ æ–°å¢ exporters/skinned_exporter.py
   â””â”€ æ–°å¢ exporters/character_exporter.py

5. æ–°å¢æ¨¡å—
   â”œâ”€ config/export_settings.py
   â”œâ”€ config/constants.py
   â”œâ”€ core/formats/packed_normal.py
   â”œâ”€ core/formats/quaternion.py
   â”œâ”€ builders/geometry/static_builder.py
   â”œâ”€ builders/geometry/skinning_builder.py
   â”œâ”€ builders/model/hardpoint_builder.py
   â””â”€ builders/model/action_builder.py
```

### é˜¶æ®µ3ï¼šæ›´æ–°å¼•ç”¨å’Œå¯¼å…¥
```
1. æ›´æ–° __init__.py ä¸­çš„å¯¼å…¥è·¯å¾„
2. æ›´æ–°æ‰€æœ‰æ¨¡å—é—´çš„ç›¸å¯¹å¯¼å…¥
3. æµ‹è¯•æ’ä»¶åŠ è½½
```

---

## âœ… é‡æ„åçš„ä¼˜åŠ¿

| æ–¹é¢ | å½“å‰æ¶æ„ | æ–°æ¶æ„ | æ”¹è¿› |
|------|---------|--------|------|
| **æ–‡ä»¶ç»„ç»‡** | æ‰å¹³åŒ–ï¼ŒèŒè´£æ··ä¹± | å±‚æ¬¡åŒ–ï¼ŒèŒè´£æ¸…æ™° | âœ… |
| **æ¨¡å—æ•°é‡** | 15ä¸ªæ–‡ä»¶ | 40+ä¸ªæ–‡ä»¶ | æ›´ç»†ç²’åº¦ |
| **å•ä¸ªæ–‡ä»¶å¤§å°** | å¤§ï¼ˆ800+è¡Œï¼‰ | å°ï¼ˆ<200è¡Œï¼‰ | âœ… |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ | å®¹æ˜“ | âœ… |
| **å¯æ‰©å±•æ€§** | å›°éš¾ | å®¹æ˜“ | âœ… |
| **Actionæ”¯æŒ** | âŒ æ—  | âœ… æœ‰ | æ–°åŠŸèƒ½ |
| **Hardpointæ”¯æŒ** | â³ å ä½ | âœ… å®Œæ•´ | æ–°åŠŸèƒ½ |

---

## ğŸ¯ è¿™ä¸ªæ¶æ„é‡æ„æ–¹æ¡ˆæ‚¨è§‰å¾—å¦‚ä½•ï¼Ÿ

**ä¸»è¦æ”¹è¿›**ï¼š
1. **æŒ‰åŠŸèƒ½æ¨¡å—åŒ–** - buildersæŒ‰geometry/visual/skeleton/animation/modelåˆ†ç±»
2. **åˆ†ç¦»å…³æ³¨ç‚¹** - UI/Config/Builder/Core/Exporter/Writeræ¸…æ™°åˆ†å±‚
3. **æ”¯æŒæ–°åŠŸèƒ½** - Actionå’ŒHardpointæœ‰ä¸“é—¨çš„Builder
4. **ä¾¿äºç»´æŠ¤** - æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€ï¼Œä»£ç é‡å°

**å¦‚æœåŒæ„è¿™ä¸ªæ¶æ„ï¼Œæˆ‘å°†ï¼š**
1. åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
2. æ‹†åˆ†å’Œè¿ç§»ç°æœ‰ä»£ç 
3. å®ç°æ–°çš„Actionå’ŒHardpoint Builder
4. æ›´æ–°æ‰€æœ‰å¯¼å…¥å¼•ç”¨
5. æµ‹è¯•æ’ä»¶åŠ è½½

**æ˜¯å¦å¼€å§‹å®æ–½æ¶æ„é‡æ„ï¼Ÿ** ğŸš€
