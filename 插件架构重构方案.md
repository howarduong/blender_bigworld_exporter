# 🏗️ BigWorld Blender 插件架构重构方案

**版本**: v2.0  
**日期**: 2025-10-22  
**目标**: 基于新UI设计规范，重构目录结构，优化模块职责

---

## 📊 重构原则

1. **按功能划分** - 而不是按文件类型
2. **清晰的数据流** - 从UI→数据→文件的单向流动
3. **模块独立** - 每个模块职责单一，便于测试
4. **便于扩展** - 预留扩展点，但不实现占位功能

---

## 🎯 新目录结构设计

```
blender_bigworld_exporter/
│
├── __init__.py                          # 插件入口（简化）
│
├── config/                              # 📋 配置管理（新增）
│   ├── __init__.py
│   ├── export_settings.py               # 导出配置数据类
│   └── constants.py                     # 常量定义（魔数、版本号等）
│
├── ui/                                  # 🖥️ 用户界面
│   ├── __init__.py
│   ├── preferences.py                   # 偏好设置面板（重构）
│   ├── object_properties.py             # 对象属性面板（重构）
│   ├── export_operator.py               # 导出操作符（重构）
│   │
│   ├── components/                      # UI组件（新增）
│   │   ├── __init__.py
│   │   ├── action_list.py               # Action列表UIList
│   │   └── hardpoint_list.py            # 硬点列表UIList
│   │
│   └── operators/                       # UI操作符（新增）
│       ├── __init__.py
│       ├── action_ops.py                # Action添加/删除操作
│       └── hardpoint_ops.py             # 硬点添加/删除操作
│
├── core/                                # 🔧 核心系统
│   ├── __init__.py
│   ├── coordinate_converter.py          # 坐标转换器
│   ├── schema.py                        # 数据结构定义（扩展）
│   ├── validator.py                     # 数据验证器
│   │
│   ├── formats/                         # 格式处理（新增）
│   │   ├── __init__.py
│   │   ├── vertex_format.py             # 顶点格式
│   │   ├── packed_normal.py             # Packed Normal处理
│   │   └── quaternion.py                # 四元数处理
│   │
│   └── io/                              # 文件IO（新增）
│       ├── __init__.py
│       ├── bin_section_writer.py        # BinSection写入
│       ├── packed_section_writer.py     # PackedSection写入
│       └── xml_writer.py                # XML写入辅助
│
├── builders/                            # 🏗️ 数据构建器（重组）
│   ├── __init__.py
│   │
│   ├── geometry/                        # 几何数据构建（新增）
│   │   ├── __init__.py
│   │   ├── static_builder.py            # 静态几何构建
│   │   ├── skinning_builder.py          # 蒙皮数据构建
│   │   └── primitives_builder.py        # Primitives组装
│   │
│   ├── visual/                          # 视觉数据构建（新增）
│   │   ├── __init__.py
│   │   ├── material_builder.py          # 材质数据构建
│   │   ├── renderSet_builder.py         # RenderSet构建
│   │   └── visual_builder.py            # Visual组装
│   │
│   ├── skeleton/                        # 骨骼数据构建（新增）
│   │   ├── __init__.py
│   │   ├── bone_hierarchy_builder.py    # 骨骼层级构建
│   │   └── skeleton_builder.py          # Skeleton组装
│   │
│   ├── animation/                       # 动画数据构建（新增）
│   │   ├── __init__.py
│   │   ├── keyframe_sampler.py          # 关键帧采样
│   │   └── animation_builder.py         # Animation组装
│   │
│   ├── model/                           # 模型数据构建（新增）
│   │   ├── __init__.py
│   │   ├── hardpoint_builder.py         # 硬点数据构建
│   │   ├── action_builder.py            # Action数据构建
│   │   └── model_builder.py             # Model组装
│   │
│   └── factory.py                       # Builder工厂（新增）
│
├── exporters/                           # 📤 导出器（重组）
│   ├── __init__.py
│   ├── base_exporter.py                 # 基础导出器（抽象类）
│   ├── static_exporter.py               # 静态模型导出器
│   ├── skinned_exporter.py              # 蒙皮模型导出器
│   ├── character_exporter.py            # 角色动画导出器
│   └── export_dispatcher.py             # 导出调度器
│
├── writers/                             # ✍️ 文件写入器（保持）
│   ├── __init__.py
│   ├── primitives_writer.py             # .primitives写入
│   ├── visual_writer.py                 # .visual写入
│   ├── model_writer.py                  # .model写入（需扩展）
│   ├── animation_writer.py              # .animation写入
│   ├── manifest_writer.py               # manifest.json写入
│   └── audit_writer.py                  # audit.log写入
│
├── utils/                               # 🛠️ 工具函数（新增）
│   ├── __init__.py
│   ├── path_resolver.py                 # 路径解析
│   ├── file_manager.py                  # 文件管理
│   ├── logger.py                        # 日志工具
│   └── mesh_utils.py                    # 网格工具
│
└── docs/                                # 📚 文档（新增）
    ├── 20251019新插件方案.md            # 主方案文档
    ├── UI设计规范_核心功能版.md         # UI设计规范
    └── 20251019新插件方案_备份.md       # 备份文档
```

---

## 🔄 当前结构 vs 新结构对比

### **当前结构（扁平化）**
```
当前目录（问题）：
├── export_builders.py     # ❌ 混杂所有Builder
├── export_dispatcher.py   # ❌ 调度逻辑混乱
├── export_processor.py    # ❌ 与dispatcher重复
├── core/                  # ❌ 混杂IO和逻辑
│   ├── bin_section_writer.py
│   ├── packed_section_writer.py
│   ├── xml_writer.py
│   ├── coordinate_converter.py
│   ├── vertex_format.py
│   ├── schema.py
│   ├── validator.py
│   ├── logger.py
│   ├── file_manager.py
│   └── path_resolver.py
├── ui/                    # ✅ 基本合理
└── writers/               # ✅ 基本合理

问题：
1. Builder全在一个文件，太臃肿
2. core目录职责不清（IO、格式、工具混杂）
3. 缺少明确的导出流程抽象
4. 缺少Action和Hardpoint的Builder
```

### **新结构（模块化）**
```
新目录（改进）：
├── config/                # 📋 配置集中管理
├── ui/                    # 🖥️ UI完全独立
│   ├── components/        # UI组件独立
│   └── operators/         # UI操作独立
├── core/                  # 🔧 核心系统（纯逻辑）
│   ├── formats/           # 格式处理独立
│   └── io/                # IO独立
├── builders/              # 🏗️ 构建器按功能分类
│   ├── geometry/          # 几何相关
│   ├── visual/            # 视觉相关
│   ├── skeleton/          # 骨骼相关
│   ├── animation/         # 动画相关
│   └── model/             # 模型相关（含Action、Hardpoint）
├── exporters/             # 📤 导出器（清晰流程）
├── writers/               # ✍️ 文件写入（保持）
└── utils/                 # 🛠️ 工具函数（独立）

优势：
1. 功能划分清晰
2. 模块职责单一
3. 便于测试和维护
4. 易于扩展新功能
```

---

## 📁 模块职责详细说明

### 1️⃣ `config/` - 配置管理

**职责**：集中管理所有配置相关的代码

#### `export_settings.py`
```python
"""
导出配置数据类
- ExportSettings（全局配置）
- ObjectExportSettings（对象配置）
- 从UI属性转换为内部配置对象
"""

@dataclass
class ExportSettings:
    """全局导出配置"""
    root_path: str
    texture_path: str
    axis_mode: str
    unit_scale: float
    auto_validate: bool
    write_audit: bool

@dataclass  
class ObjectExportSettings:
    """对象导出配置"""
    export_type: str  # STATIC / SKINNED / CHARACTER
    resource_id: str
    parent_model: Optional[str]
    actions: List[ActionConfig]  # Action配置列表
    hardpoints: List[HardpointConfig]  # 硬点配置列表
```

#### `constants.py`
```python
"""
常量定义
- 文件魔数
- 版本号
- 默认值
"""

BINSECTION_MAGIC = 0x42A14E65
BINSECTION_VERSION = 0x01
DEFAULT_EXTENT = 100.0
MAX_BONE_INDEX = 255
```

---

### 2️⃣ `ui/` - 用户界面（重构）

**职责**：UI展示和用户交互，不包含业务逻辑

#### `preferences.py`（重构后）
```python
"""
插件偏好设置
- BigWorldAddonPreferences（6个核心属性）
- 移除所有占位属性
"""

class BigWorldAddonPreferences(AddonPreferences):
    root_path: StringProperty()
    texture_path: StringProperty()
    axis_mode: EnumProperty()
    unit_scale: FloatProperty()
    auto_validate: BoolProperty()
    write_audit: BoolProperty()
    
    # ❌ 移除：naming_template, lod_rule, schema_file, directory_strategy
```

#### `object_properties.py`（重构后）
```python
"""
对象属性
- BigWorldObjectProperties（精简）
- BigWorldAction（新增）
- BigWorldHardpoint（保留）
- BIGWORLD_PT_object_panel（重构）
"""

class BigWorldObjectProperties(PropertyGroup):
    export_type: EnumProperty()  # STATIC/SKINNED/CHARACTER
    resource_id: StringProperty()
    parent_model: StringProperty()
    
class BigWorldAction(PropertyGroup):
    name: StringProperty()
    animation_name: StringProperty()
    blended: BoolProperty()
    track: IntProperty()

class BigWorldHardpoint(PropertyGroup):
    name: StringProperty()
    hardpoint_type: EnumProperty()
    bone_name: StringProperty()
    use_empty: BoolProperty()
    target_empty: PointerProperty()
```

#### `ui/components/` - UI组件

**action_list.py**
```python
"""
Action列表UIList
- BIGWORLD_UL_actions
- 显示Action名称、关联动画、混合状态、轨道
"""

class BIGWORLD_UL_actions(UIList):
    def draw_item(self, context, layout, data, item, ...):
        # 显示：名称 | 动画 | 混合 | 轨道
```

**hardpoint_list.py**
```python
"""
硬点列表UIList
- BIGWORLD_UL_hardpoints  
- 显示硬点名称、类型、绑定位置
"""

class BIGWORLD_UL_hardpoints(UIList):
    def draw_item(self, context, layout, data, item, ...):
        # 显示：名称 | 类型 | 绑定骨骼/Empty
```

#### `ui/operators/` - UI操作符

**action_ops.py**
```python
"""
Action相关操作
- BIGWORLD_OT_action_add
- BIGWORLD_OT_action_remove
- BIGWORLD_OT_action_move_up
- BIGWORLD_OT_action_move_down
"""
```

**hardpoint_ops.py**
```python
"""
硬点相关操作
- BIGWORLD_OT_hardpoint_add
- BIGWORLD_OT_hardpoint_remove
"""
```

---

### 3️⃣ `core/` - 核心系统（纯逻辑）

**职责**：提供纯粹的数据处理和转换，不依赖Blender

#### `core/formats/` - 格式处理

**vertex_format.py**
```python
"""
顶点格式处理
- build_vertex_format()
- get_vertex_stride()
- parse_vertex_format()
"""
```

**packed_normal.py**
```python
"""
Packed Normal处理
- pack_normal(nx, ny, nz) -> uint32
- unpack_normal(packed) -> (nx, ny, nz)
"""
```

**quaternion.py**
```python
"""
四元数处理
- normalize_quaternion()
- quaternion_to_matrix()
"""
```

#### `core/io/` - 文件IO

**bin_section_writer.py**
```python
"""
BinSection写入器
- 只负责二进制写入
- 不包含业务逻辑
"""
```

**packed_section_writer.py**
```python
"""
PackedSection写入器
- 二进制XML写入
- 不包含业务逻辑
"""
```

---

### 4️⃣ `builders/` - 数据构建器（重组）

**职责**：从Blender对象提取数据，转换为BigWorld数据结构

#### `builders/geometry/` - 几何构建

**static_builder.py**
```python
"""
静态几何数据构建
- extract_vertices(mesh) -> List[Vector3]
- extract_normals(mesh) -> List[Vector3]  # Vector3格式
- extract_uvs(mesh) -> List[Vector2]
- extract_indices(mesh) -> List[int]
"""
```

**skinning_builder.py**
```python
"""
蒙皮数据构建
- extract_bone_indices(mesh, armature) -> List[List[int]]
- extract_bone_weights(mesh, armature) -> List[List[int]]
- validate_bone_indices()
- normalize_weights()
"""
```

**primitives_builder.py**
```python
"""
Primitives组装
- build_static_primitives(mesh)
- build_skinned_primitives(mesh, armature)
- build_primitive_groups(mesh)
"""
```

#### `builders/visual/` - 视觉构建

**material_builder.py**
```python
"""
材质数据构建
- extract_textures(material) -> dict
- build_material_slot(material, texture_root)
"""
```

**renderSet_builder.py**
```python
"""
RenderSet构建
- build_renderSet(primitives_path, material_slot, group_index)
"""
```

**visual_builder.py**
```python
"""
Visual组装
- build_static_visual(renderSets, bbox)
- build_skinned_visual(renderSets, bbox, skeleton)
"""
```

#### `builders/skeleton/` - 骨骼构建

**bone_hierarchy_builder.py**
```python
"""
骨骼层级构建
- build_bone_tree(armature) -> List[BoneNode]
- calculate_bind_matrix(bone) -> Matrix4x3
- convert_to_y_up(matrix)
"""
```

**skeleton_builder.py**
```python
"""
Skeleton组装
- build_skeleton(armature) -> Skeleton
"""
```

#### `builders/animation/` - 动画构建

**keyframe_sampler.py**
```python
"""
关键帧采样
- sample_position_keys(action, bone, fps) -> List[Key]
- sample_rotation_keys(action, bone, fps) -> List[Key]
- sample_scale_keys(action, bone, fps) -> List[Key]
"""
```

**animation_builder.py**
```python
"""
Animation组装
- build_animation(action, armature) -> Animation
- build_animation_channel(bone, action) -> AnimationChannel
"""
```

#### `builders/model/` - 模型构建

**hardpoint_builder.py**（新增）
```python
"""
硬点数据构建
- build_hardpoint(hardpoint_config, skeleton) -> Hardpoint
- get_bone_path(bone_name, skeleton) -> str
- calculate_hardpoint_transform()
"""
```

**action_builder.py**（新增）
```python
"""
Action数据构建
- build_action(action_config) -> ModelAction
- validate_action_reference()
"""
```

**model_builder.py**
```python
"""
Model组装
- build_static_model(visual_ref, bbox)
- build_skinned_model(visual_ref, bbox, parent, hardpoints)
- build_character_model(visual_ref, bbox, animations, actions, hardpoints)
"""
```

#### `builders/factory.py`（新增）
```python
"""
Builder工厂
- 根据导出类型创建对应的Builder组合
"""

class BuilderFactory:
    @staticmethod
    def create_builders(export_type):
        if export_type == 'STATIC':
            return {
                'primitives': StaticPrimitivesBuilder,
                'visual': StaticVisualBuilder,
                'model': StaticModelBuilder
            }
        elif export_type == 'SKINNED':
            return {
                'primitives': SkinnedPrimitivesBuilder,
                'visual': SkinnedVisualBuilder,
                'model': SkinnedModelBuilder,
                'skeleton': SkeletonBuilder
            }
        elif export_type == 'CHARACTER':
            return {
                'primitives': SkinnedPrimitivesBuilder,
                'visual': SkinnedVisualBuilder,
                'model': CharacterModelBuilder,
                'skeleton': SkeletonBuilder,
                'animation': AnimationBuilder
            }
```

---

### 5️⃣ `exporters/` - 导出器（新设计）

**职责**：协调整个导出流程，调用Builders和Writers

#### `base_exporter.py`（新增）
```python
"""
基础导出器抽象类
- 定义导出流程模板
- 子类实现具体步骤
"""

class BaseExporter:
    def export(self, obj, settings):
        # 模板方法模式
        self.validate(obj)
        data = self.build_data(obj, settings)
        self.write_files(data, settings)
        self.post_process(settings)
    
    @abstractmethod
    def build_data(self, obj, settings):
        pass
```

#### `static_exporter.py`（新增）
```python
"""
静态模型导出器
- 只导出.primitives + .visual + .model
"""

class StaticExporter(BaseExporter):
    def build_data(self, obj, settings):
        primitives = PrimitivesBuilder.build_static(obj)
        visual = VisualBuilder.build_static(obj, primitives_path)
        model = ModelBuilder.build_static(visual_ref, bbox)
        return (primitives, visual, model)
    
    def write_files(self, data, settings):
        primitives_writer.write(data[0])
        visual_writer.write(data[1])
        model_writer.write(data[2])
```

#### `skinned_exporter.py`（新增）
```python
"""
蒙皮模型导出器
- 导出.primitives + .visual + .model（含骨骼和硬点）
"""

class SkinnedExporter(BaseExporter):
    def build_data(self, obj, settings):
        skeleton = SkeletonBuilder.build(armature)
        primitives = PrimitivesBuilder.build_skinned(obj, armature)
        visual = VisualBuilder.build_skinned(obj, skeleton)
        hardpoints = HardpointBuilder.build_all(settings.hardpoints, skeleton)
        model = ModelBuilder.build_skinned(visual_ref, hardpoints, parent)
        return (primitives, visual, model, skeleton)
```

#### `character_exporter.py`（新增）
```python
"""
角色动画导出器
- 完整导出（含Action系统）
"""

class CharacterExporter(BaseExporter):
    def build_data(self, obj, settings):
        skeleton = SkeletonBuilder.build(armature)
        primitives = PrimitivesBuilder.build_skinned(obj, armature)
        visual = VisualBuilder.build_skinned(obj, skeleton)
        animations = AnimationBuilder.build_all(actions, armature)
        actions = ActionBuilder.build_all(settings.actions, animations)
        hardpoints = HardpointBuilder.build_all(settings.hardpoints, skeleton)
        model = ModelBuilder.build_character(visual_ref, animations, actions, hardpoints)
        return (primitives, visual, animations, model, skeleton)
```

#### `export_dispatcher.py`（简化）
```python
"""
导出调度器（简化）
- 根据export_type选择对应的Exporter
"""

class ExportDispatcher:
    def dispatch(self, obj, settings):
        exporter = self._get_exporter(settings.export_type)
        return exporter.export(obj, settings)
    
    def _get_exporter(self, export_type):
        if export_type == 'STATIC':
            return StaticExporter()
        elif export_type == 'SKINNED':
            return SkinnedExporter()
        elif export_type == 'CHARACTER':
            return CharacterExporter()
```

---

### 6️⃣ `utils/` - 工具函数

**职责**：提供通用工具函数，不包含业务逻辑

```python
utils/
├── path_resolver.py      # 路径解析和规范化
├── file_manager.py       # 文件创建、删除、检查
├── logger.py             # 日志记录
└── mesh_utils.py         # 网格工具（三角化、法线计算等）
```

---

## 🔄 数据流程图（新架构）

```
┌─────────────────────────────────────────────────────────────┐
│                      UI Layer                                │
│  preferences.py  object_properties.py  export_operator.py   │
└────────────┬────────────────────────────────────────────────┘
             │ 用户配置
             ↓
┌─────────────────────────────────────────────────────────────┐
│                   Config Layer                               │
│           export_settings.py  constants.py                  │
└────────────┬────────────────────────────────────────────────┘
             │ 配置对象
             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Exporter Layer                              │
│   static_exporter  skinned_exporter  character_exporter    │
└────────────┬────────────────────────────────────────────────┘
             │ 协调流程
             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Builder Layer                               │
│  geometry/  visual/  skeleton/  animation/  model/         │
│    ├─ static_builder.py                                     │
│    ├─ skinning_builder.py                                   │
│    ├─ hardpoint_builder.py  ← 新增                         │
│    └─ action_builder.py     ← 新增                         │
└────────────┬────────────────────────────────────────────────┘
             │ 数据对象
             ↓
┌─────────────────────────────────────────────────────────────┐
│                   Core Layer                                 │
│  coordinate_converter  schema  validator  formats/  io/    │
└────────────┬────────────────────────────────────────────────┘
             │ 处理后数据
             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Writer Layer                                │
│  primitives_writer  visual_writer  model_writer            │
│  animation_writer   manifest_writer  audit_writer          │
└────────────┬────────────────────────────────────────────────┘
             │ 文件
             ↓
        BigWorld Files
```

---

## 📦 核心数据结构扩展

### 扩展 `core/schema.py`

需要添加以下数据类：

```python
# 新增：Action数据结构
@dataclass
class ModelAction:
    """Model中的Action定义"""
    name: str                    # Action名称
    animation_ref: str           # 引用的animation名称
    blended: bool               # 是否混合
    track: int                  # 轨道索引
    # 未来扩展：
    # filler: Optional[int]
    # match_info: Optional[MatchInfo]

# 新增：Hardpoint数据结构
@dataclass
class Hardpoint:
    """硬点定义"""
    name: str                    # 硬点名称（如HP_RightHand）
    identifier: str              # 骨骼完整路径
    transform: List[List[float]] # 4x3变换矩阵
    hardpoint_type: str          # 类型标识（元数据）

# 扩展：Model数据结构
@dataclass
class Model:
    visual_type: str            # nodeless或nodefull
    visual_ref: str
    extent: float
    bounding_box: BoundingBox
    parent: Optional[str]       # 新增
    animations: List[ModelAnimation]
    actions: List[ModelAction]  # 新增
    hardpoints: List[Hardpoint] # 新增
```

---

## 🔀 迁移计划

### 阶段1：创建新目录结构
```bash
1. 创建新目录：
   - config/
   - ui/components/
   - ui/operators/
   - core/formats/
   - core/io/
   - builders/geometry/
   - builders/visual/
   - builders/skeleton/
   - builders/animation/
   - builders/model/
   - exporters/
   - utils/

2. 保留目录：
   - writers/ (不变)
```

### 阶段2：迁移和拆分文件
```
1. core/ → 分拆
   ├─ coordinate_converter.py → core/ (保持)
   ├─ schema.py → core/ (扩展)
   ├─ validator.py → core/ (保持)
   ├─ vertex_format.py → core/formats/
   ├─ bin_section_writer.py → core/io/
   ├─ packed_section_writer.py → core/io/
   ├─ xml_writer.py → core/io/
   ├─ logger.py → utils/
   ├─ file_manager.py → utils/
   └─ path_resolver.py → utils/

2. export_builders.py → 拆分
   ├─ PrimitivesBuilder → builders/geometry/primitives_builder.py
   ├─ VisualBuilder → builders/visual/visual_builder.py
   ├─ SkeletonBuilder → builders/skeleton/skeleton_builder.py
   ├─ AnimationBuilder → builders/animation/animation_builder.py
   └─ ModelBuilder → builders/model/model_builder.py

3. ui/ → 重构和新增
   ├─ preferences_panel.py → ui/preferences.py (重构)
   ├─ object_panel.py → ui/object_properties.py (重构)
   ├─ export_panel.py → ui/export_operator.py (重构)
   ├─ 新增 ui/components/action_list.py
   ├─ 新增 ui/components/hardpoint_list.py
   ├─ 新增 ui/operators/action_ops.py
   └─ 新增 ui/operators/hardpoint_ops.py

4. 导出流程 → 重组
   ├─ export_dispatcher.py → exporters/export_dispatcher.py (简化)
   ├─ export_processor.py → 删除（合并到dispatcher）
   ├─ 新增 exporters/base_exporter.py
   ├─ 新增 exporters/static_exporter.py
   ├─ 新增 exporters/skinned_exporter.py
   └─ 新增 exporters/character_exporter.py

5. 新增模块
   ├─ config/export_settings.py
   ├─ config/constants.py
   ├─ core/formats/packed_normal.py
   ├─ core/formats/quaternion.py
   ├─ builders/geometry/static_builder.py
   ├─ builders/geometry/skinning_builder.py
   ├─ builders/model/hardpoint_builder.py
   └─ builders/model/action_builder.py
```

### 阶段3：更新引用和导入
```
1. 更新 __init__.py 中的导入路径
2. 更新所有模块间的相对导入
3. 测试插件加载
```

---

## ✅ 重构后的优势

| 方面 | 当前架构 | 新架构 | 改进 |
|------|---------|--------|------|
| **文件组织** | 扁平化，职责混乱 | 层次化，职责清晰 | ✅ |
| **模块数量** | 15个文件 | 40+个文件 | 更细粒度 |
| **单个文件大小** | 大（800+行） | 小（<200行） | ✅ |
| **可测试性** | 困难 | 容易 | ✅ |
| **可扩展性** | 困难 | 容易 | ✅ |
| **Action支持** | ❌ 无 | ✅ 有 | 新功能 |
| **Hardpoint支持** | ⏳ 占位 | ✅ 完整 | 新功能 |

---

## 🎯 这个架构重构方案您觉得如何？

**主要改进**：
1. **按功能模块化** - builders按geometry/visual/skeleton/animation/model分类
2. **分离关注点** - UI/Config/Builder/Core/Exporter/Writer清晰分层
3. **支持新功能** - Action和Hardpoint有专门的Builder
4. **便于维护** - 每个文件职责单一，代码量小

**如果同意这个架构，我将：**
1. 创建新的目录结构
2. 拆分和迁移现有代码
3. 实现新的Action和Hardpoint Builder
4. 更新所有导入引用
5. 测试插件加载

**是否开始实施架构重构？** 🚀
